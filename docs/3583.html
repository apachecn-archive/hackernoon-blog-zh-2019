<html>
<head>
<title>How To Add New Cognito Users to DynamoDB Using Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Lambda 向 DynamoDB 添加新的认知用户</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-add-new-cognito-users-to-dynamodb-using-lambda-e3f55541297c#2019-06-12">https://medium.com/hackernoon/how-to-add-new-cognito-users-to-dynamodb-using-lambda-e3f55541297c#2019-06-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/21e0a39bf61250fd97eee9d2947aae8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XevdEl4AvGQaqju7sK4DrA.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">That’s a lot of servers</figcaption></figure><h1 id="1b2a" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">动机</h1><p id="a1fb" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">AWS 为开发人员提供了一些非常强大和有用的工具，但弄清楚它们是如何连接的可能是一个艰巨的过程。许多开发人员花费了无数的时间来随意筛选文档、论坛评论、未回答的 StackOverflow 问题和教程，结果却发现自己又回到了起点，没有编写任何代码。</p><p id="0121" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">影响我的一个例子是，我试图用 Amazon Cognito 认证新用户，然后将他们添加到 DynamoDB 数据库中。这篇文章主要是为我自己的参考而写的，但我希望它能帮助其他搁浅并需要重新下水的开发人员，而不是涉水通过代码的海洋。</p><p id="d580" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">好了，双关语说够了。让我们开始编码吧。</p><h1 id="862a" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">先决条件</h1><p id="1e31" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">本教程假设您已经设置了一个 Amazon Cognito 用户池以及一个带有用户表的 Dynamo 数据库。</p><h1 id="798c" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">初始设置</h1><h2 id="3b54" class="lh jh hu bd ji li lj lk jm ll lm ln jq kp lo lp ju kt lq lr jy kx ls lt kc lu dt translated">为 Lambda 函数创建 IAM 角色</h2><p id="bf13" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">首先，您需要为将要创建的 Lambda 函数设置一个 IAM 角色。</p><p id="019c" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">访问 IAM 管理控制台，从左侧菜单中选择<strong class="kg hv">角色</strong>。点击<strong class="kg hv">创建角色</strong>，选择<strong class="kg hv"> AWS 服务</strong> <strong class="kg hv"> Lambda </strong>角色。两者都突出显示后，单击<strong class="kg hv">下一步:权限</strong>。</p><p id="98c9" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">出于这个简单教程的目的，我们将选择:<br/> 1。DynamoDBFullAccess <br/> 2。AmazonCognitoDeveloperAuthenticatedIdentities<br/>3。AmazonCognitoPowerUser</p><p id="82ef" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">点击<strong class="kg hv">下一步:标签</strong></p><p id="ed00" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">可选地为您的标签设置键值对，然后单击<strong class="kg hv">下一步:查看</strong></p><p id="2235" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">想给你的角色起什么名字都行，只要你能认出它，然后点击<strong class="kg hv">创建角色。</strong></p><h2 id="08e4" class="lh jh hu bd ji li lj lk jm ll lm ln jq kp lo lp ju kt lq lr jy kx ls lt kc lu dt translated">创建新的 Lambda 函数</h2><p id="7a9b" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">访问您的 AWS Lambda 仪表板并点击<strong class="kg hv">创建功能</strong>。</p><p id="b038" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">从头选择<strong class="kg hv">作者</strong>，命名您的函数并保持<strong class="kg hv"> Node.js 10.x </strong>运行时选项处于选中状态。</p><p id="58a7" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">在<strong class="kg hv">权限</strong>下拉列表中，从第一个下拉列表中选择<strong class="kg hv">使用现有角色</strong>，并在下面出现的<strong class="kg hv">现有角色</strong>下拉列表中选择您刚刚创建的 IAM 角色。</p><p id="dcb8" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">点击<strong class="kg hv">创建功能</strong>。</p><h1 id="3251" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">编写您的函数</h1><p id="2aa6" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">在<strong class="kg hv">设计器</strong>下方的<strong class="kg hv">功能代码</strong>窗口中，我们可以开始创建功能，该功能将执行向数据库添加新用户所需的操作。</p><p id="4d06" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated"><em class="lv">感谢</em> <a class="ae lw" href="https://github.com/vbudilov" rel="noopener ugc nofollow" target="_blank"> <em class="lv"> vbudilov </em> </a> <em class="lv">的</em> <a class="ae lw" href="https://github.com/vbudilov/cognito-to-dynamodb-lambda/blob/master/cognitoToDDB.js" rel="noopener ugc nofollow" target="_blank"> <em class="lv">首发码</em> </a> <em class="lv">帮助我入门。</em></p><p id="42b8" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">将以下内容粘贴到<strong class="kg hv">功能代码</strong>窗口中。</p><figure class="lx ly lz ma fq iv"><div class="bz el l di"><div class="mb mc l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Cognito to DynamoDB</figcaption></figure><h2 id="adfc" class="lh jh hu bd ji li lj lk jm ll lm ln jq kp lo lp ju kt lq lr jy kx ls lt kc lu dt translated">这个主旨到底是怎么回事？</h2><p id="6b6a" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">该处理程序使用<a class="ae lw" href="https://aws.amazon.com/sdk-for-node-js/" rel="noopener ugc nofollow" target="_blank"> aws-sdk </a> DynamoDB API，您可以看到它在文件的顶部被实例化，但是我们需要在实际调用将数据添加到数据库的方法之前建立一些参数(我们稍后会这样做)。</p><p id="c7aa" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">一旦配置了变量，就存在一个条件语句，只有当检测到一个事件并且请求包括 userAttributes 时，该条件语句才返回 true，user attributes 是 Cognito 分配给每个新用户的唯一标识符。</p><p id="cdb5" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">然后我们基于 AWS SDK DynamoDB API <a class="ae lw" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB.html#updateTable-property" rel="noopener ugc nofollow" target="_blank">文档</a>创建一个对象，该对象被传递给 putItem 函数并返回一个承诺。</p><p id="7164" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">假设 promise 返回一个成功的响应，用户被添加到数据库中，函数结束。</p><p id="320e" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">在文章的后面，我们将会详细讨论 Lambda 如何检测实际的用户注册。</p><h1 id="f688" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">设置环境变量</h1><p id="bd03" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">请注意以下三个变量:</p><pre class="lx ly lz ma fq md me mf mg aw mh dt"><span id="62ca" class="lh jh hu me b fv mi mj l mk ml">const tableName = process.env.TABLE_NAME;    <br/>const region = process.env.REGION;    <br/>const defaultAvi = 'https://YOUR/DEFAULT/IMAGE';</span></pre><p id="9b03" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">除了这个功能之外:</p><pre class="lx ly lz ma fq md me mf mg aw mh dt"><span id="6f60" class="lh jh hu me b fv mi mj l mk ml">aws.config.update({region: region});</span></pre><p id="d00c" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">虽然您<em class="lv">可以</em>输入自己的 TABLE_NAME 和 REGION，但是最好使用 Lambda 内置的<strong class="kg hv">环境变量</strong>功能来动态定义这些变量。您会发现<strong class="kg hv">环境变量</strong>输入字段就在您正在编写函数的函数代码窗口的下面。</p><p id="eb02" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">如您所料，您可以分别用 REGION 和 TABLE_NAME 填充<strong class="kg hv">键</strong>，用 DynamoDB 表名 AWS Region 填充<strong class="kg hv">值</strong>。</p><h1 id="0f06" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">根据您的喜好修改数据库参数</h1><p id="1ffd" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">您会注意到我创建了一个数据库对象，它带有符合我的数据库表的<strong class="kg hv">项</strong>参数。您应该修改此部分以满足您的需要。</p><pre class="lx ly lz ma fq md me mf mg aw mh dt"><span id="8d78" class="lh jh hu me b fv mi mj l mk ml">// -- Write data to DDB        <br/>let ddbParams = {            <br/>  Item: {                <br/>    'id': {S: event.request.userAttributes.sub},<br/>    '__typename': {S: 'User'},<br/>    'picture': {S: defaultAvi},<br/>    'username': {S: event.userName},<br/>    'name': {S: event.request.userAttributes.name},<br/>    'skillLevel': {N: '0'},<br/>    'email': {S: event.request.userAttributes.email},<br/>    'createdAt': {S: date.toISOString()},<br/>  },<br/>  TableName: tableName        <br/>};</span></pre><h1 id="32b0" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">测试功能</h1><p id="f631" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">在我们用 Cognito 用户池实际实现这个新功能之前，我们知道它按照我们想要的方式工作是很重要的，对吗？幸运的是，Lambda 提供了一个奇妙的测试框架，允许您用一个简单的 JSON 对象提交请求。</p><p id="b7b4" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">在 Lambda 管理控制台的顶部附近，您会发现一个下拉菜单，默认显示<strong class="kg hv"> <em class="lv">选择一个测试事件</em>。</strong>点击下拉菜单，选择<strong class="kg hv">配置测试事件。</strong></p><p id="287e" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">在<strong class="kg hv">事件名称</strong>字段中输入一个容易记住的名称，并将以下代码粘贴到下面的编辑器中。</p><figure class="lx ly lz ma fq iv"><div class="bz el l di"><div class="mb mc l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Test user request</figcaption></figure><p id="0557" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">再次编辑请求以适应您已经创建的数据库模式。</p><p id="6cbc" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">当您对测试请求感到满意时，点击<strong class="kg hv"> Create。</strong></p><p id="6985" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">关闭模式并点击页面顶部事件下拉菜单右侧的<strong class="kg hv">测试</strong>按钮。</p><p id="463f" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">测试将在页面标题和编写函数的<strong class="kg hv">函数代码</strong>编辑器的控制台中返回响应。</p><p id="7985" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">成功！</p><p id="5f76" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">现在，如果您检查您的 DynamoDB，您应该在用户表中看到您的新测试用户。</p><h1 id="c9b9" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">在 Cognito 中创建确认后触发器</h1><p id="2ec0" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">访问您的 Amazon Cognito 用户池，点击左侧的<strong class="kg hv">触发器</strong>菜单项。</p><p id="c9ee" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">找到<strong class="kg hv"> Post 确认</strong>卡，选择您刚刚创建并测试的 Lambda 函数。最后，点击<strong class="kg hv">保存更改</strong>保存您的工作。</p><p id="3876" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">现在，当用户通过您的 Amazon Cognito 注册表单注册时，他们将自动添加到您的 DynamoDB 中，并可以以您认为合适的任何方式进行管理。</p><h1 id="8adf" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated"><strong class="ak">就这样</strong></h1><p id="1fb8" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">恭喜，您已经创建了一个由 Cognito 后确认触发器调用的 Lambda 函数。</p><p id="2aca" class="pw-post-body-paragraph ke kf hu kg b kh lc kj kk kl ld kn ko kp le kr ks kt lf kv kw kx lg kz la lb hn dt translated">如果你觉得我错过了什么或者可以改进这个教程，请不要犹豫，在评论中告诉我！</p></div></div>    
</body>
</html>