# 你没听说过的最奇怪的智能合约错误

> 原文：<https://medium.com/hackernoon/the-strangest-smart-contract-bug-you-havent-heard-about-a6ebc8dbc0a5>

![](img/7193fc501da863d7a48874cc8c0aef32.png)

A bug.

注意:我没有[意图](https://hackernoon.com/tagged/intention)诋毁这个项目或任何参与其中的人。加密和智能合约开发的美妙之处在于所有的代码都在展示中。我只是在评论一个*重大的*失误和一个非常有趣的情况。

勒苟拉斯交易所(LGO) [在 2018 年初筹集了大约 3000 万美元](https://www.reddit.com/r/LegolasExchange/comments/7um3jc/hard_cap_reached_3500_bitcoin_raised_in_total/)，并在[以太坊](https://hackernoon.com/tagged/ethereum)上部署了一个 ERC-20 代币。这个代币有一个特殊的功能，内置在代码中，用来奖励霍德勒。在前 2 年的每 6 个月，所有尚未转移资金的账户都应该额外获得 5%的代币，作为对他们忠诚度的奖励。回报有可能高于 5%——随着其他人放弃他们的回报而增加。

听起来很棒，对吧？

不幸的是，不可变契约的编码使得原本应该用于支付奖金的额外 20%的代币实际上肯定会丢失。

我说“几乎有保证”是因为有办法找回它们——只是需要不虔诚的合作程度。很快会有更多的报道。

**Bug**

我认为合同中有几个部分不应该通过任何严肃的审核，例如不正当地使用百分比来分配象征性的金额。

然而，导致这篇文章的有问题的 bug 可以在[契约源](https://etherscan.io/address/0x123ab195dd38b1b40510d467a6a359b201af056f#code)的第 326 行找到:

```
// calculate the bonus for one holded LGO
uint256 bonusByLgo = (BONUS_AMOUNT / 4)/unspentAmounts[_bonusDate];
```

我不打算深入探讨这个问题——你可以很容易地为自己检查我所说的话。你只需要知道这个变量，`bonusByLgo`期望被分配一个百分比。大约 0.05。如果您是一名开发人员(来自任何背景，不仅仅是智能合约开发！)你知道这有多荒谬。一个`uint256`只能被赋值为 0、1 或任何其他整数。

因此，当计算要分发的奖金百分比时，由于自然舍入，申请的用户总是会收到 0%的奖励。

除了这个错误——更大的错误是:*任何对`claimBonus` 方法的*测试都会发现这个问题。一份合同投入了 3000 万美元，但其核心功能完全未经测试。

**他们如何“解决”它**

值得称赞的是，LGO 团队开始从他们自己的储备金中手动支付奖金，这也是代币的 20%。你可以看到这些交易在很长一段时间内发生——如果你想做深入的链分析，你可以找到一个 LGO 拥有的地址分发一轮奖金[这里](https://etherscan.io/token/0x123ab195dd38b1b40510d467a6a359b201af056f?a=0x1035a5dd4859a87cf25ed31b0df7436099f7d1c3)。

LGO 的潜在持有者会读到这里，但不知道哪里出了问题，但如果我们以 LGO 的历史最高市值对代币进行估值，这个错误给公司造成了大约 700 万美元的损失。

**一条真正怪异的出路**

所以正如我在讨论 bug 的时候提到的，变量`bonusByLgo`将*几乎*总是求值为 0。除了一种情况。当`(BONUS_AMOUNT/4)`大于`unspentAmounts[_bonusDate]`时。当这种情况发生时，其余的持有人将获得一个 LGO 代币的奖励代币-100%的奖金！！

什么会引发这种情况？除非 95%的持有者移动他们的代币。只有当 5%的代币仍有资格获得奖金时，他们才会在剩余的每个奖金日获得 100%的奖金。

真正疯狂的是这个！如果社区走到一起，所有人都决定移动他们的代币——这与合同的意图完全相反——他们可能会至少归还 LGO 一些代币，并为 LGO 省下一笔钱。你甚至可以想象这样一种情况，LGO 团队或另一个流氓开发者建立了一个聪明的合同，允许剩余的持有者领取和分配奖金——尽管祝你好运获得所需的 95%的参与。

**课文**

对任何功能过于复杂的象征性契约持怀疑态度。“聪明的”智能合同开发人员应该远离任何这样的花招，当绝对需要时，应该对其进行极端的测试和审计。

更多关于智能合约的有趣方面，请在 Twitter 上找到我:[https://twitter.com/codingupastorm](https://twitter.com/codingupastorm)