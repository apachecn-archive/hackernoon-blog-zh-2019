<html>
<head>
<title>Build an Ecommerce App with Personalization using Angular and Cosmic JS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Angular和Cosmic JS构建一个个性化的电子商务应用程序</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/build-an-ecommerce-app-with-personalization-using-angular-and-cosmic-js-9eba6f33b042?source=collection_archive---------18-----------------------#2019-05-02">https://medium.com/hackernoon/build-an-ecommerce-app-with-personalization-using-angular-and-cosmic-js-9eba6f33b042?source=collection_archive---------18-----------------------#2019-05-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/5649270305f858d92e53d001fab362ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8bZBjo0KHVCcGf2Y3wqneQ.png"/></div></div></figure><p id="5f15" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">本文将假设Angular的一些基本知识，以便它可以专注于手头的特定任务。如果您对实施过程中的任何细节有不清楚的地方，请随时问我</em></p><h1 id="7073" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">TL；速度三角形定位法(dead reckoning)</h1><p id="cf9f" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">看一看<a class="ae le" href="https://github.com/cosmicjs/angular-ecommerce-personalization" rel="noopener ugc nofollow" target="_blank">库</a>和<a class="ae le" href="https://cosmicjs.com/apps/ecommerce-personalization" rel="noopener ugc nofollow" target="_blank">安装app </a>，或者<a class="ae le" href="https://cosmicjs.com/apps/ecommerce-personalization/demo" rel="noopener ugc nofollow" target="_blank">查看演示</a>。</p><h1 id="3b28" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">我们将要建造的</h1><p id="f45d" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">这个网站将是一个非常简单的电子商务网站的代表。其目的是展示我们如何为每个人提供定制的体验。我们的数据将由Cosmic JS存储和服务，我们将使用Angular作为我们的前端。</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/6dc3a5666fe83a94473c42d23a1a5261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_tjeSzGT_xilbC8zSHKvkA.png"/></div></div></figure><h1 id="b9fc" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">它将如何工作</h1><p id="8090" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我们的店面将只是一个产品列表页面，显示所有存储在宇宙JS中的产品，随机排序。产品将属于多个类别，每个产品将显示3个按钮来模拟以下行为:</p><ul class=""><li id="ea1a" class="lj lk hu je b jf jg jj jk jn ll jr lm jv ln jz lo lp lq lr dt translated">视图-&gt;值:1</li><li id="906c" class="lj lk hu je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt translated">添加到购物车-&gt;值:2</li><li id="7a5c" class="lj lk hu je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt translated">购买-&gt;价值:3</li></ul><p id="0076" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些将代表不同程度的兴趣。</p><p id="2b25" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">用户将与网站互动，他们的兴趣将存储在他们的个人资料中，增加每个产品类别的相应价值。</p><p id="11f3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一个完整的交互应该是这样的:用户点击“购买”一个“泳装”产品，增加其属于“泳装”产品的简介分数。然后，页面将对页面进行排序，更突出地显示属于“泳装”的产品。</p><h1 id="1f7a" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">准备我们的桶</h1><p id="07ed" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我们要做的第一件事是准备我们的宇宙JS桶。我们必须创建一个空桶和三种对象类型:</p><ul class=""><li id="8b9f" class="lj lk hu je b jf jg jj jk jn ll jr lm jv ln jz lo lp lq lr dt translated">种类</li><li id="084b" class="lj lk hu je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt translated">制品</li><li id="8548" class="lj lk hu je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt translated">用户</li></ul><p id="ee2f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">每个<code class="eh lx ly lz ma b">user</code>将为<code class="eh lx ly lz ma b">interests</code>存储一个<code class="eh lx ly lz ma b">sessionID</code>和一个JSON对象。<br/>每个<code class="eh lx ly lz ma b">product</code>都会有一个<code class="eh lx ly lz ma b">price</code>，一个<code class="eh lx ly lz ma b">categories</code>的集合和一个<code class="eh lx ly lz ma b">image</code>。<br/>类别不需要任何元数据，我们将只使用它的<code class="eh lx ly lz ma b">title</code>。</p><p id="a377" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你像我一样懒，你总是可以<strong class="je hv">通过<a class="ae le" href="https://cosmicjs.com/apps/ecommerce-personalization" rel="noopener ugc nofollow" target="_blank">安装app </a>来复制演示桶</strong>。</p><h1 id="29c8" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">准备场地</h1><p id="a80e" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我们需要做的第一件事是创建一个新的Angular站点(我总是推荐使用CLI来完成)。现在，让我们创建一个HTTP拦截器来处理针对Cosmic JS API的认证，所以我们不需要在每个调用中都添加这个。它将为GET请求附加<code class="eh lx ly lz ma b">read_key</code>参数，为其他所有请求附加<code class="eh lx ly lz ma b">write_key</code>。</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="5bbe" class="mf kc hu ma b fv mg mh l mi mj">@Injectable({ providedIn: 'root' })<br/>export class CosmicInterceptor implements HttpInterceptor {<br/>  intercept(req: HttpRequest&lt;any&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;any&gt;&gt; {<br/>    if (req.url.match(/api.cosmicjs/)) {<br/>      let params = new HttpParams({ fromString: req.params.toString() });<br/>      if (req.method === 'GET') {<br/>        params = params.append('read_key', environment.read_key);</span><span id="696b" class="mf kc hu ma b fv mk mh l mi mj">        req = req.clone({<br/>          params: params<br/>        });<br/>      } else {<br/>        let payload = JSON.parse(req.body);<br/>        payload.write_key = environment.write_key;</span><span id="9b9c" class="mf kc hu ma b fv mk mh l mi mj">        req = req.clone({<br/>          body: payload<br/>        });<br/>      }<br/>    }<br/>    return next.handle(req);<br/>  }<br/>}</span></pre><p id="3e22" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">产品列表将是我们唯一的页面，因此在创建组件之后，我们的路由应该如下所示:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="65d3" class="mf kc hu ma b fv mg mh l mi mj">const routes: Routes = [{ path: '', component: ProductListingComponent }];</span></pre><h1 id="75d2" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">产品列表页面</h1><p id="10cd" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我们需要展示产品，所以让我们定义我们的模型:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="e618" class="mf kc hu ma b fv mg mh l mi mj">import { Category } from './category';</span><span id="0cf4" class="mf kc hu ma b fv mk mh l mi mj">export class Product {<br/>  _id: string;<br/>  slug: string;<br/>  title: string;<br/>  price: string;<br/>  categories: Category[];<br/>  image: string;</span><span id="ac68" class="mf kc hu ma b fv mk mh l mi mj">  constructor(obj) {<br/>    this._id = obj._id;<br/>    this.slug = obj.slug;<br/>    this.title = obj.title;<br/>    this.price = obj.metadata.price;<br/>    this.image = obj.metadata.image.url;<br/>    this.categories = [];</span><span id="3d79" class="mf kc hu ma b fv mk mh l mi mj">    if (obj.metadata &amp;&amp; obj.metadata.categories) {<br/>      obj.metadata.categories.map(category =&gt; this.categories.push(new Category(category)));<br/>    }<br/>  }<br/>}</span></pre><p id="e97c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">*我们稍后会在那里讨论类别。</em></p><p id="2d43" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在让我们开始用方法填充我们的服务。首先，我们需要一个<code class="eh lx ly lz ma b">getProducts()</code>方法:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="0840" class="mf kc hu ma b fv mg mh l mi mj">private products$: Observable&lt;Product[]&gt;;</span><span id="0702" class="mf kc hu ma b fv mk mh l mi mj">getProducts(): Observable&lt;Product[]&gt; {<br/>    if (!this.products$) {<br/>      this.products$ = this.http.get&lt;Product[]&gt;(this.productsUrl).pipe(<br/>        tap(_ =&gt; console.log('fetched products')),<br/>        map(_ =&gt; {<br/>          return _['objects'].map(element =&gt; new Product(element));<br/>        }),<br/>        shareReplay(1),<br/>        catchError(this.handleError('getProducts', []))<br/>      );<br/>    }<br/>    return this.products$;<br/>  }</span></pre><p id="db20" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">*我们正在缓存响应，我们的产品不会经常改变，我们会经常调用这个方法……</em></p><p id="7341" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">组件本身将非常简单。现在，它只会调用两个对我们服务的调用:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="4641" class="mf kc hu ma b fv mg mh l mi mj">import { Component, OnInit } from '@angular/core';<br/>import { CosmicService } from 'src/app/core/_services/cosmic.service';<br/>import { Product } from '@models/product';<br/>import { UserService } from 'src/app/core/_services/user.service';<br/>import { User } from '@models/user';</span><span id="148b" class="mf kc hu ma b fv mk mh l mi mj">@Component({<br/>  selector: 'app-product-listing',<br/>  templateUrl: './product-listing.component.html',<br/>  styleUrls: ['./product-listing.component.scss']<br/>})<br/>export class ProductListingComponent implements OnInit {<br/>  public productList: Product[];<br/>  public user: User;</span><span id="cac1" class="mf kc hu ma b fv mk mh l mi mj">  constructor(private cosmicService: CosmicService, private userService: UserService) {}</span><span id="9e49" class="mf kc hu ma b fv mk mh l mi mj">  ngOnInit() {<br/>    this.userService.user$.subscribe(user =&gt; {<br/>      this.user = user;<br/>    });<br/>    this.cosmicService.getProducts().subscribe(products =&gt; (this.productList = products));<br/>  }<br/>}</span></pre><p id="c502" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是HTML:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="53a8" class="mf kc hu ma b fv mg mh l mi mj">&lt;div class="columns" *ngIf="productList &amp;&amp; user"&gt;<br/>  &lt;ng-container *ngFor="let product of (productList | customSort:user.interests)"&gt;<br/>          &lt;div class="product-tile column is-one-third"&gt;<br/>            &lt;img src="{{ product.image }}" class="image"/&gt;<br/>            &lt;div class="level is-size-4 is-uppercase"&gt;<br/>                &lt;span class="level-item"&gt;{{product.title}}&lt;/span&gt;<br/>                &lt;span class="level-item has-text-weight-bold"&gt;${{product.price}}&lt;/span&gt;<br/>            &lt;/div&gt;<br/>            &lt;app-actions [product]="product"&gt;&lt;/app-actions&gt;<br/>          &lt;/div&gt;<br/>  &lt;/ng-container&gt;<br/>&lt;/div&gt;</span></pre><p id="aac6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你注意到那个<code class="eh lx ly lz ma b">app-actions</code>组件了吗？它将负责用户将对每个产品执行的操作。不过我们先来谈谈那之前的<code class="eh lx ly lz ma b">user</code>...</p><h1 id="e603" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">关于用户的一切</h1><p id="cd8f" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我们的用户模型将是最“复杂”的。因为我们将从站点创建用户，并从Cosmic JS中检索他们，所以我们需要一个更灵活的构造器。我们还添加了一些方法来构建一个有效负载对象，用于向Cosmic JS发布内容，以及另一个用于管理兴趣的对象。</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="5f8b" class="mf kc hu ma b fv mg mh l mi mj">import { Category } from './category';</span><span id="5a3c" class="mf kc hu ma b fv mk mh l mi mj">export class User {<br/>  _id: string;<br/>  slug: string;<br/>  interests: JSON;</span><span id="bdc3" class="mf kc hu ma b fv mk mh l mi mj">  constructor(obj?) {<br/>    this._id = obj ? obj._id : '';<br/>    this.slug = obj ? obj.slug : '';<br/>    this.interests = obj ? JSON.parse(obj.metadata.interests) : {};<br/>  }</span><span id="e07b" class="mf kc hu ma b fv mk mh l mi mj">  postBody() {<br/>    return {<br/>      title: this.slug,<br/>      type_slug: 'users',<br/>      metafields: [<br/>        {<br/>          key: 'interests',<br/>          value: JSON.stringify(this.interests)<br/>        }<br/>      ]<br/>    };<br/>  }</span><span id="68c6" class="mf kc hu ma b fv mk mh l mi mj">  putBody() {<br/>    return {<br/>      title: this.slug,<br/>      slug: this.slug,<br/>      metafields: [<br/>        {<br/>          key: 'interests',<br/>          value: JSON.stringify(this.interests)<br/>        }<br/>      ]<br/>    };<br/>  }</span><span id="3e43" class="mf kc hu ma b fv mk mh l mi mj">  increaseInterest(category: Category, weight: number) {<br/>    if (!this.interests[category.title]) {<br/>      this.interests[category.title] = weight;<br/>    } else {<br/>      this.interests[category.title] += weight;<br/>    }<br/>  }<br/>}</span></pre><p id="04b7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们不会为我们的示例构建一个合适的身份验证过程。每个用户在浏览器的本地存储中都有一个sessionID，我们将使用它来创建和标识用户。为了方便起见，我们将用户实例保存在会话存储中。为了保持整洁，让我们创建一个<code class="eh lx ly lz ma b">user</code>服务:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="ec9c" class="mf kc hu ma b fv mg mh l mi mj">import { Injectable } from '@angular/core';<br/>import { User } from '@models/user';<br/>import { CosmicService } from './cosmic.service';<br/>import { BehaviorSubject } from 'rxjs';</span><span id="d537" class="mf kc hu ma b fv mk mh l mi mj">@Injectable({<br/>  providedIn: 'root'<br/>})<br/>export class UserService {<br/>  private userSource = new BehaviorSubject&lt;User&gt;(new User());<br/>  public user$ = this.userSource.asObservable();</span><span id="a787" class="mf kc hu ma b fv mk mh l mi mj">  constructor(private cosmicService: CosmicService) {}</span><span id="0a90" class="mf kc hu ma b fv mk mh l mi mj">  init() {<br/>    let sessionID = localStorage.getItem('sessionID');</span><span id="1c82" class="mf kc hu ma b fv mk mh l mi mj">    if (!sessionID) {<br/>      const user = new User();</span><span id="451b" class="mf kc hu ma b fv mk mh l mi mj">      sessionID = Math.random()<br/>        .toString(36)<br/>        .substr(2, 9);</span><span id="0085" class="mf kc hu ma b fv mk mh l mi mj">      localStorage.setItem('sessionID', sessionID);<br/>      user.slug = sessionID;</span><span id="8d29" class="mf kc hu ma b fv mk mh l mi mj">      this.cosmicService.setUser(user).subscribe(user =&gt; {<br/>        this.setSessionUser(user);<br/>      });<br/>    } else if (!sessionStorage.getItem('user')) {<br/>      this.cosmicService.getUser(sessionID).subscribe(user =&gt; this.setSessionUser(user));<br/>    }<br/>  }</span><span id="7616" class="mf kc hu ma b fv mk mh l mi mj">  setSessionUser(user: User) {<br/>    sessionStorage.setItem('user', JSON.stringify(user));<br/>    this.userSource.next(user);<br/>  }</span><span id="7528" class="mf kc hu ma b fv mk mh l mi mj">  getSessionUser(): User {<br/>    const user = sessionStorage.getItem('user');</span><span id="6fae" class="mf kc hu ma b fv mk mh l mi mj">    if (user) {<br/>      return Object.assign(new User(), JSON.parse(user));<br/>    } else {<br/>      return null;<br/>    }<br/>  }<br/>}</span></pre><p id="407b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh lx ly lz ma b">init()</code>方法将用于我们的<code class="eh lx ly lz ma b">app.component.ts</code>:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="ffb2" class="mf kc hu ma b fv mg mh l mi mj">constructor(private userService: UserService) {}</span><span id="b224" class="mf kc hu ma b fv mk mh l mi mj">  ngOnInit() {<br/>    this.userService.init();<br/>  }</span></pre><p id="b91d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们还需要一种设置和获取用户的方法，让我们用以下方法扩展我们的<code class="eh lx ly lz ma b">cosmic.service</code>:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="cc5e" class="mf kc hu ma b fv mg mh l mi mj">getUser(slug: string): Observable&lt;User&gt; {<br/>    const url = `${this.singleObjectUrl}/${slug}`;<br/>    return this.http.get&lt;User&gt;(url).pipe(<br/>      tap(_ =&gt; console.log(`fetched user: ${slug}`)),<br/>      map(_ =&gt; {<br/>        return new User(_['object']);<br/>      }),<br/>      catchError(this.handleError&lt;User&gt;(`getUser: ${slug}`))<br/>    );<br/>  }</span><span id="acfe" class="mf kc hu ma b fv mk mh l mi mj">  setUser(user: User) {<br/>    return this.http.post&lt;User&gt;(this.addObjectPath, JSON.stringify(user.postBody())).pipe(<br/>      map(_ =&gt; {<br/>        return new User(_['object']);<br/>      }),<br/>      catchError(this.handleError&lt;User&gt;())<br/>    );<br/>  }</span></pre><p id="dff3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">另外，请注意，我们创建了一个可观察的<code class="eh lx ly lz ma b">user$</code>,每次我们在会话中设置(或更新)用户时都会发出这个消息，您已经在产品列表上看到了订阅。在文章的最后有更多关于这个的内容。</p><p id="a372" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">回到<code class="eh lx ly lz ma b">actions.component</code>。这是一组三个按钮，如下所示:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="409f" class="mf kc hu ma b fv mg mh l mi mj">&lt;div class="buttons has-addons is-centered"&gt;<br/>  &lt;a class="button is-primary" (click)="viewProduct()"&gt;<br/>    &lt;span class="icon is-small"&gt;<br/>      &lt;i class="fa fa-eye"&gt;&lt;/i&gt;<br/>    &lt;/span&gt;<br/>    &lt;span&gt;View&lt;/span&gt;<br/>  &lt;/a&gt;<br/>  &lt;a class="button is-warning" (click)="addProductToCart()"&gt;<br/>    &lt;span class="icon is-small"&gt;<br/>      &lt;i class="fa fa-shopping-cart"&gt;&lt;/i&gt;<br/>    &lt;/span&gt;<br/>    &lt;span&gt;Add to cart&lt;/span&gt;<br/>  &lt;/a&gt;<br/>  &lt;a class="button is-success" (click)="buyProduct()"&gt;<br/>    &lt;span class="icon is-small"&gt;<br/>      &lt;i class="fa fa-dollar"&gt;&lt;/i&gt;<br/>    &lt;/span&gt;<br/>    &lt;span&gt;Buy!&lt;/span&gt;<br/>  &lt;/a&gt;<br/>&lt;/div&gt;</span></pre><p id="72b2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些方法看起来像这样:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="ae12" class="mf kc hu ma b fv mg mh l mi mj">@Input() product: Product;</span><span id="986b" class="mf kc hu ma b fv mk mh l mi mj">  viewProduct() {<br/>    this.increaseInterest(1);<br/>  }</span><span id="238c" class="mf kc hu ma b fv mk mh l mi mj">  addProductToCart() {<br/>    this.increaseInterest(2);<br/>  }</span><span id="143b" class="mf kc hu ma b fv mk mh l mi mj">  buyProduct() {<br/>    this.increaseInterest(3);<br/>  }</span><span id="9515" class="mf kc hu ma b fv mk mh l mi mj">  increaseInterest(weight: number) {<br/>    const user: User = this.userService.getSessionUser();<br/>    this.product.categories.forEach((category: Category) =&gt; {<br/>      user.increaseInterest(category, weight);<br/>    }, this);</span><span id="a49e" class="mf kc hu ma b fv mk mh l mi mj">    this.userService.setSessionUser(user);<br/>    this.cosmicService.updateUser(user).subscribe();<br/>  }</span></pre><p id="7740" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当更新兴趣时，我们也在会话中刷新用户，我们也在Cosmic JS中更新用户，我们永远不知道用户何时或如何离开网站！让我们回到我们的<code class="eh lx ly lz ma b">cosmic.service</code>并添加这个方法:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="790d" class="mf kc hu ma b fv mg mh l mi mj">updateUser(user: User) {<br/>    return this.http.put&lt;User&gt;(this.editObjectPath, JSON.stringify(user.putBody())).pipe(<br/>      map(_ =&gt; {<br/>        return new User(_['object']);<br/>      }),<br/>      catchError(this.handleError&lt;User&gt;())<br/>    );<br/>  }</span></pre><h1 id="5fac" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">包装好一切</h1><p id="5609" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我们现在有办法展示产品，创造用户和他们的兴趣，更新和存储它们。就这样…差不多了。基于这一切，产品列表页面会有怎样的变化？还有最后一件事我们还没有完成customSort管道。它看起来是这样的:</p><pre class="lf lg lh li fq mb ma mc md aw me dt"><span id="3638" class="mf kc hu ma b fv mg mh l mi mj">@Pipe({<br/>  name: 'customSort'<br/>})<br/>export class CustomSortPipe implements PipeTransform {<br/>  transform(value: Product[], interests: JSON): Product[] {<br/>    value.sort((a: Product, b: Product) =&gt; {<br/>      const aWeight = this.getWeight(a.categories, interests);<br/>      const bWeight = this.getWeight(b.categories, interests);</span><span id="5dac" class="mf kc hu ma b fv mk mh l mi mj">      if (aWeight &lt; bWeight) {<br/>        return 1;<br/>      } else if (aWeight &gt; bWeight) {<br/>        return -1;<br/>      } else {<br/>        return 0;<br/>      }<br/>    });<br/>    return value;<br/>  }</span><span id="3de6" class="mf kc hu ma b fv mk mh l mi mj">  getWeight(categories: Category[], interests: JSON) {<br/>    let weight = 0;<br/>    categories.forEach(category =&gt; {<br/>      weight += interests[category.title] || 0;<br/>    });<br/>    return weight;<br/>  }<br/>}</span></pre><p id="fefc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该管道将获取产品列表，并根据参数提供的用户兴趣按重量排序…</p><p id="9068" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">神奇之处在于:产品列表页面订阅了会话用户中的更改，因此每次用户执行一个操作时，用户都会更改，排序会随着更改而重新执行。</p><p id="b445" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就这些，我希望这已经展示了如何在Angular和Cosmic JS的帮助下为你的用户提供定制的体验。</p></div></div>    
</body>
</html>