<html>
<head>
<title>Java-C-Assembly Matryoshka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Java-C 汇编 Matryoshka</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/java-c-assembly-matryoshka-932193f071d3#2019-06-04">https://medium.com/hackernoon/java-c-assembly-matryoshka-932193f071d3#2019-06-04</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/3c41dc05e791e6c5bf037ec3ee836a70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bcZOoK-554jCmUja"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Source: <a class="ae jg" href="https://unsplash.com/photos/9hhOVsf1lpU" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><blockquote class="jh ji jj"><p id="c7c9" class="jk jl jm jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hn dt translated"><strong class="jn hv">免责声明</strong> : <br/> -我将使用 Windows，尤其是 Visual C++及其内嵌汇编程序。如果你使用的是 MacOs 或者 Linux，你会发现和文章中描述的有很大的不同。<br/> -以下所有内容主要用于演示目的</p></blockquote><h1 id="7f03" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">介绍</h1><p id="5f9f" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">java 是成熟的自给自足的语言，尽管我们都知道可以将 Java“连接”到 C 语言(通过 Java-Native-Interface 或 JNI)来加速一些关键的代码。<br/>同样，对于 C/C++来说，可以将一些更关键的代码直接委托给汇编。</p><p id="fab8" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">在本文中，我想向您展示这个 Java-C-Assembly Matryoshka 是什么样子的。但是请注意，这个例子非常简单，所以在现实世界中，这种委托没有任何好处，因为它不会加速任何事情。</p><p id="c2be" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">我们要看的例子是:</p><ul class=""><li id="ae3e" class="lp lq hu jn b jo jp js jt lj lr ll ls ln lt ki lu lv lw lx dt translated">给定一个命令行程序(用 Java 编写)</li><li id="236f" class="lp lq hu jn b jo ly js lz lj ma ll mb ln mc ki lu lv lw lx dt translated">我们通过提供 2 个整数作为参数来执行程序(在客户端进行错误处理)</li><li id="65a1" class="lp lq hu jn b jo ly js lz lj ma ll mb ln mc ki lu lv lw lx dt translated">主要的业务逻辑是“sum”方法，我们认为这是程序的一个关键部分，我们希望使用 C 和汇编来“加速”。</li></ul><h1 id="b148" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">Java 语言(一种计算机语言，尤用于创建网站)</h1><h2 id="27ca" class="md kk hu bd kl me mf mg kp mh mi mj kt lj mk ml kx ll mm mn lb ln mo mp lf mq dt translated">设置</h2><p id="be82" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">首先我们需要下载<a class="ae jg" href="https://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html" rel="noopener ugc nofollow" target="_blank"> JDK </a>。<br/>我已经安装了相当旧的版本，但请放心安装新版本。<br/>安装后，验证一切正常:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="a1a1" class="md kk hu mw b fv na nb l nc nd">&gt;java -version<br/>java version "1.8.0_121"<br/>Java(TM) SE Runtime Environment (build 1.8.0_121-b13)<br/>Java HotSpot(TM) Client VM (build 25.121-b13, mixed mode, sharing)</span></pre><h2 id="89a0" class="md kk hu bd kl me mf mg kp mh mi mj kt lj mk ml kx ll mm mn lb ln mo mp lf mq dt translated">密码</h2><p id="b528" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">下面是我们的程序:主函数、解析命令行参数和我们的目标方法“sum”(用 java 实现):</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="a44d" class="md kk hu mw b fv na nb l nc nd">public class Test {<br/> <br/>    public static void main(String[] args) {<br/>  <br/>        if (args.length != 2) {<br/>            System.out.println("Error: wrong params count");<br/>            return;<br/>        }<br/>  <br/>        int a;<br/>        try {<br/>            a = Integer.parseInt(args[0]);<br/>        } catch (Throwable throwable) {<br/>            System.out.println("First param is not a number");<br/>            return;<br/>        }<br/>  <br/>        int b;<br/>        try {<br/>            b = Integer.parseInt(args[1]);<br/>        } catch (Throwable throwable) {<br/>            System.out.println("Second param is not a number");<br/>            return;<br/>        }<br/>  <br/>        Test test = new Test();<br/>        System.out.println(test.sum(a, b));<br/>    }<br/> <br/>    public static int sum(int a, int b) {<br/>        return a + b;<br/>    }<br/>}</span></pre><h2 id="dba0" class="md kk hu bd kl me mf mg kp mh mi mj kt lj mk ml kx ll mm mn lb ln mo mp lf mq dt translated">编制</h2><p id="595e" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">为了运行程序，我们首先需要用 java 编译器编译它。它将生成<code class="eh ne nf ng mw b">Test.class</code>二进制文件，我们稍后将执行该文件。</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="19d6" class="md kk hu mw b fv na nb l nc nd">&gt; javac Test.java</span></pre><h2 id="3183" class="md kk hu bd kl me mf mg kp mh mi mj kt lj mk ml kx ll mm mn lb ln mo mp lf mq dt translated">执行</h2><p id="07e5" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">执行程序调用<code class="eh ne nf ng mw b">java</code>并提供参数。看看我们的程序工作正常，并打印数字的总和。</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="1916" class="md kk hu mw b fv na nb l nc nd">&gt; java Test 3 4<br/>7</span></pre><h1 id="72b0" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">C/JNI</h1><h2 id="d56b" class="md kk hu bd kl me mf mg kp mh mi mj kt lj mk ml kx ll mm mn lb ln mo mp lf mq dt translated">设置</h2><p id="f09a" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">安装<a class="ae jg" href="https://chocolatey.org/" rel="noopener ugc nofollow" target="_blank"> Chocolatey </a>并使用它安装 Visual C++构建工具:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="1d03" class="md kk hu mw b fv na nb l nc nd">choco install visualcpp-build-tools</span></pre><p id="63c1" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">我们将需要这些工具来把 C 文件编译成库 dll 文件。具体来说，为了编译，我们需要<code class="eh ne nf ng mw b">cl</code>命令，所以检查它是否工作:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="f8da" class="md kk hu mw b fv na nb l nc nd">&gt;cl<br/>Microsoft (R) C/C++ Optimizing Compiler Version 19.16.27031.1 for x86<br/>Copyright (C) Microsoft Corporation.  All rights reserved.</span></pre><h2 id="01e1" class="md kk hu bd kl me mf mg kp mh mi mj kt lj mk ml kx ll mm mn lb ln mo mp lf mq dt translated">密码</h2><p id="047a" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">Java 可以通过 JNI 与 C 进行通信。为了建立通信，我们需要更新我们的 Java 程序:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="7309" class="md kk hu mw b fv na nb l nc nd">public class Test {<br/> <br/>    public static void main(String[] args) {<br/>  <br/>        if (args.length != 2) {<br/>            System.out.println("Error: wrong params count");<br/>            return;<br/>        }<br/>  <br/>        int a;<br/>        try {<br/>            a = Integer.parseInt(args[0]);<br/>        } catch (Throwable throwable) {<br/>            System.out.println("First param is not a number");<br/>            return;<br/>        }<br/>  <br/>        int b;<br/>        try {<br/>            b = Integer.parseInt(args[1]);<br/>        } catch (Throwable throwable) {<br/>            System.out.println("Second param is not a number");<br/>            return;<br/>        }</span><span id="9048" class="md kk hu mw b fv nh nb l nc nd"><strong class="mw hv">        System.loadLibrary("Test");<br/>        </strong>Test test = new Test();<br/>        System.out.println(test.sum(a, b));<br/>    }<br/> <br/>    <strong class="mw hv">public native int sum(int a, int b);</strong><br/>}</span></pre><p id="a97c" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">首先，我们提供所谓的本地方法，而不是静态方法和实现。它没有任何实现，因为我们希望它通过 JNI 提供。其次，我们需要加载我们的 C 库——我们用<code class="eh ne nf ng mw b">System.loadLibrary</code>方法来完成。</p><p id="ff24" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">更新程序后，我们需要生成 Test.h 头文件:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="d980" class="md kk hu mw b fv na nb l nc nd">&gt; javah Test</span></pre><p id="cae4" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">生成的头文件将包含我们的 C 程序的所有设置。我们的 Java 程序中有一个本地方法，这里我们有在头文件中生成的方法的方法声明:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="ba44" class="md kk hu mw b fv na nb l nc nd">/* DO NOT EDIT THIS FILE - it is machine generated */<br/>#include &lt;jni.h&gt;<br/>/* Header for class Test */</span><span id="15fd" class="md kk hu mw b fv nh nb l nc nd">#ifndef _Included_Test<br/>#define _Included_Test<br/>#ifdef __cplusplus<br/>extern "C" {<br/>#endif<br/>/*<br/> * Class:     Test<br/> * Method:    sum<br/> * Signature: (II)I<br/> */<br/><strong class="mw hv">JNIEXPORT jint JNICALL Java_Test_sum<br/>  (JNIEnv *, jobject, jint, jint);</strong></span><span id="12fc" class="md kk hu mw b fv nh nb l nc nd">#ifdef __cplusplus<br/>}<br/>#endif<br/>#endif</span></pre><p id="4425" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">我们需要一个函数的实现，所以创建 Test.c 文件并实现方法:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="c615" class="md kk hu mw b fv na nb l nc nd">#include "Test.h"</span><span id="5aba" class="md kk hu mw b fv nh nb l nc nd">JNIEXPORT jint JNICALL Java_Test_sum<br/>  (JNIEnv *env, jobject obj, jint a, jint b) {<br/>   return a + b;<br/>  }</span><span id="df71" class="md kk hu mw b fv nh nb l nc nd">void main() {}</span></pre><h2 id="3cb6" class="md kk hu bd kl me mf mg kp mh mi mj kt lj mk ml kx ll mm mn lb ln mo mp lf mq dt translated">编制</h2><p id="2fdf" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">将我们的 C 库编译成 Test.dll:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="3788" class="md kk hu mw b fv na nb l nc nd">&gt; cl -I"%JAVA_HOME%\include" -I"%JAVA_HOME%\include\win32" -LD Test.c -FeTest.dll</span></pre><h2 id="b1ff" class="md kk hu bd kl me mf mg kp mh mi mj kt lj mk ml kx ll mm mn lb ln mo mp lf mq dt translated">执行</h2><p id="57e2" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">如上所示重新编译我们的 Java 程序，并执行以查看它是否仍然工作:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="7f04" class="md kk hu mw b fv na nb l nc nd">&gt; java Test 3 4<br/>7</span></pre><h1 id="7580" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">装配</h1><h2 id="c160" class="md kk hu bd kl me mf mg kp mh mi mj kt lj mk ml kx ll mm mn lb ln mo mp lf mq dt translated">密码</h2><p id="3500" class="pw-post-body-paragraph jk jl hu jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">以前我们有 C 实现，看起来基本上和 java 一样:<code class="eh ne nf ng mw b">a + b</code>。当我们使用汇编时，我们是在一个较低的层次上工作，所以这样的小操作需要更多的代码。让我们更新我们的 C 程序以使用汇编语言——为此我们添加了<code class="eh ne nf ng mw b">__asm</code>块——它是 Visual C++的内联汇编程序。我们在那个块里面写指令。你可以看到我们将变量<code class="eh ne nf ng mw b">a</code>放入寄存器<code class="eh ne nf ng mw b">eax</code>，将变量<code class="eh ne nf ng mw b">b</code>放入寄存器<code class="eh ne nf ng mw b">ebx</code>。然后我们对寄存器的内容求和，并将其存储在<code class="eh ne nf ng mw b">eax</code>寄存器中(这就是<code class="eh ne nf ng mw b">add</code>命令的作用)。<br/>最后，我们将<code class="eh ne nf ng mw b">eax</code>寄存器的值存储在结果字段中:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="51de" class="md kk hu mw b fv na nb l nc nd">#include "Test.h"<br/>#include &lt;stdio.h&gt;</span><span id="3f39" class="md kk hu mw b fv nh nb l nc nd">JNIEXPORT jint JNICALL Java_Test_sum<br/>  (JNIEnv *env, jobject obj, jint a, jint b) {<br/>    int result;<br/>    __asm {<br/>        mov eax, a<br/>        mov ebx, b<br/>        add eax, ebx<br/>        mov result, eax<br/>    }<br/>    return result;<br/>}</span><span id="bb7f" class="md kk hu mw b fv nh nb l nc nd">void main() {}</span></pre><p id="86b9" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">重新编译 C 库(无需重新编译 Java 程序)并再次执行 Java 程序:</p><pre class="mr ms mt mu fq mv mw mx my aw mz dt"><span id="3a0e" class="md kk hu mw b fv na nb l nc nd">&gt; java Test 3 4<br/>7</span></pre><p id="eb51" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">所以，它起作用了。</p><p id="c078" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">希望你喜欢，也许今天学到了一些东西。如果不是，那么我希望至少它是有趣的。</p><p id="b673" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">编码快乐！</p><p id="099a" class="pw-post-body-paragraph jk jl hu jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated"><strong class="jn hv">参考文献</strong>:</p><div class="ni nj fm fo nk nl"><a href="https://docs.oracle.com/javase/7/docs/technotes/tools/windows/javac.html" rel="noopener  ugc nofollow" target="_blank"><div class="nm ab ej"><div class="nn ab no cl cj np"><h2 class="bd hv fv z el nq eo ep nr er et ht dt translated">Java 编程语言编译器</h2><div class="ns l"><h3 class="bd b fv z el nq eo ep nr er et ek translated">javac 工具读取用 Java 编程语言编写的类和接口定义，并将它们编译成…</h3></div><div class="nt l"><p class="bd b gc z el nq eo ep nr er et ek translated">docs.oracle.com</p></div></div></div></a></div><div class="ni nj fm fo nk nl"><a href="https://www.baeldung.com/jni" rel="noopener  ugc nofollow" target="_blank"><div class="nm ab ej"><div class="nn ab no cl cj np"><h2 class="bd hv fv z el nq eo ep nr er et ht dt translated">JNI 指南(Java 本地接口)| Baeldung</h2><div class="ns l"><h3 class="bd b fv z el nq eo ep nr er et ek translated">如果您在 Java 生态系统中有几年的经验，并且有兴趣与……</h3></div><div class="nt l"><p class="bd b gc z el nq eo ep nr er et ek translated">www.baeldung.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz ja nl"/></div></div></a></div><div class="ni nj fm fo nk nl"><a href="https://docs.microsoft.com/en-us/cpp/assembler/inline/inline-assembler?view=vs-2019" rel="noopener  ugc nofollow" target="_blank"><div class="nm ab ej"><div class="nn ab no cl cj np"><h2 class="bd hv fv z el nq eo ep nr er et ht dt translated">内嵌汇编程序</h2><div class="ns l"><h3 class="bd b fv z el nq eo ep nr er et ek translated">汇编语言有许多用途，如提高程序速度、减少内存需求和控制…</h3></div><div class="nt l"><p class="bd b gc z el nq eo ep nr er et ek translated">docs.microsoft.com</p></div></div></div></a></div></div></div>    
</body>
</html>