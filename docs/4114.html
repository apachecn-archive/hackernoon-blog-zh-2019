<html>
<head>
<title>Monitoring CI/CD Pipelines with Amazon EventBridge</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Amazon EventBridge 监控 CI/CD 管道</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/monitoring-ci-cd-pipelines-with-amazon-eventbridge-32177e2f2c3e#2019-07-13">https://medium.com/hackernoon/monitoring-ci-cd-pipelines-with-amazon-eventbridge-32177e2f2c3e#2019-07-13</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="02f7" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">Amazon EventBridge 是一个无服务器事件总线，它可以使用来自您自己的应用程序、软件即服务(SaaS)应用程序和 AWS 服务的数据轻松地将应用程序连接在一起。</p></blockquote><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff jt"><img src="../Images/ea071d6e4e453264e315277841de32da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6WU2y1Kq063oXtqvnJyoMw.jpeg"/></div></div></figure><p id="58ae" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">在这篇文章中，我将使用 CircleCI、CloudWatch 和 EventBridge 构建一个简单的解决方案来监控 React app 的 CI/CD 管道。</p><p id="3099" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">因此，综合所有因素，我采取了以下步骤:</p><ul class=""><li id="856d" class="ki kj hu ix b iy iz jc jd kf kk kg kl kh km js kn ko kp kq dt translated">创建 EventBridge 规则。</li><li id="bb83" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">创建一个 Lambda 函数来记录 CircleCI 事件。</li><li id="7c5d" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">将作业状态发送到 EventBus 的配置 CircleCI。</li></ul><h1 id="1e1d" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">先决条件</h1><p id="0bd9" class="pw-post-body-paragraph iu iv hu ix b iy lu ja jb jc lv je jf kf lw ji jj kg lx jm jn kh ly jq jr js hn dt translated">遵循本指南之前，必须完成以下工作:</p><ul class=""><li id="bd7b" class="ki kj hu ix b iy iz jc jd kf kk kg kl kh km js kn ko kp kq dt translated">设置 AWS 帐户</li><li id="fcae" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">安装<a class="ae lz" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a></li><li id="b29f" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">使用用户凭据配置 AWS CLI</li><li id="057c" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">设置一个<a class="ae lz" href="https://circleci.com" rel="noopener ugc nofollow" target="_blank"> CircleCI 账户</a></li></ul><h1 id="cbef" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">创建 AWS Lambda 函数</h1><p id="d8d0" class="pw-post-body-paragraph iu iv hu ix b iy lu ja jb jc lv je jf kf lw ji jj kg lx jm jn kh ly jq jr js hn dt translated">创建一个 Lambda 函数来记录 CircleCI 事件。在下一步中将此函数指定为 EventBridge 规则的目标。</p><p id="4630" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">lambda 函数应该是这样的:</p><pre class="ju jv jw jx fq ma mb mc md aw me dt"><span id="7bcd" class="mf kx hu mb b fv mg mh l mi mj">module.exports.circleciLog = async event =&gt; {<br/>  console.log(event);<br/>  return null;<br/>};</span></pre><p id="d831" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">更多详情，查看我们的官方<a class="ae lz" href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started-create-function.html" rel="noopener ugc nofollow" target="_blank">教程</a>这里。</p><h1 id="d5e2" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">使用自定义源创建 EventBridge 规则</h1><p id="46f5" class="pw-post-body-paragraph iu iv hu ix b iy lu ja jb jc lv je jf kf lw ji jj kg lx jm jn kh ly jq jr js hn dt translated">您可以从 Amazon <a class="ae lz" href="https://console.aws.amazon.com/events/home" rel="noopener ugc nofollow" target="_blank"> EventBridge 控制台创建规则。</a>在我们的例子中，我将使用<a class="ae lz" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>:</p><p id="d7e4" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">以下命令创建了一个带有自定义源<code class="eh mk ml mm mb b">circleci.myapp</code>的规则</p><pre class="ju jv jw jx fq ma mb mc md aw me dt"><span id="02b0" class="mf kx hu mb b fv mg mh l mi mj"><strong class="mb hv">$</strong>aws events put-rule --name "circleci.myapp" --event-pattern "{\"source\":[\"circleci.myapp\"]}"</span></pre><p id="5169" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">接下来，获取上一步创建的 lambda 函数<code class="eh mk ml mm mb b">circleci-log-dev-circleci</code>的 Arn，</p><pre class="ju jv jw jx fq ma mb mc md aw me dt"><span id="44c1" class="mf kx hu mb b fv mg mh l mi mj"><strong class="mb hv">$</strong>aws lambda get-function  --function-name circleci-log-dev-circleciLog --query Configuration.FunctionArn</span></pre><p id="2c39" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">复制 Arn，然后将目标添加到规则<code class="eh mk ml mm mb b">circleci.myapp</code>中。</p><pre class="ju jv jw jx fq ma mb mc md aw me dt"><span id="d9e6" class="mf kx hu mb b fv mg mh l mi mj"><strong class="mb hv">$</strong>aws events put-targets --rule circleci.myapp --targets "Id"="1","Arn"="<em class="iw">arn:aws:lambda:</em><strong class="mb hv"><em class="iw">REGION</em></strong><em class="iw">:</em><strong class="mb hv"><em class="iw">ACCOUNTID</em></strong><em class="iw">:function:circleci</em>-log-dev-circleciLog"</span></pre><p id="ec46" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">好了，完成了！让我们创建 CircleCI 配置并将项目推送到 Github。</p><h1 id="7086" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">配置 CircleCI</h1><p id="5e67" class="pw-post-body-paragraph iu iv hu ix b iy lu ja jb jc lv je jf kf lw ji jj kg lx jm jn kh ly jq jr js hn dt translated">CircleCI 配置存储在位于<code class="eh mk ml mm mb b">~/.circleci/config.yml</code>的单个 YAML 文件中，更多详情，请点击查看<a class="ae lz" href="https://circleci.com/docs/2.0/writing-yaml/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="a962" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">在配置中，CircleCI 运行以下命令将自定义事件发送到 EventBridge，以便它们可以与规则匹配:</p><pre class="ju jv jw jx fq ma mb mc md aw me dt"><span id="5228" class="mf kx hu mb b fv mg mh l mi mj">aws events put-events --entries '[{ "Source": "circleci.myapp", "DetailType": "CircleCI state change", "Detail": "{ \"app\": \"myapp\", \"type\": \"fail\" }"}]'</span></pre><p id="d8f9" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated"><code class="eh mk ml mm mb b">config.yml</code>应该是这样的:</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="mn mo l"/></div></figure><h1 id="0f52" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">一切准备就绪，尝试一下吧！</h1><ul class=""><li id="8a89" class="ki kj hu ix b iy lu jc lv kf mp kg mq kh mr js kn ko kp kq dt translated">将提交推送到远程存储库主分支。</li><li id="74db" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">打开亚马逊 CloudWatch 控制台。</li><li id="a3d1" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">在导航窗格中，选择<strong class="ix hv">日志</strong>，过滤<code class="eh mk ml mm mb b"><a class="ae lz" href="https://ap-southeast-2.console.aws.amazon.com/cloudwatch/home?region=ap-southeast-2#logStream:group=/aws/lambda/circleci-log-dev-circleciLog" rel="noopener ugc nofollow" target="_blank">/aws/lambda/circleci-log-dev-circleciLog</a></code>。</li></ul><p id="1b40" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">下面是日志的样子:</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff ms"><img src="../Images/9a311f38b4bb940063b97263dd518ded.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aMwVZA50gn7cA7UAjZrocg.png"/></div></div></figure><h1 id="f3d9" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">创建自定义 CloudWatch 指标来监控 Lambda 日志</h1><p id="27e3" class="pw-post-body-paragraph iu iv hu ix b iy lu ja jb jc lv je jf kf lw ji jj kg lx jm jn kh ly jq jr js hn dt translated">这是一个可选的步骤，我发现它真的很有用，因为它允许我监视 Lambda 日志中的特定字符串，并在发现时发送警报。</p><ul class=""><li id="df56" class="ki kj hu ix b iy iz jc jd kf kk kg kl kh km js kn ko kp kq dt translated">转到您的 CloudWatch 控制台。</li><li id="436d" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">选中 lambda 日志组旁边的复选框，单击“创建度量过滤器”。</li></ul><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff mt"><img src="../Images/88c360586fc678d1f8ff63ae5b8f8d2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QQrQj5KUGRjkGgiNZ9j1CA.png"/></div></div></figure><ul class=""><li id="32bc" class="ki kj hu ix b iy iz jc jd kf kk kg kl kh km js kn ko kp kq dt translated">在过滤模式中输入类似“失败”的内容。单击“分配指标”。</li></ul><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff mu"><img src="../Images/d60ed0bd4d01e5a6223fa28193f6ce80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lkbBFjG3rgZV7nSqquYHmA.png"/></div></div></figure><ul class=""><li id="6229" class="ki kj hu ix b iy iz jc jd kf kk kg kl kh km js kn ko kp kq dt translated">输入此指标的名称(此名称稍后可用于设置警报)。</li><li id="1a8c" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">点击“创建过滤器”。</li><li id="0a1f" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">转到“警报”部分。</li><li id="ec2c" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">点击“创建警报”。</li><li id="3437" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">在指标类别列表的底部，找到“自定义指标”下拉列表，并选择“记录指标”。</li><li id="4a0c" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">找到并选择您的指标名称，单击“下一步”。</li><li id="1f17" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">选择一个合理的时间段，然后选择“总和”作为统计值。</li><li id="237c" class="ki kj hu ix b iy kr jc ks kf kt kg ku kh kv js kn ko kp kq dt translated">设置当指标在 1 个周期内" &gt; 0 "时触发的警报。</li></ul><p id="9533" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">差不多就是这样！希望你觉得这篇文章有用，你可以在我的<a class="ae lz" href="https://github.com/yai333/Monitoring-CI-CD-Pipelines-with-Amazon-EventBridge" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hv"> GitHub repo </strong> </a>中找到完整的项目。</p></div></div>    
</body>
</html>