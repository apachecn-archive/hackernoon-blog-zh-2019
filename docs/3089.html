<html>
<head>
<title>Building a web app in Python to visualise Google My Business Discovery data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python构建一个web应用程序来可视化Google我的业务发现数据</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-a-web-app-to-visualise-google-my-business-discovery-data-4d7c7f510e6?source=collection_archive---------9-----------------------#2019-05-16">https://medium.com/hackernoon/building-a-web-app-to-visualise-google-my-business-discovery-data-4d7c7f510e6?source=collection_archive---------9-----------------------#2019-05-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/ba09475591425b58ca0974c2aa82f00d.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*F5gm9Q0ABcBgc5FEESs7gA.png"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">Source: Memegenerator</figcaption></figure><p id="065c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">数据可视化是分析过程中不可或缺的一部分，它使您能够以一种易于与所有业务部门沟通的方式讲述您的数据故事，并让您了解您的业务的不同方面是如何表现的。它类似于一部电影；有时候，传达信息的最佳方式是通过视觉上吸引人的调制解调器，它能够抓住人们的注意力并增加回忆。</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="fe ff ka"><img src="../Images/d274a5e9abab11d16c10e3ce850b8037.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XiNJgDYf9uJoJC_fPj8jaA.jpeg"/></div></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">Inaccurate information</figcaption></figure><p id="bd88" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">不言而喻，与上面的图像不同，产生的可视化必须准确，特别是如果这些可视化为用于指导商业和营销决策的报告提供信息。</p><p id="41dd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最近，我签约为一家大银行的一个部门做一些分析工作。当我失望地发现他们实际上并没有在大楼里存放大量现金时，我发现这项工作非常有趣。我必须完成的任务之一是开发报告，以可视化数字营销数据。其中一份报告，没有透露太多，涉及从谷歌我的业务(GMB)可视化数据。</p><p id="c482" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">根据此任务，让我们创建一个场景。假设你在一家大公司工作，在一个国家/世界有多个分支机构。所有的实体分支机构都在GMB上市，因为你想让人们轻松找到你的分支机构，你想从执行与你的行业相关的搜索查询的人那里吸引潜在的新客户。每个月，您都希望获得与您的分支机构相关的搜索、操作和查看的摘要，例如:地图总浏览量、总操作数、总浏览量、最高浏览位置和按用户执行的搜索和操作排名的前10个位置。你或许可以在Excel、Google Data Studio和Tableau上创建这些可视化效果，但是为了这篇博客，我决定使用Flask创建一个web应用程序，允许用户上传从GMB提取的discovery CSV，清理CSV并只需点击一下就可以创建可视化效果。</p><p id="0795" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我从未在Python上创建过网络应用，所以我满足于使用<a class="ae kj" href="http://flask.pocoo.org/" rel="noopener ugc nofollow" target="_blank"> flask </a>,因为根据我的研究，它似乎相对容易理解。</p><p id="be11" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">为app创建文件夹</strong></p><p id="95bd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">烧瓶文档有一个非常简单易懂的教程，教你如何设置虚拟环境和安装依赖项来启动项目。第一步包括在我的Jupyter终端上创建项目文件夹和虚拟环境(我的默认shell是bash)。设置并激活我的虚拟环境后，我继续创建requirements.txt文件。这个文件包含了运行我的应用程序需要安装的所有库。这背后的想法是允许另一个想要与我的应用程序交互的最终用户在他/她的机器上重新创建虚拟环境以及应用程序运行所需的库。</p><pre class="kb kc kd ke fq kk kl km kn aw ko dt"><span id="706e" class="kp kq hu kl b fv kr ks l kt ku">#requirements.txt </span><span id="99fa" class="kp kq hu kl b fv kv ks l kt ku">Flask==0.12.3<br/>click==6.7<br/>gunicorn==19.7.1<br/>itsdangerous==0.24<br/>Jinja2==2.9.6<br/>MarkupSafe==1.0<br/>pytz==2017.2<br/>requests==2.13.0<br/>Werkzeug==0.12.1<br/>pandas==0.23.0<br/>matplotlib==1.4.2<br/>numpy=1.8.2</span></pre><p id="041e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">需求文件创建在我刚刚创建的同一个文件夹中。创建这个文件后，我使用pip安装了需求文件中列出的库。</p><pre class="kb kc kd ke fq kk kl km kn aw ko dt"><span id="1a44" class="kp kq hu kl b fv kr ks l kt ku">pip install -r requirements.txt</span></pre><p id="c57d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">构建网络应用</strong></p><p id="ce63" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">加载相关库后。第一步是允许用户上传报告。</p><pre class="kb kc kd ke fq kk kl km kn aw ko dt"><span id="c4c2" class="kp kq hu kl b fv kr ks l kt ku">UPLOAD_FOLDER = ‘./Downloads/gmbreports’<br/>if not os.path.exists(UPLOAD_FOLDER):<br/> os.makedirs(UPLOAD_FOLDER)<br/> <br/>ALLOWED_EXTENSIONS = ‘csv’<br/>app = Flask(__name__)<br/>app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER<br/>def allowed_file(filename):<br/>    return '.' in filename and \<br/>           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS</span></pre><p id="2b1c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用这段代码，我将允许上传的文件限制为CSV格式的文件，并指定上传的文件将保存在本地机器的downloads/gmbreports文件夹下。我添加了一个条件，如果路径不存在，就必须创建它。</p><p id="4066" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，我为我的web应用程序创建了Flask类的实例，这“启动”了我的flask web应用程序。</p><p id="6464" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">界面</strong></p><p id="dafa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">由于该应用程序的目的是以CSV的形式接收输入并生成报告，我创建了一个功能，提示用户上传CSV。</p><pre class="kb kc kd ke fq kk kl km kn aw ko dt"><span id="40e0" class="kp kq hu kl b fv kr ks l kt ku"><a class="ae kj" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods=['GET', 'POST'])<br/>def upload_file():<br/>    if request.method == 'POST':<br/>        if 'file' not in request.files:<br/>            flash('No file part')<br/>            return redirect(request.url)<br/>        file = request.files['file']<br/>        if file.filename == '':<br/>            flash('You need to upload a csv file')<br/>            return redirect(request.url)<br/>        if file and allowed_file(file.filename):<br/>            filename = secure_filename(file.filename)<br/>            file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))<br/>            return redirect(url_for('uploaded_file',<br/>                                    filename=filename))<br/>    return '''<br/>    &lt;!doctype html&gt;<br/>    &lt;title&gt;Google My Business Discovery Report Builder&lt;/title&gt;<br/>    &lt;h1&gt;Google My Business Discovery Report Builder&lt;/h1&gt;<br/>    &lt;p&gt;This web app allows you to build a report based on the discovery csv extracted from your Google My Business Account, giving you visualisations about the volume of searches and actions carried out based on each location of your branch listed on Google My Business.&lt;/p&gt;<br/>    &lt;form action="/transform" method="post" enctype="multipart/form-data"&gt;<br/>      &lt;p&gt;&lt;input type="file" name="file"&gt;<br/>         &lt;input type="submit" value=Visualise&gt;<br/>    &lt;/form&gt;<br/>    '''</span></pre><p id="2039" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我的代码中的@app.route部分是一个装饰器，它告诉flask应该触发upload_file函数运行的URL。此函数检查上传的文件是否为允许的格式(CSV)，将文件保存在指定的文件夹中，并返回带有我的应用程序前端界面的HTML。</p><p id="9175" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">HTML本质上是一个上传表单，它运行一个我命名为transform的函数。该函数清理CSV文件，并根据文档中的数据创建可视化效果。</p><h2 id="f678" class="kp kq hu bd kw kx ky kz la lb lc ld le jn lf lg lh jr li lj lk jv ll lm ln lo dt translated">清理和创建可视化的功能</h2><p id="e184" class="pw-post-body-paragraph jc jd hu je b jf lp jh ji jj lq jl jm jn lr jp jq jr ls jt ju jv lt jx jy jz hn dt translated">由于这个应用程序的核心功能是从GMB提取一个特定格式的CSV，清理它并返回大约8个基于显示数据的可视化，我的下一步涉及创建“主函数”来执行这个转换</p><pre class="kb kc kd ke fq kk kl km kn aw ko dt"><span id="5354" class="kp kq hu kl b fv kr ks l kt ku">def transform():<br/> disc = open(‘clean.csv’)<br/> disc2 = open(‘clean_two.csv’,’w’)<br/> #cleaning up csv<br/> for row in disc:<br/> row = row.strip()<br/> row = row[1:-1]<br/> row = row.replace(‘“”’,’”’)<br/> disc2.write(row+’\n’)<br/> disc2.close()<br/> disc.close()<br/> discovery = pd.read_csv(‘clean_two.csv’)<br/> discovery_clean = discovery.iloc[1:]<br/> cols = list(discovery_clean.columns[4:])<br/> discovery_clean[cols] = discovery_clean[cols].apply(pd.to_numeric,errors=’coerce’)</span></pre><p id="0c42" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最初，CSV在一行中返回的应该是许多列(没有划分为列)，但是，一个共同的特征是每个列名都用双引号括起来。为了清理这个问题，我将双引号转换为单引号——这样我可以利用pd.read_csv将引号中的每个文本作为列名读取，然后将每个新行作为列下的一行。</p><p id="e3e9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">作为清理的一部分，我删除了出现在第二行中的值，因为这些值不能归类为列或归属于每列的值，这些是列的描述。</p><pre class="kb kc kd ke fq kk kl km kn aw ko dt"><span id="4b49" class="kp kq hu kl b fv kr ks l kt ku">with PdfPages('plots.pdf') as pdf:<br/>        #first figure<br/>        plt.figure(figsize=(20,10))<br/>        ax = discovery_clean[cols].sum().plot.bar(figsize=(20,10))<br/>        ax.axes.get_yaxis().set_visible(False)<br/>        ax.set_title('Overview\n',fontsize='15',color='black')<br/>        ax.xaxis.set_tick_params(labelsize=15)<br/>        for x in ax.patches:<br/>            ax.text(x.get_x()-.09,x.get_height()+20,\<br/>            f'{int(x.get_height()):,}',fontsize=15,color='black')<br/>        plt.rcParams['figure.figsize']=(20,10)<br/>        pdf.savefig(bbox_inches='tight')<br/>        plt.close()</span></pre><p id="f2ef" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">继续转换功能，我希望可视化以pdf格式返回，每个可视化创建自己的页面。使用<a class="ae kj" href="https://matplotlib.org/gallery/misc/multipage_pdf.html" rel="noopener ugc nofollow" target="_blank"> PdfPages </a>函数，我创建了包装器/框架来创建多个pdf页面，并开始创建一个可视化的摘要，总结了在该文档所代表的时间段内GMB所有地点所执行的关键操作。</p><pre class="kb kc kd ke fq kk kl km kn aw ko dt"><span id="f5d9" class="kp kq hu kl b fv kr ks l kt ku">plt.figure(figsize=(16,8))<br/>mpl.rcParams['font.size'] = 12<br/>disc_plot = discovery_clean.groupby('Business name')['Total views'].sum().nlargest(10)<br/>labels = list(disc_plot.index)<br/>nums = (disc_plot.values).astype(int)<br/>def actual_nums(vals):<br/>    a = np.round(vals/100.*nums.sum())<br/>    return a<br/>explode = []<br/>for v in nums:<br/>    if v == max(nums):<br/>        explode.append(0.3)<br/>    else:<br/>        explode.append(0)<br/>plt.pie(nums,labels=labels,autopct=actual_nums,explode=explode,radius=0.50)<br/>plt.tight_layout()<br/>plt.title("Top 10 views per location\n",fontsize=15,color='black')<br/>plt.axis('equal')<br/>pdf.savefig(bbox_inches='tight')<br/>plt.close()</span></pre><p id="fd16" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">第二个可视化返回一个饼图，显示具有最高浏览量的前几个位置，并展开具有最大值的饼图。因为饼图默认返回百分比，所以我创建了一个函数来将百分比转换成相应的数字。我确保以这样一种方式来调整这个图表和后续图表的大小，以便将它们保存为pdf，每个图表都是一页，不会被切断。</p><p id="ff9e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">创建报告</strong></p><p id="9036" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我的报告中总共创建了8个图表。</p><pre class="kb kc kd ke fq kk kl km kn aw ko dt"><span id="e003" class="kp kq hu kl b fv kr ks l kt ku"><a class="ae kj" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/transform',methods=["POST"])<br/>def transform_view():<br/>    request_file=request.files['file']<br/>    request_file.save('clean.csv')<br/>    if not request_file:<br/>        return "No file"<br/>    result = transform()<br/>    print(result)    <br/>    return send_file('plots.pdf', as_attachment=True)</span></pre><p id="b2b8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我想要的一件事是将报告保存为pdf格式，并保存为附件，当我在web应用程序上按下上传按钮时，它会自动下载。将as_attachment设置为true允许我的函数将我的报告保存为附件，并在报告创建后下载到我的本地机器上。</p><p id="cec2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">输出样本</strong></p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="fe ff lu"><img src="../Images/72688a7c5fd39bf7eb37b9f2fdd3c116.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DFCqUEZWs-GmzN86Q-EjAw.png"/></div></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">Running the app on bash</figcaption></figure><p id="a439" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">通过引用文件名(main.py)在bash上运行应用程序会产生一个到web应用程序的链接，单击链接my browser会打开web应用程序。</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="fe ff lv"><img src="../Images/4afd03b2b8afa2182218dd1e6fea3fc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YWFdUTxki6IhGwP45etAsA.png"/></div></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">Google My Business Discovery Report Builder web -app</figcaption></figure><p id="0a13" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">没有向应用程序添加任何CSS，这将返回相对简单的web应用程序，我可以上传从Google My Business提取的discovery CSV文件，并创建带有摘要可视化的报告。</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="fe ff lw"><img src="../Images/1dd32edd74c69d522521dab6a891ca4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QVyuqg_dC0G-LAMvPJfxuA.png"/></div></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">Summary of Google My Business searches and actions</figcaption></figure><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="fe ff lx"><img src="../Images/7ffa142b2449bf350615d3f908ec79db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZYB8JgCuu4raGeKIihcxgA.png"/></div></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">Top 10 locations based on Google My Business Views</figcaption></figure><p id="f1fe" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该功能生成的输出是一个易于理解和生成的报告，消除了每次从Google My Business提取discovery CSV时生成新的可视化内容的需要。</p><p id="afab" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">鳍。</p></div><div class="ab cl ly lz hc ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="hn ho hp hq hr"><p id="535e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">欢迎提出任何评论和批评，或者关注我那些没有争议的推文。</p></div></div>    
</body>
</html>