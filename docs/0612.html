<html>
<head>
<title>How we built a real-time in-game currency service with 7.5M transactions per minute</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何构建每分钟750万笔交易的实时游戏内货币服务</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-we-built-a-real-time-in-game-currency-service-with-7-5m-transactions-per-minute-375ebf0cc34a?source=collection_archive---------12-----------------------#2019-01-25">https://medium.com/hackernoon/how-we-built-a-real-time-in-game-currency-service-with-7-5m-transactions-per-minute-375ebf0cc34a?source=collection_archive---------12-----------------------#2019-01-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="2480" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于我们这些在<a class="ae jp" href="https://getloconow.com" rel="noopener ugc nofollow" target="_blank"> Loco </a>的技术人员来说，没有什么比致力于前沿解决方案、使用新产品和解决在StackOverflow上没有解决方案的问题更令人兴奋的了。最近，我们遇到了一个这样的问题，并发现了一种这样的<a class="ae jp" href="https://hackernoon.com/tagged/technology" rel="noopener ugc nofollow" target="_blank">技术</a>来解决它。</p><p id="7284" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们围绕<a class="ae jp" href="https://tarantool.org" rel="noopener ugc nofollow" target="_blank"> Tarantool </a>，一个高性能<a class="ae jp" href="https://hackernoon.com/tagged/database" rel="noopener ugc nofollow" target="_blank">数据库</a>，设计了我们新的高性能交易货币服务。它作为我们的SSOT(真实的单一来源)数据库来发布一个新的特性。</p><h2 id="314a" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">为什么我们会想到塔兰图尔？</h2><p id="7ebc" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">我们必须建立一个游戏中的货币交易系统，要求至少15万并发用户实时获得硬币。用户应该能够使用硬币，只要他们得到它。对于我们来说，<em class="kq">实时</em>就是<em class="kq"> ~300ms </em>。对于<strong class="it hv">所有</strong>我们的用户，所有<strong class="it hv"> 150K并发用户</strong>。</p><p id="d197" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">解决这个问题的一个方法是使用Redis。将其用作NoSQL数据库的直写缓存。这很快就会变得痛苦。我们必须保持一致性，处理竞争情况，处理缓存失效、驱逐、过期等。</p><p id="e2a1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kq">耐用性</em> — Redis专注于具有定期快照功能的内存处理。但是Tarantool有全面的WAL日志和快照，我们不需要管理；不像Redis。</p><p id="efde" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kq">原子性</em> —没有一种简单的方法可以跨Redis和后台NoSQL数据库执行原子操作。这意味着在这个解决方案中没有SSOT ( <em class="kq">真理的单一来源</em>)。</p><p id="29f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还有一大堆其他问题。</p><p id="9d90" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">听起来很简单，对吗？仅仅是每秒几十万次数据库事务。</p><p id="7efe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kq">什么？你说没有？</em></p><h2 id="9294" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">塔兰图尔是如何解决我们的问题的</h2><p id="6041" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">Tarantool是一个全面的NoSQL数据库，内置了Lua应用服务器、事务、存储过程和真正的持久性。</p><p id="72b2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Tarantool提供了两种存储引擎:Memtx(内存存储引擎)和Vinyl(磁盘存储引擎)。这两个引擎都提供了可靠的ACID事务。</p><p id="489e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当MemTx崩溃时，MemTx使用WAL(预写日志)和快照来满足一致性。</p><p id="ec31" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它可以有任意数量的二级索引。</p><p id="e8d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它支持Lua中的服务器端脚本，用于批处理操作之类的操作，这本身就是一个很好的特性。</p><p id="617b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="kq"> Tarantool拥有超快的CRUD运算</em> </strong></p><p id="41d7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kq">它通过在单线程上使用纤程执行事务来实现这一点。</em></p><p id="e3cd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kq">这是什么意思？</em></p><p id="3389" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">没有多个线程同时在数据库上运行。纤维是一种轻质线。事务处理器线程将执行纤程中的所有指令，直到发生让步，然后继续执行另一条指令。纤维被期望使用<em class="kq">合作多任务</em>来防止饥饿<em class="kq">。</em>此外，所有IO任务(磁盘、网络等。)触发隐性屈服。开发人员在大多数情况下不需要担心纤程。</p><figure class="ks kt ku kv fq kw fe ff paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="fe ff kr"><img src="../Images/5a526e65c2a840ddef8a8924f0d49648.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cw5Jtm0a6YRRJMPe0ZIerQ.jpeg"/></div></div></figure><h2 id="a965" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">这东西有多快？</h2><p id="ab16" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">我们的目标是用5秒钟跑完50万公里。</p><p id="f9da" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="kq">我们使用Memtx在3.6秒内完成了这项工作！</em></strong>3.6秒50万交易！</p><p id="52b7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请记住，这是针对所有事务的完整ACID属性。</p><p id="e2f8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">越来越好了。对我们来说，一个事务有一个写操作和一个更新操作。</p><p id="9906" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Tarantool一开始完全是一个实验。我们意识到了风险。我们成功了，并获得了良好的基准测试结果。而且，现在已经投入生产了！</p><p id="d0d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="kq">优点</em> </strong>:</p><ol class=""><li id="616d" class="ld le hu it b iu iv iy iz jc lf jg lg jk lh jo li lj lk ll dt translated">极快</li><li id="0d3c" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">服务器端自定义Lua函数(我们可以减少批处理操作的网络调用)</li><li id="4cd2" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">单线程(Tarantool中只有一个事务处理器线程)</li><li id="eded" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">一个持久的内存数据库(Memtx)</li><li id="7e06" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">服务器管理(<em class="kq"> tarantoolctl </em>实用程序)</li><li id="281a" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">数据库分片(V <a class="ae jp" href="https://github.com/tarantool/vshard" rel="noopener ugc nofollow" target="_blank"> shard </a>)和复制</li><li id="d287" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">乙烯基磁盘存储可以很好地替代NoSQL数据库</li><li id="bd49" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated"><a class="ae jp" href="https://t.me/tarantool" rel="noopener ugc nofollow" target="_blank"> Tarantool电报组支持</a>(原Tarantool开发人员在此组上响应)</li></ol><p id="7cf0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="kq">缺点</em> </strong>:</p><ol class=""><li id="20df" class="ld le hu it b iu iv iy iz jc lf jg lg jk lh jo li lj lk ll dt translated">基础设施(如果您正在试用Community edition，您需要自己管理快照的实例、分片和定期备份。)</li><li id="a463" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">不是一个很大的社区。任何问题都要依靠他们的电报组。</li><li id="4929" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">AWS或Azure等云平台不提供(AWS marketplace中存在旧版本。)所以我们必须为Tarantool实例构建自己的监控系统。</li></ol><p id="d3c5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Tarantool企业版具有解决这里列出的一些缺点的功能。但是它不是免费的。</p><p id="10bc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你应该开始使用Tarantool吗？</p><p id="9f43" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是一个百万美元的问题。在某些情况下，确实如此。</p><p id="5dee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">问自己这些问题:</p><ol class=""><li id="a53a" class="ld le hu it b iu iv iy iz jc lf jg lg jk lh jo li lj lk ll dt translated">你真的需要一个快速处理的数据库吗？这是面向用户的关键需求吗？</li><li id="b023" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">最终一致性对您的场景不起作用吗？</li><li id="7016" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">您是否已经计划在另一个数据库之前使用Redis/cache层？</li><li id="91f3" class="ld le hu it b iu lm iy ln jc lo jg lp jk lq jo li lj lk ll dt translated">您是否愿意管理通常由云平台支持的所有基础架构需求？</li></ol><p id="f7d6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你的答案是肯定的，那么是的！马上选择塔兰图尔。也许你可以用小微服务试试，然后做大！！！</p><p id="6aa5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就我个人而言，我们真的很喜欢Tarantool。投产三个月，都没有什么大问题！</p></div><div class="ab cl lr ls hc lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hn ho hp hq hr"><p id="2bd5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kq">要想每天赢得现金，玩Loco吧！</em> <a class="ae jp" href="https://getloconow.onelink.me/eQ3k/loco" rel="noopener ugc nofollow" target="_blank"> <em class="kq">现在就下载</em> </a> <em class="kq">这个app吧。</em></p><figure class="ks kt ku kv fq kw"><div class="bz el l di"><div class="ly lz l"/></div></figure></div></div>    
</body>
</html>