<html>
<head>
<title>Configuring Multiple Node Pools in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS中配置多个节点池</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/configuring-multiple-multiple-node-pools-b2509641ac82?source=collection_archive---------19-----------------------#2019-01-17">https://medium.com/hackernoon/configuring-multiple-multiple-node-pools-b2509641ac82?source=collection_archive---------19-----------------------#2019-01-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="b82b" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">根据您的部署需求定制EC2</p></blockquote><p id="ecd5" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">想象一下这个场景。你有一些小而简单的微服务。它们都可以在200mb内存上完美运行，并且可以立即扩展。工程幸福。但是，等待…在这蓝色的天空中，风景中的一道伤疤，隐藏着一个预兆。一块巨石形状的风暴云。您需要让这个庞然大物在您的Kubernetes集群中运行，但是它比您的其他应用程序要大得多。用互联网的话说，“wut do？”</p><figure class="jx jy jz ka fq kb fe ff paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="fe ff jw"><img src="../Images/884cd1e054af6359fcab8a9d250c0a0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FVDKvmS1aHdlbnZ4"/></div></div><figcaption class="ki kj fg fe ff kk kl bd b be z ek">Your cluster is gonna need some guns of steel.</figcaption></figure><h2 id="df30" class="km kn hu bd ko kp kq kr ks kt ku kv kw jt kx ky kz ju la lb lc jv ld le lf lg dt translated">你的微服务EC2实例类型够吗？</h2><p id="1a2a" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf jt lj ji jj ju lk jm jn jv ll jq jr js hn dt translated">你的微服务可以装进小盒子里，但你的整体需要一些果汁。在单个实例中根本没有足够的能力将您的应用程序作为一个pod来运行。纯粹主义者会告诉你“那么，将其重构为微服务”。现实并不总是非黑即白的。</p><h2 id="d812" class="km kn hu bd ko kp kq kr ks kt ku kv kw jt kx ky kz ju la lb lc jv ld le lf lg dt translated">所以你把所有东西都放在大箱子里吗？</h2><p id="3ca2" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf jt lj ji jj ju lk jm jn jv ll jq jr js hn dt translated">您的第一个目标可能是重新评估一切—耗尽现有节点并部署到更大的机器上。这样，您就不需要运行多个节点池。这能行！但这是有代价的。集群中浪费资源的可能性更大。更大的盒子意味着你更有可能有未被充分利用的实例，从而浪费你的钱。</p><h2 id="645e" class="km kn hu bd ko kp kq kr ks kt ku kv kw jt kx ky kz ju la lb lc jv ld le lf lg dt translated">好的，那么我可以有多种节点类型吗？</h2><p id="05da" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf jt lj ji jj ju lk jm jn jv ll jq jr js hn dt translated">你可以的，你这个幸运的家伙。这很简单，只需要几个步骤。出于本教程的考虑，我将假设您熟悉Kubernetes的概念，如<code class="eh lm ln lo lp b">pod</code>或<code class="eh lm ln lo lp b">node</code>。如果你不是，你应该通读一下<a class="ae lq" href="https://kubernetes.io/docs/concepts/workloads/pods/pod/" rel="noopener ugc nofollow" target="_blank"> Kubernetes文档</a>。此外，我假设您熟悉AWS术语，如Autoscaling Group (ASG)和EC2。如果你不是，<a class="ae lq" href="https://aws.amazon.com/ec2/" rel="noopener ugc nofollow" target="_blank">请先通读AWS文档</a>。为了简洁和清晰起见，我将不包括对IAM角色和安全组的更改。官方文件包含了这些细节。</p><h2 id="9df9" class="km kn hu bd ko kp kq kr ks kt ku kv kw jt kx ky kz ju la lb lc jv ld le lf lg dt translated">好吧！集群自动缩放器</h2><p id="a3b6" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf jt lj ji jj ju lk jm jn jv ll jq jr js hn dt translated">你首先需要连接的是<a class="ae lq" href="https://github.com/kubernetes/autoscaler" rel="noopener ugc nofollow" target="_blank">集群自动缩放器</a>。这有一个特定于AWS的安装模式。它将检测EC2实例中何时没有空闲空间来部署pod，此时它将增加ASG中EC2实例的数量。它的工作原理是调整ASG中的“所需”字段，直到达到您设置的预定义最大值。我不会在这里详细讨论安装，因为文档非常好。当您按照这些说明操作时，请确保将其设置为“自动发现”。这样，当您添加新的ASG时，它会检测到它们，而您不需要重新配置您的集群。</p><h2 id="d95c" class="km kn hu bd ko kp kq kr ks kt ku kv kw jt kx ky kz ju la lb lc jv ld le lf lg dt translated">接下来，你的自动缩放组</h2><p id="4088" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf jt lj ji jj ju lk jm jn jv ll jq jr js hn dt translated">旋转ASG是非常简单的。为了举例，我们将使用Terraform。在下面的代码片段中，我们将创建一个自动缩放组和一个运行配置。运行配置是ASG在构建新的EC2实例时应该使用的模板。这里有一些关键的东西需要注意。</p><ol class=""><li id="7678" class="lr ls hu ix b iy iz jc jd jt lt ju lu jv lv js lw lx ly lz dt translated">我们将忽略对<code class="eh lm ln lo lp b">desired_capacity</code>的更改。这是因为群集自动缩放器将使用该值来缩放群集。我们不想每次做一个<code class="eh lm ln lo lp b">terraform apply</code>就把它重置回2。</li><li id="459e" class="lr ls hu ix b iy ma jc mb jt mc ju md jv me js lw lx ly lz dt translated">有两个突出显示的标记键。<code class="eh lm ln lo lp b">k8s.io/cluster-autoscaler/enabled</code><strong class="ix hv">是强制的</strong>以确保集群自动缩放器可以检测你的自动缩放组。第二，<code class="eh lm ln lo lp b">k8s.io/cluster-autoscaler/cluster_name</code>不是强制性的，但是如果您正在运行多个集群，这是一个好主意。这将防止两个集群获得相同的ASG。</li></ol><pre class="jx jy jz ka fq mf lp mg mh aw mi dt"><span id="2c3e" class="km kn hu lp b fv mj mk l ml mm">resource "aws_autoscaling_group" "worker_node_asg" {<br/>    desired_capacity = 2<br/>    max_size         = 10<br/>    min_size         = 1<br/>    name_prefix      = "worker-node-"<br/>    lifecycle {<br/>         ignore_changes = ["desired_capacity"]<br/>    }<br/>    tag {<br/>        key = "Name"<br/>        value = "worker-node"<br/>        propagate_at_launch = true<br/>    }<br/>    tag {<br/>        key = "k8s.io/cluster-autoscaler/enabled"<br/>        value = "true"<br/>        propagate_at_launch = true<br/>    }<br/>    tag {<br/>        key = "k8s.io/cluster-autoscaler/cluster_name" <br/>        value = "true"<br/>        propagate_at_launch = true<br/>    }<br/>}</span></pre><p id="59ec" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">以及您的ASG的启动配置(模板)。注意以粗体突出显示的<code class="eh lm ln lo lp b">instance_type</code>字段。</p><pre class="jx jy jz ka fq mf lp mg mh aw mi dt"><span id="8d1b" class="km kn hu lp b fv mj mk l ml mm">resource "aws_launch_configuration" "worker_launch_configuration" {<br/>    image_id             = "${data.aws_ami.worker_ami.id}"<br/>    instance_type        = "t2.medium"<br/>    name_prefix          = "worker-node-"<br/>    security_groups      = ["${some_security_group_ID}"]<br/>    create_before_destroy = true<br/>}</span></pre><p id="9628" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">为您想要创建的每个EC2实例类型创建这个基础设施。我们假设，从现在开始，您已经为两种不同的实例类型做了两次。</p><h2 id="1bdd" class="km kn hu bd ko kp kq kr ks kt ku kv kw jt kx ky kz ju la lb lc jv ld le lf lg dt translated">让我们让豆荚更挑剔</h2><p id="1747" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf jt lj ji jj ju lk jm jn jv ll jq jr js hn dt translated">你的豆荚此刻相当悠闲——当它们被扔向k8s api时，它们叹息着说“哦，把我放在任何地方都行”。我们需要给他们一点选择的余地，我们可以用<strong class="ix hv">节点选择器</strong>做到这一点。这将允许pod指定它想要运行的节点类型。</p><h2 id="8c19" class="km kn hu bd ko kp kq kr ks kt ku kv kw jt kx ky kz ju la lb lc jv ld le lf lg dt translated">找到你的标签</h2><p id="c751" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf jt lj ji jj ju lk jm jn jv ll jq jr js hn dt translated">如果您运行<code class="eh lm ln lo lp b">kubectl get node -o yaml</code>，您将看到一些EC2实例。寻找<code class="eh lm ln lo lp b">beta.kubernetes.io/instance-type</code>标签，这将让您知道EC2实例类型是什么。您可以在您的资源yaml中使用它来选择您希望您的应用程序部署到哪个盒子。还有其他方法可以做到这一点，不会用AWS特有的东西污染您的yaml一如既往，要小心。一个简单的例子yaml可能是这样的:</p><pre class="jx jy jz ka fq mf lp mg mh aw mi dt"><span id="8c9b" class="km kn hu lp b fv mj mk l ml mm">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: nginx<br/>  labels:<br/>    env: test<br/>spec:<br/>  containers:<br/>  - name: nginx<br/>    image: nginx<br/>  nodeSelector:<br/>    <strong class="lp hv">beta.kubernetes.io/instance-type: t2.medium</strong></span></pre><p id="fde3" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">使用<code class="eh lm ln lo lp b">nodeSelector</code>旗给了这个豆荚一个偏好——它很挑剔。一旦您运行<code class="eh lm ln lo lp b">kubectl apply -f myfile.yaml</code>并将其推送到k8s API，kubernetes将找到一个具有正确实例类型的盒子并部署它。如果它不存在，它将触发自动缩放组为您创建一个实例。</p><h2 id="5e58" class="km kn hu bd ko kp kq kr ks kt ku kv kw jt kx ky kz ju la lb lc jv ld le lf lg dt translated">现在你知道了！</h2><p id="6dd7" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf jt lj ji jj ju lk jm jn jv ll jq jr js hn dt translated">您已经有了一个支持多种EC2实例类型的集群。您可以添加任意数量的ASG。去占领这个世界吧，你这个小淘气！</p></div><div class="ab cl mn mo hc mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="hn ho hp hq hr"><p id="29d3" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">如果你喜欢这个教程，我会定期在twitter上写一些关于T4的文章。</p></div></div>    
</body>
</html>