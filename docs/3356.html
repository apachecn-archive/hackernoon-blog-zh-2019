<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/hackernoon/continuous-deployment-pipeline-with-bitbucket-pipelines-to-aws-ec2-using-aws-code-deploy-c96e34b1d793#2019-05-29">https://medium.com/hackernoon/continuous-deployment-pipeline-with-bitbucket-pipelines-to-aws-ec2-using-aws-code-deploy-c96e34b1d793#2019-05-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><blockquote class="hs"><p id="a833" class="ht hu hv bd hw hx hy hz ia ib ic id ek translated">使用 AWS 代码部署到 AWS EC2 的连续部署管道！</p></blockquote><figure class="if ig ih ii ij ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff ie"><img src="../Images/40ab7c88e01c5def35601239ceadc7b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H07PZ_hcT6aM_alZKPF1bA.jpeg"/></div></div></figure><p id="967b" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated"><em class="jo"> Node.js 应用</em></p><p id="53ce" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">如果您在这里，我假设您知道什么是持续部署，以及您为什么需要它。在本帖中，我们将了解如何在 AWS EC2 实例上部署一个简单的 Node.js 应用程序，以及如何<strong class="it jp">自动化它的交付</strong>也就是说，每次对您的生产存储库进行“git 推送”时，代码将被部署并托管在您的服务器上，而您无需做任何事情。</p><p id="4ab1" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">我们将在这个演示示例中使用的应用程序是一个简单的“Hello World”<strong class="it jp">node . js</strong>应用程序，但是我们将介绍入门概念，然后可以根据您的需求进行扩展。这是我们的节点服务器的 app.js 文件的目录结构</p><figure class="jq jr js jt fq ik"><div class="bz el l di"><div class="ju jv l"/></div></figure><figure class="jq jr js jt fq ik fe ff paragraph-image"><div class="fe ff jw"><img src="../Images/d455f763d19a6efbfc6c7ef0bd1b0501.png" data-original-src="https://miro.medium.com/v2/resize:fit:352/format:webp/1*Rduxt1KkWedweHHk5GE5rA.jpeg"/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Initial Directory Structure !</strong></figcaption></figure><p id="e54e" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated"><strong class="it jp"> <em class="jo">好了，我们开始吧！</em>T13】</strong></p><p id="6b26" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated"><strong class="it jp">概述:<br/> </strong>简要概述我们将要设置的内容，<br/> Bitbucket 存储库有管道支持，我们可以使用它们来简化我们的部署，您可以在这里阅读关于它们的更多信息<a class="ae kc" href="https://confluence.atlassian.com/bitbucket/get-started-with-bitbucket-pipelines-792298921.html" rel="noopener ugc nofollow" target="_blank">。他们为各种平台提供集成，如亚马逊网络服务、谷歌云平台、微软 Azure 等等。</a></p><p id="2f52" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">我们将设置一个具有编程访问权限的 IAM 用户，bitbucket-pipelines 将使用该用户将我们的应用程序的副本推送到 S3 存储桶，然后在 AWS Codedeploy 上触发部署，这将根据我们的 appspec.yml 配置，代表我们在 EC2 实例上部署我们的应用程序。嗯，这可能看起来很多，但是坚持住，我们会全部完成的！因此，让我们首先设置一个 IAM 用户，我假设您熟悉基本的 Amazon Web 服务。</p><h2 id="865f" class="kd ke hv bd kf kg kh ki kj kk kl km kn jc ko kp kq jg kr ks kt jk ku kv kw kx dt translated">步骤 1:创建 IAM 组、用户、角色！</h2><p id="54ea" class="pw-post-body-paragraph ir is hv it b iu ky iw ix iy kz ja jb jc la je jf jg lb ji jj jk lc jm jn id hn dt translated">创建具有权限的 IAM 组</p><ul class=""><li id="f44e" class="ld le hv it b iu iv iy iz jc lf jg lg jk lh id li lj lk ll dt translated">亚马逊 3 完全访问</li><li id="24f8" class="ld le hv it b iu lm iy ln jc lo jg lp jk lq id li lj lk ll dt translated">AWSCodeDeployFullAccess</li></ul><figure class="jq jr js jt fq ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff lr"><img src="../Images/a5e06a7c4acde0feb214ee6cbf31d4e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2MAexPMGpI47OMmutfMKkw.jpeg"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Create A Group !</strong></figcaption></figure><p id="6116" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">创建一个用户，并将其添加到这个组与编程访问，<br/>保存凭证(访问密钥，秘密访问密钥)，我们将需要它。</p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff ls"><img src="../Images/64f38989386abdda1bc375d0fdc77034.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZyXnVZtYuN10yoOCTxOJNg.jpeg"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Add A</strong> <strong class="bd kb">User To Group !</strong></figcaption></figure><p id="f93d" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">还要在 IAM 中创建一个角色，并选择 EC2 服务，因为我们的 EC2 实例稍后将使用该角色与 CodeDeploy 交互，并添加策略<code class="eh lt lu lv lw b">AmazonS3FullAccess</code>和<code class="eh lt lu lv lw b">AWSCodeDeployRole</code></p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff lx"><img src="../Images/d88f322045ff3fc0465b38c4f5bd094f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aZ2PRkSk77mSoKQDc5wC-w.jpeg"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Create A Role !</strong></figcaption></figure><p id="7502" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">创建角色后，将<strong class="it jp">信任关系</strong>编辑如下。将地区更改为您正在工作的地区，我的是 N.Virginia，即 us-east-1</p><pre class="jq jr js jt fq ly lw lz ma aw mb dt"><span id="e074" class="kd ke hv lw b fv mc md l me mf">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Service": [<br/>            "ec2.amazonaws.com",<br/>            "codedeploy.us-east-1.amazonaws.com"<br/>        ]<br/>      },<br/>      "Action": "sts:AssumeRole"<br/>    }<br/>  ]<br/>}</span></pre></div><div class="ab cl mg mh hc mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="hn ho hp hq hr"><p id="a80f" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated"><strong class="it jp">步骤 2:创建一个 S3 存储桶和一个 EC2 实例</strong></p><p id="e477" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">创建一个 S3 桶，命名为任何你喜欢的名字，并保持桶的默认设置为简单，目前，我命名为<code class="eh lt lu lv lw b">directcodedeploy-codedeploy-deployment </code>。</p><p id="ecbd" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">接下来，创建一个 EC2 实例，操作系统可以根据您的要求，我们将使用 Ubuntu 16.04！我们需要添加我们已经创建的 IAM 角色-AWSCodeDeployRole，现在为了让 AWS 代码部署识别我们的实例，它将寻找标记，因此我们需要标记它，所以我们将标记它为<br/> <code class="eh lt lu lv lw b">Name = CodeDeployDirect</code>，在<strong class="it jp">安全组</strong>中打开您的应用程序所需的适当端口，就像我们的应用程序需要打开端口 3000 一样。</p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div class="fe ff mn"><img src="../Images/ce0419a72dcf2b9e26478ea7dfc4fe6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*tqdrLBvfcJ9hlQ5IdDya3w.jpeg"/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Add IAM Role !</strong></figcaption></figure><figure class="jq jr js jt fq ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff mo"><img src="../Images/b25dfde274a76be7b5f7e220beedfebe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B1fhr30oIGI2raE-FVV0UQ.jpeg"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Add Tag !</strong></figcaption></figure><p id="9902" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">启动实例，然后在您的服务器上安装 CodeDeploy 代理，根据您的操作系统，安装过程可能会有所不同。您可以在此处找到适当的指南<a class="ae kc" href="https://docs.aws.amazon.com/codedeploy/latest/userguide/codedeploy-agent-operations-install.html" rel="noopener ugc nofollow" target="_blank"/>，根据您的操作系统遵循说明，并确保<strong class="it jp"> Code Deploy 代理已启动并正在运行</strong>！</p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff mp"><img src="../Images/00d4c76400b2b0bcf93c6612109e7a42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KM9tXuXsEgp5JM6HqCNOpg.jpeg"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Code Deploy Agent On Server !</strong></figcaption></figure></div><div class="ab cl mg mh hc mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="hn ho hp hq hr"><p id="54e5" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated"><strong class="it jp">步骤 3:创建一个 CodeDeploy 应用程序</strong></p><p id="4995" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">转到 AWS CodeDeploy 控制台并单击创建应用程序</p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff mq"><img src="../Images/e374a4a4eeb85e222ef234ee774dfc05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PPcNXYgOGiqUkUx3pgu5Qg.jpeg"/></div></div></figure><p id="4b56" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">然后使用以下设置创建一个部署组<br/>名称:<code class="eh lt lu lv lw b">DG1 </code>(可以任意选择)<br/>服务角色:<code class="eh lt lu lv lw b">AWSCodeDeployRole<br/></code>部署类型:<code class="eh lt lu lv lw b">In Place<br/></code>部署设置:<code class="eh lt lu lv lw b">CodeDeployDefault.OneAtATime<br/></code>禁用负载均衡<br/>在环境配置下:</p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div class="fe ff mr"><img src="../Images/2f747d6eb6fa4688fe9470bbe14a011e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*QIwfgrDYz-lPSVWMqCab3w.jpeg"/></div></figure><p id="8f15" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">您应该看到 1 个匹配的实例，然后点击 Create Deployment Group</p></div><div class="ab cl mg mh hc mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="hn ho hp hq hr"><p id="849d" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">到目前为止，我们已经设置了一个供 Bitbucket 管道使用的 IAM 用户，一个用于存储应用程序 zip 文件的 S3 bucket，一个用于部署应用程序的 EC2 实例，还安装了代码部署代理，以便根据 appspec.yml 文件部署应用程序。你可以在这里看到一些关于如何配置 appspec.yml <a class="ae kc" href="https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file-example.html#appspec-file-example-server" rel="noopener ugc nofollow" target="_blank">的基本例子，你也可以在这里</a>阅读<strong class="it jp">更多关于如何配置 bitbucket-pipelines.yml <a class="ae kc" href="https://confluence.atlassian.com/bitbucket/configure-bitbucket-pipelines-yml-792298910.html" rel="noopener ugc nofollow" target="_blank">的</a></strong>。</p><p id="c7f1" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">对于我们的应用程序，<strong class="it jp"> appspec.yml </strong>如下所示:</p><figure class="jq jr js jt fq ik"><div class="bz el l di"><div class="ju jv l"/></div></figure><p id="7cf2" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">上面使用的三个简单的 bashscripts 如下:</p><figure class="jq jr js jt fq ik"><div class="bz el l di"><div class="ju jv l"/></div></figure><figure class="jq jr js jt fq ik"><div class="bz el l di"><div class="ju jv l"/></div></figure><figure class="jq jr js jt fq ik"><div class="bz el l di"><div class="ju jv l"/></div></figure><p id="c8f5" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">将以下文件添加到您的存储库中，然后在 bitbucket 中添加存储库变量，并在出现提示时启用管道！</p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff ms"><img src="../Images/6858939f0880f8254af152ac23f48a94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y3oxFk-UMRkJMiMCdquWeA.jpeg"/></div></div></figure><p id="052b" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">现在剩下的就是设置并将 bitbucket-pipelines.yml 推送到我们的存储库，这样一切都可以工作了。</p><figure class="jq jr js jt fq ik"><div class="bz el l di"><div class="ju jv l"/></div></figure><p id="4d57" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">我们在这里看到的管道是由 Atlassian 维护的另一个脚本，您只需粘贴管道，提供一些关键的信息，其余的就为您完成了。<br/>你可以了解更多关于管道和检查其他管道<a class="ae kc" href="https://confluence.atlassian.com/bitbucket/pipes-958765631.html" rel="noopener ugc nofollow" target="_blank">在这里</a>。<br/> <em class="jo">最终的目录结构是这样的</em></p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div class="fe ff mt"><img src="../Images/f9ce19a1d0b1a8a1c677c045d4c0e5b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:346/format:webp/1*00vWOzNCexoMCgY9BvVVaw.jpeg"/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Final Directory Structure !</strong></figcaption></figure><p id="e457" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">现在是提交和推送到远程的时候了。<br/>将更改推送到 Bitbucket 之后，转到您的存储库的管道部分，您将能够看到一个由<strong class="it jp"> #1 </strong>触发的管道，类似于</p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff mu"><img src="../Images/082c88e624fa0d8e754c233c720615b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pv6SIGwZ59LjUtOnmbTb4Q.jpeg"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Pipeline In Progress !</strong></figcaption></figure><p id="df37" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">如果您按照正确的步骤操作，您将看到一个成功的管道运行，并且您的应用程序被部署在服务器上！</p><figure class="jq jr js jt fq ik fe ff paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="fe ff mv"><img src="../Images/9ca1b613da3acac835eec2230c2c48d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8VLK9CrQ_pSo6Tr92sG5Kg.jpeg"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Pipeline Successful !</strong></figcaption></figure><figure class="jq jr js jt fq ik fe ff paragraph-image"><div class="fe ff mw"><img src="../Images/ff72b91fdbdc0d82ab839a4583efcae8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1032/format:webp/1*4EIw585YDHkAnOIjnat4NQ.jpeg"/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek"><strong class="bd kb">Deployed Application !</strong></figcaption></figure><p id="f6e1" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">现在尝试在您的本地存储库中更改消息，然后将其推送到远程，几分钟后访问您的 URL，看看它将如何减轻您未来部署的负担！</p><p id="6a48" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">干得好！</p><p id="b275" class="pw-post-body-paragraph ir is hv it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn id hn dt translated">感谢阅读！如果你喜欢你所读的，那么留下一个👏然后跟着走。</p></div></div>    
</body>
</html>