<html>
<head>
<title>Implementing Staking in Solidity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Solidity中实现打桩</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/implementing-staking-in-solidity-1687302a82cf?source=collection_archive---------0-----------------------#2019-03-27">https://medium.com/hackernoon/implementing-staking-in-solidity-1687302a82cf?source=collection_archive---------0-----------------------#2019-03-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="6c51" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过几行solidity代码，您可以实现一个赌注机制，这是令牌经济学中最强大的激励机制之一。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/1475c7c628b3b9c99474aa28b566f3a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1hIqmh3UXUlEk0dM5WA4ng.jpeg"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Photo by <a class="ae kf" href="https://www.pexels.com/@rawpixel?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">rawpixel.com</a> from <a class="ae kf" href="https://www.pexels.com/photo/white-ipad-955447/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">Pexels</a></figcaption></figure><blockquote class="kg kh ki"><p id="3d75" class="ir is kj it b iu iv iw ix iy iz ja jb kk jd je jf kl jh ji jj km jl jm jn jo hn dt translated">我犯的任何错误都是对我未来的投资。罗丝·纳马朱娜斯</p></blockquote><h1 id="3d60" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">打桩简介</h1><p id="45c3" class="pw-post-body-paragraph ir is hu it b iu ll iw ix iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo hn dt translated">当某人贡献一些资产以换取对企业活动的某种程度的控制、影响或参与时，他就被认为在企业中拥有股份。</p><p id="b961" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在加密货币领域，这被理解为给予用户某种权利或奖励，只要他们不转移他们拥有的一些令牌。赌注机制通常鼓励代币持有，反对代币交易，这反过来又会推高代币估值。</p><p id="bf7c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<a class="ae kf" href="http://www.techhq.io" rel="noopener ugc nofollow" target="_blank"> TechHQ </a>我们相信知识是为了共享而存在的，在这篇文章中，我们将展示如何在solidity中实现一个staking机制。整个项目包括开发环境和测试都可以从<a class="ae kf" href="https://github.com/HQ20/StakingToken" rel="noopener ugc nofollow" target="_blank">我们的公共github </a>获得。</p><p id="96b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了建立这种锁定机制，我们需要:</p><ul class=""><li id="50e0" class="lq lr hu it b iu iv iy iz jc ls jg lt jk lu jo lv lw lx ly dt translated">一个标记。</li><li id="9de6" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">跟踪利害关系、利益相关者和回报的数据结构。</li><li id="0189" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">创建和移除标桩的方法。</li><li id="f12f" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">奖励制度。</li></ul><p id="817d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们继续吧。</p><h1 id="69b0" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">标桩令牌</h1><p id="6aac" class="pw-post-body-paragraph ir is hu it b iu ll iw ix iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo hn dt translated">可以创建一个作为ERC20标记的标记标记。稍后我将需要SafeMath和Ownable，所以让我们也导入并使用它们。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><p id="20f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就这样，其他什么都不需要。</p><h1 id="53f9" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">利益相关者</h1><p id="7c83" class="pw-post-body-paragraph ir is hu it b iu ll iw ix iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo hn dt translated">在这个实现中，我们将跟踪利益相关者，以便在以后促进激励的稳健分布。理论上，不像普通的ERC20令牌那样跟踪他们是可能的，但在实践中，如果你不跟踪他们，就很难确保利益相关者不会利用分销系统。</p><p id="b5d6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了实现，我们将只使用利益相关者地址的动态数组。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><p id="f037" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以下方法添加利益相关者、移除利益相关者并验证地址是否属于利益相关者。其他更有效的实现当然是可能的，但我喜欢这个可读性。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><h1 id="c056" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">赌注</h1><p id="9887" class="pw-post-body-paragraph ir is hu it b iu ll iw ix iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo hn dt translated">最简单的股权形式需要记录<em class="kj">股权大小</em>和<em class="kj">股权持有人。</em>一个非常简单的实现可能只是从利益相关者的地址到股份大小的映射。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><p id="cb25" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将遵循ERC20中的函数名，并创建等效函数来从stakes映射中获取数据。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><p id="aad3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在将赋予STK持有者创造和移除股权的能力。我们将在标记时烧毁代币，以阻止用户转移代币，直到标记被移除。</p><p id="72dd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，如果用户尝试下注比他拥有的更多的令牌，则在下注创建时，burn将会恢复，而在下注移除时，如果尝试移除更多已下注的令牌，则赌注映射的更新将会恢复。</p><p id="8464" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，我们使用addStakeholder和removeStakeholder来记录谁拥有股份，以便稍后在奖励系统中使用。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><h1 id="7a8c" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">奖励</h1><p id="ce5b" class="pw-post-body-paragraph ir is hu it b iu ll iw ix iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo hn dt translated">奖励机制可以有许多不同的实现方式，并且运行起来相当繁重。对于该合同，我们将实现一个非常简单的版本，其中利益相关者定期获得相当于其个人股份1%的STK代币奖励。</p><p id="3401" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在更复杂的合同中，当满足某些条件时，奖励的分配会自动触发，但在这种情况下，我们将让所有者手动触发它。根据最佳实践，我们还将跟踪奖励，并实施一种方法来提取奖励。</p><p id="bdd4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">和以前一样，为了使代码可读，我们遵循了ERC20.sol合同中的命名约定，首先是数据结构和数据管理方法:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><p id="b470" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">按照以下方法计算、分配和提取奖励:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><h1 id="fd59" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">测试</h1><p id="3aa4" class="pw-post-body-paragraph ir is hu it b iu ll iw ix iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo hn dt translated">没有一套全面的测试，任何合同都是不完整的。我倾向于至少在每个函数中产生一个bug，而且事情经常不像我想的那样工作。你可以说我大部分时间都会犯错，而且肯定不止我一个人这样。</p><p id="e494" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了允许你产生有效的代码，测试在开发建立和使用契约的过程中也是非常有用的。我总是从设置测试环境的代码开始编写入门文档。</p><p id="465d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来摘录了测试环境是如何设置和使用的。我们将铸造1000个STK代币，并把它们给一个用户来玩这个系统。我们使用松露进行测试，这给了我们可以使用的账户。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><p id="9a81" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当创建测试时，我总是编写使代码恢复的测试，但是这些测试看起来并不有趣。createStake的测试显示了创建一个桩需要做什么，以及之后应该改变什么。</p><p id="c424" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">需要注意的是，在这个标桩合同中，我们有两个并行的数据结构，一个用于STK余额，一个用于标桩，以及它们的总和如何在标桩创建和移除过程中保持不变。在这个例子中，我们给用户3 STK威，该用户的余额加上赌注的总和将总是3。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><p id="61b3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于奖励，下面的测试显示了所有者如何分配费用，用户获得1%的奖励。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><p id="c4da" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当分配奖励时，STK的总供应量增加，这个测试显示了三个数据结构(余额、赌注和奖励)如何相互关联。现有的和承诺的STK的数量将永远是在创造时铸造的数量加上在奖励中分配的数量，奖励可能被铸造也可能不被铸造。在分配完成之前，在创建时铸造的STK的数量将等于余额和赌注的总和。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="me mf l"/></div></figure><h1 id="922d" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">结论</h1><p id="579c" class="pw-post-body-paragraph ir is hu it b iu ll iw ix iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo hn dt translated">赌注和奖励机制是一个强大的激励工具，只需要我们想让它有多复杂就有多复杂。ERC20标准和SafeMath中提供的方法允许我们用大约200行稀疏代码对其进行编码。</p><p id="c28f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请随意使用<a class="ae kf" href="https://github.com/HQ20/StakingToken" rel="noopener ugc nofollow" target="_blank">我们的公共github </a>中的代码用于您自己的目的，或者如果您希望我们帮助实现该模式的生产版本，请联系<a class="ae kf" href="https://www.techhq.io/#GetinTouch" rel="noopener ugc nofollow" target="_blank">我们</a>。我们也非常感谢任何其他反馈。</p><h1 id="4525" class="kn ko hu bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk dt translated">谢谢</h1><p id="a627" class="pw-post-body-paragraph ir is hu it b iu ll iw ix iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo hn dt translated">感谢<a class="ae kf" href="https://www.linkedin.com/in/vladsilviufarcas/" rel="noopener ugc nofollow" target="_blank">弗拉德·弗卡司</a>启发了这些代码，感谢<a class="ae kf" href="https://www.linkedin.com/in/sergiomcpereira/" rel="noopener ugc nofollow" target="_blank">塞尔吉奥·佩雷拉</a>和<a class="ae kf" href="https://www.linkedin.com/in/temmartins/" rel="noopener ugc nofollow" target="_blank">蒂亚戈·马丁斯</a>发表评论，特别感谢<a class="ae kf" href="https://www.linkedin.com/in/obernardovieira/" rel="noopener ugc nofollow" target="_blank">贝尔纳多·维埃拉</a>教我如何做真实世界的区块链应用。</p></div></div>    
</body>
</html>