<html>
<head>
<title>Using AWS CloudFormation Macros and Custom Resources with the Serverless Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在无服务器框架中使用 AWS CloudFormation 宏和自定义资源</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/using-aws-cloudformation-macros-and-custom-resources-with-the-serverless-framework-ab7bb121d13d#2019-04-25">https://medium.com/hackernoon/using-aws-cloudformation-macros-and-custom-resources-with-the-serverless-framework-ab7bb121d13d#2019-04-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/02532fc70cba11e231adf39333db45f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wOGuECv6fDCik5sRsTuuug.jpeg"/></div></div></figure><p id="185d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">无服务器框架</strong>几天前发布了<a class="ae ka" href="https://github.com/serverless/serverless/releases" rel="noopener ugc nofollow" target="_blank"> 1.4.11 </a>，增加了检测到转换时的额外功能，这意味着我们现在可以使用 AWS CloudFormation 宏从无服务器框架执行定制处理。</p><p id="5427" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在本文中，我展示了一个使用 CloudFormation 定制资源和宏在每次部署后向示例应用程序添加默认文章的示例。</p><h2 id="aea2" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">CloudFormation 宏和自定义资源</h2><blockquote class="kw kx ky"><p id="65d1" class="jc jd kz je b jf jg jh ji jj jk jl jm la jo jp jq lb js jt ju lc jw jx jy jz hn dt translated"><a class="ae ka" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html" rel="noopener ugc nofollow" target="_blank">云形成宏</a>就像你的云形成模板的预处理器。提交 CloudFormation 模板后，在 CloudFormation 实际开始提供资源之前，会调用宏来转换模板的各个部分。</p><p id="b2dc" class="jc jd kz je b jf jg jh ji jj jk jl jm la jo jp jq lb js jt ju lc jw jx jy jz hn dt translated"><a class="ae ka" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html" rel="noopener ugc nofollow" target="_blank">定制资源</a>极大地扩展了 CloudFormation 的功能，因为您可以将定制逻辑作为 CloudFormation 部署的一部分来运行。</p></blockquote><h2 id="0e09" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">用例</h2><p id="817b" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">我运行我的 CloudFormation 模板，它设置了一个 DynamoDb 表和 lambda 函数。然后，CloudFormation 模板在每次部署后将默认的欢迎文章添加到空的 DynamoDb 表中。</p><h2 id="a07c" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">先决条件</h2><p id="3112" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">遵循本指南之前，必须完成以下工作:</p><ul class=""><li id="c1a7" class="li lj hu je b jf jg jj jk jn lk jr ll jv lm jz ln lo lp lq dt translated">设置 AWS 帐户</li><li id="3e06" class="li lj hu je b jf lr jj ls jn lt jr lu jv lv jz ln lo lp lq dt translated">安装 AWS CLI</li><li id="5ad0" class="li lj hu je b jf lr jj ls jn lt jr lu jv lv jz ln lo lp lq dt translated">使用用户凭据配置 AWS CLI</li><li id="5710" class="li lj hu je b jf lr jj ls jn lt jr lu jv lv jz ln lo lp lq dt translated">将无服务器框架(≥1.4.11)安装或更新至最新版本</li></ul><pre class="lw lx ly lz fq ma mb mc md aw me dt"><span id="dda9" class="kb kc hu mb b fv mf mg l mh mi">$ npm install -g serverless</span></pre><h2 id="364c" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">云形成自定义资源</h2><p id="18e3" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">让我们来看看如何使用定制资源，要使用 CloudFormation 定制资源，您需要:</p><ul class=""><li id="90a1" class="li lj hu je b jf jg jj jk jn lk jr ll jv lm jz ln lo lp lq dt translated">定义自定义资源。</li><li id="1cf3" class="li lj hu je b jf lr jj ls jn lt jr lu jv lv jz ln lo lp lq dt translated">通过部署到 AWS Lambda 函数，使自定义资源逻辑可用。</li><li id="0009" class="li lj hu je b jf lr jj ls jn lt jr lu jv lv jz ln lo lp lq dt translated">引用 Lambda 函数来使用 yml 模板中的自定义资源。</li></ul><p id="dae7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下面是一个自定义资源和 lambda 函数的示例:</p><figure class="lw lx ly lz fq iv"><div class="bz el l di"><div class="mj mk l"/></div></figure><p id="2f43" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如上所示，您必须提供 ServiceToken 属性。ServiceToken 是 AWS Lambda 函数的 ARN。</p><h2 id="7c03" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">问题</h2><p id="1503" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">如果我们部署上面的模板，自定义资源在第一次部署时被调用。不会再触发了。要解决这个问题，我们必须向自定义资源添加一个具有动态值的属性。</p><p id="91cb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我的例子中，我使用 CloudFormation 宏来获取堆栈的最后更新日期时间，然后将日期时间值注入到自定义资源的属性中。</p><h2 id="4302" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">设置云形成宏</h2><p id="6bb7" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">创建一个新的无服务器框架项目，并将以下配置添加到 serverless.yml</p><figure class="lw lx ly lz fq iv"><div class="bz el l di"><div class="mj mk l"/></div></figure><p id="21a0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意新的 Cloudformation 资源<code class="eh ml mm mn mb b">AWS::Cloudformation::Macro</code>，它使得 Lambda 函数可以从其他 CloudFormation 模板中访问。</p><h2 id="4298" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">添加 Lambda 函数</h2><p id="f9ad" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">现在，让我们更新 handler.js，创建 lambda 函数来获取 CloudFormation 堆栈的 LastUpdatedTime:</p><figure class="lw lx ly lz fq iv"><div class="bz el l di"><div class="mj mk l"/></div></figure><p id="4723" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于上述宏，我们希望使用 CloudFormation 模板中提供的 CloudFormation 参数中的堆栈名称。参数将在我们的 Lambda 事件对象上的<strong class="je hv">参数</strong>键下提供，我们的 CloudFormation 模板将在<strong class="je hv">片段</strong>键中提供。</p><h2 id="648b" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">部署 CloudFormation 宏</h2><p id="c96f" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">宏可以这样部署:</p><pre class="lw lx ly lz fq ma mb mc md aw me dt"><span id="aebf" class="kb kc hu mb b fv mf mg l mh mi">$ sls deploy</span></pre><h2 id="9772" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">使用</h2><p id="6750" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">现在可以使用新创建的宏了，回到定制资源的<code class="eh ml mm mn mb b">serverless.yml</code>模板，添加<strong class="je hv"> StackLastUpdatedTime </strong>属性以使用我们新生成的宏，使用唯一的参数 StackLastUpdatedTime 强制定制资源在每个部署上重新创建:</p><figure class="lw lx ly lz fq iv"><div class="bz el l di"><div class="mj mk l"/></div></figure><p id="92ce" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，让我们创建一个 lambda 函数，该函数在每次部署时被触发，如果 DynamoDB 表为空，则将欢迎文章添加到该表中。</p><figure class="lw lx ly lz fq iv"><div class="bz el l di"><div class="mj mk l"/></div></figure><p id="3b03" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，当自定义资源创建请求成功时，必须向 S3 存储桶发送类似于以下格式的响应:</p><pre class="lw lx ly lz fq ma mb mc md aw me dt"><span id="91b0" class="kb kc hu mb b fv mf mg l mh mi">{<br/>    <strong class="mb hv">StackId</strong>:<br/>      "arn:aws:cloudformation:ap-southeast-2:687416365397:stack/CustomResourceCMSDefaultPost-dev/67c30500-6741-11e9-9b67-0a8814e42c77",<br/>    <strong class="mb hv">RequestId</strong>: "5270edad-8d64-453a-8683-da2db12f7381",<br/>    <strong class="mb hv">Status</strong>: "SUCCESS",<br/>    <strong class="mb hv">PhysicalResourceId</strong>: "2019/04/25/[$LATEST]8c7b0002a0ba45c29ea6685b99e28977",<br/>    <strong class="mb hv">LogicalResourceId</strong>: "DefaultPost",<br/>    <strong class="mb hv">Data</strong>: {<br/>      LastUpdatedTime: "2019-04-25T12:07:16.747Z"<br/>    }<br/>  };</span></pre><h2 id="d9c3" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">部署服务并试用它！</h2><pre class="lw lx ly lz fq ma mb mc md aw me dt"><span id="ebad" class="kb kc hu mb b fv mf mg l mh mi">$ sls deploy</span></pre><p id="526f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在运行以下命令来检查默认项目是否已经添加到 DynamoDb 表中。</p><pre class="lw lx ly lz fq ma mb mc md aw me dt"><span id="fecf" class="kb kc hu mb b fv mf mg l mh mi">$ aws dynamodb scan --table-name devposts</span></pre><h2 id="c209" class="kb kc hu bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated"><strong class="ak">结果</strong></h2><figure class="lw lx ly lz fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mo"><img src="../Images/454b892de8442d957b6fb6ef9fc108c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-PzHUMg4Lm6AKBT3sfCyMQ.png"/></div></div></figure><p id="49fa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">希望你觉得这篇文章有用，你可以在我的<a class="ae ka" href="https://github.com/yai333/CustomResourceExample" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv"> GitHub repo </strong> </a>中找到完整的项目。</p><figure class="lw lx ly lz fq iv"><div class="bz el l di"><div class="mp mk l"/></div></figure></div></div>    
</body>
</html>