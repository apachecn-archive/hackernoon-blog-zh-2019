<html>
<head>
<title>Analytics services. Serverless analytics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分析服务。无服务器分析</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/analytics-services-part-3-e3981e694f99?source=collection_archive---------16-----------------------#2019-01-15">https://medium.com/hackernoon/analytics-services-part-3-e3981e694f99?source=collection_archive---------16-----------------------#2019-01-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="cd3b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">无服务器和AWS Lambda操作指南</em></p><p id="1654" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我们关于分析系统的三部分故事的第三部分。在这里，您可以找到回答客户端分析问题的<a class="ae jq" rel="noopener" href="/poteha-labs/analytics-services-part-1-d25dd5339977">第1部分</a>，以及关于传统服务器端分析实施的<a class="ae jq" rel="noopener" href="/poteha-labs/analytics-services-part-2-efba0a516fd9">第2部分</a>。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/8515ae5ee11ec75ac11419d3f3298076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2v-axviEp7bTH-CvN8d-Uw.jpeg"/></div></div></figure><p id="bd02" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这一部分，我们将继续向您介绍服务器端分析，尤其是完全基于<em class="jp">云服务</em>的实现。在前一部分中，我们已经列出了实现的主要步骤。这些是:</p><ol class=""><li id="1b8b" class="kd ke hu it b iu iv iy iz jc kf jg kg jk kh jo ki kj kk kl dt translated">数据查询</li><li id="0fa9" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo ki kj kk kl dt translated">流处理</li><li id="89c0" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo ki kj kk kl dt translated">数据库ˌ资料库</li><li id="db7e" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo ki kj kk kl dt translated">聚合服务</li><li id="be65" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo ki kj kk kl dt translated">前端</li></ol><p id="7516" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这同样适用于这里，唯一的区别是每个步骤都尽可能地转移到云服务。因此，我们将按照上面列出的主要步骤的原始顺序，尝试描述潜在的云选项属性以及它们之间的差异。</p><h2 id="d52a" class="kr ks hu bd kt ku kv kw kx ky kz la lb jc lc ld le jg lf lg lh jk li lj lk ll dt translated"><strong class="ak"> 1。数据查询</strong></h2><p id="3c15" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">在我们的工作中，我们一般更喜欢使用<a class="ae jq" href="https://aws.amazon.com/ru/kinesis/" rel="noopener ugc nofollow" target="_blank"> Kinesis </a>。这是一个由亚马逊开发和管理的SaaS流媒体平台。这个解决方案比Kafka容易得多(包括其自托管和可管理的选项)。它允许实时和批处理，并可以轻松地将数据从客户端发送到流。与Kafka相比，使用Kinesis的最大好处是您不必操作和管理任何底层基础设施(服务器和集群)。Kinesis可以通过编程和网络界面进行缩放。以每秒100个事件(每个事件0.5 KB)的速度运行一个分片流的成本大约是每月20美元。它转化为每月2.6亿次活动(大约。130 Gb的数据)。</p><p id="40d7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">可能的选择:可管理的Kafka(这要困难得多)，RabbitMQ，或任何其他类似的pub/子队列。</p><h2 id="e84a" class="kr ks hu bd kt ku kv kw kx ky kz la lb jc lc ld le jg lf lg lh jk li lj lk ll dt translated"><strong class="ak">原始日志存储</strong></h2><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff lr"><img src="../Images/1dd5b7024f0b68c1366a067704c41588.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N6Lf1XWqb45ay-XFihyS_w.jpeg"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Raw logs storage</figcaption></figure><p id="26c0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">谈到原始日志存储，我们更喜欢亚马逊消防软管和S3的二重奏。</p><p id="13f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Firehose是Kinesis的一部分，它从生产者那里接收事件，将它们保存一段特定的时间(比如说5分钟)，然后批量发送到目的地。反过来，S3是一个高度持久和可扩展的云存储。值得提醒的是，存储原始日志的主要目的是为了在整个日志传输过程中出现问题时有一个相关的副本。</p><p id="9595" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们建议将对象分批上传到S3，以减少上传操作的数量，因为您需要为每一个上传操作付费。这项服务是完全托管的，不需要任何管理。每秒1000个事件(每个0.5 Kb)的成本是每月9美元。5美元用于消防软管，另外4美元用于在S3存储130 Gb的数据。如果你不打算删除前一个月的原始日志，S3的价格将每月上涨4美元。Athena是一项附加服务，它允许对存储在S3存储桶中的数据进行SQL查询。</p><h2 id="660f" class="kr ks hu bd kt ku kv kw kx ky kz la lb jc lc ld le jg lf lg lh jk li lj lk ll dt translated"><strong class="ak"> 2。流处理</strong></h2><p id="7d25" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">为了处理连续生成的事件，我们需要包含一些允许自定义逻辑创建的平台。例如，Kinesis对亚马逊Lambda很友好。</p><p id="05fb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Lambda是一个云服务，它允许运行用Node.js、Python、Java、C#和Go编写的业务逻辑，而无需手动管理服务器。简而言之，Lambda是一个响应触发器(HTTP查询、计时器或Kinesis事件)而被调用的无状态函数。Lambda会根据同时发生的事件数量自动增减。您只需为函数执行的时间付费:特别是调用和函数的生命周期(每100毫秒执行一次代码)。每秒处理大约100个事件的估计成本是每月5美元。</p><p id="2185" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">另一个可能的选择是使用Docker开发自己的基于容器的应用程序。Docker是一个容器平台，它允许您在任何服务器上使用预定义的环境部署代码。与裸服务器相比，它大大减少了部署时间，并允许使用流行的orchestrator(Kubernetes、Docker Swarm、Rancher等)配置自动扩展。)不像Lambdas，容器不设置任何限制(对使用的语言或外部库、持续时间、内存等)。)对于你的系统来说。然而，容器比Lambda需要更多的操作和管理。</p><p id="c8e2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">我们经常使用的无服务器功能如下:</strong></p><ul class=""><li id="1f37" class="kd ke hu it b iu iv iy iz jc kf jg kg jk kh jo lw kj kk kl dt translated">基本上，我们创建一个中央入口点和一个中央处理器，周围是其他微服务和插件。这是创建事件配置和路由方案的方法。</li><li id="fce1" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">例如，您可以创建一个配置文件，将一整套事件发送到处理模块和指标计算:其中一个发送到聚合，另一个发送到不同的分析系统，等等。</li><li id="f07a" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">因此，这些工作流的每一部分都可以被Amazon lambda函数替换。因此，你可以得到一组并行工作的功能，而不是大量的火花流。它们中的一些调用其他的，它表现为相关功能的有向图。</li></ul><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff lx"><img src="../Images/7a85a6927ba8af411ddef778d867bc1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*nxGX0RNidBpE-y_pSwXa6A.gif"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Lambda calls Lambda</figcaption></figure><p id="42f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Lambda函数如何调用另一个？有两种方法:直接调用或通过API。为了进行直接调用，我们使用<a class="ae jq" href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" rel="noopener ugc nofollow" target="_blank"> boto3 </a>(这是为Lambda内置的)。调用可以是同步和异步的，这样我们只为函数调用付费。相反，使用API时，可以使用restful接口。但是，API是付费选项。</p><p id="7fd1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">无服务器的重要之处在于使用它的方式多种多样。这些是以下方面的发展:</p><ul class=""><li id="a671" class="kd ke hu it b iu iv iy iz jc kf jg kg jk kh jo lw kj kk kl dt translated">WSGI应用程序(开发只需几个小时)</li><li id="74a8" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">网站</li><li id="d2e2" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">聊天机器人</li><li id="0035" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">MapReduce架构</li><li id="eb43" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">按需计算</li></ul><p id="b12a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以及您应该考虑的一些限制:</p><ul class=""><li id="b6de" class="kd ke hu it b iu iv iy iz jc kf jg kg jk kh jo lw kj kk kl dt translated">运行密集型任务时的CPU或GPU使用率。这意味着人们不能通过Lambda运行高度复杂的计算任务。</li><li id="af94" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">只有3 Gb的内存配额，可以很容易地超过。</li><li id="1e16" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">冷启动。如果很长时间没有人使用该应用程序，在下一次请求时，将发生容器调用，请求处理时间可能会增加10倍。要避免这种情况，请尝试使用预热方法:每小时向lambda函数发送一个测试事件，以便它保持“预热”。然而，冷启动问题还没有解决。我们相信在不久的将来，其中一个云提供商将会管理它。</li></ul><h2 id="0e23" class="kr ks hu bd kt ku kv kw kx ky kz la lb jc lc ld le jg lf lg lh jk li lj lk ll dt translated"><strong class="ak"> 3。数据库</strong></h2><p id="2cda" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">为了存储处理过的数据，我们提出研究以下已知的解决方案:Amazon RDS Postgres和ClickHouse。</p><p id="b9fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AWS RDS是一项服务，它消除了常见的数据库管理任务，如备份、安全更新和性能优化。它还有助于副本资源调配。它不是像DynamoDB那样完全托管的数据库，但仍然比自己运行Postgres方便。Postgres是一个对象关系数据库，具有许多很棒的特性，但它不是存储尤其是查询分析事件的最佳选择。</p><p id="2ae8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">幸运的是，有专门为在生产中构建分析系统而开发的列(面向列)数据库。它们对软件开发人员/devops和数据科学家/分析师都很清楚。最流行的列数据库之一是Apache制造的HBase。它专门针对高负载进行了优化，但是，它很难部署和扩展，并且有一个复杂的API。</p><p id="7733" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">另一个柱状数据库是ClickHouse。它是由Yandex专门为分析服务开发的。它是为使用类似SQL的语法进行极快的实时(<a class="ae jq" href="https://clickhouse.yandex/benchmark.html" rel="noopener ugc nofollow" target="_blank">基准</a>)查询而设计的。它有各种有用的内置分析功能。我们在20亿个条目的数据集上测试了ClickHouse，大多数聚合查询的执行时间不到1秒。</p><p id="1aed" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Clickhouse可以在单台机器上很好地工作，但也可以相对容易地部署到集群中。对于指定的工作负载(每秒100个事件)，在EC2上使用ClickHouse运行一个实例每月的成本从50美元到120美元不等，具体取决于分配的内存量。通过使用保留的实例，实例的价格可以显著降低:承诺在一年或三年的期限内使用相同的实例。SSD存储每月每Gb 0.11美元。您也可以在自己的硬件上运行ClickHouse。</p><h2 id="6da2" class="kr ks hu bd kt ku kv kw kx ky kz la lb jc lc ld le jg lf lg lh jk li lj lk ll dt translated"><strong class="ak"> 4。聚合服务</strong></h2><figure class="js jt ju jv fq jw fe ff paragraph-image"><div class="fe ff ly"><img src="../Images/7a74d505db8add010540bf805a7f7a23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*QnSJQXBeORFvs6Nh4DQ4qA.gif"/></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">Big data analysis</figcaption></figure><p id="1816" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于在步骤1中，我们已经创建了一个用于路由所有应用程序事件的通用配置文件，因此现在可以轻松连接任何分析系统。例如，随着新应用程序版本的发布，我们可能会引入新的事件。假设，分析师想通过他们的分析系统界面，比如Mixpanel来查看它们。</p><p id="caad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了实现这一点，我们应该添加一个用Lambda语言支持的<a class="ae jq" href="https://aws.amazon.com/ru/lambda/faqs/" rel="noopener ugc nofollow" target="_blank">之一编写的新组件:Node.js (JavaScript)、Python、Java(与Java 8兼容)、C#(。网芯)而去。这是可以快速简单地完成的事情。请注意，所有模块都可以用AWS Linux编译，并且应该与应用程序同时部署，否则它将无法按预期工作。</a></p></div><div class="ab cl lz ma hc mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="hn ho hp hq hr"><p id="890d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是一个可能的最终架构方案，使用描述的亚马逊服务和几个成本估计。</p><h2 id="5cbf" class="kr ks hu bd kt ku kv kw kx ky kz la lb jc lc ld le jg lf lg lh jk li lj lk ll dt translated">体系结构</h2><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff mg"><img src="../Images/085bc607969f37b84e57e59b85cedc7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j82UDh_C9zTQLH4gAIIMnQ.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek"><em class="mh">Scheme showing how the final architecture may look</em></figcaption></figure><h2 id="6861" class="kr ks hu bd kt ku kv kw kx ky kz la lb jc lc ld le jg lf lg lh jk li lj lk ll dt translated">费用</h2><figure class="js jt ju jv fq jw fe ff paragraph-image"><div class="fe ff mi"><img src="../Images/605ce41347cc1882eb26be8595157392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*e7bKJna53CC6izC6OtcCmA.png"/></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek"><em class="mh">*Cost can be reduced 30–50% when using reserved instances (12 or 36 months commitment)</em></figcaption></figure><h1 id="73c8" class="mj ks hu bd kt mk ml mm kx mn mo mp lb mq mr ms le mt mu mv lh mw mx my lk mz dt translated">结论</h1><p id="e72a" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">为企业实施分析解决方案可以通过多种方式实现。我们上面描述的解决方案是一种低成本且易于部署的变体。这是通过一系列Amazon和无服务器技术实现的，这些技术允许:</p><ul class=""><li id="a0bf" class="kd ke hu it b iu iv iy iz jc kf jg kg jk kh jo lw kj kk kl dt translated">使用lambda函数微调事件；</li><li id="ed90" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">显著降低和管理成本；</li><li id="5d98" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">平滑缩放；</li><li id="4d3e" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">减少花在devops上的时间。团队领导自己可以管理和处理部署；</li><li id="cac4" class="kd ke hu it b iu km iy kn jc ko jg kp jk kq jo lw kj kk kl dt translated">快速发布新版本。</li></ul><p id="0128" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">感谢您的阅读！请向我们提问，留下您的评论，敬请关注！在</strong><a class="ae jq" href="https://potehalabs.com" rel="noopener ugc nofollow" target="_blank"><strong class="it hv">https://potehalabs.com</strong></a>找到我们</p></div></div>    
</body>
</html>