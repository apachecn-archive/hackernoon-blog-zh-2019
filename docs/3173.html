<html>
<head>
<title>10x Better Fixed Point Math in Solidity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">10倍更好的可靠性定点数学</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/10x-better-fixed-point-math-in-solidity-32441fd25d43?source=collection_archive---------6-----------------------#2019-05-20">https://medium.com/hackernoon/10x-better-fixed-point-math-in-solidity-32441fd25d43?source=collection_archive---------6-----------------------#2019-05-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="89d4" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">使用这个库花十分之一的汽油在你的定点数学上。</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/05e61b3112b1599933eb81f6f9d9faca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*47ZMYDSZVMvGmZkVVTeP_Q.jpeg"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Save time and money for your users.</figcaption></figure><blockquote class="jz"><p id="eff8" class="ka kb hu bd kc kd ke kf kg kh ki kj ek translated">“技术什么都不是。重要的是你对人们有信心，相信他们本质上是善良和聪明的，如果你给他们工具，他们会用这些工具做很棒的事情。”—史蒂夫·乔布斯</p></blockquote><h1 id="498a" class="kk kl hu bd km kn ko kp kq kr ks kt ku ja kv jb kw jd kx je ky jg kz jh la lb dt translated">介绍</h1><p id="99da" class="pw-post-body-paragraph lc ld hu le b lf lg iv lh li lj iy lk ll lm ln lo lp lq lr ls lt lu lv lw kj hn dt translated">最近我们<a class="ae lx" rel="noopener" href="/cement/fixed-point-math-in-solidity-616f4508c6e8">为以太坊智能合约发布了一个定点数学库</a>。我们为推动智能合约开发的发展感到非常自豪，并且我们在<a class="ae lx" href="http://www.medium.com" rel="noopener">媒体</a>首页上以区块链和加密货币为主题。</p><p id="9c29" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">嗯，这个来自ABDK consulting 的<a class="ae lx" href="https://github.com/abdk-consulting/abdk-libraries-solidity" rel="noopener ugc nofollow" target="_blank">用于solidity smart contracts的定点数学库甚至更好。它使用一小部分气体来运行大多数方法，并支持更多的函数，如平方根和指数。</a></p><p id="6305" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">代码本身也更干净，这要归功于一个数字表示，它允许更轻松地检测溢出。相比之下，我们的实现现在感觉相当沉重。</p><h1 id="ef04" class="kk kl hu bd km kn ko kp kq kr ks kt ku ja md jb kw jd me je ky jg mf jh la lb dt translated">代码分析</h1><p id="f254" class="pw-post-body-paragraph lc ld hu le b lf lg iv lh li lj iy lk ll lm ln lo lp lq lr ls lt lu lv lw kj hn dt translated">主要区别在于，ABDK库以存储在int128中的64.64位格式表示定点数。这种数字表示在代码本身中有解释。</p><pre class="jk jl jm jn fq mg mh mi mj aw mk dt"><span id="137a" class="ml kl hu mh b fv mm mn l mo mp">/**<br/>* Smart contract library of mathematical functions operating with<br/>* signed 64.64-bit fixed point numbers. Signed 64.64-bit fixed point<br/>* number is basically a simple fraction whose numerator is signed<br/>* 128-bit integer and denominator is 2**64. As long as denominator <br/>* is always the same, there is no need to store it, thus in Solidity<br/>* signed 64.64-bit fixed point numbers are represented by int128<br/>* type holding only the numerator.<br/>*/</span></pre><p id="0f66" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">这允许将两个int128定点数相加或相乘，并将结果存储到int256中，从而使中间溢出成为不可能。一旦乘法完成，如果结果数超过2**128，我们将知道它不再适合我们的64.64位表示，我们只是恢复。</p><p id="abde" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">使用二进制表示还允许使用位移操作符，我认为使用位移操作符比使用十进制操作符要便宜得多。</p><p id="511b" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">这个溢出保护乘法的实现有多棒:</p><pre class="jk jl jm jn fq mg mh mi mj aw mk dt"><span id="41a5" class="ml kl hu mh b fv mm mn l mo mp">function mul (int128 x, int128 y) internal pure returns (int128) {<br/>    int256 result = int256(x) * y &gt;&gt; 64;<br/>    require (result &gt;= MIN_64x64 &amp;&amp; result &lt;= MAX_64x64);<br/>    return int128 (result);<br/>}</span></pre><p id="fbd0" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">唯一的限制是ABDK不能原样表示高于2⁶⁴的值。在加密货币领域，than意味着它不能处理超过19位的令牌操作*，也不能代表超过184亿个令牌的金额。调整64.64表示可以通过减少小数部分来增加整数部分的限制，反之亦然。</p><p id="a9ce" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated"><em class="mq"> *编辑:不真实，ABDK中的限制。数学对库可以处理哪些令牌没有影响。见评论。</em></p><h1 id="03b2" class="kk kl hu bd km kn ko kp kq kr ks kt ku ja md jb kw jd me je ky jg mf jh la lb dt translated">性能试验</h1><p id="3be1" class="pw-post-body-paragraph lc ld hu le b lf lg iv lh li lj iy lk ll lm ln lo lp lq lr ls lt lu lv lw kj hn dt translated">聪明是有回报的。下面是在<a class="ae lx" href="https://github.com/CementDAO/Fixidity" rel="noopener ugc nofollow" target="_blank">固定性</a>和<a class="ae lx" href="https://github.com/abdk-consulting/abdk-libraries-solidity" rel="noopener ugc nofollow" target="_blank"> ABDK </a>中运行加法、乘法和对数所需气体的比较。为了找到这些值，我将对库的调用包装在一个契约中，该契约将结果作为事件返回。这包括事务中的库调用，因此它们有一个gas开销。</p><pre class="jk jl jm jn fq mg mh mi mj aw mk dt"><span id="63bf" class="ml kl hu mh b fv mm mn l mo mp">pragma solidity ^0.5.0;<br/>import “../ABDKMath64x64.sol”;</span><span id="78b3" class="ml kl hu mh b fv mr mn l mo mp">contract ABDKMathMock {<br/>    event ValueCalculated(int256 output);</span><span id="3b58" class="ml kl hu mh b fv mr mn l mo mp">    …</span><span id="1b43" class="ml kl hu mh b fv mr mn l mo mp">    function add (int128 x, int128 y) public {<br/>        emit ValueCalculated(ABDKMath64x64.add(x, y));<br/>    }</span><span id="aa10" class="ml kl hu mh b fv mr mn l mo mp">    …</span><span id="d8b2" class="ml kl hu mh b fv mr mn l mo mp">}</span></pre><p id="79aa" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">为了得出实际的方法成本，我必须调整eth-gas reporter返回的值，减去基础交易成本的<a class="ae lx" href="https://ethereum.github.io/yellowpaper/paper.pdf" rel="noopener ugc nofollow" target="_blank"> 21000 gas和事件</a>的2000 gas。以下是eth-gas-reporter的报道:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ms"><img src="../Images/5d09030ddd19762e8425f7bd392588a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*odY-1h9sw75WMU9tRJ8NRQ.png"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Gas use comparison between ABDK and Fixidity.</figcaption></figure><p id="70c7" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">平均而言，使用ABDK的所有操作都是使用固定性的gas成本的10%,并且我假设计算性能也更好。对于迭代方法和高值，差异甚至更大。</p><h1 id="f67f" class="kk kl hu bd km kn ko kp kq kr ks kt ku ja md jb kw jd me je ky jg mf jh la lb dt translated">结论</h1><p id="35c4" class="pw-post-body-paragraph lc ld hu le b lf lg iv lh li lj iy lk ll lm ln lo lp lq lr ls lt lu lv lw kj hn dt translated">尽管增加了复杂性和成本，但定点数学在智能合约中仍有真正的用途。Mikhail Vladimirov为ABDK实现了一个非常聪明和高效的库，极大地降低了在智能契约中使用定点数学的成本。</p><p id="f852" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">我们在实现<a class="ae lx" href="http://www.cementdao.com" rel="noopener ugc nofollow" target="_blank"> CementDAO </a>时的一个顾虑是计算稳定性既慢又昂贵。其他竞争的stablecoins具有不太先进的稳定机制，但同时也提供了更好的性能。</p><p id="ae71" class="pw-post-body-paragraph lc ld hu le b lf ly iv lh li lz iy lk ll ma ln lo lp mb lr ls lt mc lv lw kj hn dt translated">在我们的下一次产品迭代中，我们将以更低的成本获得更好的稳定性机制。你不爱开源吗？</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mt mu l"/></div></figure></div></div>    
</body>
</html>