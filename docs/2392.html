<html>
<head>
<title>Managing Ubuntu Snaps: the stuff no one tells you</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理Ubuntu快照:没人告诉你的事情</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/managing-ubuntu-snaps-the-stuff-no-one-tells-you-625dfbe4b26c?source=collection_archive---------1-----------------------#2019-04-15">https://medium.com/hackernoon/managing-ubuntu-snaps-the-stuff-no-one-tells-you-625dfbe4b26c?source=collection_archive---------1-----------------------#2019-04-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/934cc9713d3250a4085d97d1c106f6d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NDQDe0i5HZOvbRAI2tXQtQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The snapcraft.io site: where snap developers and users meet</figcaption></figure><p id="bdbd" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">Canonical的快照绝对是真货。安全和便携的Linux包管理系统不仅仅是一个展示你的技术信用的极客工具。想想<a class="ae ke" href="https://snapcraft.io/store" rel="noopener ugc nofollow" target="_blank">越来越多的公司已经购买并通过snaps提供他们的桌面软件，包括Blender、Slack、Spotify、Android Studio和微软(Microsoft！)Visual Studio代码。不要忘记，snap系统的真正增长是在物联网设备和服务器领域，而不是桌面。</a></p><p id="5515" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">但是随着snap越来越受欢迎——一些新的Linux发行版默认安装了snapd服务——您可能会想知道应该如何让它们工作。不要误解我的意思:有各种各样的基于web的指南来查找、安装和删除snaps。开发人员可以从一些地方获得帮助，将他们的应用程序构建成快照。但是现在我要说的是<em class="kf">配置</em>他们的行为或者<em class="kf">在出现问题时排除故障</em>。</p><p id="17f6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">请注意，您可以使用以下命令来搜索要安装的新快照:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="c433" class="kp kq hu kl b fv kr ks l kt ku">$ snap find aws</span></pre><p id="e845" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">当您找到您喜欢的软件包时，您可以使用以下方式安装它:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="5c40" class="kp kq hu kl b fv kr ks l kt ku">$ snap install aws-cli</span></pre><p id="cb6c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">哦，你用删除键删除它们。</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="4e96" class="kp kq hu kl b fv kr ks l kt ku">$ snap remove aws-cli</span></pre><p id="5215" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">那里。你不能说我什么都没教过你。但这不是本文要讨论的内容。我们将要讨论的是真正的管理内容，比如更改配置或排除故障。</p><h2 id="e2b2" class="kp kq hu bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln dt translated">了解快照文件系统</h2><p id="2ad8" class="pw-post-body-paragraph jg jh hu ji b jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd hn dt translated">那么，这和你通常在Linux上做的方式有什么不同呢？配置文件通常会放在<em class="kf"> /etc/ </em>中，进程会通过<em class="kf"> systemctl </em>来揭示它们最深的秘密，日志会找到它们的<em class="kf"> /var/log/ </em>中。</p><p id="f063" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">别着急，朝圣者。在Snapland，事情并不总是这样。你看，快照实际上只不过是一个压缩文件(使用<em class="kf">命名)。snap </em> extension)包含运行包所需的整个文件系统。这些文件实际上从未被解压缩和“安装”，而是在运行时动态挂载，并作为虚拟环境向用户公开。</p><p id="9b82" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这意味着程序使用的资源可能实际上不存在于主机系统中。因此，例如，Nextcloud snap为其后端创建了自己的Apache和MySQL版本。所以，比方说，如果你想在<em class="kf">/etc/Apache 2/sites-available/</em>中配置一个新的虚拟主机，或者以传统方式创建一个新的MySQL用户，你就不走运了。</p><p id="a876" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这种方法的优点是显著的:安装和设置通常会更加顺利，并且您不太可能遇到依赖性问题和冲突。但这也至少意味着你对驱动你软件的重要器官的接触更少了。</p><p id="dc54" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">那么，所有爽快的事情都发生在哪里？亲自查看一下您的主机文件系统:您可能会发现比您所能看到的更多的快照目录(如果您愿意的话)。以下是快照安装过程可能创建的目录:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="4b08" class="kp kq hu kl b fv kr ks l kt ku">/snap/<br/>/var/snap/<br/>/var/lib/snapd/<br/>/home/username/snap/</span></pre><p id="c2cc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这么多？为什么让我们一次过一遍。请随意使用您自己的Linux机器来亲眼看看这一切。</p><p id="75ad" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">实际的<em class="kf">。快照</em>文件保存在<em class="kf"> /var/lib/snapd/snaps/ </em>目录下。运行时，这些文件将挂载在根目录<em class="kf"> /snap/ </em>下。看那边——在/snap/core/子目录中——您会看到看起来像一个普通的Linux文件系统。它实际上是活动快照使用的虚拟文件系统。</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="fb2d" class="kp kq hu kl b fv kr ks l kt ku">$ ls /snap/core/current<br/>bin   dev  home  lib64  meta  opt   root  sbin  srv  tmp  var<br/>boot  etc  lib   media  mnt   proc  run   snap  sys  usr  writable</span></pre><p id="732c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这里是一个子目录，包含Nextcloud snap使用的(只读)配置文件。当然，这只有在你安装了next cloud(<em class="kf">snap install next cloud</em>)的情况下才会出现。</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="b331" class="kp kq hu kl b fv kr ks l kt ku">$ ls /snap/nextcloud/current/conf/<br/>httpd.conf  mime.types  ssl.conf</span></pre><p id="929b" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">好的。现在<em class="kf"> /var/snap/ </em>呢？与传统的<em class="kf"> /var/ </em>非常相似，<em class="kf"> /var/snap/ </em>中的文件包含各种形式的用户数据和日志文件——应用程序在操作期间生成和使用的数据。此示例显示了一些桌面相关快照使用的数据目录，包括AWS CLI和Slack team communication tool。(好吧，从技术上讲，AWS CLI不是桌面工具。)</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="01dc" class="kp kq hu kl b fv kr ks l kt ku">$ ls /var/snap<br/>aws-cli  core18           gnome-system-monitor  gnome-calculator<br/>brave    gnome-3-26-1604  gnome-characters      gtk-common-themes<br/>core     gnome-3-28-1804  gnome-logs            slack</span></pre><p id="f985" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">深入您机器上的<em class="kf"> /var/snap/ </em>子目录，看看您能发现什么。</p><p id="f300" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这样，至少在某些Linux文件系统上，用户的主目录中只剩下<em class="kf"> ~/snap </em>目录。它将包含使用您将在/var/snap中看到的一些名称的目录。里面发生了什么事？</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="fae9" class="kp kq hu kl b fv kr ks l kt ku">$ ls ~/snap<br/>aws-cli  brave  gnome-calculator  slack</span></pre><p id="84ae" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">据我所知，这些目录旨在存储与您的用户帐户使用的设置相关的版本化数据。</p><h2 id="eb0d" class="kp kq hu bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln dt translated">快照管理工具</h2><p id="8cb7" class="pw-post-body-paragraph jg jh hu ji b jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd hn dt translated">到目前为止，我已经向您展示了如何找到保存在配置文件(在<em class="kf"> /var/snap/ </em>)、虚拟文件系统(<em class="kf"> /snap/ </em>)和用户设置集合(<em class="kf"> ~/snap </em>)中的各类数据。我还向您展示了<em class="kf">而不是</em>要查看的地方— <em class="kf"> /var/lib/snapd/ </em> —也就是。快照文件本身是活的；这里没什么可看的，快走吧。</p><p id="787e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">那么实际的管理呢？这有点复杂。一些快照(如Nextcloud)公开了功能全面的管理界面。我在<a class="ae ke" rel="noopener" href="/@dbclin/administrating-nextcloud-as-a-snap-4eb43ca6d095">我的管理下一个云的快照文章</a>中谈到了这一点。但似乎快照的简单性有时意味着没有太多实际配置的可能。</p><p id="7558" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然而，情况并非总是如此。但首先，你需要了解一下<em class="kf">的快照服务</em>。一些更复杂的应用需要多层软件栈。例如，Nextcloud创建并管理自己的Apache、MySQL、PHP和Redis版本。简而言之，这些“层”中的每一层都被称为服务。</p><p id="6844" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果您的计算机上安装的任何快照都有自己的服务，您可以使用以下snapd命令列出它们及其状态:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="ff3f" class="kp kq hu kl b fv kr ks l kt ku">$ snap services<br/>Service                    Startup  Current   Notes<br/>nextcloud.apache           enabled  active    -<br/>nextcloud.mdns-publisher   enabled  active    -<br/>nextcloud.mysql            enabled  active    -<br/>nextcloud.nextcloud-cron   enabled  active    -<br/>nextcloud.nextcloud-fixer  enabled  inactive  -<br/>nextcloud.php-fpm          enabled  active    -<br/>nextcloud.redis-server     enabled  active    -<br/>nextcloud.renew-certs      enabled  active    -</span></pre><p id="bbe2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您还可以控制服务的运行和启动状态。这个例子将停止Nextcloud的Apache服务，并确保它不会在系统重新启动时启动(尽管，请记住，这将禁用next cloud——您可能不想这样做):</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="0e56" class="kp kq hu kl b fv kr ks l kt ku">$ snap stop --disable nextcloud.apache</span></pre><p id="7b41" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您还可以使用systemctl来管理快照服务进程:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="5dff" class="kp kq hu kl b fv kr ks l kt ku">$ systemctl status snap.nextcloud.apache</span></pre><p id="8465" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果您的快照至少包括一项服务，您可以使用snapd查看其日志:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="c5fb" class="kp kq hu kl b fv kr ks l kt ku">$ snap logs nextcloud</span></pre><p id="b5ad" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您还可以指定特定的服务:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="5890" class="kp kq hu kl b fv kr ks l kt ku">$ snap logs nextcloud.mysql</span></pre><p id="8482" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">对于某些快照(如Nextcloud)，snapd可以从命令行进行有用的配置。您可以使用<em class="kf"> snap get </em>显示可用设置:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="d061" class="kp kq hu kl b fv kr ks l kt ku">$ snap get nextcloud<br/>Key        Value<br/>mode       production<br/>nextcloud  {...}<br/>php        {...}<br/>ports      {...}<br/>private    {...}</span></pre><p id="83eb" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">通过添加特定设置的名称来下拉一个级别。这个例子向我们展示了Nextcloud目前只监听端口80 (HTTP)和443 (HTTPS)。</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="2810" class="kp kq hu kl b fv kr ks l kt ku">$ snap get nextcloud ports<br/>Key          Value<br/>ports.http   80<br/>ports.https  443</span></pre><p id="4826" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您可以使用<em class="kf"> set </em>命令更改设置。这将告诉Nextcloud在端口8080上监听不安全的HTTP请求，而不是80。</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="e827" class="kp kq hu kl b fv kr ks l kt ku">$ snap set nextcloud ports.http=8080</span></pre><p id="ed6d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">Snapd还提供了一些系统范围的配置设置，在这里<a class="ae ke" href="https://docs.snapcraft.io/system-options/87" rel="noopener ugc nofollow" target="_blank">描述</a>，在这里维护<a class="ae ke" href="https://docs.snapcraft.io/environment-variables/7983" rel="noopener ugc nofollow" target="_blank">环境变量的文档，在这里</a>可以找到关于<a class="ae ke" href="https://docs.snapcraft.io/keeping-snaps-up-to-date/7022" rel="noopener ugc nofollow" target="_blank">保持快照更新的信息。</a></p><p id="7324" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">当事情需要解决的时候，所有这些都会让你开始。所以开始吧。</p><p id="bfac" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><em class="kf">寻找更多？你可能会喜欢我的关于Linux、AWS和Docker相关主题的</em> <a class="ae ke" href="https://bootstrap-it.com/" rel="noopener ugc nofollow" target="_blank"> <em class="kf">书籍和Pluralsight课程</em> </a> <em class="kf">。</em></p></div></div>    
</body>
</html>