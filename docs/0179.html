<html>
<head>
<title>The EVM Is Fundamentally Unsafe</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EVM从根本上说是不安全的</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-evm-is-fundamentally-unsafe-d69f2e3b908b?source=collection_archive---------3-----------------------#2019-01-08">https://medium.com/hackernoon/the-evm-is-fundamentally-unsafe-d69f2e3b908b?source=collection_archive---------3-----------------------#2019-01-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/4dfb90a0fb45078f7f843f80aa929334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FSC5umaSmaxKcOoNJcA3Hg.png"/></div></div></figure><p id="b7c6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">对以太坊虚拟机vs. Kadena的Pact智能合约语言的深入研究</em></p><p id="fef4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在智能合约<a class="ae kb" href="https://hackernoon.com/tagged/development" rel="noopener ugc nofollow" target="_blank">开发</a>的过去三年里，<a class="ae kb" href="https://hackernoon.com/tagged/cryptocurrency" rel="noopener ugc nofollow" target="_blank">加密货币</a>社区已经目睹了用Solidity编写的智能合约被各种各样的漏洞和利用所颠覆(DAO利用、<a class="ae kb" href="https://cointelegraph.com/news/parity-multisig-wallet-hacked-or-how-come" rel="noopener ugc nofollow" target="_blank">奇偶校验多签名钱包漏洞</a>等)。)，并且通常将不安全智能合约的优势归咎于可靠性智能合约语言及其许多怪癖。然而，我们坚持认为，一些最糟糕的可靠性缺陷——缺乏检查和可追溯性，链上代码的不透明性和模糊性，以及对外部智能合约的昂贵、缓慢和危险的调用——直接源于以太坊虚拟机(EVM)架构中的基础设计决策。</p><p id="cc99" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">虽然我们知道EWASM工作组寻求在以太坊上推进智能合约技术的发展，但我们警告不要忽视EVM的缺陷并指向闪亮的新解决方案，因为如果设计缺陷没有被发现，它们将面临重复出现的严重风险。在讨论这些缺陷时，我们还将它们与通知设计<a class="ae kb" href="https://github.com/kadena-io/pact" rel="noopener ugc nofollow" target="_blank"> Pact </a>、<a class="ae kb" href="http://kadena.io" rel="noopener ugc nofollow" target="_blank"> Kadena </a>的开源智能合约语言的决策进行对比，该语言有意识地避免了许多这些陷阱。</p><h2 id="a3b9" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">虚拟机及其他</h2><p id="34e2" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">一个构造良好的虚拟机(VM)试图保护语言设计者避免危险的错误，并通过调度支持、名称解析等核心特性支持高效的构造。然而，EVM未能提供类似的保证，通常以体现以太坊核心精神的模糊理由来呈现“全球计算机器”拥有一台图灵完全机器而不使开发者面临现代虚拟机已经消除了几十年的风险是可能的。相反，EVM无视这种智慧，并期望编译成它的地表语言来解决它们。</p><p id="42dd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">事实上，EVM太复杂了，在字节码语言和本机功能的紧缩中不安全，但没有包含足够的适当VM的特性，在构造上不安全。如果EVM采用更严格的图灵不完全计算模型，它可以接近比特币字节码的安全保证。另一方面，如果EVM提供了现代VM所期望的特性，那么它将接近Java虚拟机(JVM)等机器所提供的低级安全性。</p><p id="d97b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此，任何以EVM为目标的语言都必须应对其不安全的设计选择和缺乏现代VM特性的问题。调度和抽象等功能必须完全由面向用户的语言来处理，这使得语言设计者(如Solidity的作者)的工作特别困难，并且有太多的机会犯严重的错误。</p><h2 id="9b56" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">EVM字节码不是人类可读的</h2><p id="adae" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">比特币提供了一种安全、简单且有效易读的字节码语言，旨在保证在区块链上运行的程序的一致性和正确性。它提供了一个最小的指令集，并主要使用字节码来保持较小的有效载荷。它从未被设计成通用语言的编译目标。这些经过深思熟虑的语言级限制最大限度地减少了理解给定有效负载实际上在做什么的认知开销，以便开发人员可以更有效地推理他们自己的代码以及其他人的代码。的确，有经验的比特币开发者可以直接阅读和解读比特币操作码。</p><p id="4675" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">EVM的创造者保留了字节码模型，但抛弃了小的、易于理解的程序的想法。相反，他们将字节码视为“目标机器码”，人类可读的代码被编译到其中。这就是为什么Solidity不可能在链上读取，必须反编译才能调试或验证。以太坊生态系统中的几个项目试图围绕编译的代码提供额外的保证，例如通过F*定理证明语言正式验证以太坊智能合约的努力，通过指定Solidity的图灵不完全子语言，尽管仍处于研究项目的初期阶段。但是与许多具有低级设计错误的架构一样，这代表了大量的工作，而这些工作本来是可以通过正确的设计来避免的。相反，EVM扩展了比特币字节码，但为了给任意高级代码提供最小的编译目标，它做了太多。在这样做的时候，它失去了人类可读契约的关键安全特性。</p><p id="096c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Pact采取了一种不同的方法，它提供了一种直接执行的解释语言，而不是像Solidity那样编译。此外，它还秉承了“越小越好”的理念，这一理念直接受到了比特币脚本的启发。无数高速运行SQL的数据库，以及在改进Javascript解释器方面取得的巨大进步，证明了编译语言比解释语言性能更好的论点是错误的。历史已经证明，如果一种语言不能提供内联、缓存和“实时”优化，那么解释型语言就能超越编译型语言，同时提供更好的可读性。</p><p id="6e45" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">解释器的使用意味着部署的Pact代码将人类可读的智能契约直接放到链上。相比之下，任何建立在EVM之上的语言都会产生难以辨认且无法被人类验证的字节码，因此只会对用该语言编写的程序的功能产生不完整的理解。最后，Pact作为一种面向价值的函数式编程语言，强化了这种保证的概念:开发人员或读者可以用EVM字节码永远不会承认的方式对Pact代码进行等式推理。</p><h2 id="c424" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">EVM允许语言是图灵完全的</h2><p id="6d4b" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">出于保证正确性的目的，比特币的字节码还包含另一个重要的安全特性:图灵不完全性。通过这样做，比特币字节码保护程序免受递归攻击，以及无意中陷入无限循环的风险，这在分布式计算机上是昂贵的，并且是等待发生的安全漏洞。</p><p id="5a78" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在EVM诞生之初，以太坊开发人员试图通过提供一个与比特币相似的指令集来改进比特币字节码，但通过添加跳转、调用和相关指令来消除图灵不完全约束。这些允许非终止递归，以及对代码位置和系统中其他契约的任意控制流。</p><p id="53af" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这对运行在EVM上的程序的表达能力和正确性产生了强大而深远的影响，使这些程序暴露于一整类无法用图灵不完全语言表达的错误和非确定性行为。DAO漏洞提供了一个很好的例子，在这个例子中，攻击者可以在结算余额之前递归地从钱包中提款，在终止之前向他们的帐户中存入数百万。DAO漏洞还利用了可靠的“默认方法”分派模型，这是任何理智的现代VM原则上都禁止的，这显示了将这样的功能留给更高级别的构造的危险。不过，如果EVM在第一个案例中限制了图灵完全性，DAO漏洞就不会发生。</p><p id="7182" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">今天，我们看到Solidity开发生态系统中出现了一些最佳实践，这些实践要求在gas耗尽或者递归被证明终止的情况下有某种终止条件。这是一个用户限制他们自己的指令集的例子；这种情况本可以通过更严格的EVM计算模型来避免。</p><p id="b724" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">相比之下，Pact的设计是图灵不完全的，以防止递归错误和相关的不良使用模式。我们认为，在区块链事务环境中，真正的递归用例的比例非常小，不值得冒安全风险去支持。此外，根据定义，区块链是一个计算受限的环境，这就是为什么需要gas模型，这意味着真正的递归用例将导致无法预测资源使用情况，并且应该正确地离线执行。</p><h2 id="fd9d" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">EVM执行模型昂贵、缓慢且不安全</h2><p id="e182" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">EVM没有处理其执行模型的许多特性和关键组件，迫使语言设计人员手动实现它们。例如，EVM将以下功能留给了语言实现者:</p><ul class=""><li id="64e4" class="lc ld hu je b jf jg jj jk jn le jr lf jv lg jz lh li lj lk dt translated">真正的库支持，而不只是在众所周知的地址祝福调用目标</li><li id="b6b8" class="lc ld hu je b jf ll jj lm jn ln jr lo jv lp jz lh li lj lk dt translated">更丰富的数据类型</li><li id="abff" class="lc ld hu je b jf ll jj lm jn ln jr lo jv lp jz lh li lj lk dt translated">接口/API的直接支持和实施</li></ul><p id="b0c0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">通过这种方式，EVM放弃了真正虚拟机的许多定义功能，如调度、代码自省和标准库的提供，这导致执行环境昂贵、缓慢且不安全。</p><p id="8be3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在EVM中，当执行合同时，EVM采用不透明的“自上而下”执行模型，其中智能合同的整个主体作为不透明的代码块加载，并从第一条指令开始盲目执行，一直运行到终止。相反，像JVM这样的VM理解在特定的名称空间或模块中表达了什么功能，并允许它们被单独加载和直接调用。“自顶向下”模型意味着，当调用外部契约时，EVM必须加载整个契约，以便找到并执行单个函数。</p><p id="164d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">标准库是另一个不受EVM支持的常见虚拟机功能。例如，在JVM中，许多常见的核心函数都存储在随VM分发的标准“rt.jar”库中。如果智能合约能够访问标准库，它们将能够将许多常见任务委托给标准库，而不是直接在智能合约中实现它们。每次执行用户智能合同中的每一条指令的成本迫使开发人员支付大量额外的费用，仅仅是为了建立编写合同所需的基本功能的特权，这使得EVM上的智能合同更加昂贵。内置合同代表了一种不令人满意的变通办法，它可以降低天然气成本，但对改善低效的执行模式毫无帮助。</p><p id="648b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">除了速度慢、费用高之外，在EVM打外线也非常不安全。因为调用协定无法确定哪些协定内引用在其他协定中是有效的，所以在运行时，对于引用不存在或格式错误的引用的引用，绝对没有保护措施。这种现象引发了平价钱包问题，即钱包被称为中央核心契约，随后被删除，锁定了钱包中的资金。同时，DAO hack是一个不安全契约引用的例子，它只为“用户”帐户(EOAs或“外部拥有的帐户”)设计，当被恶意契约帐户调用时，它允许默认方法(莫名其妙地在“发送”方法上执行以进行支付)启动递归利用。</p><p id="3c46" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">相反，Pact提供了一个标准库作为首要原则，提供了Pact作者编写安全有效的契约所需的所有必要工具。此外，Pact永远不会“用完操作码”或内置的契约地址，允许它在需要时加入新功能。因此，gas模型对于本机定义的函数保持良好定义和静态，这允许用户以模块化的方式构建他们的代码，同时仍然保留推理他们代码的功能性以及运行时成本的能力。</p><p id="fa19" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">此外，当契约作者在区块链上调用另一个契约时，特定的功能代码(及其所有可传递的依赖项)被永久地内联在用户的调用点，因此执行不仅很快(代码在直接作用域内)，而且在以后也不可能被破坏，因此更安全。</p><h2 id="a096" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">EVM缺乏本地多签名支持和可升级合同</h2><p id="608e" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">以太坊中的合同和账户是通过地址引用的，地址是某个公钥的散列表示，该公钥天生就有权以提升的特权访问地址。这种设计选择的结果使得以太坊和EVM不允许对多签名认证的本地支持，并且强化了被误导的“代码即法律”的设计选择，使得智能合同永远不能在特定地址升级代码。这确实是EVM缺乏现代调度机制的原因之一，因为如果没有任何基于名称的解决方案，这将是一个比我们今天所面临的更加不透明的系统。然而，缺乏分派和基于名称的解析本质上保证了代码不能被升级，因为没有任何关于地址中包含什么代码的原始表示(如内容散列等)，所以没有办法知道代码是否被升级。</p><p id="e97d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">更糟糕的是，单地址格式本质上迫使EVM中的所有契约都是单签名的，并使用昂贵的内置契约和/或多个事务调用来支持多签名。如果EVM已经分派，则契约可以与抽象名称相关联，这将使签名与契约地址解耦，从而允许契约本身是多重签名的。</p><p id="09e2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">作为这些缺陷的结果，multisig钱包、合同标准和技术的家庭手工业被引入以填补这一空白。代理契约、多重签名验证功能和钱包(如Gnosis或奇偶多重签名)已被引入来提供这一急需的功能，但代价是增加了管理交易的多个地址的费用。相比之下，比特币和随后的Pact从未将它们的设计局限于单一签名方法，从而消除了这种变通方法的动机。事实上，Pact提供了键集作为验证原语，这意味着任何事务都可以选择多sig或单SIG，而不会增加程序员的复杂性。此外，Pact提供了一个适当的调度模型，允许命名的(因此是可升级的)智能契约由单签名或多签名密钥集管理。</p><h2 id="5e24" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">结论</h2><p id="e387" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">EWASM是一种新的努力，旨在为以太坊上的EVM提供一种更安全的替代方案，EVM团队多年来一直在逐步改进EVM。不幸的是，造成EVM不安全和低效用户体验的许多因素无法通过补丁或快速修复来解决，因为它们是EVM设计中深层建筑问题的后果。EVM放弃了比特币字节码优雅的简单性，用户为之付费:它没有为语言开发人员提供安全和可用的执行环境。</p><p id="075d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">虽然这篇文章对EVM提出了批评，但我们并不希望与以太坊的开发者发生冲突，我们尊重他们为推出更安全的电子货币所做的努力。但是，只要电子瓦斯管理没有挑战EVM中的每一个核心概念，它就会遭受类似的命运，就像那些试图采用创新想法和用例的企业和开发商一样，只会在可避免的开发或过高的天然气成本中损失金钱。在Kadena，我们设计了Pact，以一种明显不同的方式来解决区块链的安全性和可用性问题。一种将控制和安全放回到开发人员手中的方法。但是，我们也希望对EVM的缺点有一个清晰的认识，这将丰富整个社会对EVM的理解，以及为了创造一个更美好的未来，电子政务必须纠正什么。</p><figure class="lq lr ls lt fq iv"><div class="bz el l di"><div class="lu lv l"/></div></figure></div></div>    
</body>
</html>