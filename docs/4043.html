<html>
<head>
<title>Domain Fronting in a nutshell</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">简而言之，域名前置</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/domain-fronting-in-a-nutshell-159e21bf23a4#2019-07-08">https://medium.com/hackernoon/domain-fronting-in-a-nutshell-159e21bf23a4#2019-07-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="bb76" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可能已经听说过<a class="ae jp" href="https://en.wikipedia.org/wiki/Domain_fronting" rel="noopener ugc nofollow" target="_blank">域名抢注</a>，尤其是在像<a class="ae jp" href="https://signal.org/blog/looking-back-on-the-front/" rel="noopener ugc nofollow" target="_blank">信号</a>和<a class="ae jp" href="https://www.wired.co.uk/article/telegram-in-russia-blocked-web-app-ban-facebook-twitter-google" rel="noopener ugc nofollow" target="_blank">电报</a>这样的流行信息应用逃避政府审查的背景下</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/ba670063acaa1aa4db94d1ebb4b96edf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9cmfYU6E71dFt8KOa7Gs5A.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">CDNs</figcaption></figure><h2 id="1af5" class="kg kh hu bd ki kj kk kl km kn ko kp kq jc kr ks kt jg ku kv kw jk kx ky kz la dt translated">简要描述</h2><p id="3a95" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">域名前置允许绕过审查，对可能被 DPI、DNS 过滤或 ip 阻止的资源进行审查，在幕后，它依赖于托管多个域的 cdn。无论是 AWS 还是 GCP(主要的 CDN 提供商)都不会再允许这种伎俩被使用了。谷歌声称它在 GCP 从未被支持过，而亚马逊<a class="ae jp" href="https://aws.amazon.com/blogs/security/enhanced-domain-protections-for-amazon-cloudfront-requests/" rel="noopener ugc nofollow" target="_blank">称</a>违反了 AWS 服务条款。</p><h2 id="26d4" class="kg kh hu bd ki kj kk kl km kn ko kp kq jc kr ks kt jg ku kv kw jk kx ky kz la dt translated">域名前置是如何工作的？</h2><blockquote class="lg lh li"><p id="7cf1" class="ir is lj it b iu iv iw ix iy iz ja jb lk jd je jf ll jh ji jj lm jl jm jn jo hn dt translated">域名前置通过使流量看起来像是由一个有效的域名产生的来绕过审查。这种方法是可行的，因为现代 cdn 包含两个相互独立存在的部分。外部部分用于建立与客户端的 SSL 连接，而内部部分在流量解密后处理请求。在这个阶段，重新路由到隐藏的目的地变得可能。</p></blockquote><p id="a5cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在正常情况下，三个请求(DNS、SNI 和 HTTP 主机头)具有相同的主机名。DNS 和 SNI 请求以纯文本形式发送(可能会被审查者跟踪)，而内部 HTTP 流量是加密的。域前置依赖于在 DNS 和 SNI 请求中发送相同的主机，在 HTTP 主机报头中发送不同的被阻止主机。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff ln"><img src="../Images/4c24109a38703122e67502ebfb9c5a98.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*CLoW7Yf9Z1OE2NrlMfG14A.png"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Domain fronting in a nutshell</figcaption></figure><p id="4d59" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如，域 A、域 B 在同一个 CDN 下，并且域 A 在某些国家被阻止，而域 B 没有。将有效的域 B 放在 SNI 报头中，将被阻止的域 A 放在 HTTP 报头中，这是域前置的主要思想。由于 SNI 不是 TLS 协议的加密部分，授权机构可以看到与有效的域 b 建立连接的意图。CDN 读取带有被阻止的域 A 的 HTTP 主机报头，并将请求转发到指定的源(被阻止的域 A)</p><h2 id="e94d" class="kg kh hu bd ki kj kk kl km kn ko kp kq jc kr ks kt jg ku kv kw jk kx ky kz la dt translated">实验</h2><p id="9c12" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">捕捉网络流量的过程是对审查者的模仿。为此，我更喜欢使用 Wireshark 或 ngrep。</p><p id="153c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在一个终端中启动 tshark:</p><blockquote class="lg lh li"><p id="20e5" class="ir is lj it b iu iv iw ix iy iz ja jb lk jd je jf ll jh ji jj lm jl jm jn jo hn dt translated">sudo tshark-T fields-Y ' TCP . dstport = = 443 和 SSL . handshake . extensions _ server _ name '-e SSL . handshake . extensions _ server _ name</p></blockquote><p id="1ab0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在第二个终端中运行以下命令:</p><blockquote class="lg lh li"><p id="2bb7" class="ir is lj it b iu iv iw ix iy iz ja jb lk jd je jf ll jh ji jj lm jl jm jn jo hn dt translated">科尔-斯<a class="ae jp" href="https://github.com" rel="noopener ugc nofollow" target="_blank">https://github.com</a></p></blockquote><p id="dfd6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在第一个终端中，tshark 显示了我们刚刚访问的站点的名称:</p><blockquote class="lg lh li"><p id="606e" class="ir is lj it b iu iv iw ix iy iz ja jb lk jd je jf ll jh ji jj lm jl jm jn jo hn dt translated">github.com</p></blockquote><p id="9f2a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是对上面 cURL 发送的请求的模拟:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lo lp l"/></div></figure><p id="dca8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Tshark 在上面的直播中展示了同样的回应。</p><p id="9985" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在让我们尝试利用域名前置。由于 GCP 和 AWS 禁止这种方法，我们使用 GitHub 页面进行演示。使用 GitHub 页面的网站列表在这里是<a class="ae jp" href="http://(https://www.wappalyzer.com/technologies/github-pages)" rel="noopener ugc nofollow" target="_blank"/>。如上所述，禁止域(从上面的列表中随机选择- <em class="lj"> bulma.io </em>)必须只在 HTTP Host header 中设置，而同一 CDN 下的“有效”域(<em class="lj">GitHub . io</em>domain<em class="lj"/>—GitHub pages)必须在其余地方指定。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lo lp l"/></div></figure><p id="3ff3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它生成的输出证明响应是由“禁止的”资源发送的:</p><blockquote class="lg lh li"><p id="736e" class="ir is lj it b iu iv iw ix iy iz ja jb lk jd je jf ll jh ji jj lm jl jm jn jo hn dt translated"><meta property="”og:url”" content="”https://bulma.io&quot;"/></p></blockquote><p id="26ac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在第一个终端，tshark 显示了<em class="lj">github . io</em>——审查员的“有效”域名。结束了。</p></div><div class="ab cl lq lr hc ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hn ho hp hq hr"><p id="8ccc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有时使用 GitHub 页面的网站也会使用带有受限域名前缀的 cdn。在这种情况下，畴前是不可实现的。</p><p id="a051" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在写这篇文章的时候，有可能使用域名前缀和快速 CDN。使用该 CDN 的网站列表在此处为<a class="ae jp" href="https://www.wappalyzer.com/technologies/fastly" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="cbd8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">与上面的例子类似，我随机选择了<em class="lj"> StackOverflow </em>作为“阻止”域，随机选择了<em class="lj"> NY Times </em>作为“允许”域:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lo lp l"/></div></figure><p id="9376" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">输出:</p><blockquote class="lg lh li"><p id="92f6" class="ir is lj it b iu iv iw ix iy iz ja jb lk jd je jf ll jh ji jj lm jl jm jn jo hn dt translated"><meta property="”og:url”" content="”https://stackoverflow.com/&quot;/"/></p></blockquote><p id="a0da" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在第一个终端中，tshark 显示了<em class="lj">nytimes.com</em>，我们得到了来自<em class="lj"> StackOverflow 的响应。从 nytimes.com<em class="lj">和 Fasty CDN 到 stackoverflow.com</em>的</em>流量被成功地重新路由</p><p id="f386" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Fasty CDN 下的更多有趣的域示例(查看上面的最后一个链接):</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lo lp l"/></div></figure><blockquote class="lg lh li"><p id="5f6b" class="ir is lj it b iu iv iw ix iy iz ja jb lk jd je jf ll jh ji jj lm jl jm jn jo hn dt translated"><meta property="og:url" content="https://imgur.com/"/></p></blockquote><p id="1c94" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">沙克指着 drupal.org</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lo lp l"/></div></figure><blockquote class="lg lh li"><p id="68bc" class="ir is lj it b iu iv iw ix iy iz ja jb lk jd je jf ll jh ji jj lm jl jm jn jo hn dt translated"><meta property="”og:url”" content="”https://giphy.com/&quot;"/></p></blockquote><p id="9b0d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如预期的那样，沙克展示了 apple.stackexchange.com</p></div><div class="ab cl lq lr hc ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hn ho hp hq hr"><h2 id="417a" class="kg kh hu bd ki kj kk kl km kn ko kp kq jc kr ks kt jg ku kv kw jk kx ky kz la dt translated">副作用</h2><p id="b16d" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">cdn 服务于数千个不同的领域。因此，对一个域名的审查可能会破坏许多无害资源的可用性。这发生在一年前的俄罗斯，当时当局试图封锁电报。当局盲目封锁 Telegram 使用的 CDNs 下的所有资源。许多主要和次要的网络服务不可用。这个先例似乎是 GCP 禁止在 AWS 中使用这项技术的真正原因。</p></div></div>    
</body>
</html>