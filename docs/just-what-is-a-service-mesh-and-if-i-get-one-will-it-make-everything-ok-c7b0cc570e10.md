# 什么是“服务网格”,如果我得到了一个服务网格，一切都会好吗？(2019 年 Dockercon 摘要)

> 原文：<https://medium.com/hackernoon/just-what-is-a-service-mesh-and-if-i-get-one-will-it-make-everything-ok-c7b0cc570e10>

凯尔萨斯的乔恩·克里斯滕森和克里斯·希克曼回顾了埃尔顿·斯通曼的 DockerCon 2019 年会议，题为，*什么是“服务网”，如果我得到一个，它会让一切都好吗？*

**展览的一些亮点包括:**

*   埃尔顿对服务网格的定义是:软件组件之间的通信被做成自己的主干，以供组件之间相互交流
*   服务网格是 DNS，但是更高一级；服务发现是微服务的 DNS
*   为什么需要服务网格:API、Web 和数据库服务器之间的连接
*   服务网格架构:软件组件的代理提供对网格的访问
*   服务网格的一般特征包括流量管理、安全性和可观察性
*   何时使用服务网格:众多微服务、雪花实施和云原生应用试点
*   服务网格提供了很多功能，但不是免费的；增加了一层复杂性
*   服务网格备选方案:功能切换、动态 DNS、负载平衡器等。

**链接和资源**

[什么是“服务网格”，如果我得到了一个，它会让一切都好起来吗？](https://www.docker.com/dockercon/2019-videos?watch=just-what-is-a-service-mesh-and-if-i-get-one-will-it-make-ev)

[DockerCon 2019](https://www.docker.com/dockercon/)

[Ruby on Rails](https://rubyonrails.org/)

姜戈

[Kubernetes](https://kubernetes.io/)

[Istio](https://istio.io/)

[数据狗](https://www.datadoghq.com/)

凯尔苏斯

[秘密媒体](https://www.secretstache.com/)

**转录**

里奇:在 Mobycast 的第 61 集，我们回顾了 DockerCon 2019 年的另一场题为“什么是‘服务器网格’，如果我得到一个，它会让一切都好起来吗？”埃尔顿·斯通曼。欢迎来到 Mobycast，这是一个关于云原生开发、AWS 和构建分布式系统的每周对话。让我们直接开始吧。

乔恩:欢迎你，克里斯。又是一集 Mobycast。

克里斯:嘿，乔恩。回来真好。

乔恩:好吧。连续两次。我们缺失的音域有点棘手。我会问你最近在忙什么，克里斯。

克里斯:我很喜欢西雅图的天气。天气晴朗。我想今天差不多要达到 80 度了。我花了很多时间在户外来弥补我们漫长的冬天。这太令人高兴了——看到太阳，感觉到热，穿着短裤，试着不去看下周的天气预报，或者这个被拿走了。

乔恩:是的。这里太糟糕了。这应该是河流冲浪季节的开始，如果你不知道那是什么，就谷歌一下河流冲浪。我为此兴奋不已。现在，流量都下降了，因为当天气变冷时，融化季节的河水流量下降了。他们没有创造一个很好的大浪来冲浪。

克里斯:你需要喷火器或者类似的东西。

乔恩:对。它会融化所有的山。

克里斯:是的。车站和上面的人。

乔恩:我们将在下一集谈论你在多克康看到的另一个非常好的演讲。这可能也是一个两部分。正如我们所说，DockerCon 更关注企业，也可能关注对 Docker 来说有点陌生的人。许多可用的演讲并不是针对那些从 Docker 诞生以来就一直使用它的人的。

我认为，对我来说，我真的很兴奋。我们将讨论服务网格，直到今天我对它才刚刚有所了解。直到半个小时后，我才知道，对于我们的客户和凯尔萨斯的公司来说，没有他们我们可能会过得很好。我希望被证明是错的。也许是时候了。也许它们已经成为某种东西，甚至四个、五个和十几个微服务的用户也可以从服务网格中受益。

我们开始吧，克里斯。我们来谈谈服务网格。

克里斯:对。现在是讨论这个问题的好时机，因为服务网格这个术语已经出现了一段时间。如果你愿意，可以这么说，天气很热。你会听到很多关于它的讨论，而且肯定是关于现在最流行的服务网格，也就是 Istio。我在码头区看过这个演讲。这样去才有意义。会议的标题是，“什么是‘服务网格’，如果我得到一个，它会使一切正常吗？”这是 Docker 的开发人员 Elton Stoneman 给出的。

这次会议的真正好处是，它真正讨论了一般的高级服务网络。内容将涵盖什么是服务网格以及我们为什么需要它们？它们是如何工作的？基本架构是什么？它们能提供什么功能？你应该用一个吗？做这些的成本是多少？这就是我们今天要讨论的内容。为了真正给服务网格一个好的待遇，在此结束时，肯定应该对您在顶部的问题有一个好的想法，“嘿，我们应该为我们的客户使用它吗？”答案是非常明显的。

定义了服务网格之后，这是什么？埃尔顿有他自己的简化定义。他喜欢提到这一点，它是软件组件之间的通信，被制作成它自己的东西。注意，它不是特定于容器的。不是微服务特有的。如果你愿意的话，它只是指这个通信中枢，让这些组件能够相互通信。

Jon:过去的我认为我们曾经称之为中间件，但是没关系。

克里斯:世界上有各种各样的东西，各种不同的技术，我不知道你是否记得，CORBA。

乔恩:是的。这正是我想说的。处理所有的交流。

Chris:这里的区别在于，大多数这些东西不一定会造成网络流量。你可以把服务网络想象成电话总机，是连接电话的电话接线员。有人试着打电话并说，“我想去和这个人说话，”所以接线员正在建立连接。打电话的人不知道该如何建立联系。他们只是要求提出请求。他们知道，如果你愿意，他们有地图。我和他们谈过了。

这就是服务网格相对于对象、请求代理和中间件所做的事情。我认为这更多的是关于互操作性和[…]。应用层中的内容比网络层中的多。这就是服务器的网格所在。

乔恩:好的。有了这样的描述，我想再深入探讨一下。我知道我们会更深入地了解它的实际情况和作用。这让我觉得服务网格有点像 DNS，但更像是你服务的 DNS。

克里斯:这是很大一部分。如果不谈论服务发现，就不能真正谈论服务网格。这是一个很大的话题，也是服务网格将为您提供的内容之一。服务发现基本上是微服务的 DNS，其中有许多许多微服务，并跟踪它们的名称和位置。这成了一个难题。服务发现正在推动并使其更加动态。这肯定是服务网格将有助于促进的事情。

乔恩:好的，这很有帮助。

Chris:我们对服务网格有一个大致的定义。为什么我们需要服务网格？在这次演讲中，我们将浏览这些例子。让我们从一个简单的应用程序开始。我们有一个 web 服务器，它需要与数据库通信。为了做到这一点，你需要知道或者你需要实现一些功能，比如数据库的地址是什么？为什么要连接它？什么是超时？这是怎么回事？这种逻辑。这些都是需要考虑的。它需要得到执行和处理。

如果你只有两个组件，你只需要做一次就完成了。现在，如果您将 API 服务器添加到组合中，会发生什么呢？您有 web 服务器、APS 服务器、数据库服务器，现在，您必须再次开始做同样的事情。比如说 web 服务器和 API 服务器之间的连接，同样的问题，比如地址是什么？我如何连接到它？加密、超时和诸如此类的东西呢？

对于微服务架构，这肯定会很快成为一项难以管理的任务，因为有太多不同的软件、组件和服务，所以会有太多的点对点连接。你拥有所有这些不同的点对点连接。你必须处理所有这些沟通的事情。

乔恩:我有点同意你的观点，但是我又被打断了。我道歉。这就是我的想法。好的，你只要放一个苹果、一个橘子和一根香蕉在外面。你说，“他们都以同样的方式互相交谈，让我们把它抽象出来。”我有点像，“不，他们没有。”它们是苹果、橘子和香蕉。我将有非常不同的规则来重试数据库。我会的，可能是一个 web 服务器要求我的 API 服务器。如果它以某种方式重试，这可能没问题。我当然不会重试。在某些方面，同样的方式，我想，我的数据库。他们之间的交流也不一样。我想，在这一切之下，它是 CCPIP，但我们不只是在我们的 API 服务器和我们的数据库之间编写套接字代码是有原因的。都提升了一个层次。

我很紧张，因为感觉我们将会有一个装满真正分散的东西的袋子，我们将试图使它具有互操作性，或者试图找到所有东西之间的最小公分母，以及它如何有用。

克里斯:有几件事要记住，水果的比喻也一样。在这个特殊的例子中，我确实提到了三个在功能上完全不同的组件。Web 服务器、微服务、API 和数据库服务器。叫苹果，版纳，梨。

然而，在微服务的架构中，你会有很多很多的 API 服务器。它们都是香蕉，不同的品种等等。苹果也是一样，你可以有很多不同的苹果。一些浮雕，一些苹果，等等。你有那个。从那个方面考虑一下。你肯定对事物有分类，所以你可以在高层次上思考，你可能会，“好的，我重试逻辑。这可能是不同的点，我在和一个数据库说话。当它与 restful API 类型的东西对话时，可能没有太大的不同。”如果你愿意，这就像有适用于每一种水果的服务政策。此外，所有这些东西都需要像水、肥料、阳光这样的东西——不管它是哪种水果。

这里有很多共性。有很多重复的地方。有些东西你也可以分类和分组——有很多重叠的地方。这就是服务网格要解决的问题。你不必重复发明轮子，保持你的架构干燥。

乔恩:好的。酷毙了。

Chris:这基本上是为什么服务网格被创建的起源。它确实归结为微服务的架构和许多单个组件的激增，而不是大的整体。点对点的交流增加了，这就成了一个更大的问题。

这是一个讨论服务网格如何工作的好时机，这是一个基本的架构。实际上，这里的关键点是它是软件组件的代理。就在这个领域，服务网格以这种方式工作，对于您拥有的每个组件，您希望成为网格的一部分，将会有一个代理的侧边部署。这个代理基本上可以访问网格。现在，你的软件组件不再直接与其他软件和组件对话，它只与代理对话。代理现在正在实现整个通信主干。

乔恩:好的。你没有做你的，一些东西，比如加密，甚至认证。诸如此类的东西将会存在于你放在任何地方的边车中。

Chris:这取决于您使用的是什么网格，您在应用程序中使用了多少功能，取决于我们所说的是什么，如果是相互 TLS 加密，如证书、身份，肯定可以通过您的网格进行管理。

这绝对是关键所在——

乔恩:对，这有助于事情变得清楚。现在我有了一个可以理解的东西，它连接到我系统中的每一个容器，我可以和它对话。该容器负责从实际运行的容器中获取信息。我明白了。是啊，这很有用。

克里斯:是的。你的软件组件，他们与代理对话。然后，代理与其他代理对话。地址之类的东西，比如我需要与之交谈的这个东西的地址是什么？像超时、重试、加密之类的事情，现在都在代理实现的服务网格中。

现在，由于这种架构，现在您拥有了与应用程序分离的代理。您可以继续向其添加功能。像速率限制这样的事情变得非常容易做。无论如何，您不必对您的应用程序进行任何更改。你只要有一个策略说，“嘿，当这个组件向另一个组件发出请求时，我不会让它比每 60 秒或类似的频率更频繁地发出请求。”

乔恩:酷。

Chris:服务网格给了我们什么一般特征？它实际上可以归结为三大类。我们有交通管理。在交通管理中，这是一个很大的问题，但我们已经讨论过了。这是服务发现，如负载平衡、故障处理、健康检查、重试逻辑。它还可以定制路线，比如错误的注射。你可以做像 A/B 测试和舞台展示这样的事情。所有这些都属于交通管理。这是一个服务网络将带给你的最大好处之一。

服务网格的第二个重要组成部分是安全性。诸如加密、认证、授权之类的事情可以由您的服务网格来涵盖。比如中立的 TLS 加密和完全自动化的证书管理。您的网状网络可以发布、跟踪和轮换用于相互 TLS 的证书。

乔恩:现在，这对我来说变得如此明显。我认为，对于很多刚接触 monoliths 的人来说，monoliths 免费提供的东西，比如你的 Rails 框架或赞高框架会给你所有这些东西，然后你只需要在它上面实现一些特性。现在一切都是分布式的，而且非常小，您仍然需要所有这些特性。你仍然需要你的大框架带给你的所有这些东西。现在，您需要以一种真正分布式的方式使用它。感觉这是服务网在这个巨大的分布式世界中给你的很大一部分回报。

克里斯:对，也许吧。我认为部分原因是微服务架构之类的东西现在已经产生了这些问题。如果它是一个整体，它只是在与数据库对话，那么创建 X509 证书的想法是通过网络进行加密的相互 TLS 加密，并自动轮换这些证书。这不仅仅是交易、负载平衡和定制路由。这些成为我们必须处理的新问题，因为我们有微服务架构。

从这个意义上说，通信比微服务架构要复杂得多。服务网格正试图帮助减轻一些痛苦。

嘿，你好。这是丰富的。请原谅我的突然打断。我们最近突破了 30，000 名听众的内部里程碑。我想花点时间感谢你的支持。我还希望鼓励你去 iTunes 给我们留下评论。积极的反馈和建设性的批评对我们来说都非常重要。告诉我们进展如何，我们将保证每周发布新的剧集。好吧，我们继续吧。

Chris:第三大类服务网状特性是吸收性。这些事情包括监控、日志记录、分布式跟踪以及可视化。你的网可以给你。您可以看到系统内部发生的所有通信，在这些通信中，速度可能很慢或出现问题—故障排除、调试。分布式跟踪成为架构微服务中需要解决的一个关键问题，因为它不再像“哦，我加入这项服务。怎么回事？”并说，“不，你必须沿着这条路走。”这实际上是从服务 A 到 B 到 C 再到 d，你需要把所有这些都考虑进去。这就是分布式跟踪。这也是你的服务网会给你的。

乔恩:好的，酷。我觉得我明白了。我也觉得我已经对事情的发展有了一点头绪，知道我们是否需要这样做。我对未来的预测，对你来说现在哪个问题更难？处理您的所有服务和他们操作服务所需的所有东西，并让他们相互交流，这对您来说更难吗？

Chris:我认为这一切都归结于你的微服务之间的这种通信有多痛苦。如果你有足够多的微服务，那么你需要一个网格。但是如果你真的没有感觉到痛苦，就像我们呼唤的这些功能没有真正对你说话，那么你可能不需要它。

乔恩:对。我就是这个意思。如果您只是部署一些服务，则不需要它。也许你一周最多只部署几次，而你有好的 CICT 可以自动部署它们。对他们来说找到对方并不困难，因为他们只有几个人。他们都有自己的重试和失败规则。监控它们并不困难，因为您可以将它们分别连接到一个监控系统—服务器应用程序监控系统—并在一个控制面板中同时查看它们。然后，感觉服务网格只是增加了另一个你必须照顾和喂养的东西。这就像另一个组件，你必须小心，并确保它正在运行，等等。

克里斯:当然。

Jon:这是一个应用程序，你必须将它部署到集群中，确保它有足够的带宽来接受请求。初始代理必须启动并运行。否则，你的每一项服务都将停止。

克里斯:服务网格不是免费的。它肯定有自己复杂的一层。例如，我们之前提到的 Istio 可能是最受欢迎、最健壮、最成熟的服务网格，它只是在 Kubernetes 集群上进行[…]的标准安装。在这次演讲中，我指出了这一点，仅 Istio 一项服务就花费了 59 个容器。这是在您开始部署任何应用程序之前。

乔恩:太神奇了。

Chris:这一点的另一点是，它实际上有大约 200 万行代码。那里有很多。你可以获得很多功能，但不是免费的。不仅如此，你还必须考虑如何使用它？我该怎么保养？我如何配置它？我如何运行它？所有那些东西。这需要一个学习过程。

我们正在讨论什么时候应该使用服务网格，并明确考虑网格的成本。它有点涉及到你什么时候应该使用它。如果你有很多服务，这又会引起麻烦，比如服务就是一个问题。您确实想做速率限制之类的事情，或者您想做更详细、更精细的路由，或者您想使它更容易，出于安全原因设置一个策略。只有这些服务会与这些服务类型的东西进行对话，这时你就要开始考虑服务网格了。

如果你有雪花实施，你会发现你在每个应用或微服务中重复构建一些功能。这是另一件你应该考虑的事情，服务网状网是摆脱这种情况的一种方式，重新发明轮子。

如果您正在从头开始进行应用程序试点，您也可以考虑服务网格。Greenfield 构建在云原生应用之上，您可能会认为这是一种尝试和熟悉服务网格的方式。如果你有少量的微服务，你可能不需要服务网格。

乔恩:是的。我可能不得不对此表示强烈反对。除非你确定你会非常非常快地从 0 到 60，否则这感觉就像是在一个有限的开发项目中，玩着服务网。此外，尝试发明一些全新的东西。我觉得这有点不对劲。不要把那作为去做某事的时间。这也是超硬的——开发一个前所未有的全新应用。

克里斯:对。我认为 Elton 在这里提出的观点是，如果你要使用它，不要在现有的应用程序上使用它。我们得去改变代码什么的。处理一些事情，从零开始。

乔恩:这是一个非常棘手的问题。当你从零开始，除非你一开始就知道，“好吧，我们要从零开始。这个东西将会有 25 个微服务，它们都需要互相交流。它将拥有数百万用户和追随者。”如果你从第一天起就知道这一点，并且你知道你将需要超级灵活的负载平衡能力、路由管理，所有你从服务网格得到的东西。

也许你是一个 teleco，你正在建立一个新的东西。你知道接下来会发生什么。人们会蜂拥而至，你需要这样，好吧，当然，这可能是你这么做的原因。否则，如果你说，“我不知道人们会不会用这个。我们不确定这是否会成为一件大事。”也许你是一家初创公司，或者你正在一家企业内创建一个新的东西，你不知道人们会对它有什么反应，你知道它会从小处开始。然后，感觉你不应该从那里开始，你应该省去它，以便最大化每个开发人员小时可以获得的特性数量。

然后，你最终会遇到一种情况，你需要它，这似乎是你的开发人员在开发时可以考虑的最重要的功能，向它添加功能就像人们需要能够将它添加到现有的架构中。让我们认真思考一下，因为是架构在成长。他们是遭受服务纠缠的人，这使得你想要有一个服务网格。

看起来不像是这样吗？就像，“哦，糟了！所有东西都倒了。我们有服务纠纷。我们不知道该怎么办。听说 Istio 解决了这个问题，我们去补充吧。”那不是最正常的方式吗？

克里斯:对。其他的一切，就像建筑的大坑。这是架构变革，没有灵丹妙药。在过去的五、六、七年里，我们一直在处理同样的问题，大泥块将它们分解成微服务。你是怎么做到的？只是不要把所有事情都搞砸了。这里也是一样。

乔恩:我只是想更进一步，因为感觉不应该是一回事。你已经有微服务了。你一开始就决定了，你要做微服务。微服务的好处是它们都可以独立部署，从外面看有相同的服务区域，至少它们看起来像小黑匣子，运行在彼此的容器中，可能是一个小集群。在很大程度上，它们不像蛋白质。他们看起来非常相似。看起来关键在于，应该有可能将这些东西放入一个管理系统中，由它来代理。然后，他们会说，“嘿，我太酷了。你在代理我？”就像，“没问题，酷。”没有代理我也很好。我仍然很高兴现在你被代理了。

Chris:这需要付出的努力程度将与你一开始在申请中投入的内容成正比。服务网格为您提供的所有这些东西，如服务发现、相互 TLS、重试逻辑、路由，实际上都取决于您现有的架构——如果您现在有代码更改，您将如何处理。也许甚至像服务发现这样简单的事情，也许你现在正在使用 DNS，现在你需要改变。这就是代码的变化。可能你和其他微服务之间实现了 TLS 加密。现在，您想要利用相互 TLS 并拥有您的服务网格层证书，这就是代码更改。同样的事情发生了，也许你已经做了配额或速率限制，重试逻辑，所有这些。

乔恩:但是很难说出一个问题，因为现在每次我们开始一个新项目，我们都要玩俄罗斯轮盘赌。我们会因为从第一天开始就必须实现服务网格而失去所有的速度，从而扼杀这个项目吗？或者我们会得到一堆速度，得到一堆用户，然后在我们迫切需要服务网格的时候却无法应用时倒下？就像你可以选择你想要的死亡。

克里斯:好消息是，需要服务网格的人是网飞。有点像那个规模。对于大多数人、大多数组织来说，我只是觉得它们不够复杂。这就像，“哦，如果我们没有一个服务网络，我们就会失败。”你可以在没有网格的情况下实现这些。服务网格有多种选择。我们讨论了三件主要的事情，给予交通管理安全性，吸收性。在服务网格之外，所有这些东西都有中介。你想减多少就减多少。你可以做的事情，如功能颠覆或你可以有动态的流量管理 DNS。我们大量使用负载平衡器和基于路径的路由，以及应用负载平衡器和 AWS。如果我们愿意，我们可以轻松地进行 A/B 测试或蓝绿色部署。

可观察性也是如此。你可以去实现工具。甚至去做事，使用托管服务，如 Datadog 或 SignalFx。外面有数百万种这样的服务。有很好的开源工具，如 Prometheus 等。这些问题都是有答案的，并不是全有或全无。

同样，除非你真的要有一个非常大的工程团队，或者你正在创建许多微服务。你只是不能达到那种规模，就像“哦，我需要这个。”

乔恩:对。真的很有趣。这非常有趣，因为正如你所说，我的一部分就像是，如果你花时间在负载平衡器上摆弄路由逻辑，而你有特殊的 DNS，专门处理 DNS 查找的代码行。您拥有未来的[……]您正在手工编码，您拥有所有其他的东西，您也正在配置您的应用程序监控。那感觉像是许多独立的作品。从这个角度来思考它会很有趣，有点像 Istio 是一个大怪兽，但它是一个集中的怪兽，当你玩它时，它可能会有一个相当一致的外观。如果它取代了你必须去不同的地方独自体验的一系列功能，也许有一次，它可能有点像一个超级巨大的学习曲线。一旦你做到了，就像，哇。现在，所有这些都变得简单多了，我会在每个项目中使用它，不管它有多小。

克里斯:对。我敢肯定，你一定有这样的感觉，这样做的人。你完全可以决定进行投资，通过学习曲线，让自己变得非常非常擅长。这是一个非常坚实的基础设施，非常非常强大。有点像 Kubernetes。Kubernetes 是 310 万长度的代码。库伯内特非常非常大。成为 Kubernetes 的专家需要很长的时间。

有点意思。这类事情有点反开发行动。像 Istio 和 Kubernetes 这样的东西，变得如此复杂。开发商不会碰它的。他们不用它。他们不明白。那纯粹是为了行动小组。

乔恩:是的。

Chris:这有点像是再次建立那堵墙，因为这些工具变得越来越复杂，而不是复杂。

乔恩:我完全同意。这是一个伟大的观点。

克里斯:这可能是关于你是否应该在这些事情上加倍下注的另一个好的经验法则。你有行动小组吗？你想有一个行动小组吗？这可能就是你要走的路。

乔恩:非常酷。我认为第二集将会更深入地探讨其中一些是如何工作的。我认为这可能已经足够好了，我们已经从高级架构的角度讨论了它是什么，以及我们是否应该使用它。那么，我们下周会回来，更深入地讨论这个问题。

克里斯:好的。听起来不错。

乔恩:谢谢你，克里斯。

克里斯:谢谢你，乔恩。

亲爱的听众，你坚持到了最后。感谢您抽出时间，并邀请您继续与我们在线交流。这一集，以及显示笔记和其他宝贵的资源可在 mobycast.fm/61.如果你有任何问题或额外的见解，我们鼓励你给我们留下评论。谢谢你，我们下周再见。