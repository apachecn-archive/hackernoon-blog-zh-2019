<html>
<head>
<title>Flow Control for Your Microservices: Migration from Hystrix to Sentinel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微服务的流量控制:从Hystrix迁移到Sentinel</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/flow-control-for-your-microservices-migration-from-hystrix-to-sentinel-fdcdda50917a?source=collection_archive---------23-----------------------#2019-01-15">https://medium.com/hackernoon/flow-control-for-your-microservices-migration-from-hystrix-to-sentinel-fdcdda50917a?source=collection_archive---------23-----------------------#2019-01-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="0909" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">由于没有来自Hystrix的更多更新，阿里巴巴技术团队提议将Sentinel作为替代方案。这是</em> <a class="ae jq" rel="noopener" href="/@alitech_2017/alibaba-open-source-series-6ec06ca2a402"> <strong class="it hv"> <em class="jp">哨兵开源</em> </strong> </a> <em class="jp">系列的一部分。</em></p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/c5ec5592000282124e587975bcbd8c9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_KA49CMGQuNQIoeIyV7Hg.jpeg"/></div></div></figure><p id="c53d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">随着微服务越来越流行，服务之间的稳定性变得越来越重要。微服务系统中广泛使用流量控制、容错、系统负载保护等技术，以提高系统的健壮性，保证业务的稳定性，最大限度地减少因接入流量过大和系统负载过重造成的系统中断。</p><p id="5524" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Hystrix是网飞的一个开源延迟和容错库，最近在其GitHub主页上宣布不再开发新功能。建议开发者使用其他仍然活跃的开源项目。那么有哪些选择呢？</p><p id="faa3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上次我们介绍了Resilience4j和Sentinel: <a class="ae jq" rel="noopener" href="/@alitech_2017/resilience4j-and-sentinel-two-open-source-alternatives-to-netflix-hystrix-d75bc89f3b03">网飞·海斯特里克斯的两个开源替代产品</a></p><p id="7641" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本文将帮助您从Hystrix迁移到Sentinel，并帮助您快速使用Sentinel。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff kd"><img src="../Images/8758d991d37d782f7eae173c0d4a647e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b0XzSo5T72_7RCtdYON1xQ.png"/></div></div></figure><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff ke"><img src="../Images/29df5127e59c82d9208fbb48789e195f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*efFeEbZI2ZQ4G3w2tzgNnQ.png"/></div></div></figure><h1 id="6e27" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">hystrix命令</h1><p id="f2f1" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">Hystrix的执行模型采用命令模式设计，将业务逻辑和回退逻辑封装到一个命令对象中(<code class="eh li lj lk ll b">HystrixCommand</code> / <code class="eh li lj lk ll b">HystrixObservableCommand</code>)。一个简单的例子:</p><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="aaa1" class="lq kg hu ll b fv lr ls l lt lu">public class SomeCommand extends HystrixCommand&lt;String&gt; {</span><span id="4fbb" class="lq kg hu ll b fv lv ls l lt lu">    public SomeCommand() {<br/>        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey("SomeGroup"))<br/>            // command key<br/>            .andCommandKey(HystrixCommandKey.Factory.asKey("SomeCommand"))<br/>            // command configuration<br/>            .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()<br/>                .withFallbackEnabled(true)<br/>            ));<br/>    }</span><span id="2f6d" class="lq kg hu ll b fv lv ls l lt lu">    @Override<br/>    protected String run() {<br/>        // business logic<br/>        return "Hello World!";<br/>    }<br/>}</span><span id="2c1a" class="lq kg hu ll b fv lv ls l lt lu">// The execution model of Hystrix<br/>// sync mode:<br/>String s = new SomeCommand().execute();<br/>// async mode (managed by Hystrix):<br/>Observable&lt;String&gt; s = new SomeCommand().observe();</span></pre><p id="5051" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Sentinel不指定执行模型，也不关心代码是如何执行的。在Sentinel中，您应该做的只是用Sentinel API包装您的代码来定义资源:</p><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="81b3" class="lq kg hu ll b fv lr ls l lt lu">Entry entry = null;<br/>try {<br/>    entry = SphU.entry("resourceName");<br/>    // your business logic here<br/>    return doSomeThing();<br/>} catch (BlockException ex) {<br/>    // handle rejected<br/>} finally {<br/>    if (entry != null) {<br/>        entry.exit();<br/>    }<br/>}</span></pre><p id="ff6b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Hystrix中，定义命令时通常需要配置规则。在Sentinel中，资源定义和规则配置是分开的。用户首先通过Sentinel API为相应的业务逻辑定义资源，然后在需要时配置规则。详情请参考<a class="ae jq" href="https://github.com/alibaba/Sentinel/wiki/How-to-Use" rel="noopener ugc nofollow" target="_blank">文件</a>。</p><h1 id="1ffb" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">线程池隔离</h1><p id="69d2" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">线程池隔离的好处是隔离比较彻底，可以针对一个资源的线程池进行处理，不会影响到其他资源。但缺点是线程数量很大，线程上下文切换的开销非常大，尤其是对于低延迟调用。Sentinel没有提供这么重的隔离策略，而是提供了一个相对轻量级的隔离策略——线程计数流控制作为信号量隔离。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff lw"><img src="../Images/8dd0b1834533e31e7036d95c75cfd6a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WCxAynIBqN3rwe4a342gcA.jpeg"/></div></div></figure><h1 id="bc5a" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">信号量隔离</h1><p id="2808" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">Hystrix的信号量隔离是在命令定义时配置的，例如:</p><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="7261" class="lq kg hu ll b fv lr ls l lt lu">public class CommandUsingSemaphoreIsolation extends HystrixCommand&lt;String&gt; {</span><span id="f496" class="lq kg hu ll b fv lv ls l lt lu">    private final int id;</span><span id="5241" class="lq kg hu ll b fv lv ls l lt lu">    public CommandUsingSemaphoreIsolation(int id) {<br/>        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey("SomeGroup"))<br/>            .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()<br/>                .withExecutionIsolationStrategy(ExecutionIsolationStrategy.SEMAPHORE)<br/>                .withExecutionIsolationSemaphoreMaxConcurrentRequests(8)));<br/>        this.id = id;<br/>    }</span><span id="e17c" class="lq kg hu ll b fv lv ls l lt lu">    @Override<br/>    protected String run() {<br/>        return "result_" + id;<br/>    }<br/>}</span></pre><p id="3c5b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Sentinel中，信号量隔离是作为一种流控制模式(线程计数模式)提供的，因此您只需要为资源配置流规则:</p><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="4e47" class="lq kg hu ll b fv lr ls l lt lu">FlowRule rule = new FlowRule("doSomething") // resource name<br/>    .setGrade(RuleConstant.FLOW_GRADE_THREAD) // thread count mode<br/>    .setCount(8); // max concurrency<br/>FlowRuleManager.loadRules(Collections.singletonList(rule)); // load the rules</span></pre><p id="5460" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您正在使用Sentinel dashboard，您也可以轻松地在dashboard中配置规则。</p><h1 id="eb76" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">断路</h1><p id="a0b7" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">Hystrix断路器支持误差百分比模式。相关属性:</p><ul class=""><li id="6bb8" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated"><code class="eh li lj lk ll b">circuitBreaker.errorThresholdPercentage</code>:门槛</li><li id="77b7" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated"><code class="eh li lj lk ll b">circuitBreaker.sleepWindowInMilliseconds</code>:断路器断开时的睡眠窗口</li></ul><p id="4c8a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如:</p><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="2778" class="lq kg hu ll b fv lr ls l lt lu">public class FooServiceCommand extends HystrixCommand&lt;String&gt; {</span><span id="f6c6" class="lq kg hu ll b fv lv ls l lt lu">    protected FooServiceCommand(HystrixCommandGroupKey group) {<br/>        super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey("OtherGroup"))<br/>            // command key<br/>            .andCommandKey(HystrixCommandKey.Factory.asKey("fooService"))<br/>            .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()<br/>                .withExecutionTimeoutInMilliseconds(500)<br/>                .withCircuitBreakerRequestVolumeThreshold(5)<br/>                .withCircuitBreakerErrorThresholdPercentage(50)<br/>                .withCircuitBreakerSleepWindowInMilliseconds(10000)<br/>            ));<br/>    }</span><span id="a9bc" class="lq kg hu ll b fv lv ls l lt lu">    @Override<br/>    protected String run() throws Exception {<br/>        return "some_result";<br/>    }<br/>}</span></pre><p id="bca4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Sentinel中，您只需要为想要自动降级的资源配置断路规则。例如，对应于上述Hystrix示例的规则:</p><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="8cf2" class="lq kg hu ll b fv lr ls l lt lu">DegradeRule rule = new DegradeRule("fooService")<br/>    .setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO) // exception ratio mode<br/>    .setCount(0.5) // ratio threshold (0.5 -&gt; 50%)<br/>    .setTimeWindow(10); // sleep window (10s)<br/>// load the rules<br/>DegradeRuleManager.loadRules(Collections.singletonList(rule));</span></pre><p id="7825" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您正在使用<a class="ae jq" href="https://github.com/alibaba/Sentinel/wiki/Dashboard" rel="noopener ugc nofollow" target="_blank"> Sentinel仪表板</a>，您也可以在仪表板中轻松配置断路规则。</p><p id="6fc4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了异常比率模式，Sentinel还支持基于平均响应时间和分钟异常的自动断路。</p><h1 id="0f8b" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">注释支持</h1><p id="0aba" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">Hystrix提供注释支持来封装命令并对其进行配置。下面是一个Hystrix注释的示例:</p><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="28a2" class="lq kg hu ll b fv lr ls l lt lu">// original method<br/>@HystrixCommand(fallbackMethod = "fallbackForGetUser")<br/>User getUserById(String id) {<br/>    throw new RuntimeException("getUserById command failed");<br/>}</span><span id="5f27" class="lq kg hu ll b fv lv ls l lt lu">// fallback method<br/>User fallbackForGetUser(String id) {<br/>    return new User("admin");<br/>}</span></pre><p id="af6f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Hystrix规则配置与命令执行捆绑在一起。我们可以在<code class="eh li lj lk ll b">@HystrixCommand annotation</code>的<code class="eh li lj lk ll b">commandProperties</code>属性中配置命令的规则，比如:</p><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="a950" class="lq kg hu ll b fv lr ls l lt lu">@HystrixCommand(commandProperties = {<br/>        @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50")<br/>    })<br/>public User getUserById(String id) {<br/>    return userResource.getUserById(id);<br/>}</span></pre><p id="6d99" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用Sentinel注释类似于Hystrix，如下所示:</p><ul class=""><li id="7ea6" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated">添加注释支持依赖:<code class="eh li lj lk ll b">sentinel-annotation-aspectj</code>并将方面注册为Spring bean(如果使用的是<a class="ae jq" href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba" rel="noopener ugc nofollow" target="_blank"> Spring Cloud Alibaba </a>那么bean会被自动注入)；</li><li id="d53c" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">给需要流量控制和断路的方法添加<code class="eh li lj lk ll b">@SentinelResource</code>注释。您可以在注释中设置<code class="eh li lj lk ll b">fallback</code>或<code class="eh li lj lk ll b">blockHandler</code>功能；</li><li id="01db" class="lx ly hu it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf dt translated">配置规则</li></ul><p id="6979" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">具体可参考<a class="ae jq" href="https://github.com/alibaba/Sentinel/blob/master/sentinel-extension/sentinel-annotation-aspectj/README.md" rel="noopener ugc nofollow" target="_blank">注释支持文档</a>。标记注释的示例:</p><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="c8af" class="lq kg hu ll b fv lr ls l lt lu">// original method<br/>@SentinelResource(fallback = "fallbackForGetUser")<br/>User getUserById(String id) {<br/>    throw new RuntimeException("getUserById command failed");<br/>}</span><span id="66f0" class="lq kg hu ll b fv lv ls l lt lu">// fallback method (only invoked when the original resource triggers circuit breaking); If we need to handle for flow control / system protection, we can set `blockHandler` method<br/>User fallbackForGetUser(String id) {<br/>    return new User("admin");<br/>}</span></pre><p id="f0ec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后配置规则:</p><ul class=""><li id="16fc" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated">通过API(例如<code class="eh li lj lk ll b">DegradeRuleManager.loadRules(rules)</code>方法)</li></ul><pre class="js jt ju jv fq lm ll ln lo aw lp dt"><span id="96c9" class="lq kg hu ll b fv lr ls l lt lu">DegradeRule rule = new DegradeRule("getUserById")<br/>    .setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO) // exception ratio mode<br/>    .setCount(0.5) // ratio threshold (0.5 -&gt; 50%)<br/>    .setTimeWindow(10); // sleep window (10s)<br/>// load the rules<br/>DegradeRuleManager.loadRules(Collections.singletonList(rule));</span></pre><ul class=""><li id="11e3" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated">通过<a class="ae jq" href="https://github.com/alibaba/Sentinel/wiki/Dashboard" rel="noopener ugc nofollow" target="_blank">哨兵仪表盘</a></li></ul><h1 id="de8b" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">集成</h1><p id="5aa2" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">Sentinel拥有与Web Servlet、Dubbo、Spring Cloud和gRPC的集成模块。用户可以通过引入适配器依赖来快速使用Sentinel，并进行简单的配置。如果你之前一直使用春云网飞，你可以考虑迁移到<a class="ae jq" href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba" rel="noopener ugc nofollow" target="_blank">春云阿里</a>。</p><h1 id="bf37" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">动态配置</h1><p id="0452" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">Sentinel为动态规则管理提供了动态规则数据源支持。Sentinel提供的<code class="eh li lj lk ll b">ReadableDataSource</code>和<code class="eh li lj lk ll b">WritableDataSource</code>接口简单易用。</p><p id="a7dd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Sentinel动态规则数据源提供扩展模块，以便与流行的配置中心和远程存储集成。目前支持Nacos、ZooKeeper、Apollo、Redis等多种动态规则源，可以覆盖多种生产场景。</p><p id="edf5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt"><strong class="it hv"><em class="jp">(Original article by Zhao Yihao赵奕豪)</em></strong></p></div><div class="ab cl ml mm hc mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hn ho hp hq hr"><h1 id="8ffe" class="kf kg hu bd kh ki ms kk kl km mt ko kp kq mu ks kt ku mv kw kx ky mw la lb lc dt translated">阿里巴巴科技</h1><p id="01dc" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">关于阿里巴巴最新技术的第一手深度资料→脸书:<a class="ae jq" href="http://www.facebook.com/AlibabaTechnology" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">【阿里巴巴科技】</strong> </a>。Twitter:<a class="ae jq" href="https://twitter.com/AliTech2017" rel="noopener ugc nofollow" target="_blank"><strong class="it hv">【AlibabaTech】</strong></a>。</p></div></div>    
</body>
</html>