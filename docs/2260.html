<html>
<head>
<title>How to download image files in Ruby</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Ruby 中下载图像文件</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-download-image-files-in-ruby-c189ba52fad6#2019-04-08">https://medium.com/hackernoon/how-to-download-image-files-in-ruby-c189ba52fad6#2019-04-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/12a456dc5ac9d6e24c797d3900e08bde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0fOcblm7Q9BSWGH5g7BKZw.png"/></div></div></figure><p id="6f2c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你曾经需要在你的 Ruby 应用程序中下载并保存一个图像吗？请继续阅读，找出方法。</p><h1 id="862b" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">普通的老红宝石</h1><p id="a677" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">下载没有任何依赖关系的文件的最流行的方法是使用标准库<code class="eh ld le lf lg b"><a class="ae lh" href="https://ruby-doc.org/stdlib-2.6.2/libdoc/open-uri/rdoc/OpenURI.html" rel="noopener ugc nofollow" target="_blank">open-uri</a></code>。</p><p id="ea1e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh ld le lf lg b"><a class="ae lh" href="https://ruby-doc.org/core-2.6.2/Kernel.html#method-i-open" rel="noopener ugc nofollow" target="_blank">Kernel#open</a></code>是一种可以用来打开文件、流或进程进行读写的方法。例如，您可以使用以下代码打开一个文件并读取其内容:</p><pre class="li lj lk ll fq lm lg ln lo aw lp dt"><span id="02f9" class="lq kb hu lg b fv lr ls l lt lu">open("./test.txt") do |file|<br/>  puts file.read<br/>end</span></pre><p id="b3b2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh ld le lf lg b">open-uri</code>扩展了<code class="eh ld le lf lg b">Kernel#open</code>，这样它可以像打开文件一样打开 URIs。我们可以用它来下载图像，然后保存为文件。</p><p id="4519" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为此，我们首先需要<code class="eh ld le lf lg b">open-uri</code>，然后使用<code class="eh ld le lf lg b">open</code>方法来访问一个图像 URL。然后，我们可以打开一个文件，将图像的内容写入文件。打开 IRB 并尝试以下操作:</p><pre class="li lj lk ll fq lm lg ln lo aw lp dt"><span id="5a10" class="lq kb hu lg b fv lr ls l lt lu">require "open-uri"<br/><br/>open("https://s3.amazonaws.com/com.twilio.prod.twilio-docs/images/test.original.jpg") do |image|<br/>  File.open("./test.jpg", "wb") do |file|<br/>    file.write(image.read)<br/>  end<br/>end</span></pre><p id="8c83" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在你打开 IRB 的目录中，你会找到你下载的图像。</p><p id="3bfb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是成功的，但这是一个简单的例子。实际上，您可能希望处理潜在的错误，例如丢失图像的 404 错误。另外，使用<code class="eh ld le lf lg b">open-uri</code>还有很多其他潜在的问题。</p><h1 id="84a5" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">open-uri 的问题</h1><p id="1165" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">问题是，像这样使用<code class="eh ld le lf lg b">open-uri</code>并不理想。首先，上面的代码不是很有效，它将整个图像加载到内存中，然后写入磁盘。原来<code class="eh ld le lf lg b">open-uri</code>还有一些其他的怪癖。<a class="ae lh" href="https://twin.github.io/improving-open-uri/" rel="noopener ugc nofollow" target="_blank"> Janko Marohni 在<a class="ae lh" href="https://github.com/shrinerb/shrine" rel="noopener ugc nofollow" target="_blank">神社</a>工作时发现了一堆这样的问题</a>。值得注意的是，<code class="eh ld le lf lg b">open-uri</code>:</p><p id="b6e2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了解决这一切，Janko 创造了<code class="eh ld le lf lg b"><a class="ae lh" href="https://github.com/janko/down" rel="noopener ugc nofollow" target="_blank">Down</a></code> <a class="ae lh" href="https://github.com/janko/down" rel="noopener ugc nofollow" target="_blank">宝石</a>。它可以让您避免这些问题，安全有效地下载文件。</p><h1 id="380d" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">使用<code class="eh ld le lf lg b">Down</code> gem 改善下载</h1><p id="9307" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">让我们使用<code class="eh ld le lf lg b">Down</code>下载相同的图像。从安装 gem 开始:</p><pre class="li lj lk ll fq lm lg ln lo aw lp dt"><span id="2f83" class="lq kb hu lg b fv lr ls l lt lu">gem install down</span></pre><p id="02d4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们可以使用<code class="eh ld le lf lg b">Down.download</code>将图像下载到<code class="eh ld le lf lg b"><a class="ae lh" href="https://docs.ruby-lang.org/en/2.6.0/Tempfile.html" rel="noopener ugc nofollow" target="_blank">Tempfile</a></code>:</p><pre class="li lj lk ll fq lm lg ln lo aw lp dt"><span id="329a" class="lq kb hu lg b fv lr ls l lt lu">require "down"<br/><br/>tempfile = Down.download("https://s3.amazonaws.com/com.twilio.prod.twilio-docs/images/test.original.jpg")</span></pre><p id="8d7d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你想把这个文件保存到文件系统中，<code class="eh ld le lf lg b">Down</code>有一个选项。将目录作为<code class="eh ld le lf lg b">:destination</code>选项传递会将文件保存到该目录。</p><pre class="li lj lk ll fq lm lg ln lo aw lp dt"><span id="7efc" class="lq kb hu lg b fv lr ls l lt lu">require "down"<br/><br/>Down.download(<br/>  "https://s3.amazonaws.com/com.twilio.prod.twilio-docs/images/test.original.jpg",<br/>  destination: "./"<br/>)</span></pre><p id="e6ee" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将给下载的文件一个由<code class="eh ld le lf lg b">Tempfile</code>生成的随机名称。如果你想从 URL 中保留文件名，你需要做更多的工作。在这种情况下，我们可以将文件下载到一个<code class="eh ld le lf lg b">Tempfile</code>中，然后将它移动到我们硬盘上的一个永久位置。</p><p id="a3a4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为此，我们将使用<code class="eh ld le lf lg b"><a class="ae lh" href="https://ruby-doc.org/stdlib-2.6.2/libdoc/fileutils/rdoc/FileUtils.html" rel="noopener ugc nofollow" target="_blank">FileUtils#mv</a></code>,它有两个参数，文件名和我们要将它移动到的目的地。为了获得文件的原始名称，<code class="eh ld le lf lg b">Down</code>返回的<code class="eh ld le lf lg b">Tempfile</code>对象有一个我们可以使用的<code class="eh ld le lf lg b">original_filename</code>方法。</p><pre class="li lj lk ll fq lm lg ln lo aw lp dt"><span id="7adb" class="lq kb hu lg b fv lr ls l lt lu">require "down"<br/>require "fileutils"<br/><br/>tempfile = Down.download("https://s3.amazonaws.com/com.twilio.prod.twilio-docs/images/test.original.jpg")<br/>FileUtils.mv(tempfile.path, "./#{tempfile.original_filename}")</span></pre><p id="bc9e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我们已经安全有效地下载了文件，并将其永久存储在我们的硬盘上。</p><h1 id="7ce1" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">高级用法</h1><p id="f717" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated"><code class="eh ld le lf lg b">Down</code>也采用了一堆其他选项来控制下载体验。默认情况下，它只允许 2 次重定向，但是你可以用<code class="eh ld le lf lg b">max_redirects</code>选项来控制。您也可以使用<code class="eh ld le lf lg b">max_size</code>选项限制文件的大小。这将阻止攻击者通过下载大量图像来占用您的服务器。如果您想下载一个大小不超过 5MB、最多包含 5 个重定向的文件，您可以使用:</p><pre class="li lj lk ll fq lm lg ln lo aw lp dt"><span id="dfff" class="lq kb hu lg b fv lr ls l lt lu">Down.download(<br/>  "https://s3.amazonaws.com/com.twilio.prod.twilio-docs/images/test.original.jpg",<br/>  max_redirects: 5,<br/>  max_size: 5 * 1024 * 1024<br/>)</span></pre><p id="b83c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">文档中还有<a class="ae lh" href="https://github.com/janko/down" rel="noopener ugc nofollow" target="_blank">更多选项，包括如何将文件流下来，将 gem 的后端从<code class="eh ld le lf lg b">open-uri</code>和<code class="eh ld le lf lg b">Net::HTTP</code>改为</a><a class="ae lh" href="https://github.com/janko/down#httprb" rel="noopener ugc nofollow" target="_blank"> HTTP.rb </a>或<a class="ae lh" href="https://github.com/janko/down#wget-experimental" rel="noopener ugc nofollow" target="_blank"> Wget </a>。</p><h1 id="1544" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">后续步骤</h1><p id="bac0" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">在这篇文章中，我们看到了如何使用<code class="eh ld le lf lg b">open-uri</code>和<code class="eh ld le lf lg b">Down</code>下载图片。<code class="eh ld le lf lg b">Down</code>要安全得多，因为它使我们避免了无限的重定向循环和远程代码注入，而且它对用户更加友好，因为它总是返回一个<code class="eh ld le lf lg b">Tempfile</code>，让我们可以轻松地限制文件大小。</p><p id="972a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你可以用它来从 Twilio MMS 或 WhatsApp messages 下载媒体，或者用 Rails 中的 T2 活动存储为用户上传图片提供更多选择。</p><p id="2d17" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你在 Ruby 中使用过其他下载图片的方法吗？请在下面的评论中或者在推特上告诉我，地址是<a class="ae lh" href="https://twitter.com/philnash" rel="noopener ugc nofollow" target="_blank"> @philnash </a>。</p></div><div class="ab cl lv lw hc lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hn ho hp hq hr"><p id="38d1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="mc">原载于</em><a class="ae lh" href="https://www.twilio.com/blog/download-image-files-ruby" rel="noopener ugc nofollow" target="_blank"><em class="mc">www.twilio.com</em></a><em class="mc">。</em></p></div></div>    
</body>
</html>