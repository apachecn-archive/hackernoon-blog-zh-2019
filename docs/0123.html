<html>
<head>
<title>Kotlin-Spring Boot: Gotchas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">科特林-Spring Boot:明白了</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/kotlin-spring-boot-gotchas-e267be7ec022#2019-01-06">https://medium.com/hackernoon/kotlin-spring-boot-gotchas-e267be7ec022#2019-01-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/d180e60cfd381659aa8d21eb22278f88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*335G-wr9wfI3LlBYgndkLw.png"/></div></div></figure><p id="af9b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">自从我们在我目前工作的公司采用 Kotlin 作为我们的后端服务以来，已经有大约 6 个月了。我们一直在将现有的 java spring boot 服务迁移到 Kotlin。</p><p id="5394" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们在科特林的经历大多很棒。但有时确实感觉 Spring 是为了支持 Kotlin 而改造的。有一些基本问题，比如:</p><ol class=""><li id="a492" class="ka kb hu je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">Spring 要求打开带注释的类，默认情况下 Kotlin 中的所有类都是关闭的。这可以通过在 gradle 配置中添加<code class="eh kj kk kl km b"><strong class="je hv">kotlin-spring</strong></code>插件来解决。</li><li id="5bbe" class="ka kb hu je b jf kn jj ko jn kp jr kq jv kr jz kf kg kh ki dt translated">Hibernate 实体需要一个无参数的构造函数，Kotlin 提供了一个编译器插件<code class="eh kj kk kl km b"><strong class="je hv">kotlin-jpa</strong></code>来为类生成一个额外的零参数构造函数。</li></ol><p id="504e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">需要注意的是，这些问题已经被发现，项目是使用<a class="ae ks" href="http://start.spring.io/#!language=kotlin" rel="noopener ugc nofollow" target="_blank"> start.spring.io </a>生成的，这些插件已经嵌入到您的配置中。在进一步阅读部分会有更多的细节。</p><h2 id="88bf" class="kt ku hu bd kv kw kx ky kz la lb lc ld jn le lf lg jr lh li lj jv lk ll lm ln dt translated"><strong class="ak"> Spring DTO @NotNull 验证</strong></h2><p id="89ae" class="pw-post-body-paragraph jc jd hu je b jf lo jh ji jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz hn dt translated">让我们用一个简单的 DTO 来表示一个用于创建一个人的 HTTP 请求体，其中我们期望<code class="eh kj kk kl km b">name</code>和<code class="eh kj kk kl km b">age</code>为<strong class="je hv"> <em class="lt">而非空</em> </strong>。我们使用<code class="eh kj kk kl km b"><em class="lt">javax</em></code> <em class="lt">的</em> <code class="eh kj kk kl km b">@NotNull</code>注释来验证请求字段，我们已经将其定义为不可空。</p><figure class="lu lv lw lx fq iv"><div class="bz el l di"><div class="ly lz l"/></div></figure><p id="07ad" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于以下请求:</p><pre class="lu lv lw lx fq ma km mb mc aw md dt"><span id="e6d6" class="kt ku hu km b fv me mf l mg mh">{<br/>    "age": 20,<br/>    "description": "person with no name"<br/>}</span></pre><p id="1cfe" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们预计在<code class="eh kj kk kl km b">name</code>字段上会有一个验证错误，但是它通过了 DTO 上指定的验证器。</p><h2 id="9df1" class="kt ku hu bd kv kw kx ky kz la lb lc ld jn le lf lg jr lh li lj jv lk ll lm ln dt translated">为什么？</h2><p id="05a9" class="pw-post-body-paragraph jc jd hu je b jf lo jh ji jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz hn dt translated"><code class="eh kj kk kl km b">javax</code>验证器需要一个对象的实例才能验证它。由于字段被声明为不可空的，<code class="eh kj kk kl km b">jackson-module-kotlin</code>根据字段的类型为其提供默认值。在<code class="eh kj kk kl km b">name(String)</code>的情况下，它将其设置为空字符串，或者在<code class="eh kj kk kl km b">age(Int)</code>的情况下设置为<code class="eh kj kk kl km b">0</code>。</p><h2 id="3342" class="kt ku hu bd kv kw kx ky kz la lb lc ld jn le lf lg jr lh li lj jv lk ll lm ln dt translated">可能的变通办法</h2><ol class=""><li id="578a" class="ka kb hu je b jf lo jj lp jn mi jr mj jv mk jz kf kg kh ki dt translated">基于您的用例，考虑该值成为验证中的默认值的可能性。针对可能的违约进行验证。</li></ol><figure class="lu lv lw lx fq iv"><div class="bz el l di"><div class="ly lz l"/></div></figure><p id="b315" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这确保了名称字段至少有一个字符，并且在空字符串上验证失败。类似地，对于年龄，它可以被指定为至少具有值 1。</p><p id="f2d7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">2.为<code class="eh kj kk kl km b">jackson-module-kotlin</code>启用<code class="eh kj kk kl km b">DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES</code>可以在反序列化期间构造对象时抛出错误。这些不同于验证错误，必须进行相应的处理。</p><p id="b70c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我看来，前一种方法更可取，因为除了它仍然会抛出验证错误之外，它还允许您为验证指定更具表达性的条件，从而使它更具可读性。</p><h2 id="bd25" class="kt ku hu bd kv kw kx ky kz la lb lc ld jn le lf lg jr lh li lj jv lk ll lm ln dt translated">Spring 不支持协程</h2><p id="42e5" class="pw-post-body-paragraph jc jd hu je b jf lo jh ji jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz hn dt translated">在 Kotlin 版本 1.3 中，协程变得稳定了。然而，它们仍然不支持开箱即用。</p><h2 id="c4f5" class="kt ku hu bd kv kw kx ky kz la lb lc ld jn le lf lg jr lh li lj jv lk ll lm ln dt translated">为什么？</h2><p id="3aca" class="pw-post-body-paragraph jc jd hu je b jf lo jh ji jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz hn dt translated">Spring framework 的调度程序不支持 Kotlin 编译器为<strong class="je hv">协程</strong>生成的构造。Kotlin 编译器为<code class="eh kj kk kl km b"><strong class="je hv">suspended</strong></code>函数生成一个<code class="eh kj kk kl km b"><strong class="je hv">Continuation</strong></code>参数，Spring 没有内置的处理程序。</p><h2 id="f0a3" class="kt ku hu bd kv kw kx ky kz la lb lc ld jn le lf lg jr lh li lj jv lk ll lm ln dt translated">可能的解决方案</h2><p id="c00e" class="pw-post-body-paragraph jc jd hu je b jf lo jh ji jj lp jl jm jn lq jp jq jr lr jt ju jv ls jx jy jz hn dt translated">多亏了<a class="ae ks" href="https://github.com/konrad-kaminski" rel="noopener ugc nofollow" target="_blank"> Konrad </a>的努力，通过使用<a class="ae ks" href="https://github.com/konrad-kaminski/spring-kotlin-coroutine" rel="noopener ugc nofollow" target="_blank"> spring-kotlin-coroutine </a>可以在 Spring 中使用协程。该库提供了一些模块来支持 Spring 中不同应用程序/域的协同程序。</p><p id="eb28" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或者只是利用 Spring 自带的<a class="ae ks" href="https://spring.io/guides/gs/async-method/" rel="noopener ugc nofollow" target="_blank"> @Async executors </a>。</p><p id="6796" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Spring 正在努力为协程提供更多的本地支持。它的状态在这里被跟踪。<a class="ae ks" href="https://jira.spring.io/browse/SPR-15413" rel="noopener ugc nofollow" target="_blank">https://jira.spring.io/browse/SPR-15413</a></p></div><div class="ab cl ml mm hc mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hn ho hp hq hr"><h1 id="01c8" class="ms ku hu bd kv mt mu mv kz mw mx my ld mz na nb lg nc nd ne lj nf ng nh lm ni dt translated">进一步阅读</h1><ul class=""><li id="9354" class="ka kb hu je b jf lo jj lp jn mi jr mj jv mk jz nj kg kh ki dt translated"><a class="ae ks" href="https://github.com/FasterXML/jackson-module-kotlin/issues/130" rel="noopener ugc nofollow" target="_blank">https://github . com/faster XML/Jackson-module-kot Lin/issues/130</a></li><li id="8cfc" class="ka kb hu je b jf kn jj ko jn kp jr kq jv kr jz nj kg kh ki dt translated"><a class="ae ks" href="https://kotlinlang.org/docs/reference/compiler-plugins.html" rel="noopener ugc nofollow" target="_blank">https://kotlinlang.org/docs/reference/compiler-plugins.html</a></li><li id="c1b6" class="ka kb hu je b jf kn jj ko jn kp jr kq jv kr jz nj kg kh ki dt translated"><a class="ae ks" href="https://www.youtube.com/watch?v=WO6d6nWg6Zk" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=WO6d6nWg6Zk</a></li></ul><p id="635a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">希望你喜欢读这篇文章，就像我喜欢写这篇文章一样。 <br/> <em class="lt">你是否认为这样会对某人有所帮助？不要犹豫分享。如果你喜欢，点击下面的</em> <strong class="je hv"> <em class="lt">拍拍</em> </strong> <em class="lt">，这样其他人会在媒体上看到。别忘了在博客后用</em> <strong class="je hv"> <em class="lt">来表达爱意！</em> </strong></p></div></div>    
</body>
</html>