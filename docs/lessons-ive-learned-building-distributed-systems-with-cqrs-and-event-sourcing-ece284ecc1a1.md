# 利用 CQRS 和事件源构建分布式系统的经验教训

> 原文：<https://medium.com/hackernoon/lessons-ive-learned-building-distributed-systems-with-cqrs-and-event-sourcing-ece284ecc1a1>

![](img/739bc150ebe72b874474e44fa9adcf99.png)

几年前，我有了一个想法，或者更确切地说是一种动力。甚至可能是一种痴迷。我想在开发中建立效率的圣杯。不需要对每个人都这样。我想让它属于我。

我想构建由简单服务组成的高度可伸缩的容错系统，这些系统是可维护的、可扩展的、经得起时间考验的，更重要的是——易于人类理解。

我希望我的服务易于测试，并且我不想考虑它们在生产中是如何运行的。

我希望我自己和我的队友能够快速交付高质量的代码。当代码交付得更快时，这意味着您的业务可以更快地进行试验，因此，可以更快地找到成功的想法。

这基本上是《精益创业》这本书的全部观点。

建造。测量。学习。重复一遍。从初创企业到企业，都是如此。

要想赢，你需要建立、测量、学习、重复、重复、再重复。

它给了我们的企业竞争优势。

希望这意味着每个人都赚更多的钱，这意味着我们(或者可能是我)可以专注于我们真正想要的东西:享受生活、攀岩、旅行、写作、与我美丽的女朋友共度时光，老实说，可能还会编程...或者太多。

然而，我们不能只是更快。我们不能牺牲质量。

我们的代码基本上支持所有的东西，而且所有的东西不可能一直被破坏！尤其是我在海边的时候！

事实证明，这样的事情说起来容易做起来难。阅读领域驱动设计并了解它在实践中到底意味着什么并不容易。

我曾听别人开玩笑说，花在理解和运用 DDD 技术上的时间相当于获得一个博士学位。

我第一次读 DDD 是在 2007 年，当时我是大学二年级学生。我甚至不能说我现在是 DDD 专家——然而，有一些来自 DDD 的真正有用的概念，而且，今天的语言比 2003 年写这本书及其例子时更加强大和富有表现力。

直到几年后的现在，我才明白如何做好这件事。更重要的是，我已经使用这些技术运行了几个生产系统，并将我在这个问题上的观点和方法正式化，这样我就可以与他人分享我所学到的东西了！

我的观点是:这很复杂，但主要是因为信噪比。

有一大堆噪音。除了建模问题，这仍然留下了数百个库和方法来构建微服务，因为它基本上意味着“一个真正小而集中的服务”。

我想成为噪音中最强的信号，你可以跟随它走向成功。

此外，仅仅拥有一堆服务就意味着一大堆新的令人头疼的问题！

更多要测试的服务！
更多要测试的集成！
更多部署要部署！
要供应更多的数据库！
更多缓存将失效！
万事多！

制作简单服务的行为使您的架构和操作变得更加复杂。

确实如此。

事情就是这样的。

然而…

[这并不意味着它需要复杂。](https://hackernoon.com/complicated-patterns-arent-always-that-complicated-usually-it-s-the-simple-ones-that-bite-you-caf870f2bf03)

快速类比:有人记得 CSS 滑动门技术吗？

那是在 CSS 很糟糕的时候，需要大约 100 行代码来制作圆角。

这是一行代码。

随着时间的推移，事情往往会变得更容易。

然而，仍然很难就如何构建微服务达成共识！

但是不要担心，我在这里将指导你三个关键领域，这将帮助你对付多头野兽。

# 1.了解更多设计模式！

软件工程的下一件事就是永远站在前人的肩膀上。没有成千上万工程师的头脑和思想，下一套思想和模式就不可能出现。

如果你已经不喜欢模式了，那么，我很惊讶你是一个工程师！如果你遇到一个问题，很可能有人已经解决了它，或者至少解决了它的一部分。

设计模式对于构建高度可伸缩的、容错的、对人友好的系统是必不可少的！

在我每天的工作中，我总是使用各种各样的模式！我想到了几个很棒的模式:事件源、存储库模式、单例、工厂、CQRS、断路器、POJOs 等等！

除了经典模式之外，在我多年的工作中，我还遇到了一些“微服务”模式，它们有助于从更高层次的角度考虑为企业设计大型系统。

没有比经典的“蓝皮书”更好的资源来帮助你了解这些概念。如此受欢迎，以至于其他工程师会知道你在说什么:[领域驱动设计:解决软件核心的复杂性:Eric Evans](https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215) 。

就微服务具体模式而言，下面是我最常用的几种:[这五种微服务模式会让你成为更好的工程师。](https://hackernoon.com/learning-these-5-microservice-patterns-will-make-you-a-better-engineer-52fc779c470a)

继续前进…

## 2.物品很重要，但你知道什么也很重要吗？事件和命令。

命令是事情发生的方式。事件就是已经发生的事情。

命令和事件都是消息。

实体是事件发生的地方。聚合是相关实体的集合。

事实证明，所有这些事情都非常非常重要。

通常，当关注 OO 原则时，你会听到人们谈论实体，也许是集合，但是事件和命令却丢失了！当您只是用新状态更新数据库时，这甚至更糟。你模拟的所有世界历史都会随着每一次`UPDATE`而丢失。

我觉得很悲哀。😢

在人们理解这一点之前，ORM 很流行，被一些人称为“计算机科学的越南”。我们没有用 ORM 赢得战争。

> [计算机科学的越战 Ted Neward 的博客](http://blogs.tedneward.com/post/the-vietnam-of-computer-science/)
> 
> [对象关系映射是计算机科学的越南](https://blog.codinghorror.com/object-relational-mapping-is-the-vietnam-of-computer-science/) [](http://blogs.tedneward.com/post/the-vietnam-of-computer-science/)[编码恐怖](https://blog.codinghorror.com/object-relational-mapping-is-the-vietnam-of-computer-science/)

多年来，许多领域驱动设计的支持者发展了他们的思维，不再关注名词，并开始迎来一个事件的新时代。查看格雷格·杨、乌迪·达汗和里纳特·阿卜杜拉林的作品。甚至谷歌的“DDD”组最终也更名为 CQRS/ES+AR(命令查询责任分离，事件源基于聚合根)！

事件是分布式系统的语言……也是生活的语言。

在对世界建模时，您还需要对世界的事件和命令建模。事件和命令作为分布式系统的语言确实工作得很好。

当我想象系统时，我喜欢想象纸质表格被填写并在人类参与者之间传递，这本质上是一个分布式系统，也是一种考虑最终一致性的简单方法。

`inventory.product.catalog`收益率`inventory.product.cataloged`

```
bus.on(‘inventory.product.cataloged’, reactToTheFactThatThisEventHappened)`
```

在此基础上，我还想引入一个非常简单的数学方程:

```
state = leftFold([…previousEvents])
```

该状态是先前事件的左折叠。

对于那些说 JavaScript 的人来说:

```
const eventsourcing = (events, snapshot = {}) =>   
  events
     .reduce((state, event) =>
        Object.assign({}, state, event.payload), snapshot)
```

对于您的领域来说，这些事件是规范化的、不变的事实来源。

因此，当前状态是通过顺序地将事件一个接一个地应用来获得的。

如果你知道在你的世界子集里发生的每一件事——你是有限的——那么你就能决定那个世界的状态。

这里有一个简单的人为的例子——想象你正在建造一个机器人，它可以把物品放在桌子上。

该表可以是您的**聚合**。

你现在正在使用桌子吗？可能是一台笔记本电脑，或者一个电视遥控器。

这种情况下的**背景**就是眼前的问题。我们想知道桌子上有什么东西，新东西可以放在什么地方。我们的模型只需要包含与该任务相关的信息。

您可以想象，如果您正在为一个仓库编写软件，您对什么是表以及您将关注什么信息的想法可能会非常不同。

背景很重要。在 DDD，这就是埃文斯所说的**有界语境**。

无论如何，继续这个例子…

让我们命令机器人把一个球放在桌子上。

为此，我使用了一个名为“ [servicebus](https://github.com/mateodelnorte/servicebus) 的库。Servicebus 真的很酷，因为它允许您对事件使用中间件，因此您可以轻松地添加 Redis 支持的重试或重复数据删除逻辑，或者毫不费力地进行跟踪。它最初是建立在 RabbitMQ 上的，但是我一直在开发一个支持原始插件的 Kafka 版本。

```
bus.send('table.item.place', { 
  type: 'ball',
  properties: { color: 'red' },
  position: { top: 1, left: 1, unit: 'inch' }
}
```

当它发生时，机器人可以自信地宣布“我把球放在桌子上了！它的位置距离顶部 1 英寸，距离左侧 1 英寸！”

它发生了。

它不可能不发生。

这是不可改变的事实。球被放在桌子上。句号。

让我们让世界上的其他人知道，这样他们就可以在订阅的情况下对事件做出响应。

```
bus.publish('table.item.placed', { item })
```

现在，我要强调的是，这一事件的发生是不可改变的事实。

报纸已经出版了，送出门了！

如果你想撤销它，你唯一的选择是另一个命令— `table.item.remove`

这将导致事件`table.item.removed`在成功完成时被发布。

如果您是第三方，看不到该表，但您订阅了关于该表的不可避免的事件，则您可以确定该表的当前状态。

一个球被放在桌子上，然后拿走了。当前状态是一个空表。

这种基于事件的架构被称为“最终一致”系统。

球一放在桌子上，第三方不会立即知道，但是，它会收到一条消息，说明事件已经发生。一旦收到消息，接收者就可以确定表的新状态。

这也是一种非常流行的模式。很大程度上是因为 CAP 定理，它代表一致性、可用性和分区容差。规则是你只能选两个。系统的不同部分可以针对不同的目标进行优化，系统通常会牺牲一致性。

例如，如果你直到 23 秒后才知道比利发布了那个 rad new Instagram，那也没关系。你最终会明白的。

尽管我多年来一直在构建这样的服务，但最近它又掀起了一轮“事件驱动架构”的潮流。

它离 CQRS 也只有一步之遥。您所需要的只是订阅一些事件流，并创建一个适合手边应用程序的数据的**投影**。这个过程被称为反规范化，因此我把做这个的服务称为“反规范化器”。

> 这让我想起了一个有趣的故事:有一次，在我闲逛的时候，有人问起 CQRS，我不小心写了“道德败坏者”。他就像“真的有一种东西叫做道德败坏者”一样。🤣

帮你自己一个忙，读一读这篇 2012 年的相关文章:[日志:每个软件工程师都应该知道的实时数据的统一抽象| LinkedIn 工程](https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying)作者:[Jay kre PS](https://medium.com/u/73c856c7a485?source=post_page-----ece284ecc1a1--------------------------------)Kafka 的联合创始人。

## 3.自动化您的运营和基础架构

devo PS——开发和运营的交集——正在复兴。

正如我前面提到的，随着服务的简化，一些复杂性必然会转移到您的操作和架构中。

我知道我想要构建高度可伸缩的容错系统，这些系统由简单的服务组成，可维护、寿命长、可扩展，并且易于人类理解。

我知道微服务和领域驱动的设计模式将允许我实现所有这些目标，并允许我自己和我的团队持续地交付能够经受时间考验的高质量代码。

然而，在生产中运行它们被证明是一项非常艰巨的任务。

我刚到 DevOps，甚至不知道从哪里开始。

在谷歌上搜索后，我遇到了大量的 AWS 课程，有五种不同级别的认证，每一种都需要几个月的时间和数百美元的课程。

这不是一个小订单。我知道事实上的标准是成为 AWS 解决方案架构师…问题是，这是 AWS 的第 5 级认证，在此之前，我基本上只部署到像 Heroku 和 Modulus 这样的 PaaS 提供商，或者其他人处理过 DevOps。

所以，最终在花了几年时间搞清楚了 DDD 和 CQRS/ES+AR 的事情之后，我仍然不得不成为另一个完全不同的学科领域的专家，以便能够有效地做这件事。

还记得我说过的那些 CSS 滑动门吗？在 HTML 和 CSS 中制作一个带圆角的标签大约需要 100 行代码。

幸运的是，随着时间的推移，事情变得越来越简单。

和 DevOps 在一起变得比以往任何时候都危险。阅读[我的 DevOps 幸福之旅，没有无用的 AWS 认证](https://hackernoon.com/my-journey-to-achieving-devops-bliss-without-useless-aws-certifications-a7cbf7c539d1)并确保在结束时获得为期三周的免费电子邮件课程！

# 结论

今天就到这里吧！感谢阅读。如果你有任何问题，或者你觉得这很有帮助，我很乐意在评论中听到你的想法。

帮助我联系他人的最佳方式是点击并按住鼓掌按钮或在社交媒体上分享！

最好，
[李雅达·斯科特](https://twitter.com/pat_scott)

jrn andréMyrland 在评论中提出了一个很好的问题——请务必查看我的答案，以获得更好的更高水平的图片。