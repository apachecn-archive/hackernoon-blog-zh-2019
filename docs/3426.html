<html>
<head>
<title>Real-time Object Detection API using Amazon SageMaker and Amazon API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Amazon SageMaker 和 Amazon API Gateway 的实时对象检测 API</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-realtime-object-detection-api-with-amazon-sagemaker-and-amazon-api-gateway-c9f62a9fd69a#2019-06-03">https://medium.com/hackernoon/building-realtime-object-detection-api-with-amazon-sagemaker-and-amazon-api-gateway-c9f62a9fd69a#2019-06-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/3e04a0b44829d746749e77b8ac92a9d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z-Aj-KiTsxernAa5CwfcWw.jpeg"/></div></div></figure><p id="9ec1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">亚马逊 SageMaker 是一个端到端的机器学习(ML)平台。它支持在云端训练和托管机器学习模型。以下是 SageMaker 程序的概述。</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ka"><img src="../Images/5e4b8be48e8b515523771ee17646f415.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iAgXKalsx2yj0aYAz99SyQ.png"/></div></div></figure><p id="ff9c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">通过使用 SageMaker 的内置算法，我们可以用一行简单的代码部署我们的模型。</p><p id="2c25" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这篇文章中，我将使用 SageMaker 部署一个汽车分类模型，并使用 API Gateway 和 AWS Lambda 调用模型端点。</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kf"><img src="../Images/eaf596465150a982bb59e0e0c6e05c64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6kLFMtCR441-QNfV-PMqAQ.png"/></div></div></figure><h1 id="1b71" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">创建一个 Amazon SageMaker 笔记本实例</h1><p id="811c" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">我们需要使用 notebook 实例来创建和管理 Jupyter notebook，以便我们能够准备和处理数据，并训练和部署机器学习模型。欲了解更多详情，请点击查看文档<a class="ae lj" href="https://docs.aws.amazon.com/sagemaker/latest/dg/gs-setup-working-env.html" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="638e" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">准备培训数据</h1><p id="0378" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">您可以使用 AWS 地面实况工具来标注您自己的数据集。在这个例子中，我使用了来自 Stanford 的<a class="ae lj" href="http://ai.stanford.edu/~jkrause/cars/car_dataset.html" rel="noopener ugc nofollow" target="_blank">汽车数据集。</a></p><blockquote class="lk ll lm"><p id="cc9b" class="jc jd ln je b jf jg jh ji jj jk jl jm lo jo jp jq lp js jt ju lq jw jx jy jz hn dt translated">汽车数据集包含 196 类汽车的 16，185 张图像。数据被分成 8，144 个训练图像和 8，041 个测试图像，其中每个类别被大致分成 50-50 个部分。类别通常是品牌、型号、年份，例如 2012 款特斯拉 Model S 或 2012 款宝马 M3 coupe。</p></blockquote><h2 id="1d72" class="lr kh hu bd ki ls lt lu km lv lw lx kq jn ly lz ku jr ma mb ky jv mc md lc me dt translated">下载数据</h2><p id="28e5" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">让我们创建一个新的 notebook 实例并打开 Jupyter，然后下载数据集，</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="8dec" class="lr kh hu mg b fv mk ml l mm mn">import os<br/>import urllib.request</span><span id="0527" class="lr kh hu mg b fv mo ml l mm mn">def download(url):<br/>    filename = url.split("/")[-1]<br/>    if not os.path.exists(filename):<br/>        urllib.request.urlretrieve(url, filename)</span><span id="c78a" class="lr kh hu mg b fv mo ml l mm mn">download('<a class="ae lj" href="http://imagenet.stanford.edu/internal/car196/cars_train.tgz'" rel="noopener ugc nofollow" target="_blank">http://imagenet.stanford.edu/internal/car196/cars_train.tgz'</a>)<br/>download('<a class="ae lj" href="https://ai.stanford.edu/~jkrause/cars/car_devkit.tgz'" rel="noopener ugc nofollow" target="_blank">https://ai.stanford.edu/~jkrause/cars/car_devkit.tgz'</a>)</span></pre><p id="0774" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">…然后打开包装。</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="6241" class="lr kh hu mg b fv mk ml l mm mn">%%bash<br/>tar -xzf car_devkit.tgz<br/>tar -xzf cars_train.tgz</span></pre><p id="bff6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，注释位于”。mat "格式(Matlab 文件)。我们必须用以下值将它转换成一个数组:图片名称、图片类别 ID、训练/验证标签。</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="12ce" class="lr kh hu mg b fv mk ml l mm mn"><strong class="mg hv">import</strong> <strong class="mg hv">scipy.io</strong> <strong class="mg hv">as</strong> <strong class="mg hv">sio</strong></span><span id="8a3f" class="lr kh hu mg b fv mo ml l mm mn"><strong class="mg hv">def</strong> readClasses(matFile):   <br/>    content = sio.loadmat(matFile)<br/>    classes = [(_[0]) <strong class="mg hv">for</strong> _ <strong class="mg hv">in</strong> content['class_names'][0]]<br/>    <strong class="mg hv">return</strong> classes    <br/><br/><strong class="mg hv">def</strong> readAnnotations(matFile):   <br/>    content = sio.loadmat(matFile)<br/>    <strong class="mg hv">return</strong> content['annotations'][0]</span></pre><h2 id="10d1" class="lr kh hu bd ki ls lt lu km lv lw lx kq jn ly lz ku jr ma mb ky jv mc md lc me dt translated">准备注释数据</h2><p id="9b1a" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">Amazon SageMaker 对象检测算法支持 RecordIO 和 Image &amp; JSON 格式，我使用下面的脚本将数组转换为 JSON 文件作为注释输入:</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="c981" class="lr kh hu mg b fv mk ml l mm mn"><strong class="mg hv">from</strong> <strong class="mg hv">imageio</strong> <strong class="mg hv">import</strong> imread<br/><br/>categories = readClasses("devkit/cars_meta.mat")<br/>annotations = readAnnotations("devkit/cars_train_annos.mat")<br/><br/><strong class="mg hv">for</strong> img <strong class="mg hv">in</strong> images :<br/>    shape = imread('cars_train/<strong class="mg hv">{}</strong>'.format(img)).shape<br/>    jsonFile = img.split('.')[0]+'.json'<br/>    <br/>    line = {}<br/>    line['file'] = img<br/>    line['image_size'] = [{<br/>        'width':int(shape[1]),<br/>        'height':int(shape[0]),<br/>        'depth':3<br/>    }]<br/>     <br/>    line['annotations'] = []<br/>    line['categories'] = [] <br/>    <em class="ln">#print(annotations)</em><br/>    <strong class="mg hv">for</strong> anno <strong class="mg hv">in</strong> annotations:<br/>         <strong class="mg hv">if</strong>(anno[5][0]==img):<br/>            <em class="ln">#print(anno) </em><br/>            line['annotations'].append({<br/>                    'class_id':int(fix_index_mapping(anno[4][0][0])),<br/>                    'top':int(anno[1][0][0]),<br/>                    'left':int(anno[0][0][0]),<br/>                    'width':abs(int(anno[2][0][0])- int(anno[0][0][0])),<br/>                    'height':abs(int(anno[3][0][0]) -int(anno[1][0][0])),<br/>                })<br/>            class_name = ''<br/>            <strong class="mg hv">for</strong> ind,cat <strong class="mg hv">in</strong> enumerate(categories, start=1):<br/>                <strong class="mg hv">if</strong> int(anno[4][0][0]) == ind:<br/>                    class_name = str(cat)<br/>            <strong class="mg hv">assert</strong> class_name <strong class="mg hv">is</strong> <strong class="mg hv">not</strong> ''<br/>            line['categories'].append({<br/>                'class_id':int(anno[4][0][0]),<br/>                'name':class_name<br/>            })<br/>   <br/>    <strong class="mg hv">if</strong> line['annotations']:<br/>        <strong class="mg hv">with</strong> open(os.path.join('car-generated', jsonFile),'w') <strong class="mg hv">as</strong> p:<br/>            json.dump(line,p)</span></pre><p id="efed" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下面是一个. json 文件的示例。</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="ce24" class="lr kh hu mg b fv mk ml l mm mn">{"file": "00001.jpg", "image_size": [{"width": 600, "height": 400, "depth": 3}], "annotations": [{"class_id": 13, "top": 116, "left": 39, "width": 530, "height": 259}], "categories": [{"class_id": 14, "name": "Audi TTS Coupe 2012"}]}</span></pre><h1 id="b816" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">上传到 S3</h1><p id="2763" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">亚马逊 SageMaker 预计该数据集将在 S3 桶中可用。我们需要上传图像和注释 JSON 文件到 S3 桶。</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="39df" class="lr kh hu mg b fv mk ml l mm mn">%%time</span><span id="c692" class="lr kh hu mg b fv mo ml l mm mn">prefix = "prefix = 'car-Detection'"</span><span id="15ba" class="lr kh hu mg b fv mo ml l mm mn"><strong class="mg hv">train_channel</strong> = prefix + '/car-train'<br/><strong class="mg hv">validation_channel</strong> = prefix + '/car-validation'<br/><strong class="mg hv">train_annotation_channel</strong> = prefix + '/train_annotation'<br/><strong class="mg hv">validation_annotation_channel</strong> = prefix + '/validation_annotation'</span><span id="d31b" class="lr kh hu mg b fv mo ml l mm mn">sess.upload_data(path='car-train', bucket=bucket, key_prefix=train_channel)<br/>sess.upload_data(path='car-validation', bucket=bucket, key_prefix=validation_channel)<br/>sess.upload_data(path='car-train_annotation', bucket=bucket, key_prefix=train_annotation_channel)<br/>sess.upload_data(path='car-validation_annotation', bucket=bucket, key_prefix=validation_annotation_channel)</span><span id="2ca5" class="lr kh hu mg b fv mo ml l mm mn"><strong class="mg hv">s3_train_data</strong> = 's3://{}/{}'.format(bucket, train_channel)<br/><strong class="mg hv">s3_validation_data</strong> = 's3://{}/{}'.format(bucket, validation_channel)<br/><strong class="mg hv">s3_train_annotation</strong> = 's3://{}/{}'.format(bucket, train_annotation_channel)<br/><strong class="mg hv">s3_validation_annotation</strong> = 's3://{}/{}'.format(bucket, validation_annotation_channel)<br/><strong class="mg hv">s3_output_location</strong> = 's3://<strong class="mg hv">{}</strong>/<strong class="mg hv">{}</strong>/output'.format(bucket, prefix)</span></pre><p id="e020" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们有了一些可以被培训工作使用的标记数据，我们准备好进行下一步了。</p><h1 id="c5ae" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">训练和建立模型</h1><p id="b68a" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">在这个例子中，我们使用内置算法对象检测来训练我们的模型。你可以在这个<a class="ae lj" href="https://github.com/yai333/SageMakerCarClassification/blob/master/CarClassification.ipynb" rel="noopener ugc nofollow" target="_blank"> Github 库</a>里看到整个笔记本。训练数据的相关代码如下:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="17fe" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果训练过程进展顺利，我们将有我们的模型，它将被上传到输出 s3 桶。该模型可以在 AWS 控制台和 AWS 命令行中看到:</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="6dd5" class="lr kh hu mg b fv mk ml l mm mn"><strong class="mg hv">$</strong>aws sagemaker list-training-jobs --region ap-southeast-2</span></pre><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mr"><img src="../Images/3642d8e2e99539828051d47521f1d9e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eYlajFeSlhbky3ber-A9ug.jpeg"/></div></div></figure><h1 id="e1b2" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated"><strong class="ak">部署模型</strong></h1><p id="dbc4" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">一旦培训完成，我们就可以将经过培训的模型部署为 Amazon SageMaker 实时托管端点。</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="bc37" class="lr kh hu mg b fv mk ml l mm mn"><strong class="mg hv">object_detector</strong> = od_model.deploy(initial_instance_count = 1,                                  instance_type = 'ml.m4.xlarge')</span></pre><p id="86ae" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以通过导航到 Amazon SageMaker 控制台中的“端点”选项卡来检查端点配置和状态。</p><h1 id="bb70" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">创建一个无服务器 REST API</h1><p id="2a4b" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">一旦创建了 Sagemaker 端点，就可以使用该端点从 notebook 进行推理。AWS 团队提供了一个样本脚本，以便于可视化检测输出。通过使用以下脚本过滤掉低可信度检测，您可以使用边界框来可视化高可信度预测:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="mp mq l"/></div></figure><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ms"><img src="../Images/c7902c106536915e05a9379b68560464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aTGXUUkVOJtgLKtSs758JQ.png"/></div></div></figure><p id="c606" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">太好了——这很有效！我想让它对外界可用，所以我们必须创建一个 API。这可以通过使用<a class="ae lj" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>轻松实现</p><h2 id="bb50" class="lr kh hu bd ki ls lt lu km lv lw lx kq jn ly lz ku jr ma mb ky jv mc md lc me dt translated">开始使用无服务器框架</h2><p id="2b9a" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">首先，您需要安装无服务器框架</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="f731" class="lr kh hu mg b fv mk ml l mm mn"><strong class="mg hv">$</strong>sls create --template aws-python3 --path car-classification</span></pre><p id="3fd1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建的目录包括两个文件——handler . py 是 Lambda 函数。serverless.yml 文件，需要该文件来配置我们的应用程序的行为方式:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="1a42" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，允许策略资源是一个 SSM (AWS Systems Manager 代理)参数。要在 SSM 中存储一个值，我需要运行以下命令:</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="c4df" class="lr kh hu mg b fv mk ml l mm mn"><strong class="mg hv">$</strong>aws ssm put-parameter --name sagemakerarn --type String --value arn:aws:sagemaker:ap-southeast-2:YOUR_ACCOUNT_ID:endpoint/object-detection-2019-06-01-04-13-54-575 --region ap-southeast-2D</span></pre><h2 id="3766" class="lr kh hu bd ki ls lt lu km lv lw lx kq jn ly lz ku jr ma mb ky jv mc md lc me dt translated">添加 Lambda 函数</h2><p id="f9ad" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">现在，让我们更新 handler.py 来调用 SageMaker 端点。handler.py 文件如下所示:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="mp mq l"/></div></figure><h2 id="ca84" class="lr kh hu bd ki ls lt lu km lv lw lx kq jn ly lz ku jr ma mb ky jv mc md lc me dt translated">部署 API</h2><p id="e5aa" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">要部署您的 API，请运行以下命令:</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="a77e" class="lr kh hu mg b fv mk ml l mm mn">$ serverless deploy -v</span></pre><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mt"><img src="../Images/a46cf2de21f8b1a0ec3a1d80c89631e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oQpHAJzZ0aUA1JtOLY3Pfw.png"/></div></div></figure><h1 id="ef79" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">测试 API</h1><p id="b3ea" class="pw-post-body-paragraph jc jd hu je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">我们已经到了旅程的终点！我们现在可以使用 CURL 调用已部署的无服务器 API 端点:</p><pre class="kb kc kd ke fq mf mg mh mi aw mj dt"><span id="04b8" class="lr kh hu mg b fv mk ml l mm mn"><strong class="mg hv">$</strong>curl -d '{"img_url":"<a class="ae lj" href="https://bit.ly/2IbFF70" rel="noopener ugc nofollow" target="_blank">https://bit.ly/2IbFF70</a>"}' -H "Content-Type: application/json" -X POST <a class="ae lj" href="https://lphw1ud698.execute-api.ap-southeast-2.amazonaws.com/dev/sagemaker" rel="noopener ugc nofollow" target="_blank">https://xxxx.execute-api.ap-southeast-2.amazonaws.com/dev/sagemaker</a></span></pre><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mu"><img src="../Images/8d45c0ab85fb05c20dd9016582cc544e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4qEXDpJQP7AXnZ1puXVNUA.png"/></div></div></figure><p id="ae75" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">差不多就是这样！希望你觉得这篇文章有用，你可以在我的<a class="ae lj" href="https://github.com/yai333/SageMakerCarClassification/blob/master/README.md" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv"> GitHub repo </strong> </a>中找到完整的项目。</p></div></div>    
</body>
</html>