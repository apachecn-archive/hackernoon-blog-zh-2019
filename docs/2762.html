<html>
<head>
<title>Bitbucket + Bitrise: Configuring Continuous Integration for iOS apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Bitbucket + Bitrise:为iOS应用配置持续集成</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/bitbucket-bitrise-configuring-continuous-integration-for-an-ios-app-8974474bca6b?source=collection_archive---------31-----------------------#2019-04-29">https://medium.com/hackernoon/bitbucket-bitrise-configuring-continuous-integration-for-an-ios-app-8974474bca6b?source=collection_archive---------31-----------------------#2019-04-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="ba3f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是Ivan Parfenchuk为Bitbucket撰写的客座博文。Ivan是一名独立的iOS和Ruby开发人员，热衷于构建愉快的体验。和他在Twitter上联系<a class="ae jq" href="https://twitter.com/gazebushka" rel="noopener ugc nofollow" target="_blank"><em class="jp">@ gazebushka</em></a><em class="jp">。</em></p><p id="a426" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当iOS应用程序开始增长时，在某个时候，拥有一个快速的开发-发布-测试反馈循环变得至关重要。您可以通过手动完成所有工作来创建这个循环，但是如果您使用持续集成(CI)工具，它会更快更高级。</p><p id="4df1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用CI工具，您可以构建发布的历史，并快速查看哪个构建包含了什么。您可以对每个构建自动运行测试，并捕捉一些不可避免的错误。您可以在发行说明中保持一致性。您还可以简化您的发布周期，从而自动化您的清单。</p><p id="26c1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">听起来有趣吗？让我们尝试使用Bitbucket Webhooks、Bitrise和fastlane来构建这个反馈回路。</p><h1 id="57b4" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">部署流程</h1><p id="b49d" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">我们将用于持续集成的流程如下所示:</p><ol class=""><li id="dc26" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated">在Bitbucket中创建和合并拉请求</li><li id="0b87" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated"><a class="ae jq" href="https://bitbucket.org/product" rel="noopener ugc nofollow" target="_blank"> Bitbucket </a>对Bitrise执行“web hook”HTTP请求</li><li id="aac1" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated"><a class="ae jq" href="https://www.bitrise.io/" rel="noopener ugc nofollow" target="_blank"> Bitrise </a>开始构建流程并启动fastlane</li><li id="6d8e" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated"><a class="ae jq" href="https://fastlane.tools/" rel="noopener ugc nofollow" target="_blank"> fastlane </a>构建应用并将其发送至App Store Connect</li><li id="0fa1" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">App Store Connect处理构建，并在TestFlight中可用</li></ol><h1 id="2862" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">Bitbucket Webhooks和git分支模型</h1><p id="b384" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">每次部署都从我们创建一个拉取请求开始。</p><p id="3168" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">假设您的团队正在使用主git分支来处理处于可发布状态的代码。它还通过将这个主分支合并到发布分支来生成新的发布。</p><p id="5fd1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以下部分描述了如何手动创建Webhook。但是，如果你使用Bitrise，它可以自动为你创建一个Webhook，所以，请随意跳到Bitrise部分。</p><h1 id="3025" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">手动Webhook配置</h1><p id="6501" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">接下来，让我们配置Bitbucket Webhooks，以便每当有人推送释放分支或合并Pull请求以释放分支时，都会触发Webhook。</p><p id="b8fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要做到这一点，请进入您的Bitbucket存储库，然后单击侧边菜单中的“设置”。然后点击“工作流程”部分的“Webhooks”，然后点击“添加webhook”</p><p id="e68a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">填写标题、URL(见下文)，将状态设置为活动，并为触发器选择“从完整的触发器列表中选择”。我们将使用的触发器是:</p><ol class=""><li id="001e" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated">存储库:推送</li><li id="8a1d" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">拉式请求:创建、更新</li></ol><p id="b307" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要获取我们的Webhook的URL:</p><ol class=""><li id="aed8" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated">去Bitrise，创建一个新的应用程序</li><li id="b696" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">打开仪表板-&gt;您的应用-&gt;代码选项卡</li><li id="a839" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">滚动到Incoming Webhooks部分，然后单击手动设置。</li><li id="46b9" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">选择“Bitbucket Webhooks”并复制Webhook URL</li></ol><figure class="lj lk ll lm fq ln fe ff paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="fe ff li"><img src="../Images/b074fa1348c85e3047fdd610a3dac9d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mGhsp9fuqfcOBHh6.png"/></div></div></figure><h1 id="3a8d" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">Bitrise和自动Webhook配置</h1><p id="85e9" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">Bitrise是一个持续集成的平台。您可以在其中配置不同的部署“工作流”，并让Bitrise服务器构建和发布您的应用程序。下面是为我们的CI设置创建新部署工作流的步骤。</p><figure class="lj lk ll lm fq ln"><div class="bz el l di"><div class="lu lv l"/></div></figure><ol class=""><li id="e086" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated">首先在Bitrise注册，进入仪表盘，点击“添加新应用”</li><li id="df05" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">如果您希望您的配置和日志保持私有，请选择“私有”</li><li id="c01b" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">选择Bitbucket并将其连接到您的帐户</li><li id="8df1" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">点按“自动添加SSH密钥”或手动配置SSH访问</li><li id="a850" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">在“选择分行”步骤中，输入“release”作为分行名称</li><li id="25c1" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">在项目构建配置中选择“快速通道”，检查浪子通道是否设置为“ios版本”。</li><li id="b3a8" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">选择您通常用来构建应用程序的堆栈或最新可用的Xcode/macOS，然后点按“确认”。</li><li id="bd21" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">在最后一步“Webhook设置”中，点击“为我注册Webhook”</li></ol><p id="9997" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后一步在Bitbucket中创建了一个Webhook，所以您不需要手动做任何事情。你可以去Bitbucket repository，在Settings -&gt; Webhooks中检查Webhook的配置。</p><p id="52b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们的设置中，我们将使用fastlane构建应用程序并将其发布到App Store Connect。</p><h1 id="6c04" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">浪子构型</h1><p id="6757" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">浪子是一套自动化开发和发布过程的工具。</p><p id="4048" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">按照本指南安装fastlane: <a class="ae jq" href="https://docs.fastlane.tools/getting-started/ios/setup" rel="noopener ugc nofollow" target="_blank">设置— fastlane文档</a></p><p id="6d6d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">简而言之，您需要安装Xcode开发工具:</p><pre class="lj lk ll lm fq lw lx ly lz aw ma dt"><span id="2cc3" class="mb js hu lx b fv mc md l me mf">xcode-select --install</span></pre><p id="0fe6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后通过RubyGems安装fastlane</p><pre class="lj lk ll lm fq lw lx ly lz aw ma dt"><span id="ad0e" class="mb js hu lx b fv mc md l me mf">sudo gem install fastlane -NV</span></pre><p id="ffb2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">或者通过brew:</p><pre class="lj lk ll lm fq lw lx ly lz aw ma dt"><span id="d9e4" class="mb js hu lx b fv mc md l me mf">brew cask install fastlane</span></pre><p id="4335" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后在终端打开你app的工作目录，初始化fastlane。</p><pre class="lj lk ll lm fq lw lx ly lz aw ma dt"><span id="2985" class="mb js hu lx b fv mc md l me mf">cd /path/to/your/app <br/>fastlane init</span></pre><p id="51a8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">选择“3。🚀自动化应用商店分发”</p><p id="6d46" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后按照配置要求进行操作。浪子可以为您创建和配置新的应用程序Id，并创建一个示例部署“通道”Lane只是完成某些场景所需的步骤的集合。</p><p id="819f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦配置完成，让我们打开已经创建的Fastfile并配置我们的第一个部署脚本。浪子有一大套自动化各种过程的工具，比如代码签名、上传截图、运行测试等等。但是，我们将从一个简单的设置开始:</p><pre class="lj lk ll lm fq lw lx ly lz aw ma dt"><span id="4675" class="mb js hu lx b fv mc md l me mf">default_platform(:ios)  </span><span id="325b" class="mb js hu lx b fv mg md l me mf">platform :ios do   <br/>  desc "Push a new release build to the App Store"   <br/>  lane :release do     <br/>    build_app(scheme: "CITest")     <br/>    upload_to_app_store(force: true, skip_metadata: true, skip_screenshots: true)   <br/>  end <br/>end</span></pre><p id="1017" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">“释放”车道将</p><ol class=""><li id="6d86" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated">执行项目build_app的构建(scheme:“CITest”)</li><li id="68bf" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">将生成的ipa文件上传到App Store Connect upload _ to _ App _ Store。在本指南中，我们将跳过浪子元数据上传。</li></ol><p id="c8b7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以通过在“终端”中打开项目目录并运行fastlane release来测试您的设置:</p><pre class="lj lk ll lm fq lw lx ly lz aw ma dt"><span id="3b98" class="mb js hu lx b fv mc md l me mf">cd /path/to/your/app/directory <br/>fastlane release</span></pre><h1 id="9cf7" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">代码签名</h1><p id="7f9e" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">如果您发现代码签名有问题，请从这里开始:<a class="ae jq" href="https://docs.fastlane.tools/codesigning/troubleshooting" rel="noopener ugc nofollow" target="_blank">故障排除—快速通道文档</a>。您可以使用fastlane match来管理代码签名，但是要小心:如果您已经生成了证书和预置描述文件，match可能会出错。然而，如果这是一个全新的设置，或者你不太关心现有的配置文件，match将大大加快速度。</p><p id="6bee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将在示例中使用快速通道匹配:</p><pre class="lj lk ll lm fq lw lx ly lz aw ma dt"><span id="b351" class="mb js hu lx b fv mc md l me mf">cd /path/to/your/app/directory <br/>fastlane match development <br/>fastlane match adhoc <br/>fastlane match appstore</span></pre><p id="37c2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后打开Xcode，关闭自动代码签名，选择match生成的预置描述文件。</p><p id="66c0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">之后，我们可以将match添加到我们的Fastfile:</p><pre class="lj lk ll lm fq lw lx ly lz aw ma dt"><span id="a357" class="mb js hu lx b fv mc md l me mf">default_platform(:ios)<br/> <br/>platform :ios do <br/>  desc "Push a new release build to the App Store" <br/>  lane :release do <br/>      match(type: "appstore", readonly: true) <br/>    build_app(scheme: "CITest") <br/>    upload_to_app_store(force: true, skip_metadata: true, skip_screenshots: true) <br/>  end <br/>end</span></pre><h1 id="6cad" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">完成Bitrise设置</h1><figure class="lj lk ll lm fq ln fe ff paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="fe ff mh"><img src="../Images/6187b8b794becf490e3efcc6f4453180.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v17Nea3yHD2Jgdv6.png"/></div></div></figure><p id="6e1f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Bitrise正在其服务器上构建该项目，这些服务器上没有代码签名和上传应用程序到App Store Connect所需的任何密码和凭据。因此，我们必须分享其中一些，确切地说是这两个:</p><ol class=""><li id="8b71" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated">App Store Connect用户的登录名/密码</li><li id="b71c" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">解密匹配存储库的密码(如果使用匹配)</li></ol><p id="08b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">App Store Connect用户不必是您用来控制应用程序的用户。您可以在App Store Connect中创建新用户，该用户只能访问您自动化的应用程序，并且至少拥有开发人员角色。</p><p id="31cf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦你设置了新的应用商店连接用户，前往Bitrise，打开工作流编辑器标签，然后秘密。添加两个新秘密:</p><p id="d463" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">ITUNES_CONNECT_USER和ITUNES_CONNECT_PASSWORD以及此新用户的App Store凭据。另外，将相同的密码输入FASTLANE_PASSWORD secret。</p><p id="7036" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您使用match，那么再添加一个名为MATCH_PASSWORD的密码，这个密码就是您用来加密match repository的密码。</p><h1 id="64ff" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">结论</h1><p id="6783" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">应该就是这样了。尝试创建一个新的Pull请求并合并它，看看Bitrise是否会触发新的构建。如果一切顺利，您将在TestFlight中看到新版本，并能够为您的新iOS应用程序版本选择它。</p><figure class="lj lk ll lm fq ln fe ff paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="fe ff mi"><img src="../Images/7209d45b6a201c7fb19651b8bab7853a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mq3JtlN9KrLcFM_f.png"/></div></div></figure><p id="b01e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过自动化部署，您可以做更多的事情，例如:</p><ol class=""><li id="68ca" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated">使用快速通道扫描进行测试</li><li id="c764" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">自动化内部版本号递增</li><li id="1aa3" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">dSYM上传到Crashlytics_Raygun_etc</li></ol><p id="278d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，首先从简单的事情开始。希望这个指南对你有帮助！</p><p id="da6c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">喜欢分享你的技术专长吗？了解更多关于</em> <a class="ae jq" href="http://bitbucket.org/product/write" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> Bitbucket编写程序</em> </a> <em class="jp">。</em></p></div><div class="ab cl mj mk hc ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="hn ho hp hq hr"><p id="e248" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">原载于2019年4月29日</em><a class="ae jq" href="https://bitbucket.org/blog/bitbucket-bitrise-configuring-continuous-integration-for-an-ios-app" rel="noopener ugc nofollow" target="_blank"><em class="jp">https://bitbucket.org</em></a><em class="jp">。</em></p><figure class="lj lk ll lm fq ln"><div class="bz el l di"><div class="mq lv l"/></div></figure></div></div>    
</body>
</html>