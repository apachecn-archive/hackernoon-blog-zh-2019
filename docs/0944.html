<html>
<head>
<title>Fast.ai in production. Real-word text classification with ULMFiT.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生产中的 Fast.ai。基于 ULMFiT 的真实文本分类。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/fast-ai-in-production-real-word-text-classification-with-ulmfit-199769be2a6#2019-02-07">https://medium.com/hackernoon/fast-ai-in-production-real-word-text-classification-with-ulmfit-199769be2a6#2019-02-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="d95e" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">我已经克服了对 fast.ai 用于生产的怀疑，并用 ULMFiT 训练了一个非英语语言、小数据集和大量类的文本分类系统。</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/51cc6d05d39ebbb7500aaef8adc41417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AxVEIQ-iIHudk6RSikrcwQ.png"/></div></div></figure><h1 id="fc26" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">关于项目</h1><p id="fb00" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">我的朋友兼同学是<a class="ae lj" href="https://rocketbank.ru" rel="noopener ugc nofollow" target="_blank"> RocketBank </a>(俄罗斯领先的纯在线银行)的创始人之一，他让我开发一个分类器来帮助一线客户支持。</p><p id="19a1" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">最初的一系列限制相当严格—</p><ul class=""><li id="9960" class="lp lq hu kp b kq lk kt ll kw lr la ls le lt li lu lv lw lx dt translated">没有标记的历史数据</li><li id="2bb4" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">模糊的个人身份信息</li><li id="6327" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">“我们昨天就想要”</li><li id="8545" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">主要是俄语(很难找到预先训练的模型)</li><li id="968f" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">由于隐私法规，无法访问云解决方案</li><li id="12f1" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">在没有我参与的情况下，如果出现新的课程，能够重新培训模型</li></ul><p id="2304" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">工作范围非常简单——开发一个模型和服务解决方案，将传入的消息分类为 25 类。</p><p id="deb8" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">最初，在考虑了限制因素之后——我非常确定，这种方法不应该使用神经网络。为什么？</p><ul class=""><li id="409b" class="lp lq hu kp b kq lk kt ll kw lr la ls le lt li lu lv lw lx dt translated">我们永远无法在合理的时间内为神经模型标注足够的数据。</li><li id="7a0b" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">为神经模型的可靠服务建立一个环境是一种痛苦。</li><li id="fb99" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">我对用合理的资源达到要求的性能(每秒请求数)持怀疑态度。</li></ul><p id="ffbd" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">基于此，我做了个鬼脸，创造了新的<em class="md">康达</em>环境<em class="md">。我很经典。</em></p><h1 id="93db" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">数据集收集和初步研究。</h1><p id="e903" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">RocketBank 已经建立了一个由项目经理和 devo PS(T7)组成的任务组，外加一群处理数据集标记的人。这是非常聪明和有帮助的，因为在我看来，这构成了一个在工业世界中处理数据科学项目的完美团队。</p><p id="ce5d" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">我们从分析历史数据开始，得出了一些结论:</p><ul class=""><li id="6dda" class="lp lq hu kp b kq lk kt ll kw lr la ls le lt li lu lv lw lx dt translated">为了训练系统，我们只考虑银行在客户支持部门做出任何响应之前收到的消息。</li><li id="a48f" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">传入消息有两种不同的元类别——来自现有客户和新的潜在客户。将该信息作为输入添加到分类器应该为系统提供额外的信息并提高分类分数。</li><li id="e4f5" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">银行方面决定对从“信用请求”到“骚扰”的 25 种不同的信息进行分类。</li></ul><p id="9b8b" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">我请求了大约 25000 条未标记为的历史消息，仅仅几天后，一个任务组就能够将大约 1500 条历史消息分成 25 类 T11。最初，我认为这个数字(1.5k)太低，甚至无法尝试任何神经模型(我错了)。</p><h1 id="5b95" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">TD-IDF + TPOT 和 DEAP</h1><p id="6cf7" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">我会快进到不感兴趣的部分。我决定使用 TPOT 和 DEAP 测试各种风格的 TD-IDF、嵌入和优化机器学习模型。</p><p id="9c88" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">对于那些没有意识到的人来说，TPOT 和 DEAP 是数据科学家武器库中的两个秘密武器，它们使模型搜索成为 CPU 密集型和免提的。</p><p id="2fa7" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated"><a class="ae lj" href="https://github.com/EpistasisLab/tpot" rel="noopener ugc nofollow" target="_blank"> TPOT </a>运行 sklearn plus less extra(XGBoost)中嵌入的所有机器学习方法栈，并找到最优流水线。我尝试了各种嵌入，把它们输入到 TPOT，24 小时后，我说随机森林最适合我的模型(<strong class="kp hv">)哈哈，真是个惊喜！</strong>)。</p><p id="bf41" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">然后我需要找到一组最佳的超参数。我总是用<a class="ae lj" href="https://github.com/DEAP/deap" rel="noopener ugc nofollow" target="_blank"> DEAP </a>库的定向进化策略来做这件事。这实际上值得一个单独的职位。</p><p id="e986" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">无论如何，在一天结束的时候，我收到了一组优化的设置，我的精度大约是 63%。我认为这接近于我从经典方法和 1.5k 数据集所能得到的最大值。虽然从机器学习的角度来看，25 个类的 63%听起来不错，但对于现实世界的使用来说却非常糟糕。所以，我决定把研究神经网络作为最后的机会。</p><h1 id="7241" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">Fast.ai 进场。</h1><p id="5c94" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">因此，我需要一种快速的方法来检查基于神经的模型在同一任务中的性能。虽然使用 Tensorflow 从头实现一个模型是最可行的选择，但我决定用 fast.ai 和他们最近发现的 ULMFiT 进行一次快速测试。问题是，我需要一个针对俄语文本的预训练语言模型，这在 fast.ai 中不可用。在查看 fast.ai 论坛后，我发现了一个正在进行的为大多数语言创建一套语言模型的努力。有一个俄罗斯语言的线索和一个俄罗斯 Kaggler  Pavel Pleskov 预先训练的模型，他曾在 Yandex 竞赛中获得第二名。</p><p id="ecf2" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">从那时起，它主要是编写 20 行代码和几个小时的 GPU 训练时间来达到 70%的精度。经过几天的超参数调优，我达到了 80%的精度。一些提示:</p><ul class=""><li id="7962" class="lp lq hu kp b kq lk kt ll kw lr la ls le lt li lu lv lw lx dt translated">使用 FocalLoss 作为训练目标。</li><li id="86ca" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">有一个预先训练好的语言模型，但是在一个没有标记的可用数据上进行微调。</li><li id="bec9" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">将文本转换为小写，并为大写创建一个标记，为模糊数据创建一个特殊的标记。</li><li id="a740" class="lp lq hu kp b kq ly kt lz kw ma la mb le mc li lu lv lw lx dt translated">不仅在消息的开头，而且在消息的结尾放置元类的标记。</li></ul><h1 id="e3ae" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">部署</h1><p id="16e4" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">好的，很好。应该把模型转换成 TensorFlow 吗？没有，我比较懒，决定用原生 Fast.ai + Pytorch + Docker 测试模型性能。</p><p id="8ecc" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">在单核 Docker 容器中运行压力测试后，我惊讶地发现平均请求的响应时间不到 300 毫秒，并且没有崩溃。我还需要什么？没什么。</p><p id="965a" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">Fast.ai 展示了它是快速精确开发生产 ML 系统的完美解决方案。</p><h2 id="6f92" class="me jw hu bd jx mf mg mh kb mi mj mk kf kw ml mm kh la mn mo kj le mp mq kl mr dt translated">再训练</h2><p id="1c74" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">fast.ai +迁移学习的美妙之处在于，就质量和速度而言，这是再培训的一个相当可预测的结果。我在 docker 容器中分享了一个脚本，复制了我的最终培训笔记本，并提供了一个新的模型作为资产。我已经运行了几个周期的再培训和交叉验证，并获得了高度可重复的结果，因此这不仅是交付模型的简单方法，也是交付培训脚本的简单方法。</p><p id="60d5" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">我不能分享实际的代码和系统配置，但我愿意回答任何问题。</p><h2 id="1f33" class="me jw hu bd jx mf mg mh kb mi mj mk kf kw ml mm kh la mn mo kj le mp mq kl mr dt translated">如果你愿意，请鼓掌；如果你想知道更多关于 DEAP 和 TPOT 的细节，请鼓掌。</h2></div></div>    
</body>
</html>