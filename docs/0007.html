<html>
<head>
<title>Is Test Coverage a Good Metric for Test or Code Quality?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试覆盖率是测试或代码质量的好指标吗？</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/is-test-coverage-a-good-metric-for-test-or-code-quality-92fef332c871#2019-01-01">https://medium.com/hackernoon/is-test-coverage-a-good-metric-for-test-or-code-quality-92fef332c871#2019-01-01</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="c82c" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">让火焰战争开始吧。</p></blockquote><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff jt"><img src="../Images/269b886ff81344c95a619a93fb805ad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dQIj7jRLtf1sUxXS.jpg"/></div></div><figcaption class="kf kg fg fe ff kh ki bd b be z ek">I bet a pilot doesn’t look at half of this stuff.</figcaption></figure><h1 id="3022" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">首先是定义。</h1><p id="4e04" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf lj lk ji jj ll lm jm jn ln lo jq jr js hn dt translated">和所有好的观点一样，我会明确我使用的术语和它们的含义。</p><h2 id="23b7" class="lp kk hu bd kl lq lr ls kp lt lu lv kt lj lw lx kx ll ly lz lb ln ma mb lf mc dt translated">代码覆盖率百分比</h2><p id="49ae" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf lj lk ji jj ll lm jm jn ln lo jq jr js hn dt translated">其中一个自动化测试运行时执行的代码行，以占整个代码库的百分比表示。例如，65%的代码覆盖率意味着测试执行 65%的代码。</p><h2 id="2798" class="lp kk hu bd kl lq lr ls kp lt lu lv kt lj lw lx kx ll ly lz lb ln ma mb lf mc dt translated">“良好的度量”</h2><p id="2d31" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf lj lk ji jj ll lm jm jn ln lo jq jr js hn dt translated">对于这个上下文中的“好”度量标准，它必须与高质量的代码有某种关系。质量被定义为更容易理解、改变和维护。</p><h1 id="ad48" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">那么高的代码覆盖率告诉我们什么呢？</h1><p id="6135" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf lj lk ji jj ll lm jm jn ln lo jq jr js hn dt translated">考虑下面这个异常简单的示例代码。它接受一个值并给出地图的输出。为了简单起见，该地图是硬编码的。</p><pre class="ju jv jw jx fq md me mf mg aw mh dt"><span id="8a95" class="lp kk hu me b fv mi mj l mk ml">public class MyService {<br/><br/>    Map&lt;String, String&gt; myMap = new HashMap&lt;&gt;();<br/><br/>    public MyService() {<br/>        myMap.put("1", "v1");<br/>    }<br/><br/>    public String generateValue(String input) {<br/>        String mapValue = parseValue(input);<br/>        return myMap.get(mapValue);<br/>    }<br/><br/>    private String parseValue(String input) {<br/>        return input.substring(1);<br/>    }<br/>}</span></pre><h2 id="9c56" class="lp kk hu bd kl lq lr ls kp lt lu lv kt lj lw lx kx ll ly lz lb ln ma mb lf mc dt translated">那么这里 100%的代码覆盖率是什么样的呢？</h2><p id="1952" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf lj lk ji jj ll lm jm jn ln lo jq jr js hn dt translated">使用 spock 的简单单元测试可能如下所示。这将给我们 100%的测试覆盖率。</p><pre class="ju jv jw jx fq md me mf mg aw mh dt"><span id="e365" class="lp kk hu me b fv mi mj l mk ml">def "test my service does its thing properly"() {<br/>    given: 'my service'<br/>    MyService myService = new MyService()<br/><br/>    when: 'I run my service with a value ending in 1'<br/>    String output = myService.generateValue('l1')<br/><br/>    then: 'I expect something back'<br/>    output != null<br/>}</span></pre><p id="8652" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf lj jh ji jj ll jl jm jn ln jp jq jr js hn dt translated">我们知道些什么？</p><ul class=""><li id="5d2c" class="mm mn hu ix b iy iz jc jd lj mo ll mp ln mq js mr ms mt mu dt translated">当我们有 100%的测试覆盖率时，我们知道测试已经运行了代码中的所有行。</li></ul><h2 id="045e" class="lp kk hu bd kl lq lr ls kp lt lu lv kt lj lw lx kx ll ly lz lb ln ma mb lf mc dt translated">酷，所以是经过充分测试的！</h2><p id="8470" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf lj lk ji jj ll lm jm jn ln lo jq jr js hn dt translated">呃，不。让我们来看一下我的代码——如果我传入 null 会发生什么？如果有人篡改类的内部来改变输出怎么办？我们 100%的测试覆盖率能告诉我们什么吗？<strong class="ix hv">地狱号</strong>这是怎么回事？</p><h2 id="a50c" class="lp kk hu bd kl lq lr ls kp lt lu lv kt lj lw lx kx ll ly lz lb ln ma mb lf mc dt translated">代码覆盖率是一个愚蠢的指标</h2><p id="ac7e" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf lj lk ji jj ll lm jm jn ln lo jq jr js hn dt translated">当你跟踪<em class="iw">你的测试运行了多少代码的时候，它的测量是可靠的</em>，但是它绝对不会告诉你那些测试的价值。可视化它本身是没有用的，因为它与代码或测试的质量没有可靠的、可预测的关系。阻止代码覆盖率轻微下降的发布的质量关卡会招致疯狂的狗屎——像这样的测试。</p><pre class="ju jv jw jx fq md me mf mg aw mh dt"><span id="9669" class="lp kk hu me b fv mi mj l mk ml">def "test my setter works"() {<br/>    given: 'an instance of my domain object'<br/>    MyDomainObject myDomainObject = new MyDomainObject()<br/><br/>    when: 'I set some value on my domain object'<br/>    myDomainObject.setSomeValue('this is a value')<br/><br/>    then: 'i expect that value to be set'<br/>    myDomainObject.getSomeValue() == 'this is a value'<br/>}</span></pre><p id="6b59" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf lj jh ji jj ll jl jm jn ln jp jq jr js hn dt translated">当然，你可以测试它，但是<strong class="ix hv">来吧</strong>。你真的认为你的测试会被这种噪音污染吗？你应该测试你的逻辑，而不是域对象中的每一个 setter 这正是像<a class="ae mv" href="https://projectlombok.org/" rel="noopener ugc nofollow" target="_blank"> Lombok </a>这样的工具存在的原因。这就是过分热衷于代码覆盖率的问题——开发人员会找到弥补数字的方法。你创造了一个他们不相信的系统，他们会玩这个系统，这是他们的工作。这就是浪费的定义。</p><h1 id="f52b" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">我并不是说代码覆盖率是一个不好的度量标准，它只是很愚蠢</h1><p id="4996" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf lj lk ji jj ll lm jm jn ln lo jq jr js hn dt translated">作为度量标准合唱的一部分，它可以帮助描绘出代码库中正在发生的事情。如果它是一个平坦的 0%，它可能会给你一些关于团队的编码标准和测试实践的洞察力，但是它不会告诉你<strong class="ix hv">那些测试是否是好的或者整个测试策略是否被破坏了</strong>。这才是您真正关心的——经过多个领域全面测试的高质量代码。安全性、性能、弹性等。</p><p id="0329" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf lj jh ji jj ll jl jm jn ln jp jq jr js hn dt translated">让我们带着它走一走。这里有一个小小的思想实验——你有两个选择。</p><ul class=""><li id="57e5" class="mm mn hu ix b iy iz jc jd lj mo ll mp ln mq js mr ms mt mu dt translated">测试运行了代码库中 100%的代码行。那些测试就像上面的实现——它们没有告诉你太多关于代码<em class="iw">应该</em>做什么。</li><li id="cf1a" class="mm mn hu ix b iy mw jc mx lj my ll mz ln na js mr ms mt mu dt translated">您的代码库中有 50%的代码行是由测试执行的。这些测试彻底地测试了逻辑，并为它所覆盖的代码提供了优秀的活文档。然而，测试中有一些漏洞。有些课程没有涵盖。</li></ul><p id="9e8c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf lj jh ji jj ll jl jm jn ln jp jq jr js hn dt translated">我敢打赌，你的眼睛是在后者。这是因为这个思想实验有助于找出代码库中一组好的测试的真正价值。他们应该阻止不好的事情发生，并使代码更容易继续工作。前者不这样做，尽管执行了所有代码。后者有。</p><h1 id="9894" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">那么代码覆盖率本身是代码质量的一个好指标吗？</h1><p id="bea4" class="pw-post-body-paragraph iu iv hu ix b iy lh ja jb jc li je jf lj lk ji jj ll lm jm jn ln lo jq jr js hn dt translated">不，不是它自己。上面的例子显示了一个简单但常见的情况，代码覆盖率报告满分，但代码看起来像是由一个八岁的孩子写的。当你需要的是<em class="iw">质量</em>时，代码覆盖率会给你<em class="iw">数量</em>。记住，一周中的任何一天，10 个好的测试都会击败 100 个垃圾测试。</p></div><div class="ab cl nb nc hc nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hn ho hp hq hr"><p id="6030" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf lj jh ji jj ll jl jm jn ln jp jq jr js hn dt translated">更多技术漫谈，请在 twitter 上关注我！</p></div></div>    
</body>
</html>