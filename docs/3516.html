<html>
<head>
<title>Stripe Cohort Analysis with Python and Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python和熊猫的条纹队列分析</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/stripe-cohort-analysis-with-python-and-pandas-d931959cf7e?source=collection_archive---------6-----------------------#2019-06-07">https://medium.com/hackernoon/stripe-cohort-analysis-with-python-and-pandas-d931959cf7e?source=collection_archive---------6-----------------------#2019-06-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/a18f1ae0893aae7f5a61b44b0a14c9c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_lR0k3U8l26Mjc9xFV_ulw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Did you know Pandas get stoked about bamboo and cohorts?</figcaption></figure><p id="ab6f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我在做咨询的时候开始了我的第一个SaaS产品。SaaS的收入在增加，但这比不上我的时薪。傻乎乎的，我发现很难对高薪小时工说不。</p><p id="3443" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">为什么？我没看过</strong> <a class="ae ke" href="https://avc.com/2009/10/the-cohort-analysis/" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hv">队列分析</strong> </a> <strong class="ji hv">。</strong>我不明白长期缓慢稳定的订阅增长的价值。我不明白，一点点入职帮助往往会导致后期几乎没有收入。真是个笨蛋！</p><p id="2b2e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在这篇文章中，我将展示如何从你的<a class="ae ke" href="https://stripe.com" rel="noopener ugc nofollow" target="_blank">条纹</a>发票中生成你的客户群群组分析。如果这感觉像很多代码，不要担心。<strong class="ji hv">最后，我将分享一个Python脚本，它用一行代码生成了一个条带群组热图。</strong></p><h1 id="ee48" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">工具</h1><p id="b72b" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">我将使用<a class="ae ke" href="https://jupyter.org" rel="noopener ugc nofollow" target="_blank"> Jupyter笔记本</a>和几个Python包。如果你是Python新手，我建议<a class="ae ke" href="https://www.anaconda.com/distribution/" rel="noopener ugc nofollow" target="_blank">通过Anaconda </a>安装Jupyter笔记本。这将同时安装<a class="ae ke" href="http://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">Pandas</a>—<em class="li">Python数据分析库</em>。Jupyter笔记本为您提供了一种交互式的方式来探索您的数据和分享您的分析。</p><h1 id="cca9" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">方法</h1><p id="a501" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">我将遵循Greg Reda的<a class="ae ke" href="http://www.gregreda.com/2015/08/23/cohort-analysis-with-python/" rel="noopener ugc nofollow" target="_blank">群组分析的开创性方法</a>，并将其应用于您的条纹发票。</p><h2 id="6b83" class="lj kg hu bd kh lk ll lm kl ln lo lp kp jr lq lr kt jv ls lt kx jz lu lv lb lw dt translated">1.出口条纹发票</h2><p id="f914" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">我们将从条纹发票建立群组。我们可以很容易地将您的条纹发票导出到带有<a class="ae ke" href="https://petaldata.app" rel="noopener ugc nofollow" target="_blank"> PetalData </a>的熊猫数据框架中。将以下内容粘贴到你的笔记本上:</p><figure class="lx ly lz ma fq iv"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="4994" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果你有成千上万的发票(希望你有！)，下载需要一点时间。下载时，拿起你最喜欢的饮料。</p><h2 id="d047" class="lj kg hu bd kh lk ll lm kl ln lo lp kp jr lq lr kt jv ls lt kx jz lu lv lb lw dt translated">2.基于“已创建”列创建“发票_期间”列</h2><p id="5aa6" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">Petaldata创建的Pandas dataframe有一个<code class="eh md me mf mg b">created</code>列，这是发票创建的时间。由于大多数订阅服务是按月的，我们将按月分组。下面的代码以类似于<code class="eh md me mf mg b">2019-05</code>(即2019年5月)的格式命名您的群组。</p><pre class="lx ly lz ma fq mh mg mi mj aw mk dt"><span id="f9e2" class="lj kg hu mg b fv ml mm l mn mo">df['invoice_period'] = df.created.apply(lambda x: x.strftime('%Y-%m'))</span></pre><h2 id="eb2d" class="lj kg hu bd kh lk ll lm kl ln lo lp kp jr lq lr kt jv ls lt kx jz lu lv lb lw dt translated">3.根据客户的第一张发票创建“群组”列</h2><p id="cd0f" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">当你的客户收到第一张发票时，他们就存在了。我们会根据发票的日期将他们分配到他们的群组。</p><pre class="lx ly lz ma fq mh mg mi mj aw mk dt"><span id="e4ec" class="lj kg hu mg b fv ml mm l mn mo">df.set_index('customer_email', inplace=True)</span><span id="24b9" class="lj kg hu mg b fv mp mm l mn mo">df['cohort_group'] = df.groupby(level=0)['created'].min().apply(lambda x: x.strftime('%Y-%m'))<br/>df.reset_index(inplace=True)</span></pre><h2 id="628e" class="lj kg hu bd kh lk ll lm kl ln lo lp kp jr lq lr kt jv ls lt kx jz lu lv lb lw dt translated">4.按群组组&amp; invoice_period汇总数据</h2><p id="3a2f" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">现在，我们按群组和发票期进行汇总。我们的一级指数将是客户签约的月份(例如:<code class="eh md me mf mg b">2018-01</code>)，我们的二级指数将是每个发票期(例如，从2018年1月起的每个月):</p><pre class="lx ly lz ma fq mh mg mi mj aw mk dt"><span id="ade8" class="lj kg hu mg b fv ml mm l mn mo">grouped = df.groupby(['cohort_group', 'invoice_period'])</span><span id="4e85" class="lj kg hu mg b fv mp mm l mn mo"># count the unique customers, invoices, and total revenue per group + period<br/>cohorts = grouped.agg({'customer': pd.Series.nunique,<br/>                       'created': "count",<br/>                       'amount_due': np.sum})</span><span id="b8f1" class="lj kg hu mg b fv mp mm l mn mo"># make the column names more meaningful<br/>cohorts.rename(columns={'customer': 'total_customers',<br/>                        'created': 'total_invoices'}, inplace=True)<br/>cohorts.head()</span></pre><p id="02f7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这将生成如下输出:</p><figure class="lx ly lz ma fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mq"><img src="../Images/96f9fe8bbc6ffc19faf1a12e95bb37e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-jLjz_s9XtrXgF7YlhbgAg.png"/></div></div></figure><h2 id="5ed1" class="lj kg hu bd kh lk ll lm kl ln lo lp kp jr lq lr kt jv ls lt kx jz lu lv lb lw dt translated">5.标记每个群组的群组周期</h2><p id="ba6f" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">比较不同的群组(例如:2018年3月和2019年3月的注册在第二个月如何比较？)，我们需要在每一行上标注从首次购买开始的月数:</p><pre class="lx ly lz ma fq mh mg mi mj aw mk dt"><span id="a228" class="lj kg hu mg b fv ml mm l mn mo">def cohort_period(df):<br/>    df['cohort_period'] = np.arange(len(df)) + 1<br/>    return df</span><span id="ee38" class="lj kg hu mg b fv mp mm l mn mo">cohorts = cohorts.groupby(level=0).apply(cohort_period)<br/>cohorts.head()</span></pre><p id="19ad" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您将看到新的<code class="eh md me mf mg b">cohort_period</code>列:</p><figure class="lx ly lz ma fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mr"><img src="../Images/e3e61fd2afafc74b3b5a112fa4f5bb02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KlmzEVSLtLQEpmh1X25i_g.png"/></div></div></figure><h2 id="e023" class="lj kg hu bd kh lk ll lm kl ln lo lp kp jr lq lr kt jv ls lt kx jz lu lv lb lw dt translated">6.创建函数以生成热图</h2><p id="8824" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">随着时间的推移，可视化群组可能会产生噪音。为了更容易理解，我们将使用<a class="ae ke" href="http://stanford.edu/~mwaskom/software/seaborn/" rel="noopener ugc nofollow" target="_blank"> Seaborn </a>热图。下面的函数来自Greg的<a class="ae ke" href="http://www.gregreda.com/2015/08/23/cohort-analysis-with-python/" rel="noopener ugc nofollow" target="_blank">博客文章</a>，并允许我们轻松地从多个栏目生成热图。</p><p id="527f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">将这些添加到您的笔记本中:</p><pre class="lx ly lz ma fq mh mg mi mj aw mk dt"><span id="f608" class="lj kg hu mg b fv ml mm l mn mo">def cohort_heatmap(cohorts,col,title):<br/>    size = group_size(cohorts,col)<br/>    over_time = cohort_over_time(cohorts,size,col)<br/>    _cohort_heatmap(over_time,title)<br/>    <br/>def group_size(cohorts,col):<br/>    # reindex the DataFrame<br/>    cohorts.reset_index(inplace=True)<br/>    cohorts.set_index(['cohort_group', 'cohort_period'], inplace=True)</span><span id="777e" class="lj kg hu mg b fv mp mm l mn mo"># create a Series holding the total size of each cohort_group<br/>    return cohorts[col].groupby(level=0).first()</span><span id="ab68" class="lj kg hu mg b fv mp mm l mn mo">def cohort_over_time(cohorts,group_size,col):<br/>    return cohorts[col].unstack(0).divide(group_size, axis=1)</span><span id="94b8" class="lj kg hu mg b fv mp mm l mn mo">def _cohort_heatmap(cohort_over_time,title):<br/>    plt.figure(figsize=(24, 16))<br/>    plt.title(title)<br/>    sns.heatmap(cohort_over_time.T, mask=cohort_over_time.T.isnull(), annot=True, fmt='.0%');</span></pre><h2 id="351b" class="lj kg hu bd kh lk ll lm kl ln lo lp kp jr lq lr kt jv ls lt kx jz lu lv lb lw dt translated">7.客户保持</h2><p id="a091" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">都到这种地步了！只需运行以下程序，以热图的形式查看一段时间内的客户保持率:</p><pre class="lx ly lz ma fq mh mg mi mj aw mk dt"><span id="edf2" class="lj kg hu mg b fv ml mm l mn mo">cohort_heatmap(cohorts,"total_customers","Customer Retention")</span></pre><p id="7efc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这会产生:</p><figure class="lx ly lz ma fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ms"><img src="../Images/fc82eb79415277f405df16e35d24e112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bkbzaUCCULdhalghwVcEYg.png"/></div></div></figure><h2 id="e702" class="lj kg hu bd kh lk ll lm kl ln lo lp kp jr lq lr kt jv ls lt kx jz lu lv lb lw dt translated">8.收入留存</h2><p id="a38a" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">你有SaaS的圣杯吗，<a class="ae ke" href="https://www.profitwell.com/blog/how-to-achieve-negative-churn-and-why-it-matters" rel="noopener ugc nofollow" target="_blank">负面搅动</a>？这意味着即使有客户流失，你的人均收入也会随着时间的推移而增长。让我们看看:</p><pre class="lx ly lz ma fq mh mg mi mj aw mk dt"><span id="e351" class="lj kg hu mg b fv ml mm l mn mo">cohort_heatmap(cohorts,"amount_due","Revenue Retention")</span></pre><figure class="lx ly lz ma fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mt"><img src="../Images/de135f4b0ee51f93ad4d742bc13e7651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LKIp6VF0GpERTKT2KjxNmQ.png"/></div></div></figure><h1 id="bccc" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">你还能把它带到哪里？</h1><ul class=""><li id="810a" class="mu mv hu ji b jj ld jn le jr mw jv mx jz my kd mz na nb nc dt translated">使用绝对数字和百分比</li><li id="5a22" class="mu mv hu ji b jj nd jn ne jr nf jv ng jz nh kd mz na nb nc dt translated">按客户_国家过滤</li><li id="e99f" class="mu mv hu ji b jj nd jn ne jr nf jv ng jz nh kd mz na nb nc dt translated">按自定义字段筛选</li><li id="8539" class="mu mv hu ji b jj nd jn ne jr nf jv ng jz nh kd mz na nb nc dt translated">按客户规模过滤(例如:保留最大的客户)</li><li id="1433" class="mu mv hu ji b jj nd jn ne jr nf jv ng jz nh kd mz na nb nc dt translated">加入<a class="ae ke" href="https://petaldata.app/datasets/hubspot/" rel="noopener ugc nofollow" target="_blank"> Hubspot数据</a>(例如:通过有机搜索注册的客户的留存率)</li></ul><h1 id="a353" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">现在就试试吧！</h1><p id="e0e1" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">我已经用Python脚本创建了一个<a class="ae ke" href="https://github.com/petaldata/stripe-cohort-analysis" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>来完成上面的所有步骤。要使用:</p><pre class="lx ly lz ma fq mh mg mi mj aw mk dt"><span id="0d89" class="lj kg hu mg b fv ml mm l mn mo">git clone <a class="ae ke" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:petaldata/stripe-cohort-analysis.git<br/>STRIPE_API_KEY=[YOUR API KEY] python stripe_cohort_analysis.py</span></pre><p id="96a7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">该脚本将随着时间的推移生成您的客户群的两张热图(在当前目录中保存为png)。</p></div></div>    
</body>
</html>