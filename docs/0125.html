<html>
<head>
<title>Deploy Private Docker Registry on GCP with Nexus, Terraform and Packer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Nexus、Terraform和Packer在GCP部署私有Docker注册表</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/deploy-private-docker-registry-on-gcp-with-nexus-terraform-and-packer-1af2b6a2a9c9?source=collection_archive---------8-----------------------#2019-01-06">https://medium.com/hackernoon/deploy-private-docker-registry-on-gcp-with-nexus-terraform-and-packer-1af2b6a2a9c9?source=collection_archive---------8-----------------------#2019-01-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/fa9e413eb61210a05c07ae233e29a912.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*THwLoeqaLjU3IRE83n8TAA.jpeg"/></div></div></figure><p id="67e6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这篇文章中，我将带您了解如何在Google云平台上部署Sonatype Nexus OSS 3，以及如何创建一个私有的Docker托管存储库来存储您的Docker映像和其他构建工件(maven、npm和pypi等)。为了实现这一点，我们需要使用Packer来烘焙我们的机器映像，以创建预安装和配置了Nexus的黄金映像。Terraform将用于部署基于烘焙映像的Google compute实例。以下架构描述了构建工作流:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ka"><img src="../Images/4e2b3060393fb02830c1785adf0ce69f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PiK5JnFKS-RGaBl7c2FMmQ.png"/></div></div></figure><p id="a4df" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="kf"> PS:本教程用到的所有模板，都可以在我的</em> <a class="ae kg" href="https://github.com/mlabouardy/terraform-gcp-labs" rel="noopener ugc nofollow" target="_blank"> <em class="kf"> GitHub </em> </a> <em class="kf">上找到。</em></p><p id="f221" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，我们需要创建与Google Compute Engine (GCE)一起使用的机器映像。Packer将基于CentOS映像创建一个临时实例，并使用shell脚本来配置该实例:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="6f12" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">shell脚本将根据他们的<a class="ae kg" href="https://help.sonatype.com/repomanager2/installing-and-running/installing" rel="noopener ugc nofollow" target="_blank">官方文档</a>安装Nexus OSS的最新稳定版本，并等待服务启动和运行，然后它将使用脚本API发布一个groovy脚本:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="66a2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该脚本将创建一个Docker私有注册表，监听端口5000:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="cfc3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦定义了模板文件，发出<em class="kf"> packer build </em>命令来烘焙我们的机器映像:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kj"><img src="../Images/25543e52165c092ebecfea8704388792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GH_D-HXH_D16ztTFaifLMg.png"/></div></div></figure><p id="555f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您从<strong class="je hv">计算引擎</strong>仪表板返回到<strong class="je hv">图像</strong>部分，应该会创建一个名为nexus的新图像:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kk"><img src="../Images/41d442926df0091ac5dcc3512b92d9f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YBk9F0kezbABA7vQ-roG-w.png"/></div></div></figure><p id="1dbf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们已经准备好部署Nexus，我们将基于用Packer烘焙的机器映像创建一个Nexus服务器。模板文件是不言自明的，它创建了一组防火墙规则，允许来自任何地方的端口8081 (Nexus GUI)和22 (SSH)上的入站流量，并基于Nexus映像创建了一个google compute实例:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="2c0f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在终端上，运行<em class="kf"> terraform init </em>命令下载并安装Google provider，如下图所示:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kl"><img src="../Images/27db40894426a274a2cad0f500c6568e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sFQUC7TFmMvEgy80wkd6Zg.png"/></div></div></figure><p id="b1fb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用<em class="kf">地形计划</em>命令创建一个执行计划(试运行)。它向您显示将提前创建的内容，这有利于调试并确保您没有做错任何事情，如下一个截图所示:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff km"><img src="../Images/4f7772b7722efb5fb8c5fd6ee14ed0f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Agvo5R9_FF7cNAir90G5CQ.png"/></div></div></figure><p id="e46d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当你准备好了，就可以通过发出<em class="kf"> terraform apply </em>来应用更改了:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kn"><img src="../Images/66f56330f540c45274a2681b08a8acb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nrhGdoGIKBeNSkLe6Ebd7A.png"/></div></div></figure><p id="8a53" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Terraform将创建所需的资源，并在输出部分显示nexus实例的公共ip地址。跳回GCP控制台，您的nexus实例应该已经创建好了:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kk"><img src="../Images/c703eceb6ec72eae675227b0566463b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dmc1rgd-7LV6RfTRBMGERA.png"/></div></div></figure><p id="fa6d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您将您最喜欢的浏览器指向<a class="ae kg" href="http://instance_ip:8081," rel="noopener ugc nofollow" target="_blank"> http://instance_ip:8081，</a>您应该会看到Sonatype Nexus Repository Manager界面:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kk"><img src="../Images/c411d9c03fea179bf6bae181da84d6a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWgE1-_OmJ8YniVFzh1LXg.png"/></div></div></figure><p id="dbc2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">点击右上角的<strong class="je hv">签到</strong>按钮，使用用户名“<strong class="je hv"> admin </strong>和密码“<strong class="je hv"> admin123 </strong>”。然后，单击齿轮转到服务器管理和配置部分。导航到“<strong class="je hv">存储库</strong>，我们的私有Docker存储库应该创建如下:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kk"><img src="../Images/151f778e4ccc1a190ccb2aa10971d5f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1_g2cPPZddBSJ-UbgQVr7g.png"/></div></div></figure><p id="54ce" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">docker存储库按预期发布在端口5000上:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kk"><img src="../Images/a491fa178eaaa49cee1c70772e5da481.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*daj9CoCRK_xGQWQ7GKMo4g.png"/></div></div></figure><p id="a362" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此，我们需要允许该端口上的入站流量，因此相应地更新防火墙规则:</p><figure class="kb kc kd ke fq iv"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="2c70" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">发出<em class="kf"> terrafrom apply </em>命令以应用更改:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ko"><img src="../Images/46022a74731079eecdc53a87b3b2383b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l2i_3XDr4DMCy1EmOz9NaA.png"/></div></div></figure><p id="0c04" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您的私有docker注册表已经准备好在<em class="kf"> instance_ip:5000 </em>上工作，让我们通过推送docker映像来测试它。</p><p id="6c3d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因为我们已经在普通HTTP端点上公开了私有Docker注册中心，所以我们需要配置Docker守护进程作为私有Docker注册中心的客户端，以允许不安全的连接。</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kp"><img src="../Images/9105866c6e7482fa34797c25852b6b2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qmiYaJHnQaNJIurkAVhMxA.png"/></div></div></figure><ul class=""><li id="3fd3" class="kq kr hu je b jf jg jj jk jn ks jr kt jv ku jz kv kw kx ky dt translated"><em class="kf">在Windows或Mac OS X </em>:点击托盘中的<strong class="je hv"> Docker图标</strong>打开<strong class="je hv"> Preferences </strong>。点击<strong class="je hv">守护进程</strong>选项卡，在<strong class="je hv">不安全注册表</strong>部分添加暴露Nexus GUI的IP地址和端口号5000。不要忘记<strong class="je hv">应用&amp;重启</strong> <em class="kf"> </em>以使更改生效，您已经准备就绪。</li><li id="1db5" class="kq kr hu je b jf kz jj la jn lb jr lc jv ld jz kv kw kx ky dt translated"><em class="kf">其他OS </em>:遵循<a class="ae kg" href="https://docs.docker.com/registry/insecure/" rel="noopener ugc nofollow" target="_blank">官方指南</a>。</li></ul><p id="c6a7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，您应该能够使用以下命令登录到您的私有Docker注册表了:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff le"><img src="../Images/aac32b3ba68454241d79233a8ab1c3f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0npmpWsx98NARXgd4miLOA.png"/></div></div></figure><p id="406f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用<em class="kf"> docker push </em>命令将您的docker映像推送到注册表:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lf"><img src="../Images/5f89ae920752c560adc3eb92908b5a75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qUjJjWolUob1-FaS-mDflA.png"/></div></div></figure><p id="3278" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您返回Nexus Dashboard，您的docker图像应存储有最新的标签:</p><figure class="kb kc kd ke fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kk"><img src="../Images/39c74457775aa9e3b0a213a834e108f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lxUirhR1HyK7v_6441K5oQ.png"/></div></div></figure><p id="d48d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请在下面留下您的评论、反馈或建议，或者直接在Twitter<a class="ae kg" href="https://twitter.com/mlabouardy" rel="noopener ugc nofollow" target="_blank"><strong class="je hv">@</strong>mlabouardy</a>上与我联系。</p></div></div>    
</body>
</html>