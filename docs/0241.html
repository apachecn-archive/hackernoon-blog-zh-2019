<html>
<head>
<title>ASP.NET Core — How to use Dependency Injection in Entity Framework Core</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ASP.NET核心——如何在实体框架核心中使用依赖注入</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/asp-net-core-how-to-use-dependency-injection-in-entity-framework-core-4388fc5c148b?source=collection_archive---------0-----------------------#2019-01-10">https://medium.com/hackernoon/asp-net-core-how-to-use-dependency-injection-in-entity-framework-core-4388fc5c148b?source=collection_archive---------0-----------------------#2019-01-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/1bb2bd67b533b91d8ecb9ebf8cfec0d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*TVhyd7r8aMxl8u4H-sRfxw.png"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek"><strong class="bd jc">Dependency Injection with Entity Framework Core</strong></figcaption></figure><p id="9b47" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated"><strong class="jf hv">ASP.NET核心</strong>有一个优秀的<strong class="jf hv">依赖注入</strong>特性，通过它这个框架给你提供一个你想要的任何类的对象。因此您不必在代码中手动创建类对象。</p><p id="7af0" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">在本教程中，我将教你如何在<strong class="jf hv">实体框架核心</strong>中使用依赖注入方法。这将为你提供可以获得的以下好处:</p><blockquote class="kb"><p id="864c" class="kc kd hu bd ke kf kg kh ki kj kk ka ek translated">1.“DbContext”类的对象。</p><p id="507d" class="kc kd hu bd ke kf kg kh ki kj kk ka ek translated">2.从“appsettings.json”而不是从“DbContext”类的“OnConfiguring()”方法中获取连接字符串。</p></blockquote><h2 id="3c41" class="kl km hu bd kn ko kp kq kr ks kt ku kv jo kw kx ky js kz la lb jw lc ld le lf dt translated"><strong class="ak">onconfiguration()方法内的连接字符串</strong></h2><p id="dddf" class="pw-post-body-paragraph jd je hu jf b jg lg ji jj jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka hn dt translated">通常您在<code class="eh ll lm ln lo b">DbContext</code>类的<code class="eh ll lm ln lo b">OnConfiguring()</code>方法中提供您的数据库连接字符串，如下所示:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="496e" class="kl km hu lo b fv lx ly l lz ma">protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)<br/>{<br/>    if (!optionsBuilder.IsConfigured)<br/>    {<br/> optionsBuilder.UseSqlServer(@"Server=Smile;Database=Shop;Trusted_Connection=True;");</span><span id="b5ca" class="kl km hu lo b fv mb ly l lz ma">    }<br/>}</span></pre><p id="b505" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">这种方法不好，因为将连接字符串存储在<code class="eh ll lm ln lo b">appsettings.json</code>文件中更好。在<a class="ae mc" href="http://www.yogihosting.com/category/ef-core/" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hv">实体框架核心</strong> </a>中应用依赖注入后，您可以像这样简单地删除<code class="eh ll lm ln lo b">OnConfiguring()</code>方法中的所有内容:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="d4f8" class="kl km hu lo b fv lx ly l lz ma">protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)<br/>{<br/>    if (!optionsBuilder.IsConfigured)<br/>    {<br/>    }<br/>}</span></pre><p id="0a20" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">您需要按照如下所述进行以下3项更改:</p><h2 id="7046" class="kl km hu bd kn ko md kq kr ks me ku kv jo mf kx ky js mg la lb jw mh ld le lf dt translated"><strong class="ak"> 1。创建appsettings.json文件来存储数据库连接字符串</strong></h2><p id="ea33" class="pw-post-body-paragraph jd je hu jf b jg lg ji jj jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka hn dt translated">存储<em class="mi">数据库连接字符串</em>值的<code class="eh ll lm ln lo b">appsettings.json</code>文件的代码如下:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="893f" class="kl km hu lo b fv lx ly l lz ma">{<br/>    "ConnectionStrings": {<br/>        "DefaultConnection": "Server=Smile;Database=Shop;Trusted_Connection=True;"<br/>    }<br/>}</span></pre><h2 id="fbbb" class="kl km hu bd kn ko md kq kr ks me ku kv jo mf kx ky js mg la lb jw mh ld le lf dt translated"><strong class="ak"> 2。</strong> <code class="eh ll lm ln lo b">DbContext </code>类的构造函数应该继承基类</h2><p id="b81c" class="pw-post-body-paragraph jd je hu jf b jg lg ji jj jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka hn dt translated">在你的<code class="eh ll lm ln lo b">DbContext </code>类中，添加继承基类的构造函数。同时从<code class="eh ll lm ln lo b">OnConfiguring()</code>方法中移除连接字符串。<code class="eh ll lm ln lo b">DbContex </code>类的代码应该是:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="1caf" class="kl km hu lo b fv lx ly l lz ma">public class ShopContext : DbContext<br/>{<br/>    public ShopContext(DbContextOptions&lt;ShopContext&gt; options) : base(options) { }<br/>    public DbSet&lt;Products&gt; Products { get; set; }</span><span id="2fe4" class="kl km hu lo b fv mb ly l lz ma">    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)<br/>    {<br/>    }</span><span id="43d1" class="kl km hu lo b fv mb ly l lz ma">    protected override void OnModelCreating(ModelBuilder modelBuilder)<br/>    {<br/>    }<br/>}</span></pre><h2 id="459a" class="kl km hu bd kn ko md kq kr ks me ku kv jo mf kx ky js mg la lb jw mh ld le lf dt translated"><strong class="ak"> 3。在Startup.cs类中添加DbContext类作为服务</strong></h2><p id="ace9" class="pw-post-body-paragraph jd je hu jf b jg lg ji jj jk lh jm jn jo li jq jr js lj ju jv jw lk jy jz ka hn dt translated">更改<code class="eh ll lm ln lo b">Startup.cs</code>类以在其构造函数中获取<code class="eh ll lm ln lo b">Microsoft.Extensions.Configuration</code>名称空间的<code class="eh ll lm ln lo b">IConfiguration</code>对象。</p><p id="9319" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">在构造函数内部，用参数中给定的<code class="eh ll lm ln lo b">IConfiguration</code>对象的值设置<code class="eh ll lm ln lo b">IConfiguration</code>类型的公共属性的值。</p><p id="9aeb" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">这方面的代码是:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="a0e3" class="kl km hu lo b fv lx ly l lz ma">public Startup(IConfiguration configuration)<br/>{<br/>    Configuration = configuration;<br/>}</span><span id="a352" class="kl km hu lo b fv mb ly l lz ma">public IConfiguration Configuration { get; }</span></pre><p id="8f41" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">这一改变将帮助您读取<code class="eh ll lm ln lo b">Startup.cs</code>类中的<code class="eh ll lm ln lo b">appsettings.json</code>文件。</p><p id="6db5" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">接下来，将<code class="eh ll lm ln lo b">DbContext</code>类作为服务添加到<code class="eh ll lm ln lo b">ConfigureService()</code>方法中。参见下面的代码:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="e863" class="kl km hu lo b fv lx ly l lz ma">services.AddDbContext&lt;ShopContext&gt;(options =&gt; options.UseSqlServer(Configuration["ConnectionStrings:DefaultConnection"]));</span></pre><p id="35ed" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">启动类的更新代码应该是:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="f77d" class="kl km hu lo b fv lx ly l lz ma">public class Startup<br/>{<br/>    public Startup(IConfiguration configuration)<br/>    {<br/>        Configuration = configuration;<br/>    }</span><span id="dc1c" class="kl km hu lo b fv mb ly l lz ma">    public IConfiguration Configuration { get; }</span><span id="b261" class="kl km hu lo b fv mb ly l lz ma">    public void ConfigureServices(IServiceCollection services)<br/>    {<br/>        services.AddDbContext&lt;ShopContext&gt;(options =&gt; options.UseSqlServer(Configuration["ConnectionStrings:DefaultConnection"]));<br/>        services.AddMvc();<br/>    }</span><span id="75ce" class="kl km hu lo b fv mb ly l lz ma">    public void Configure(IApplicationBuilder app, IHostingEnvironment env)<br/>    {<br/>        app.UseStaticFiles();<br/>        app.UseDeveloperExceptionPage();<br/>        app.UseMvc(routes =&gt;<br/>        {<br/>            routes.MapRoute(name: "default", template: "{controller=Home}/{action=Index}/{id?}");<br/>        });<br/>    }<br/>}</span></pre><blockquote class="mj mk ml"><p id="813b" class="jd je mi jf b jg jh ji jj jk jl jm jn mm jp jq jr mn jt ju jv mo jx jy jz ka hn dt translated"><strong class="jf hv"> <em class="hu">使用依赖注入</em> </strong>在控制器中获取DbContext对象</p></blockquote><p id="1d83" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">现在你已经准备好了，让我展示如何使用<strong class="jf hv">依赖注入</strong>在构造函数中获得<code class="eh ll lm ln lo b">DbContext </code>类对象。你所要做的就是在控制器的构造函数中添加<code class="eh ll lm ln lo b">DbContext </code>类对象，并为其设置一个公共属性值。</p><blockquote class="kb"><p id="1041" class="kc kd hu bd ke kf kg kh ki kj kk ka ek translated">您可以从本教程中了解到所有关于依赖注入的特性——ASP.NET内核中的<a class="ae mc" href="http://www.yogihosting.com/aspnet-core-dependency-injection/" rel="noopener ugc nofollow" target="_blank"> <strong class="ak">依赖注入</strong> </a></p></blockquote><p id="6fef" class="pw-post-body-paragraph jd je hu jf b jg mp ji jj jk mq jm jn jo mr jq jr js ms ju jv jw mt jy jz ka hn dt translated">将以下代码添加到构造函数中:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="fd3e" class="kl km hu lo b fv lx ly l lz ma">private ShopContext shopContext;</span><span id="c262" class="kl km hu lo b fv mb ly l lz ma">public HomeController(ShopContext sc)<br/>{<br/>    shopContext = sc;<br/>}</span></pre><p id="0fbe" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">现在，您已经准备好使用实体框架核心与数据库进行通信了。</p><p id="11d8" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">要从数据库中读取记录:</p><blockquote class="mj mk ml"><p id="6873" class="jd je mi jf b jg jh ji jj jk jl jm jn mm jp jq jr mn jt ju jv mo jx jy jz ka hn dt translated">商店背景。老师；</p></blockquote><p id="c4b4" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">要在数据库中创建记录:</p><blockquote class="mj mk ml"><p id="e190" class="jd je mi jf b jg jh ji jj jk jl jm jn mm jp jq jr mn jt ju jv mo jx jy jz ka hn dt translated">商店背景。Products.Add(产品)；<br/>商店上下文。save changes()；</p></blockquote><p id="40a7" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">查看控制器的更新代码，其中还列出了读取和插入记录的操作方法。</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="ed52" class="kl km hu lo b fv lx ly l lz ma">public class HomeController : Controller<br/>{<br/>    private ShopContext shopContext;<br/>    public HomeController(ShopContext sc)<br/>    {<br/>        shopContext = sc;<br/>    }</span><span id="8ec1" class="kl km hu lo b fv mb ly l lz ma">    public IActionResult Index()<br/>    {<br/>        return View(shopContext.Teacher);<br/>    }</span><span id="9de4" class="kl km hu lo b fv mb ly l lz ma">    public IActionResult Create()<br/>    {<br/>        return View();<br/>    }</span><span id="0e73" class="kl km hu lo b fv mb ly l lz ma">    [HttpPost]<br/>    public IActionResult Create_Post(Products product)<br/>    {<br/>        if (ModelState.IsValid)<br/>        {    <br/>            shopContext.Products.Add(product);<br/>            shopContext.SaveChanges();<br/>            return RedirectToAction("Index");<br/>        }<br/>        else <br/>            return View();<br/>    }<br/>}</span></pre><p id="cd3f" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated"><strong class="jf hv"> <em class="mi">结论</em> </strong></p><p id="15b5" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">希望你喜欢这个关于<em class="mi">实体框架核心带依赖注入</em>的教程。这只是改进代码的一个步骤。如果你喜欢这个教程，那么请给我<strong class="jf hv">一些掌声</strong>，并且每周跟随我学习一次关于Web开发的教程。</p><p id="39ab" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">也可以看看我在HACKERNOON的另一篇文章— <a class="ae mc" href="https://hackernoon.com/7-common-web-development-problems-which-every-developer-from-beginners-to-experts-should-know-with-47a7d2e9367f" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hv">从初学者到专家的每个开发人员都应该知道的7个常见的Web开发问题【有多个解决方案】</strong> </a></p></div></div>    
</body>
</html>