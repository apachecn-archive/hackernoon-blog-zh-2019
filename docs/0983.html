<html>
<head>
<title>How to Implement ETL Application using Hasura GraphQL Engine And Next.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Hasura GraphQL 引擎和 Next.js 实现 ETL 应用</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-implement-etl-application-using-hasura-graphql-engine-and-next-js-4e528ae3a8bd#2019-02-08">https://medium.com/hackernoon/how-to-implement-etl-application-using-hasura-graphql-engine-and-next-js-4e528ae3a8bd#2019-02-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><h1 id="807f" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated"><strong class="ak">什么是 ETL💭？</strong></h1><p id="ed80" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated"><a class="ae kn" href="https://www.webopedia.com/TERM/E/ETL.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jr hv"> ETL </strong> </a>是<strong class="jr hv"> <em class="ko"> e </em> </strong> <em class="ko"> xtract，</em><strong class="jr hv"><em class="ko">t</em></strong><em class="ko">transform，</em><strong class="jr hv"><em class="ko">l</em></strong><em class="ko">oad</em>三个数据库函数组合成一个工具，从一个数据库中取出数据，放入另一个数据库中。</p><ul class=""><li id="4c97" class="kp kq hu jr b js kr jw ks ka kt ke ku ki kv km kw kx ky kz dt translated"><strong class="jr hv">提取</strong>是<em class="ko">从数据库中读取数据</em>的过程。在这一阶段，通常从多种不同类型的来源收集数据。</li><li id="765c" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated"><strong class="jr hv">转换</strong>是<strong class="jr hv"/><em class="ko">将提取的数据</em>从其先前的形式转换成其需要的形式，以便将其放入另一个数据库的过程。通过使用规则或查找表，或者通过将数据与其他数据相结合，可以进行转换。</li><li id="81aa" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated"><strong class="jr hv">加载</strong>是<em class="ko">将数据</em>写入目标数据库的过程</li></ul></div><div class="ab cl lf lg hc lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hn ho hp hq hr"><p id="b755" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">在 hasura 给出的样例 app 中，serverless-etl app 就是其中之一。我将展示如何使用 Next.js 实现它。</p><p id="a3c6" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">这是 hasura 给出的例子的<a class="ae kn" href="https://github.com/hasura/graphql-engine/tree/master/community/sample-apps/serverless-etl" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><p id="4ba1" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">这个应用程序的主要特点将是:-</p><ul class=""><li id="6f5b" class="kp kq hu jr b js kr jw ks ka kt ke ku ki kv km kw kx ky kz dt translated">将图书添加到数据库</li><li id="2d33" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">数据库中的数据保存在 algolia 索引中</li><li id="7f81" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">在 algolia 索引中搜索这本书</li></ul><h2 id="853b" class="lp is hu bd it lq lr ls ix lt lu lv jb ka lw lx jf ke ly lz jj ki ma mb jn mc dt translated"><strong class="ak">我们将如何实现它？</strong></h2><p id="8e90" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我们将使用 graphql 突变将图书详细信息插入到数据库中，当一些内容被插入到数据库中时，将触发一个事件，该事件将使用数据库中插入的数据更新 algolia 索引，并且在搜索时可以从 algolia 索引中检索该数据。就是这样！就这么简单。</p><h2 id="98c1" class="lp is hu bd it lq lr ls ix lt lu lv jb ka lw lx jf ke ly lz jj ki ma mb jn mc dt translated"><strong class="ak">先决条件:</strong></h2><ul class=""><li id="60bb" class="kp kq hu jr b js jt jw jx ka md ke me ki mf km kw kx ky kz dt translated">阿尔戈利亚账户</li><li id="c3b2" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">Hasura GraphQL 发动机(HGE)安装</li></ul></div><div class="ab cl lf lg hc lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hn ho hp hq hr"><p id="bff7" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">既然你准备好了，我们就开始吧！</p><h1 id="324a" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated"><strong class="ak">设置基本 Next.js 项目和 Graphql 引擎</strong></h1><p id="f646" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">第一步是使用<code class="eh mg mh mi mj b">yarn create next-app etl-example</code>创建一个 next.js 项目。这个命令将为我们将要处理的 next.js 项目创建一个基本的样板文件。</p><p id="fffc" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">从下面的要点中添加 package.json 文件中不存在的包和脚本，并使用<code class="eh mg mh mi mj b">yarn install</code>安装它。</p><figure class="mk ml mm mn fq mo"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="164b" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">接下来使用<a class="ae kn" href="https://heroku.com/deploy?template=https://github.com/hasura/graphql-engine-heroku" rel="noopener ugc nofollow" target="_blank"> one-click </a> deploy 选项设置一个 Hasura GraphQL 引擎，记下部署的 url，并使用以下代码在根文件夹中创建一个<strong class="jr hv"> config.js </strong>文件</p><figure class="mk ml mm mn fq mo"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="413a" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">用部署的 hasura 引擎的 url 替换<code class="eh mg mh mi mj b">herokuapp-url</code>。如果有的话，在配置对象中添加身份验证头。</p><h1 id="6ad4" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">创建图书表格</h1><p id="2ffe" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我们将有一个名为<strong class="jr hv"> book </strong>的单个表，其中包含书名和作者等书的详细信息。为此，我们必须转到 Hasura GraphQL 引擎控制台并创建下表</p><figure class="mk ml mm mn fq mo fe ff paragraph-image"><div class="fe ff mr"><img src="../Images/78dd1fdad073fd218a35ca285e4bc355.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/format:webp/1*M37AuUG7vEy4xTWqUxFsNw.png"/></div><figcaption class="mu mv fg fe ff mw mx bd b be z ek">book table</figcaption></figure><h1 id="ef46" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">设置 Algolia 指数</h1><p id="d37e" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">下一步是建立一个 Algolia 指数，按照下面给出的指示。</p><ul class=""><li id="7c55" class="kp kq hu jr b js kr jw ks ka kt ke ku ki kv km kw kx ky kz dt translated">注册<a class="ae kn" href="https://www.algolia.com/" rel="noopener ugc nofollow" target="_blank"> Algolia 账户</a></li><li id="eb65" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">转到仪表板，</li><li id="5492" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">点击左侧工具条上的<code class="eh mg mh mi mj b">Indices</code>选项卡</li><li id="829e" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">点击<code class="eh mg mh mi mj b">New Index</code>按钮</li><li id="d908" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">命名为<code class="eh mg mh mi mj b">demo_serverless_etl_app</code></li><li id="73e2" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">转到侧边栏上的<code class="eh mg mh mi mj b">API Keys</code>标签</li><li id="13af" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">复制<code class="eh mg mh mi mj b">Application ID</code>(我们称之为<code class="eh mg mh mi mj b"><strong class="jr hv">ALGOLIA_APP_ID</strong></code>)</li><li id="c436" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">点击<code class="eh mg mh mi mj b">All API Keys</code>选项卡，然后点击<code class="eh mg mh mi mj b">New API Key</code>按钮</li><li id="07c5" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">描述为<code class="eh mg mh mi mj b">server key</code></li><li id="aaf2" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">选择<code class="eh mg mh mi mj b">demo_serverless_etl_app</code>索引</li><li id="9251" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">选择 ACL 部分下的<code class="eh mg mh mi mj b">Add records</code></li><li id="b11e" class="kp kq hu jr b js la jw lb ka lc ke ld ki le km kw kx ky kz dt translated">点击<code class="eh mg mh mi mj b">Generate</code>并从列表中复制这个 API 键(我们称之为<code class="eh mg mh mi mj b"><strong class="jr hv">ALGOLIA_ADMIN_API_KEY</strong></code>)</li></ul><h1 id="85d5" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">设置 webhooks</h1><p id="7942" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">当一些数据被插入到数据库中时，为了将数据添加到 algolia 索引中，我们将需要一个在数据插入时触发的 webhook，这个 webhook 将把插入的数据添加到 algolia 索引中。对于单个 api 端点来说，拥有一个单独的服务器是没有意义的。我们可以做的是设置一个节点服务器，为 webhook 添加 api 端点，并将所有其他 url 路由到 next.js 处理程序。</p><p id="7292" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">对于节点服务器，我们必须在根目录下创建一个名为<code class="eh mg mh mi mj b">server.js</code>的文件，并从下面复制内容。当数据被插入表格并添加到 algolia 索引中时，路径<code class="eh mg mh mi mj b">/webhook</code>将用于触发事件。在代码中的空白处添加您的 algolia APP_ID 和 ADMIN_API_KEY。</p><figure class="mk ml mm mn fq mo"><div class="bz el l di"><div class="mp mq l"/></div></figure><h1 id="d7d0" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">构建前端</h1><p id="a5b8" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">接下来，我们将设置我们的页面，其中我们将接受作者姓名和书名，这将被添加到数据库中，还有一个搜索栏，您可以在其中搜索任何书籍。在<code class="eh mg mh mi mj b">post</code>文件夹中创建一个名为<code class="eh mg mh mi mj b">index.js</code>的文件，添加以下代码，并用您的值替换 algolia api 变量。</p><figure class="mk ml mm mn fq mo"><div class="bz el l di"><div class="mp mq l"/></div></figure><figure class="mk ml mm mn fq mo fe ff paragraph-image"><div class="fe ff my"><img src="../Images/bffd817e58e726bae33a5a89830872c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:448/format:webp/1*SKTxqrJ7iJcWndcNE7lDSw.png"/></div><figcaption class="mu mv fg fe ff mw mx bd b be z ek">Search Component</figcaption></figure><p id="07d6" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated"><strong class="jr hv"> react-instantsearch-dom </strong>包提供的<strong class="jr hv"> InstantSearch </strong>组件会自动执行搜索魔法。你不必担心编码所有这些搜索的东西😉。<strong class="jr hv">搜索框</strong>组件将呈现搜索框，而<strong class="jr hv">点击</strong>组件将呈现您的搜索结果</p><h1 id="689f" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">部署</h1><p id="e091" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">现在我们已经准备好了服务器，把它部署到任何地方，比如说<a class="ae kn" href="https://glitch.com" rel="noopener ugc nofollow" target="_blank"> glitch </a>，你将得到一个已部署服务器的 url。</p><h1 id="ddfb" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">创建事件触发器</h1><p id="c31e" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我们的下一步是在向数据库添加新书时创建一个事件触发器，为此，请转到 Hasura Graphql 引擎控制台中的<code class="eh mg mh mi mj b">Events</code>选项卡，并添加一个新的触发器。将<strong class="jr hv"> &lt; TRIGGER_URL &gt; </strong>替换为<strong class="jr hv">&lt;SERVER _ URL&gt;/web hook。</strong></p><figure class="mk ml mm mn fq mo fe ff paragraph-image"><div class="fe ff mz"><img src="../Images/48ab7f9169a901b7d5812fac9b93ca19.png" data-original-src="https://miro.medium.com/v2/resize:fit:446/format:webp/1*RyGt-2Q2VHoMEO-nbe9MMw.png"/></div><figcaption class="mu mv fg fe ff mw mx bd b be z ek">Trigger</figcaption></figure><p id="08ac" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">现在你可以在你的浏览器中打开<server_url>看看神奇之处！😉</server_url></p><p id="919b" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">就这样，我们准备好了 ETL-demo🙌。我没有在代码中添加任何样式。如果你想让它看起来更棒，只需添加所需的 css 并使其更好😎。</p><p id="925a" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">链接到 gists :- <a class="ae kn" href="https://gist.github.com/aswinzz/58e91f9c3b843cde3835deacc79804bf" rel="noopener ugc nofollow" target="_blank"> index.js </a>，<a class="ae kn" href="https://gist.github.com/aswinzz/d062678d14df02b6063217c4b81e0e94" rel="noopener ugc nofollow" target="_blank"> server.js </a>，<a class="ae kn" href="https://gist.github.com/aswinzz/cff43e3ff51ff689454e5234308656cc" rel="noopener ugc nofollow" target="_blank"> package.json </a></p><h1 id="9b8f" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">关于我</h1><p id="1c65" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我的名字是<a class="ae kn" href="http://aswinzz.me" rel="noopener ugc nofollow" target="_blank"> <strong class="jr hv"> Aswin VB </strong> </a>。我是阿拉哈巴德印度信息技术学院的一名本科生，正在攻读信息技术的学士学位。</p><p id="c392" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">我喜欢创造和学习新事物，当我有空的时候我总是这样做。我喜欢用 J <strong class="jr hv"> avaScript 和 Python </strong>编写代码。</p><p id="8aef" class="pw-post-body-paragraph jp jq hu jr b js kr ju jv jw ks jy jz ka lm kc kd ke ln kg kh ki lo kk kl km hn dt translated">你可以在<a class="ae kn" href="https://twitter.com/aswinvb1" rel="noopener ugc nofollow" target="_blank"> Twitter </a>和<a class="ae kn" href="https://github.com/aswinzz" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上关注我。</p></div></div>    
</body>
</html>