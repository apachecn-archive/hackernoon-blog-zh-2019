<html>
<head>
<title>5 Years On-Call: Lessons Learned</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">5 年待命:经验教训</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/5-years-on-call-lessons-learned-72576ef3f409#2019-01-28">https://medium.com/hackernoon/5-years-on-call-lessons-learned-72576ef3f409#2019-01-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/944dccf703145a8a25f3cbaf14d19d59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oS0kZmEwqM0-lIRkvUPpYg.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Night on-call shift.</figcaption></figure><p id="9aa1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在是凌晨 2 点 07 分，我正在睡觉，这时房间里响起了我的寻呼机的闹铃声。我秒醒，眼睛干涩，后背酸痛。我看了看我的手机。屏幕闪烁着一条错误消息，“数据库:CPU 达到 80%，高于 70%的阈值。”看起来很糟糕。可能有东西在攻击我们的数据库。我还不知道的是，情况会变得更糟，我的夜晚会变得短暂…</p><p id="4c2d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我为两种类型的公司工作过。第一个团队有专门的系统管理员负责在生产环境中进行部署，并且随叫随到。然后我加入了亚马逊，在那里软件工程师必须对他们生产的软件随叫随到。我起初认为这很奇怪，但现在我意识到这有多么重要。</p><p id="9621" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我吃了苦头才知道随叫随到是必不可少的。但是当我面对亚马逊的新员工时，我会用以下三个主要原因来解释为什么这很重要。它们都与亚马逊领导原则有关，但很容易适用于每个人。</p><h1 id="f761" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">顾客痴迷</h1><p id="2c2b" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">首先，当出现问题时，意味着您的客户受到影响，无法采取有效措施。对我们来说，存储整个仓库库存的数据库已经超负荷了。它响应缓慢，影响了零售网站的一些页面。我醒来后检查了我们的监控工具，在过去的 4 分钟里，350 名顾客在点击结账按钮时出错，阻止了他们购买。如果这种情况发生在你的网站上，我可以保证你会想尽快修复这个特定的 bug。</p><p id="1440" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这个问题对您的业务有明显的影响。因此，如果你是务实的，找一些更了解代码的人是很有意义的。他们知道最近做了哪些更改，他们可以快速确定错误的根本原因并部署修复措施。我意识到 87%的流量来自一个客户。凌晨 2 点，当数据库达到 95%的 CPU，处于崩溃的边缘时，我没有多想，我更改了我们 RDS 实例的安全组来阻止这个 IP，希望这将包含事件。</p><p id="e5b2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在这种高压的情况下，你必须保持冷静，为顾客做出最好的决定。你也没有时间请求访问或批准，所以为了消除摩擦点，给你的开发人员生产访问，这就是为什么亚马逊相信开发运营。</p><h1 id="4e2e" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">所有权</h1><p id="58d7" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">第二，如果你对你发布的代码负责，那么在将任何一行代码投入生产之前，你都会三思而行。我的第一份工作是在一家小公司，我记得这个星期五的晚上，我已经做了一个星期的功能，我的经理找到我，让我推进 prod，以便客户可以在周末测试。如果你曾经随叫随到，你知道在周五晚上释放是一个坏主意，因为如果有什么东西坏了，没有人会在那里帮助你。对我来说不幸的是，我当时还不知道这一点，所以我只是按照命令，推了推，然后不小心离开了大楼…正如你可以猜到的那样，周末期间出了一些问题，但我没有随叫随到，所以我没有受到它的影响。</p><p id="e688" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">当我正在调查这个深夜交通高峰时，另一个警报响了。我们的一个微服务中有 5000 个错误，该服务提供了一个 API 来统计库存。使用像 Sentry 这样的工具，我能够实时解析错误日志并读取“错误超时:无法连接数据库”。我发现我有罪的客户锤我们的数据库时，我阻止了它的 IP，它开始失败。我查看了代码，发现我们对前一天部署的 API 的重试逻辑进行了更改。回滚到以前的版本只是点击一个按钮。但为什么它在凌晨 2 点开始攻击我们的数据库，而不是在此之前？我还是没有头绪…</p><p id="c4eb" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">所有权意味着如果它坏了，它就在你身上。说清楚一点，重点不是责备你，而是让你负责。不要在你的代码中使用肮脏的手段，因为它会反击。投资于测试覆盖、自动化、CI/CD、监控实时日志和警报，因为您想要准确地知道什么时候出错。这个想法就是感受每一个 bug 的痛苦。如果你这样做了，你就会有明确的优先顺序。随叫随到让你有能力修复伤痛。</p><h1 id="b3a0" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">坚持最高标准</h1><p id="84a7" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">第三，如果有问题(相信我，肯定会有)，您将一劳永逸地修复错误。你不想因为同样的原因被呼两次。</p><p id="e6e1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">目前是凌晨 3:30，我手动更改了一个安全组，回滚到旧版本的代码，客户可以再次购买，stats API 正在工作，但我仍然不知道根本原因是什么，为什么它在凌晨 2 点开始失败，为什么测试没有捕捉到这种行为。老实说，这只是一个快速而肮脏的解决办法。但这没关系，因为第二天整个团队投入时间寻找合适的解决方案。它从识别根本原因开始，stats API 代码中的一个问题 bug，我们减少了数据库客户机的超时，并放置了一个重试逻辑。简而言之(1)，一个外部客户使用 stats API 生成需要仓库库存的大型财务报告。它每周在凌晨 2 点运行它们。因为该查询消耗 CPU，所以它会超时并重试，而不会终止之前的进程。</p><p id="21cc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们编写了一个测试来重现 bug，部署了一个适当的修复程序，并密切监控部署。我们写了一份事后分析，这份文件详细描述了事件的许多细节，列出了对客户的影响，汇编了适当的数据。我们使用了“5 个为什么”的方法来追踪根本原因。想出了一个行动项目清单，以避免在未来发生这种情况。它作为参考和文档。团队每月审查一次事后分析文档，这对整个公司的每个人都有帮助。我们花了 2 周时间写了一份好的事后分析文档，并实施了所有相关的行动。像一个内部和外部客户的节流阀，组织演习，把混沌猴系统等…</p><p id="e4c7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">此外，你要确保在任何事件发生前都做好准备。在随叫随到之前，我们有专门的入职流程。我们有一份叫做操作手册的文件，描述了在出现问题时的常规程序。基于<a class="ae lh" href="https://www.amazon.com/Checklist-Manifesto-How-Things-Right/dp/0312430000" rel="noopener ugc nofollow" target="_blank">清单</a>的想法，它确保我们在紧急情况下不会忘记任何东西。相信我，在凌晨 3:37，很容易忘记一些事情。</p><h1 id="ba38" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">结论</h1><p id="13bf" class="pw-post-body-paragraph jg jh hu ji b jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz lg kb kc kd hn dt translated">不存在“小 bug”或“小错误”。他们都隐藏了一些更重要的东西，质量的缺乏，有一天会越积越多，适得其反。当我加入团队时，我们平均每天都会收到一次传呼，每个人都在遭受这种情况，我们花在停火上的时间比开发新功能的时间还多。但由于我们的经理也随叫随到，他热衷于解决这种情况。经过一年对测试和最佳实践的积极投资，我们将警报次数减少到每两周一次。随叫随到可能会有压力，但它是软件工程师最好的学习工具。</p></div><div class="ab cl li lj hc lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hn ho hp hq hr"><p id="8d26" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><em class="lp"> (1)注意:我简化了我随叫随到的故事，发生的事情更复杂，更难察觉。我不想让文章充斥太多不相关的技术细节。主旨是一样的，结论也是一样的。</em></p><ul class=""><li id="07fa" class="lq lr hu ji b jj jk jn jo jr ls jv lt jz lu kd lv lw lx ly dt translated"><em class="lp">免责声明:这是我个人的反映，不涉及我的任何雇主、现在的雇主或以前的雇主。</em></li></ul></div></div>    
</body>
</html>