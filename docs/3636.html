<html>
<head>
<title>Executing Public &amp; Private Transactions on JPMorgan’s Quorum with Web3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Web3在JPMorgan的Quorum上执行公共和私人交易</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/executing-public-private-transactions-on-jpmorgans-quorum-with-web3-347190e3c35f?source=collection_archive---------10-----------------------#2019-06-14">https://medium.com/hackernoon/executing-public-private-transactions-on-jpmorgans-quorum-with-web3-347190e3c35f?source=collection_archive---------10-----------------------#2019-06-14</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="53aa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本指南面向任何对Quorum感兴趣的人。这是对使用<a class="ae jp" href="https://github.com/ethereum/web3.js" rel="noopener ugc nofollow" target="_blank"> web3.js </a>库部署契约和发送公共和私有仲裁事务的介绍。本指南中使用的代码也已上传至<a class="ae jp" href="https://github.com/ThomasRalee/quorum-iot-tutorial" rel="noopener ugc nofollow" target="_blank"> GitHub </a>。建议您在实验之前克隆回购。</p><p id="61b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本文将涵盖:</p><ul class=""><li id="9811" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">格式化您的智能合同</li><li id="991f" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">使用<a class="ae jp" href="https://chainstack.com/" rel="noopener ugc nofollow" target="_blank">链板</a>设置您的网络/基础设施</li><li id="8ea2" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">法定公开交易</li><li id="b6e3" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">法定私下交易</li></ul><p id="7d88" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了更好地说明提到的功能，我们将介绍一个简化的用例，其中包括一个结合物联网和区块链的工作实施，以监控参与者的存储设施温度。</p><h1 id="64e2" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">背景</h1><p id="e575" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">一些存储公司决定组建一个存储联盟，在区块链上共享信息和自动化流程。在这种情况下，他们决定使用法定人数。在本教程中，我们将讨论两个用例:公共事务和私有事务。</p><p id="e960" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">事务由不同的参与方创建，以便在它们所属的联合体中相互交互，每个事务将部署一个契约或执行该契约中的功能，以便将数据上传到网络。然后，这些更新将在联盟中的所有节点上复制。</p><p id="ce12" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">公开交易旨在让财团内的所有各方都能公开查看。另一方面，私人交易提供了另一层隐私。它使得交易和合同只能由获得许可的组织访问。</p><p id="0b11" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将对两种用例使用相同的智能契约，以更好地解释公共和私有事务是如何工作的。</p><h1 id="7923" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">智能合同</h1><p id="75e7" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">下面是我为这个用例创建的一个简单的智能契约。它有一个公共变量<strong class="it hv">温度</strong>，可以使用<code class="eh lh li lj lk b">set</code>方法对其进行修改，并使用<code class="eh lh li lj lk b">get</code>方法对其进行获取。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="b974" class="lt kf hu lk b fv lu lv l lw lx">pragma solidity ^0.4.25;</span><span id="5d87" class="lt kf hu lk b fv ly lv l lw lx">contract TemperatureMonitor {<br/>  int8 public temperature;</span><span id="1d18" class="lt kf hu lk b fv ly lv l lw lx">function set(int8 temp) public {<br/>    temperature = temp;<br/>  }</span><span id="cf95" class="lt kf hu lk b fv ly lv l lw lx">function get() view public returns (int8) {<br/>    return temperature;<br/>  }<br/>}</span></pre><p id="64b5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于与<a class="ae jp" href="https://github.com/ethereum/web3.js" rel="noopener ugc nofollow" target="_blank"> web3.js </a>一起工作的契约，它必须首先被格式化成各自的ABI和字节码格式。使用下面的函数<code class="eh lh li lj lk b">formatContract</code>使用以太坊的<a class="ae jp" href="https://github.com/ethereum/solc-js#readme" rel="noopener ugc nofollow" target="_blank"> solc-js </a>编译器编译合同。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="f7da" class="lt kf hu lk b fv lu lv l lw lx">function formatContract() {<br/>  const path = './contracts/temperatureMonitor.sol';<br/>  const source = fs.readFileSync(path,'UTF8');</span><span id="3ae6" class="lt kf hu lk b fv ly lv l lw lx">return solc.compile(source, 1).contracts[':TemperatureMonitor'];<br/>}</span></pre><p id="be0b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">格式化的合同应该如下所示:</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="2f14" class="lt kf hu lk b fv lu lv l lw lx">// interace<br/>[ <br/>  { <br/>    constant: true,<br/>    inputs: [],<br/>    name: ‘get’,<br/>    outputs: [Array],<br/>    payable: false,<br/>    stateMutability: ‘view’,<br/>    type: ‘function’ <br/>  },<br/>  { <br/>    constant: true,<br/>    inputs: [],<br/>    name: ‘temperature’,<br/>    outputs: [Array],<br/>    payable: false,<br/>    stateMutability: ‘view’,<br/>    type: ‘function’ <br/>  },<br/>  {<br/>    constant: false,<br/>    inputs: [Array],<br/>    name: ‘set’,<br/>    outputs: [],<br/>    payable: false,<br/>    stateMutability: ‘nonpayable’,<br/>    type: ‘function’ <br/>  }<br/>]</span><span id="1f9d" class="lt kf hu lk b fv ly lv l lw lx">// bytecode</span><span id="7785" class="lt kf hu lk b fv ly lv l lw lx">0x608060405234801561001057600080fd5b50610104806100206000396000f30060806040526004361060525763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416636d4ce63c81146057578063adccea12146082578063faee13b9146094575b600080fd5b348015606257600080fd5b50606960ae565b60408051600092830b90920b8252519081900360200190f35b348015608d57600080fd5b50606960b7565b348015609f57600080fd5b5060ac60043560000b60c0565b005b60008054900b90565b60008054900b81565b6000805491810b60ff1660ff199092169190911790555600a165627a7a72305820af0086d55a9a4e6d52cb6b3967afd764ca89df91b2f42d7bf3b30098d222e5c50029</span></pre><p id="e9b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">既然合同已经格式化并准备好了，我们将继续设置区块链基础设施来部署合同。</p><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff lz"><img src="../Images/d5ae671b4f23ad17605392ebea909fd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U6UbamZpNzgL2DrsAhsT3A.jpeg"/></div></div></figure><h1 id="7142" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">部署节点</h1><p id="c519" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated">部署区块链节点需要深厚的技术专业知识，尤其是在通过命令行界面(CLI)同步网络中的节点时。我相信大多数人都有一个艰难的时间来建立，维护或故障排除自己的区块链网络。</p><p id="2e95" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于没有经验、兴趣或时间来执行一长串依赖项和协议配置的人来说，手动部署是乏味的。对于这样的开发人员，我强烈推荐使用区块链平台即服务来设置、维护或排除他们自己的区块链。</p><p id="306b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我工作的公司，<a class="ae jp" href="https://chainstack.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">链家</strong> </a>，就是为你做这个的。chainstack平台消除了学习如何快速建立分散网络和维护区块链节点的痛苦和挫折。该平台是云无关的和多协议的。它实际上是一个一站式解决方案，不仅可以帮助您试验多种云和协议配置，还可以启动和维护生产级区块链网络。</p><p id="f992" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Chainstack上的Quorum explorer功能可以更好地显示区块链和智能合同的工作方式。下面是我如何使用Chainstack为这个用例设置具有3个节点的Quorum Raft网络的截图。</p><p id="569a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，让我们创建我们的第一个项目。你可以随意命名。</p><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff mh"><img src="../Images/bcf226cd895603b69e83cfadbe7026d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Gctqe8xS0WLv1FosFwR7vg.gif"/></div></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Create a project</figcaption></figure><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff mh"><img src="../Images/6c9529eabceebbfc44260469a0078a71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*NWWsc7-PA_1CfiPM_JB_Sg.gif"/></div></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Create Quorum Raft Network</figcaption></figure><p id="cbf9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将与网络一起创建一个默认节点。然后，我们继续向网络中添加两个节点。</p><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff mh"><img src="../Images/5504de04865ea1146e0a6c3fdd48ea18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*m7pIlKPJN95-YLNH54qAag.gif"/></div></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Create nodes</figcaption></figure><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff mm"><img src="../Images/ed466ce257918df2e2be664d39fc277e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9BgE72bpjhMuxwbew2kpew.png"/></div></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Voila! Here we have our very own network with three fully functional nodes.</figcaption></figure><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff mn"><img src="../Images/040a3155bed48ff20232f8b58cc4d507.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FBP0IMtAoYfFu8Wmrk-phA.png"/></div></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">The node details page shows the RPC, public key and other node-related information</figcaption></figure><p id="279a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在基础设施已经准备好了，我们将深入解释这个<a class="ae jp" href="https://github.com/ThomasRalee/quorum-iot-tutorial" rel="noopener ugc nofollow" target="_blank">回购</a>中的代码，关于如何使用<a class="ae jp" href="https://github.com/ethereum/web3.js" rel="noopener ugc nofollow" target="_blank"> web3.js </a>部署智能合约和执行交易。</p><h1 id="49fa" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">公共交易</h1><p id="15e3" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated"><strong class="it hv">背景:</strong>局部温度对热敏储存设施的成本削减有巨大影响，尤其是对于零度以下的要求。通过使公司能够实时共享其地理位置的环境温度并将其记录在不变的分类账上，业务参与者能够决定哪个区域最适合热敏存储设施，而无需长时间的市场研究。</p><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div class="fe ff mo"><img src="../Images/a36a92c6c514ea4bdc407bb8545dfe37.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*8C-bvlEydznlNsTnmjKf_A.png"/></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Infrastructure illustration</figcaption></figure><p id="1710" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将执行3个不同的任务，如上图所示:</p><p id="8379" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">1.通过<strong class="it hv">节点1 </strong>部署智能合约</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="7bc3" class="lt kf hu lk b fv lu lv l lw lx">const contractAddress = await deployContract(raft1Node);<br/>console.log(`Contract address after deployment: ${contractAddress}`);</span></pre><p id="d738" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2.在<strong class="it hv">节点2 </strong>上设置温度。这应该会将温度更新到3度。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="ca57" class="lt kf hu lk b fv lu lv l lw lx">const status = await setTemperature(raft2Node, contractAddress, 3);<br/>console.log(`Transaction status: ${status}`);</span></pre><p id="3270" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">3.<strong class="it hv"> Node3 </strong>从智能合约中检索温度；它应该返回3度。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="8158" class="lt kf hu lk b fv lu lv l lw lx">const temp = await getTemperature(raft3Node, contractAddress);<br/>console.log(‘Retrieved contract Temperature’, temp);</span></pre><p id="4d07" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面我们将详细介绍如何使用web3.js在Quorum节点上执行公共事务。</p><p id="6e05" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">使用RPC为3个节点启动web3实例:</strong></p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="c5b3" class="lt kf hu lk b fv lu lv l lw lx">const raft1Node = new Web3(<br/> new Web3.providers.HttpProvider(process.env.RPC1), null, {<br/>   transactionConfirmationBlocks: 1,<br/> },<br/>);</span><span id="7aa6" class="lt kf hu lk b fv ly lv l lw lx">const raft2Node = new Web3(<br/> new Web3.providers.HttpProvider(process.env.RPC2), null, {<br/>   transactionConfirmationBlocks: 1,<br/> },<br/>);</span><span id="451b" class="lt kf hu lk b fv ly lv l lw lx">const raft3Node = new Web3(<br/> new Web3.providers.HttpProvider(process.env.RPC3), null, {<br/>   transactionConfirmationBlocks: 1,<br/> },<br/>);</span></pre><p id="acfb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">接下来我们将部署智能合约:</strong></p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="20ef" class="lt kf hu lk b fv lu lv l lw lx">// returns the default account from the Web3 instance initiated previously</span><span id="ae5d" class="lt kf hu lk b fv ly lv l lw lx">function getAddress(web3) {<br/>  return web3.eth.getAccounts().then(accounts =&gt; accounts[0]);<br/>}</span><span id="91bb" class="lt kf hu lk b fv ly lv l lw lx">// Deploys the contract using contract's interface and node's default address</span><span id="2829" class="lt kf hu lk b fv ly lv l lw lx">async function deployContract(web3) {<br/>  const address = await getAddress(web3);</span><span id="de12" class="lt kf hu lk b fv ly lv l lw lx">// initiate contract with contract's interface<br/>  const contract = new web3.eth.Contract(<br/>    temperatureMonitor.interface<br/>  );</span><span id="39a5" class="lt kf hu lk b fv ly lv l lw lx">return contract.deploy({<br/>    // deploy contract with contract's bytecode<br/>    data: temperatureMonitor.bytecode,<br/>  })<br/>  .send({<br/>    from: address,<br/>    gas: '0x2CD29C0',<br/>  })<br/>  .on('error', console.error)<br/>  .then((newContractInstance) =&gt; {<br/>    // returns deployed contract address<br/>    return newContractInstance.options.address;<br/>  });<br/>}</span></pre><p id="a068" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://github.com/ethereum/web3.js" rel="noopener ugc nofollow" target="_blank"> web3.js </a>提供了两种与契约交互的方法:<code class="eh lh li lj lk b">call</code>和<code class="eh lh li lj lk b">send</code>。我们可以通过使用web3的<code class="eh lh li lj lk b">send</code>方法执行<code class="eh lh li lj lk b">set</code>方法来更新合同的温度。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="ed57" class="lt kf hu lk b fv lu lv l lw lx">// get contract deployed previously<br/>async function getContract(web3, contractAddress) {<br/>  const address = await getAddress(web3);</span><span id="ac1b" class="lt kf hu lk b fv ly lv l lw lx">return web3.eth.Contract(<br/>    temperatureMonitor.interface,<br/>    contractAddress, {<br/>      defaultAccount: address,<br/>    }<br/>  );<br/>}</span><span id="7217" class="lt kf hu lk b fv ly lv l lw lx">// calls contract set method to update contract's temperature<br/>async function setTemperature(web3, contractAddress, temp) {<br/>  const myContract = await getContract(web3, contractAddress);</span><span id="69a4" class="lt kf hu lk b fv ly lv l lw lx">return myContract.methods.set(temp).send({}).then((receipt) =&gt; {<br/>    return receipt.status;<br/>  });<br/>}</span></pre><p id="2fe6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，我们将使用web3的<code class="eh lh li lj lk b">call</code>方法来获取合同的温度。注意，<code class="eh lh li lj lk b">call</code>方法在本地节点上运行，因此不会在区块链上创建任何事务。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="f65c" class="lt kf hu lk b fv lu lv l lw lx">// calls contract get method to retrieve contract's temperature<br/>async function getTemperature(web3, contractAddress) {<br/>  const myContract = await getContract(web3, contractAddress);</span><span id="5c86" class="lt kf hu lk b fv ly lv l lw lx">return myContract.methods.get().call().then(result =&gt; result);<br/>}</span></pre><p id="70a3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们准备运行完整的<a class="ae jp" href="https://github.com/ThomasRalee/quorumWeb3TransactionsSample/blob/master/public.js" rel="noopener ugc nofollow" target="_blank"> public.js </a>，它应该会显示如下结果。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="4b1c" class="lt kf hu lk b fv lu lv l lw lx">// Execute public script<br/>node public.js</span><span id="d071" class="lt kf hu lk b fv ly lv l lw lx">Contract address after deployment: 0xf46141Ac7D6D6E986eFb2321756b5d1e8a25008F<br/>Transaction status: true<br/>Retrieved contract Temperature 3</span></pre><p id="afaa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，如下所示，我们可以通过Chainstack上的Quorum explorer访问记录。所有3个节点都与分类帐进行了交互，并且交易按预期进行了更新:</p><ul class=""><li id="92dd" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">第一个事务部署了合同</li><li id="7dc7" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">第二个交易将合约的温度设置为3度。</li><li id="7af9" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">获取温度读数仅与不更新网络的本地节点交互，因此没有创建块/事务。</li></ul><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff mp"><img src="../Images/34c154574a91dfe50ee288c932ef796c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9VIpi2cnNBq0dKk9SkuJRQ.png"/></div></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Quorum Explorer</figcaption></figure><h1 id="2c4e" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">私人交易</h1><p id="abad" class="pw-post-body-paragraph ir is hu it b iu lc iw ix iy ld ja jb jc le je jf jg lf ji jj jk lg jm jn jo hn dt translated"><strong class="it hv">背景:</strong>常见的业务需求是安全的数据加密。举个例子，一家超市从供应商那里租赁存储解决方案，用于存储海鲜等易腐食品:</p><ul class=""><li id="484a" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">供应商将每30秒从其物联网设备传输一次温度读数，供超市监控。</li><li id="8dd3" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">这些读数应该只能在联盟网络中的超市和供应商之间访问。</li></ul><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div class="fe ff mq"><img src="../Images/9bbcda8b44168f8433573e01b80e0d26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*7bfirR6hTNeqS_lK5RX-uQ.png"/></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Infrastructure illustration</figcaption></figure><p id="0963" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将执行4个不同的任务，如上图所示:</p><p id="8494" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将使用上一个场景(公共事务)中相同的3个节点来演示Quorum的私有事务特性:<em class="mr">超市</em>在<em class="mr">超市</em>和<em class="mr">存储设施之间部署一个私有的智能契约。外部方</em>将无权访问智能合同。</p><p id="0c6f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们从<em class="mr">存储设备</em>和<em class="mr">外部方</em>调用<code class="eh lh li lj lk b">get</code>和<code class="eh lh li lj lk b">set</code>方法来演示Quorum的私有事务特性。</p><p id="fe11" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">1.通过<em class="mr">超市</em>为<em class="mr">超市</em>和<em class="mr">仓储设施</em>部署私人合同</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="04fc" class="lt kf hu lk b fv lu lv l lw lx">const contractAddress = await deployContract(<br/>  raft1Node,<br/>  process.env.PK2,<br/>);</span><span id="b2bc" class="lt kf hu lk b fv ly lv l lw lx">console.log(`Contract address after deployment: ${contractAddress}`);</span></pre><p id="a3a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2.从<strong class="it hv">外部方</strong>(外部节点)设置温度并获取温度:</p><p id="8720" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">尽管无法访问合同，但事务将会成功，但是setTemperature方法不会改变温度。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="78f8" class="lt kf hu lk b fv lu lv l lw lx">// Attempts to set Contract temperature to 10, this will not mutate contract's temperature</span><span id="cb62" class="lt kf hu lk b fv ly lv l lw lx">await setTemperature(<br/>  raft3Node,<br/>  contractAddress,<br/>  process.env.PK1,<br/>  10,<br/>);</span><span id="f55e" class="lt kf hu lk b fv ly lv l lw lx">// This returns null<br/>const temp = await getTemperature(raft3Node, contractAddress);</span><span id="58ea" class="lt kf hu lk b fv ly lv l lw lx">console.log(`[Node3] temp retrieved after updating contract from external nodes: ${temp}`);</span></pre><p id="24c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">3.<code class="eh lh li lj lk b">Set</code>存储设施(内部节点)的温度和获取温度:</p><p id="a1d4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个场景中智能合约的温度应该返回<em class="mr"> 12。</em>请注意<em class="mr">存储设施</em>有权访问合同。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="1242" class="lt kf hu lk b fv lu lv l lw lx">// Updated Contract temperature to 12 degrees<br/>await setTemperature(<br/>  raft2Node,<br/>  contractAddress,<br/>  process.env.PK1,<br/>  12,<br/>);</span><span id="7a59" class="lt kf hu lk b fv ly lv l lw lx">// This returns 12<br/>const temp2 = await getTemperature(raft2Node, contractAddress);</span><span id="4449" class="lt kf hu lk b fv ly lv l lw lx">console.log(`[Node2] temp retrieved after updating contract from internal nodes: ${temp2}`);</span></pre><p id="a4be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">4.从<em class="mr">外部方</em>(外部节点)获取温度</p><p id="43d4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在步骤3，温度被设置为<em class="mr"> 12 </em>，但是<em class="mr">外部方</em>无权访问合同。返回值应该还是<em class="mr"> null </em></p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="9bf3" class="lt kf hu lk b fv lu lv l lw lx">// This returns null</span><span id="c8e2" class="lt kf hu lk b fv ly lv l lw lx">const temp3 = await getTemperature(raft3Node, contractAddress);</span><span id="1513" class="lt kf hu lk b fv ly lv l lw lx">console.log(`[Node3] temp retrieved from external nodes after update ${temp}`);</span></pre><p id="c04c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面我们将更详细地介绍如何使用web3.js在Quorum节点上执行<strong class="it hv">私有事务</strong>，因为大部分代码都是相似的，所以我将只强调与执行公共事务不同的部分。</p><p id="7b07" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，上传到分类帐的任何合同都是不可变的，因此必须通过在合同部署时(而不是之后)包含其公钥来授予对相应节点的许可访问。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="b184" class="lt kf hu lk b fv lu lv l lw lx">async function deployContract(web3, publicKey) {<br/>  const address = await getAddress(web3);<br/>  const contract = new web3.eth.Contract(<br/>    temperatureMonitor.interface,<br/>  );</span><span id="77ff" class="lt kf hu lk b fv ly lv l lw lx">return contract.deploy({<br/>    data: temperatureMonitor.bytecode,<br/>  })<br/>  .send({<br/>    from: address,<br/>    gas: ‘0x2CD29C0’, <br/>    // Grant Permission to Contract by including nodes public keys<br/>    <strong class="lk hv">privateFor: [publicKey],<br/>  </strong>})<br/>  .then((contract) =&gt; {<br/>    return contract.options.address;<br/>  });<br/>}</span></pre><p id="4612" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">类似于契约部署，通过在执行时包含网络参与者的公钥，使事务成为私有的。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="2c80" class="lt kf hu lk b fv lu lv l lw lx">async function setTemperature(web3, contractAddress, publicKey, temp) {<br/>  const address = await getAddress(web3);<br/>  const myContract = await getContract(web3, contractAddress);</span><span id="820c" class="lt kf hu lk b fv ly lv l lw lx">return myContract.methods.set(temp).send({<br/>    from: address,<br/>    // Grant Permission by including nodes public  keys<br/>    <strong class="lk hv">privateFor: [publicKey],<br/>  </strong>}).then((receipt) =&gt; {<br/>    return receipt.status;<br/>  });<br/>}</span></pre><p id="dd6e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们准备运行完整的<a class="ae jp" href="https://github.com/ThomasRalee/quorum-iot-tutorial" rel="noopener ugc nofollow" target="_blank"> private.js </a>，应该会显示如下结果。</p><pre class="ll lm ln lo fq lp lk lq lr aw ls dt"><span id="51ed" class="lt kf hu lk b fv lu lv l lw lx">node private.js<br/>Contract address after deployment: 0x85dBF88B4dfa47e73608b33454E4e3BA2812B21D<br/>[Node3] temp retrieved after updating contract from external nodes: null<br/>[Node2] temp retrieved after updating contract from internal nodes: 12<br/>[Node3] temp retrieved from external nodes after update null</span></pre><p id="fbdb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">查看下面的Quorum explorer，可以看到创建了3个事务。</p><ul class=""><li id="5cd5" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">从<em class="mr">超市</em>调配合同</li><li id="a627" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">执行来自<em class="mr">外部方</em>的<code class="eh lh li lj lk b">SetTemperature</code>方法</li><li id="6ffe" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">从<em class="mr">存储设备</em>执行<code class="eh lh li lj lk b">SetTemperature</code>方法</li></ul><figure class="ll lm ln lo fq ma fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff ms"><img src="../Images/fd864dbde51f8a079ecc2cba428120aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L9Yg2-6EwQq_GnDz1dxCgg.png"/></div></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Quorum Explorer</figcaption></figure><p id="ae43" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如您所见，两个事务都通过了，但只有从<em class="mr">存储设备</em>执行的事务成功更新了合同上的温度。因此，私有事务确保了内部各方数据的不变性，但不会将数据暴露给外部观察者。</p></div><div class="ab cl mt mu hc mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="hn ho hp hq hr"><p id="3cf6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我在新加坡参加了很多区块链的活动，但是大多数的演讲都不是以开发者为中心。在这些会议上与其他开发者交谈时，我意识到他们中的大多数人都在寻找一些更具技术性的东西，可以帮助他们开始编写自己的智能合同、在网络上部署它们、进行实验并从中学习的指南。</p><p id="5afe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，我写了这篇文章来分享我在<a class="ae jp" href="https://chainstack.com/" rel="noopener ugc nofollow" target="_blank"> Chainstack </a>学到的东西，希望能帮助其他开发者开始建立他们自己的沙箱。如果这篇文章对你有所帮助，请鼓掌并留下评论。</p><figure class="ll lm ln lo fq ma"><div class="bz el l di"><div class="na nb l"/></div></figure></div></div>    
</body>
</html>