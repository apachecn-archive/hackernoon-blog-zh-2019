<html>
<head>
<title>How To Upgrade To Rails 6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何升级到Rails 6</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-upgrade-to-rails-6-ee23ca29976a?source=collection_archive---------19-----------------------#2019-05-07">https://medium.com/hackernoon/how-to-upgrade-to-rails-6-ee23ca29976a?source=collection_archive---------19-----------------------#2019-05-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/d0028691c897e7d8c2d1119d3b7e65af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-BhuHKBsUSFcWTrROiVN5Q.jpeg"/></div></div></figure><p id="175a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我希望这是一个相当详细的概述，说明Rails的升级过程总体上是怎样的，但重点强调Rails 5.2 &gt; 6升级部分(RC1是最新的版本)。我已经看到了许多描述Rails 6中等待我们的变化列表的精彩帖子，所以我将完全跳过这些，只关注升级。请记住，尽管这只是一个概述，但当给定一个足够大的应用程序时，您这边的定制可能会使使用<code class="eh ka kb kc kd b">rails app:update</code>成为不可能。</p><h1 id="b40b" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">我应该升级吗/需要考虑的事情</h1><p id="9d9b" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">据DHH称，Rails 6 beta1已经足够稳定，可以在上面运行你的项目。事实上，在他的<a class="ae lh" href="https://weblog.rubyonrails.org/2019/1/18/Rails-6-0-Action-Mailbox-Action-Text-Multiple-DBs-Parallel-Testing/" rel="noopener ugc nofollow" target="_blank"> Rails博客文章</a>中，他写道Basecamp已经被迁移了。</p><blockquote class="li"><p id="6528" class="lj lk hu bd ll lm ln lo lp lq lr jz ek translated"><em class="ls"> Basecamp已经在生产中运行Rails 6.0.0.beta1，Shopify和GitHub以及其他公司肯定会紧随其后。这不是什么摇摇欲坠的小屋释放。</em> DHH</p></blockquote><p id="3f98" class="pw-post-body-paragraph jc jd hu je b jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv lx jx jy jz hn dt translated">但是，由于还没有正式发布，您可能会发现您使用的一些gem还没有为升级做好准备。如果gem的Rails版本被限制在5或更低版本(或任何其他依赖版本)，那么您可能会从一开始就陷入依赖地狱。如果你现在真的不想在你的生活中遇到这种情况，等到大多数宝石的创造者赶上来可能是一个更好的选择。请记住，这可能会很快改变——在过去的几周里，我看到了这方面的巨大进步。</p><p id="82e3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">另一件要考虑的事情是，你觉得你的应用程序被测试覆盖的程度有多深。良好的测试对于重大升级来说绝对至关重要。在这个过程中，你将改变几十个设置，每个设置都可能改变应用程序的工作方式。如果您想知道哪个问题是由哪个变更引起的(我想您也想知道)，您可能会在手工测试上花费大量的时间。因此，如果你的应用程序在这方面有所欠缺，那么在前进之前，尝试填补你的测试套件的所有空白。</p><h1 id="1525" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">升级过程</h1><h2 id="49c7" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">1.将Ruby至少更新到2.5版</h2><p id="82a5" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">根据应用程序的大小和升级的规模，在Ruby升级过程中，你可能会遇到一大堆错误，也可能看不到任何错误(好吧，这不太可能)。即使来自相对较新的Ruby版本，我也建议您逐步进行这些更改。Ruby版本有以下几种模式:<code class="eh ka kb kc kd b">ruby_{MAJOR}_{MINOR}_{TEENY}</code>。我不认为每个小版本都需要升级，但是每隔一个小版本(每年圣诞节发布)进行升级是个好主意。至少，我会把过程分成两部分，从中间的版本开始(在当前版本和目标版本之间)。</p><p id="a960" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在每次迭代后运行您的测试。一旦您在测试/开发中完成了工作，在试运行服务器上重复同样的操作，对任何明显的问题进行手动测试，然后才开始生产。根据您对测试的信任程度，您可能希望在进一步升级Rails之前给应用程序几天时间。</p><h2 id="d0df" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">2.将Rails升级到5.2系列的最新版本(撰写本文时是5.2.3)</h2><p id="6db4" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">在开始Rais 6升级之前，请确保您使用的是最新的Rails 5版本。如果你来自早于5的版本，有很多文章涉及这个主题，包括来自<a class="ae lh" href="https://kickstarter.engineering/upgrading-kickstarter-to-rails-5-e8203f93df55" rel="noopener ugc nofollow" target="_blank"> Kickstarter </a>、<a class="ae lh" href="https://engineering.shopify.com/blogs/engineering/upgrading-shopify-to-rails-5-0" rel="noopener ugc nofollow" target="_blank"> Shopify </a>和<a class="ae lh" href="https://github.blog/2018-09-28-upgrading-github-from-rails-3-2-to-5-2/" rel="noopener ugc nofollow" target="_blank"> GitHub </a>的报道。</p><h2 id="d947" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">3.更新Gemfile</h2><p id="0ab6" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">将<code class="eh ka kb kc kd b">gem "rails", github: "rails/rails"</code>添加到您的gem文件中，并在终端中运行<code class="eh ka kb kc kd b">bundle update rails</code>。如前所述，这可能说起来容易做起来难。对于成熟的应用程序，您很可能会看到一长串红色的未解决依赖项列表。通常情况下，事情并不像看上去那么糟糕——你所看到的是一颗宝石可能引发的连锁反应的结果。这个列表没有按照任何特定的顺序显示(至少我知道是这样)。你会得到一堆<code class="eh ka kb kc kd b">Bundler could not find compatible versions for gem XXX</code>错误，但是通常，只有少数错误包含一个冲突的宝石。根据我的经验，通常有两种罪魁祸首:</p><ul class=""><li id="8029" class="mn mo hu je b jf jg jj jk jn mp jr mq jv mr jz ms mt mu mv dt translated">rails相关宝石(<code class="eh ka kb kc kd b">rails</code>)。<code class="eh ka kb kc kd b">railties</code>、<code class="eh ka kb kc kd b">actionpack</code>、<code class="eh ka kb kc kd b">activesupport</code>等。)仅限于版本&lt; 6</li><li id="f9af" class="mn mo hu je b jf mw jj mx jn my jr mz jv na jz ms mt mu mv dt translated">通过使用<code class="eh ka kb kc kd b">~&gt;</code>操作符，gems的升级仅限于次要版本</li></ul><p id="bb67" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就是为什么我倾向于首先在列表中寻找这些。为了修复它们，我通常不得不操作项目的<code class="eh ka kb kc kd b">Gemfile</code>和<code class="eh ka kb kc kd b">Gemfile.lock</code>的组合，以及gems的<code class="eh ka kb kc kd b">.gemspec</code>和有时的<code class="eh ka kb kc kd b">Rakefile</code>。</p><p id="c8ce" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">根据本文的需要，我(实验性地)打包的项目之一是来自<a class="ae lh" href="https://github.com/alphagov" rel="noopener ugc nofollow" target="_blank"> alphagov </a>的<code class="eh ka kb kc kd b">content-data-admin</code>。在他们的例子中，这个列表有70多行，但是只有一个依赖关系阻碍了这个包的进展(在这个例子中，它是来自<code class="eh ka kb kc kd b">govuk_publishing_components</code> gem的<code class="eh ka kb kc kd b">actionview</code>(截图如下)。</p><figure class="nc nd ne nf fq iv fe ff paragraph-image"><div class="fe ff nb"><img src="../Images/7bf800b04b605c77995269223864a620.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/0*fStyvqy2S6OEfx-I.png"/></div></figure><p id="42ab" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当然，gem是否能在依赖项解锁的情况下正常工作是另一回事，但是如果大多数gem已经在Rails 5上工作了，那么在Rails 6上工作应该没有问题。对于以前的版本(Rails 4和5)，您可以使用<a class="ae lh" href="http://www.ready4rails.net/" rel="noopener ugc nofollow" target="_blank"> Ready4Rails </a>应用程序来检查gem是否准备好与特定的Rails版本一起工作——目前，没有提到Rails 6，但当您阅读本文时，这可能会发生变化。</p><p id="d20c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">修改Rails版本可能会解决这个问题，尽管这带来了一个明显的缺点，即要么派生出每一个gem，要么找一个已经为你做了这件事的人。我不知道这里有什么变通办法，所以在继续之前请记住这一点。在我捆绑的231个宝石中最大的一次升级中，有6个必须手动分叉和升级。</p><h2 id="d504" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">4.从终端运行更新任务</h2><p id="70b4" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">运行<code class="eh ka kb kc kd b">rails app:update </code>命令，它会引导您一步一步地将新的配置设置添加到您的应用程序中。这是一个互动的过程，看似简单，但如果不够谨慎，可能会导致一些意想不到的问题。我建议您对每个建议的文件更改运行diff工具(<code class="eh ka kb kc kd b">d</code>)，以充分了解更改程度。</p><figure class="nc nd ne nf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ng"><img src="../Images/0f70000eb66553ad04701bc03b33d517.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lAPjGRVgR61o4i9I.png"/></div></div></figure><p id="216b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我怀疑你会想要覆盖它将建议的一些文件(例如路线或I18n文件)。您有两种选择:</p><ul class=""><li id="a67a" class="mn mo hu je b jf jg jj jk jn mp jr mq jv mr jz ms mt mu mv dt translated">在选择<code class="eh ka kb kc kd b">y</code> / <code class="eh ka kb kc kd b">n</code>之前，选择(<code class="eh ka kb kc kd b">m</code>)并用您选择的工具合并文件</li><li id="e9af" class="mn mo hu je b jf mw jj mx jn my jr mz jv na jz ms mt mu mv dt translated">对每个文件使用<code class="eh ka kb kc kd b">y</code>，然后使用合并工具/IDE一个文件一个文件地检查，看看实现了什么变化。将新设置与旧的自定义设置相结合。</li></ul><p id="09ea" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就个人而言，我更喜欢第二种方法——我可以决定文件更新的顺序，这样可以更好地控制和查看整体情况。</p><p id="f373" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意:这一步和下一步都会令人厌倦。帮你自己一个忙，单独处理每一个场景。错过/添加/删除一个小东西是非常容易的，这最终会导致本来可以避免的几个小时的调试。如果你迷失在新旧事物中，<a class="ae lh" href="http://railsdiff.org/" rel="noopener ugc nofollow" target="_blank">这个网站</a> *会很有帮助。既然你在上面，也要检查以前升级的<a class="ae lh" href="https://edgeguides.rubyonrails.org/configuring.html#results-of-load-defaults" rel="noopener ugc nofollow" target="_blank">默认配置</a>(如果项目在Rails 5之前开始)，这是一个正确设置它们的好时机。</p><p id="e3ec" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">*正如主页上的评论所说——该工具显示了不同Rails版本中新生成的应用程序之间的差异。它<em class="mm">没有</em>显示内部版本之间实现的所有提交。</p><h2 id="dc52" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">5.取消注释新的框架默认值</h2><p id="d4ad" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">到目前为止(Rails 6.0 RC1版)，<code class="eh ka kb kc kd b">new_framework_defaults_6_0.rb</code>文件顶部的注释有点误导。它建议“翻转缺省值”，实际上您应该简单地取消对标志的注释。这要追溯到Rails 5.0，在从Rails 4.2更新之后，默认情况下，这些标志被取消注释并设置为<code class="eh ka kb kc kd b">false</code>，只有在那时才应该切换到<code class="eh ka kb kc kd b">true</code>。Rails 6不是这种情况——在这里，标志已经有了正确的值。不过在最终版本中，注释应该是<a class="ae lh" href="https://github.com/rails/rails/pull/33584" rel="noopener ugc nofollow" target="_blank">固定的</a>。在<a class="ae lh" href="https://edgeguides.rubyonrails.org/configuring.html" rel="noopener ugc nofollow" target="_blank">配置Rails应用程序</a>指南中列出并描述了所有标志及其默认值，尽管文件中的注释已经是描述性的，应该足以让您做出正确的决定(取消注释或不取消注释)。</p><h2 id="839f" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">6.添加丢失的宝石和捆绑</h2><p id="81eb" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">每个主要的Rails版本都带有一组稍微不同的gem。不幸的是，<code class="eh ka kb kc kd b">rails app:update</code>命令在这方面没有帮助，所以如果没有手动更改，应用程序可能会在没有一些依赖项的情况下崩溃。有很多方法可以解决这个问题——使用RailsDiff 就是其中之一(参见:Gemfile)。</p><h2 id="5a7f" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">7.运行迁移</h2><p id="0c4a" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated"><a class="ae lh" href="https://github.com/rails/rails/pull/35620" rel="noopener ugc nofollow" target="_blank">仅在安装了active storage</a>时才需要。</p><figure class="nc nd ne nf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nh"><img src="../Images/17e12a7e4c05971eff1c9a43be9ca148.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ldWNR0jscqYh9pCe.png"/></div></div></figure><h2 id="5e0c" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">8.通过<a class="ae lh" href="https://edgeguides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-5-2-to-rails-6-0" rel="noopener ugc nofollow" target="_blank">官方升级导轨</a>和<a class="ae lh" href="https://edgeguides.rubyonrails.org/6_0_release_notes.html" rel="noopener ugc nofollow" target="_blank">发布说明</a></h2><p id="e922" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">如果需要，从第一个链接开始实施更改。浏览第二个链接，搜索任何可能特定于您的应用程序的潜在重大变化。如果你有好的测试覆盖率，大多数问题都会在运行测试套件时出现。</p><h2 id="3f90" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">9.运行测试，抑制反对意见</h2><p id="93da" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">在较大的更新之后(特别是在遗留项目上)，弃用警告可能会占用测试的大部分输出。我的建议是尽快修复它们。你<em class="mm">可以</em>用<code class="eh ka kb kc kd b">ActiveSupport::Deprecation.silenced = true</code>隐藏它们，但是无论如何你将不得不在某个时候处理这个问题，所以为什么不现在就做呢？这一部分并不太难，同时也很有价值——让输出变得清晰真的感觉像是一种进步。</p><h2 id="25c5" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">10.运行测试，修复失败的测试</h2><p id="78ad" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">这里不可能涵盖足够多的材料来帮助任何数量可观的读者。似乎很多人已经开始试用Rails 6了，因为我遇到的大多数问题已经在论坛上被报道/询问过了。其中一些甚至已经被修复，这表明升级只会变得更容易，久而久之。</p><h2 id="ff99" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">11.执行手动测试</h2><p id="87c2" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">尽管我很愿意相信自动测试是我们所需要的，但在一切正常后，我喜欢打开服务器上的页面，手动检查是否有任何遗漏。</p><h2 id="9129" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">12.推送至暂存</h2><p id="85c4" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">在上线之前，设置或使用现有的试运行，在更接近生产的环境中测试应用程序。如果可能的话，让其他人和你一起测试。</p><h2 id="b0cd" class="ly kf hu bd kg lz ma mb kk mc md me ko jn mf mg ks jr mh mi kw jv mj mk la ml dt translated">13.推向生产</h2><h1 id="6f56" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">包裹</h1><p id="f556" class="pw-post-body-paragraph jc jd hu je b jf lc jh ji jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz hn dt translated">Rails 6 RC1版在最终发布之前可能不会有太大变化，所以现在是认真考虑升级的好时机。我的感觉是，这个过程比从4.2到5.0要容易得多，特别是如果应用程序是在5.0中的一个上启动的。x版本。和往常一样，拥有最新的依赖项和良好的测试覆盖率会大大简化整个过程。本文的第一稿是在Beta1发布后写的，在过去的几周里，我可以看到社区为实现这一飞跃所做的准备有所不同。希望在你读到这篇文章之前，大多数问题都已经解决了。</p><p id="caba" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="mm">最初发表于</em><a class="ae lh" href="https://selleo.com/blog/how-to-upgrade-to-rails-6" rel="noopener ugc nofollow" target="_blank"><em class="mm">【https://selleo.com】</em></a><em class="mm">。</em></p></div></div>    
</body>
</html>