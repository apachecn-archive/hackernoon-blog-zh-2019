<html>
<head>
<title>AWS AppSync within Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Lambda中的AWS AppSync</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/aws-appsync-queries-and-mutations-with-lambda-2aee303c66b0?source=collection_archive---------0-----------------------#2019-05-05">https://medium.com/hackernoon/aws-appsync-queries-and-mutations-with-lambda-2aee303c66b0?source=collection_archive---------0-----------------------#2019-05-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/7f6334fc26a41e15f8ef1c7bd813b72d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5qIzAsIrEPvJlz69oABiqg.png"/></div></div></figure><div class=""/><div class=""><h2 id="8490" class="pw-subtitle-paragraph jc ie if bd b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ek translated">如何在AWS Lambda和Cognito池中调用AppSync查询和变异</h2></div><p id="b64b" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">我正在使用AWS AppSync构建Floom，<a class="ae kq" href="https://market.floom.app" rel="noopener ugc nofollow" target="_blank">一个微服务市场</a>。90%的情况下它都很棒，但是仍然有一些非常明显的特性差距。其中最大的一个问题是不能通过<code class="eh kr ks kt ku b">AWSAppSyncClient</code>使用私钥访问GraphQL操作(例如，当使用Lambda进行后端操作时)。似乎应该有某种开箱即用的管理访问，允许您在不需要使用AWS Cognito进行身份验证的情况下修改和查询数据库。</p><p id="73a0" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">如果您正在使用AppSync，您可能已经将GraphQL API配置为使用AWS Cognito池(这是默认设置)。在客户端控制不同用户的访问时，使用Cognito pools非常方便。它允许您在您的<code class="eh kr ks kt ku b">schema.graphql</code>中使用<code class="eh kr ks kt ku b">@auth</code>装饰器来定义读(列表、获取)和写(创建、更新、删除)访问点。</p><p id="18dc" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">如果是这种情况，并且您想在自己的后端服务器(或AWS Lambda)上访问GraphQL操作，那么您基本上只能有两种选择:</p><ol class=""><li id="2b67" class="kv kw if jw b jx jy ka kb kd kx kh ky kl kz kp la lb lc ld dt translated"><strong class="jw ig">您可以在您的Cognito池中创建一个admin用户，然后使用该用户获取</strong> <code class="eh kr ks kt ku b"><strong class="jw ig">AWSAppSyncClient</strong></code> <strong class="jw ig"> SDK的访问凭证。</strong></li><li id="98db" class="kv kw if jw b jx le ka lf kd lg kh lh kl li kp la lb lc ld dt translated">这里有一个使用AWS IAM角色的解决方法<a class="ae kq" href="https://read.acloud.guru/backend-graphql-how-to-trigger-an-aws-appsync-mutation-from-aws-lambda-eda13ebc96c3" rel="noopener ugc nofollow" target="_blank">在这里进行了概述</a>。这包括创建经过身份验证和未经身份验证的角色，然后创建Amazon Cognito身份池，并将刚刚创建的角色链接到身份池。这还将涉及到更改客户端应用程序中的身份验证机制。您将不再能够在<code class="eh kr ks kt ku b">schema.graphql</code>中使用<code class="eh kr ks kt ku b">@auth</code>装饰器，除非您编写自己的解析器。</li></ol><p id="f860" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">在这里，我将解释如何推进选项#1。该过程的鸟瞰图如下所示:</p><ol class=""><li id="487b" class="kv kw if jw b jx jy ka kb kd kx kh ky kl kz kp la lb lc ld dt translated">在AWS Cognito中设置管理员用户</li><li id="4f7d" class="kv kw if jw b jx le ka lf kd lg kh lh kl li kp la lb lc ld dt translated">使用管理员的登录凭证从AWS Cognito获取会话<code class="eh kr ks kt ku b">jwtToken</code></li><li id="85e2" class="kv kw if jw b jx le ka lf kd lg kh lh kl li kp la lb lc ld dt translated">使用这个<code class="eh kr ks kt ku b">jwtToken</code>来获得一个<code class="eh kr ks kt ku b">AWSAppSyncClient</code>的实例</li><li id="ffba" class="kv kw if jw b jx le ka lf kd lg kh lh kl li kp la lb lc ld dt translated">现在，您可以像在前端一样使用AppSync GraphQL查询和变异。</li></ol><h1 id="0963" class="lj lk if bd ll lm ln lo lp lq lr ls lt jl lu jm lv jo lw jp lx jr ly js lz ma dt translated">创建管理员用户</h1><p id="95e3" class="pw-post-body-paragraph ju jv if jw b jx mb jg jz ka mc jj kc kd md kf kg kh me kj kk kl mf kn ko kp hn dt translated">我创建了一个用户名为<code class="eh kr ks kt ku b">admin</code>的用户，并将这个用户添加到一个名为<code class="eh kr ks kt ku b">admin</code>的组中。</p><figure class="mh mi mj mk fq hw fe ff paragraph-image"><div class="fe ff mg"><img src="../Images/d5e8a344ee97e957e16c9d2ee898a54e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*i3aBRG0z1Ky31eVlBKfbTw.png"/></div></figure><p id="2c5e" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">一旦你完成了这些，确保这个用户能够访问你在Lambda函数中需要的GraphQL操作。例如，在<a class="ae kq" href="https://floom.app" rel="noopener ugc nofollow" target="_blank"> Floom </a>中，一旦卖家完成订单，我们就需要一个<code class="eh kr ks kt ku b">Transaction</code>，所以我添加了一个<code class="eh kr ks kt ku b">@auth</code>规则，允许<code class="eh kr ks kt ku b">admin</code>组中的用户完成对<code class="eh kr ks kt ku b">Transaction</code>模型的读/写访问。</p><figure class="mh mi mj mk fq hw"><div class="bz el l di"><div class="ml mm l"/></div></figure><h1 id="4b2c" class="lj lk if bd ll lm ln lo lp lq lr ls lt jl lu jm lv jo lw jp lx jr ly js lz ma dt translated">在Lambda中获取会话令牌</h1><p id="a3eb" class="pw-post-body-paragraph ju jv if jw b jx mb jg jz ka mc jj kc kd md kf kg kh me kj kk kl mf kn ko kp hn dt translated">要在Lambda中访问AppSync的GraphQL操作，而不需要切换到AWS_IAM身份验证，我们需要使用admin用户获取会话令牌。我们可以通过<code class="eh kr ks kt ku b">aws-sdk</code>的<code class="eh kr ks kt ku b">CognitoIdentityServiceProvider</code>模块做到这一点:</p><figure class="mh mi mj mk fq hw"><div class="bz el l di"><div class="ml mm l"/></div></figure><h1 id="f1fe" class="lj lk if bd ll lm ln lo lp lq lr ls lt jl lu jm lv jo lw jp lx jr ly js lz ma dt translated">实例化AWSAppSyncClient</h1><p id="45f0" class="pw-post-body-paragraph ju jv if jw b jx mb jg jz ka mc jj kc kd md kf kg kh me kj kk kl mf kn ko kp hn dt translated">现在我们有了Cognito凭证，我们可以用它们实例化一个<code class="eh kr ks kt ku b">AWSAppSyncClient</code>对象的实例，这将允许我们使用AppSync GraphQL查询和变异。</p><figure class="mh mi mj mk fq hw"><div class="bz el l di"><div class="ml mm l"/></div></figure><h1 id="64dc" class="lj lk if bd ll lm ln lo lp lq lr ls lt jl lu jm lv jo lw jp lx jr ly js lz ma dt translated">使用AWSAppSyncClient</h1><p id="2bc2" class="pw-post-body-paragraph ju jv if jw b jx mb jg jz ka mc jj kc kd md kf kg kh me kj kk kl mf kn ko kp hn dt translated">当你的<code class="eh kr ks kt ku b">amplify push</code>你的<code class="eh kr ks kt ku b">schema.graphql</code>改变时，Amplify会给你提供一个<code class="eh kr ks kt ku b">queries.js</code>和一个<code class="eh kr ks kt ku b">mutations.js</code>的GraphQL操作，看起来像这样:</p><figure class="mh mi mj mk fq hw"><div class="bz el l di"><div class="ml mm l"/></div></figure><p id="f411" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">您可以导入整个文件以在Lambda函数中使用，或者简单地复制您需要的文件(如果您对<code class="eh kr ks kt ku b">schema.graphql</code>做了更改，记得更新它们)。</p><figure class="mh mi mj mk fq hw"><div class="bz el l di"><div class="ml mm l"/></div></figure><p id="c0f6" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">现在，您可以在Lambda设置中使用AppSync的GraphQL操作，同时仍然使用Cognito身份验证(没有AWS_IAM角色)。当您调用<code class="eh kr ks kt ku b">mutations</code>时，Amplify GraphQL客户端甚至可以使用<code class="eh kr ks kt ku b">subscriptions.js</code>中提供的订阅来订阅这些突变，就像本例中的<code class="eh kr ks kt ku b">onUpdateTransaction </code>。</p></div></div>    
</body>
</html>