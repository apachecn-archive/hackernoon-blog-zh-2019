<html>
<head>
<title>Using S3 As a Helm Repository</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 S3 作为舵库</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/using-s3-as-a-helm-repository-a76b504d494e#2019-01-02">https://medium.com/hackernoon/using-s3-as-a-helm-repository-a76b504d494e#2019-01-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="775b" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">简化您的 Kubernetes 部署</p></blockquote><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff jt"><img src="../Images/1fdcb4e6b02c96b3a59fc71f100fe54f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j5qOv3O6AE-xnUGD.png"/></div></div></figure><p id="e373" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">如果你知道标题的意思，你可能会直接进入本教程的内容。我会保持简短的介绍。</p><h2 id="6df3" class="ki kj hu bd kk kl km kn ko kp kq kr ks kf kt ku kv kg kw kx ky kh kz la lb lc dt translated">什么是头盔？</h2><p id="ca53" class="pw-post-body-paragraph iu iv hu ix b iy ld ja jb jc le je jf kf lf ji jj kg lg jm jn kh lh jq jr js hn dt translated">Helm 是一个工具，用于将 Kubernetes 资源模板化并应用到 Kubernetes 集群中。它标榜自己是“k8s 的 npm”，这是一个我发现完全没有帮助的描述。相反，<a class="ae li" href="https://hackernoon.com/what-is-helm-and-why-you-should-love-it-74bf3d0aafc" rel="noopener ugc nofollow" target="_blank">读读这篇文章</a>——它解释得很好。</p><h2 id="d33b" class="ki kj hu bd kk kl km kn ko kp kq kr ks kf kt ku kv kg kw kx ky kh kz la lb lc dt translated">你为什么想要自己的头盔库？</h2><blockquote class="ir is it"><p id="2ffc" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">从这一点开始，我将假设你熟悉什么是“掌舵图”。如果你不是，请阅读链接文章。</p></blockquote><p id="16ce" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">当您想要将应用程序部署到 Helm 中时，您有一些选择。您要么有每个应用程序的掌舵图，要么有一组应用程序的掌舵图。比如，你要么有你的<code class="eh lj lk ll lm b">auth-service-helm-chart</code>，要么有你的<code class="eh lj lk ll lm b">java-applications-helm-chart</code>。两者各有什么利弊？</p><h2 id="64c2" class="ki kj hu bd kk kl km kn ko kp kq kr ks kf kt ku kv kg kw kx ky kh kz la lb lc dt translated">每个应用程序一个图表</h2><p id="cca3" class="pw-post-body-paragraph iu iv hu ix b iy ld ja jb jc le je jf kf lf ji jj kg lg jm jn kh lh jq jr js hn dt translated"><strong class="ix hv"> <em class="iw">优点</em> </strong> <em class="iw"> : </em>您可以在图表中实现特定于应用程序或服务的逻辑。</p><p id="a4e3" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated"><strong class="ix hv"> <em class="iw">缺点</em> </strong> <em class="iw"> : </em>如果你已经有了微服务(而且很有可能是 k8s)，你最终会得到很多分散的图表。大量重复，难以大规模管理。创建新的应用程序也需要更多的努力，你必须正确地连接图表。</p><h2 id="0c8f" class="ki kj hu bd kk kl km kn ko kp kq kr ks kf kt ku kv kg kw kx ky kh kz la lb lc dt translated">适用于多种应用的图表</h2><p id="51f5" class="pw-post-body-paragraph iu iv hu ix b iy ld ja jb jc le je jf kf lf ji jj kg lg jm jn kh lh jq jr js hn dt translated"><strong class="ix hv"> <em class="iw">优点:</em> </strong>一个图表更容易管理。你的图表都在一个地方(一个图表回购)。</p><p id="df6a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated"><strong class="ix hv"> <em class="iw">缺点:</em> </strong>你需要非常小心，不要让特定的应用程序影响到共享图表的逻辑。一切都需要通用。</p><h1 id="79d7" class="ln kj hu bd kk lo lp lq ko lr ls lt ks lu lv lw kv lx ly lz ky ma mb mc lb md dt translated">我不喜欢重复</h1><p id="cccd" class="pw-post-body-paragraph iu iv hu ix b iy ld ja jb jc le je jf kf lf ji jj kg lg jm jn kh lh jq jr js hn dt translated">因此，我选择了共享图表方法。这就产生了一个新问题——我们到底在哪里存放图表？进入<a class="ae li" href="https://github.com/hypnoglow/helm-s3" rel="noopener ugc nofollow" target="_blank">舵 s3 插件</a>。</p><h2 id="d47e" class="ki kj hu bd kk kl km kn ko kp kq kr ks kf kt ku kv kg kw kx ky kh kz la lb lc dt translated"><strong class="ak">安装插件</strong></h2><p id="afd3" class="pw-post-body-paragraph iu iv hu ix b iy ld ja jb jc le je jf kf lf ji jj kg lg jm jn kh lh jq jr js hn dt translated">要配置本地 helm CLI 以使用此插件，需要调用以下命令:</p><pre class="ju jv jw jx fq me lm mf mg aw mh dt"><span id="ef64" class="ki kj hu lm b fv mi mj l mk ml">helm plugin install https://github.com/hypnoglow/helm-s3.git</span></pre><h2 id="eb41" class="ki kj hu bd kk kl km kn ko kp kq kr ks kf kt ku kv kg kw kx ky kh kz la lb lc dt translated">给 S3 桶装上电线</h2><p id="b5ed" class="pw-post-body-paragraph iu iv hu ix b iy ld ja jb jc le je jf kf lf ji jj kg lg jm jn kh lh jq jr js hn dt translated">一个舵库需要有一个<code class="eh lj lk ll lm b">index.yaml</code>作为它的根。你可以使用 helm CLI 来初始化它，但是用一点 terraform 来连接它会更容易。不要运行两个命令或依赖正确配置的<code class="eh lj lk ll lm b">helm</code> CLI，而是运行一个命令并完全依赖 terraform。</p><pre class="ju jv jw jx fq me lm mf mg aw mh dt"><span id="71b9" class="ki kj hu lm b fv mi mj l mk ml">resource "aws_s3_bucket" "helm_central" {</span><span id="caf5" class="ki kj hu lm b fv mm mj l mk ml">   bucket = "my-helm-central-bucket"</span><span id="2429" class="ki kj hu lm b fv mm mj l mk ml">   acl    = "private"</span><span id="9e0a" class="ki kj hu lm b fv mm mj l mk ml">}</span><span id="385a" class="ki kj hu lm b fv mm mj l mk ml">resource "aws_s3_bucket_object" "object" {</span><span id="c321" class="ki kj hu lm b fv mm mj l mk ml">   bucket = "${aws_s3_bucket.helm_central.bucket}"</span><span id="476f" class="ki kj hu lm b fv mm mj l mk ml">   key    = "charts/index.yaml"</span><span id="66b5" class="ki kj hu lm b fv mm mj l mk ml">   source = "/path/to/my/files/index.yaml"</span><span id="c623" class="ki kj hu lm b fv mm mj l mk ml">}</span></pre><p id="5c9d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">这个地形需要在本地目录中有一个名为<code class="eh lj lk ll lm b">index.yaml</code>的文件。我使用的文件如下所示:</p><pre class="ju jv jw jx fq me lm mf mg aw mh dt"><span id="96b0" class="ki kj hu lm b fv mi mj l mk ml">apiVersion: v1</span><span id="7951" class="ki kj hu lm b fv mm mj l mk ml">entries: {}</span></pre><p id="d92c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated"><strong class="ix hv">注意</strong>，这将创建一个关键的“图表”,您的捆绑图表将放在那里。此外，您的 S3 存储桶将无法从互联网上访问，您需要通过 IAM 角色来管理访问。</p><h2 id="56a6" class="ki kj hu bd kk kl km kn ko kp kq kr ks kf kt ku kv kg kw kx ky kh kz la lb lc dt translated">告诉赫尔姆你的新桶</h2><p id="4936" class="pw-post-body-paragraph iu iv hu ix b iy ld ja jb jc le je jf kf lf ji jj kg lg jm jn kh lh jq jr js hn dt translated">现在您已经有了一个 bucket，您需要通知您的本地 Helm CLI S3 bucket 存在，并且它是一个可用的 Helm 存储库。为此，您可以使用 s3 插件:</p><pre class="ju jv jw jx fq me lm mf mg aw mh dt"><span id="199c" class="ki kj hu lm b fv mi mj l mk ml">helm repo add my-charts s3://my-helm-central-bucket/charts</span></pre><p id="f056" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated"><strong class="ix hv">注意:</strong>无论你从哪里运行掌舵命令，都需要适当的 IAM 访问这个 S3 桶。要么读，要么写，或者两者都读。</p><h2 id="f999" class="ki kj hu bd kk kl km kn ko kp kq kr ks kf kt ku kv kg kw kx ky kh kz la lb lc dt translated">测试一下！</h2><p id="8cf3" class="pw-post-body-paragraph iu iv hu ix b iy ld ja jb jc le je jf kf lf ji jj kg lg jm jn kh lh jq jr js hn dt translated">拉下一个现有的图表，打包并推送到新的存储库中。</p><pre class="ju jv jw jx fq me lm mf mg aw mh dt"><span id="e8cf" class="ki kj hu lm b fv mi mj l mk ml"># This will download the tar.gz from your stable central repository.<br/>helm fetch stable/rabbitmq</span><span id="28ed" class="ki kj hu lm b fv mm mj l mk ml"># This will push that new tar.gz into your private repository.<br/>helm s3 push rabbitmq-&lt;version&gt;.tgz my-charts</span></pre><p id="6277" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">如果成功了，恭喜你！您刚刚建立了自己的图表库。</p></div><div class="ab cl mn mo hc mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="hn ho hp hq hr"><p id="a14d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kf jh ji jj kg jl jm jn kh jp jq jr js hn dt translated">更多关于技术的文章和漫谈，请在 twitter 上关注我<a class="ae li" href="https://twitter.com/chris_cooney" rel="noopener ugc nofollow" target="_blank"/>！</p></div></div>    
</body>
</html>