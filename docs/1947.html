<html>
<head>
<title>Just how expensive is the AWS SDK?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS SDK 到底有多贵？</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/just-how-expensive-is-the-full-aws-sdk-abc73d28f62b#2019-03-23">https://medium.com/hackernoon/just-how-expensive-is-the-full-aws-sdk-abc73d28f62b#2019-03-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="307b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">如果你不熟悉冷启动在 AWS Lambda 环境下的工作方式，那么先读读</em> <a class="ae jq" href="https://theburningmonk.com/2018/01/im-afraid-youre-thinking-about-aws-lambda-cold-starts-all-wrong/" rel="noopener ugc nofollow" target="_blank"> <em class="jp">这篇文章</em> </a> <em class="jp">。</em></p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><p id="6b5a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当 Node.js Lambda 函数冷启动时，会发生许多事情:</p><ul class=""><li id="7d06" class="jy jz hu it b iu iv iy iz jc ka jg kb jk kc jo kd ke kf kg dt translated">Lambda 服务必须找到一个有足够容量来托管新容器的服务器</li><li id="c19f" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">新容器被初始化</li><li id="2cff" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">Node.js 运行时已初始化</li><li id="adc4" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">您的处理程序模块被初始化，这包括初始化您在处理程序函数外部声明的任何全局变量和函数</li></ul><p id="a8fe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您为 Lambda 函数启用主动跟踪，您将能够看到在 X 射线中这些步骤上花费了多少时间。不幸的是，初始化容器和 Node.js 运行时所花费的时间没有被记录为片段。但是你可以从持续时间的差异中计算出来。</p><p id="d26d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里，<code class="eh km kn ko kp b">Initialization</code>是指初始化处理程序模块所需的时间。</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff kq"><img src="../Images/c3c11410ea1f7148ff1be812a2cfe4d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lZxu_KmnQ4x3oXZk.png"/></div></div></figure><p id="0a1a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上面的跟踪是针对下面的函数的，它只需要 AWS SDK。如你所见，这个简单的<code class="eh km kn ko kp b">require</code>为冷启动增加了 147ms。</p><pre class="kr ks kt ku fq lc kp ld le aw lf dt"><span id="c3dc" class="lg lh hu kp b fv li lj l lk ll">const AWS = require('aws-sdk')<br/>module.exports.handler = async () =&gt; {<br/>}</span></pre><p id="51e2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您的功能需要与 AWS 资源交互时，请考虑这种业务成本。但是，如果您只需要与一个服务(例如 DynamoDB)进行交互，您可以使用这个一行程序节省一些初始化时间。</p><pre class="kr ks kt ku fq lc kp ld le aw lf dt"><span id="9744" class="lg lh hu kp b fv li lj l lk ll">const DynamoDB = require('aws-sdk/clients/dynamodb')<br/>const documentClient = new DynamoDB.DocumentClient()</span></pre><p id="dc2b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它直接需要 DynamoDB 客户端，无需初始化整个 AWS SDK。我做了一个实验，看看这个简单的改变可以节省多少冷启动时间。</p><p id="e2f8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">我的同事</em> <a class="ae jq" href="https://www.linkedin.com/in/justin-caldicott-96b36a9/" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> <em class="jp">贾斯汀·卡尔迪科特</em> </strong> </a> <em class="jp">激起了我的兴趣并做了大量的初步分析，这是我的功劳。</em></p><p id="5b4f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了 AWS SDK 之外，我们还经常需要 XRay SDK，并使用它来自动检测 AWS SDK。不幸的是，<code class="eh km kn ko kp b">aws-xray-sdk</code>包裹里还有一些我们不需要的额外行李。默认情况下，它支持 Express.js 应用程序、MySQL 和 Postgres。如果你只对 AWS SDK 和<code class="eh km kn ko kp b">http</code> / <code class="eh km kn ko kp b">https</code>模块感兴趣，那么你只需要<code class="eh km kn ko kp b">aws-xray-sdk-core</code>。</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div class="fe ff lm"><img src="../Images/4ff5df0df0fc06bf2bb44adb635bd678.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/0*g6Zyd9cfn8CGxjCN.png"/></div></figure><h1 id="365f" class="ln lh hu bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj dt translated">方法学</h1><p id="8f39" class="pw-post-body-paragraph ir is hu it b iu mk iw ix iy ml ja jb jc mm je jf jg mn ji jj jk mo jm jn jo hn dt translated">我测试了许多配置:</p><ul class=""><li id="8a06" class="jy jz hu it b iu iv iy iz jc ka jg kb jk kc jo kd ke kf kg dt translated"><a class="ae jq" href="https://github.com/theburningmonk/aws-sdk-coldstart-overhead/blob/master/functions/no-aws-sdk.js" rel="noopener ugc nofollow" target="_blank">没有 AWS SDK </a></li><li id="8feb" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><a class="ae jq" href="https://github.com/theburningmonk/aws-sdk-coldstart-overhead/blob/master/functions/dynamodb-only.js" rel="noopener ugc nofollow" target="_blank">仅需要 DynamoDB 客户端</a></li><li id="9d04" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><a class="ae jq" href="https://github.com/theburningmonk/aws-sdk-coldstart-overhead/blob/master/functions/aws-sdk.js" rel="noopener ugc nofollow" target="_blank">需要完整的 AWS SDK </a></li><li id="c747" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><a class="ae jq" href="https://github.com/theburningmonk/aws-sdk-coldstart-overhead/blob/master/functions/aws-xray-sdk-require-only.js" rel="noopener ugc nofollow" target="_blank">仅需要 x 射线 SDK(无 AWS SDK) </a></li><li id="f561" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><a class="ae jq" href="https://github.com/theburningmonk/aws-sdk-coldstart-overhead/blob/master/functions/aws-xray-sdk.js" rel="noopener ugc nofollow" target="_blank">需要 x 射线软件开发工具包并安装 AWS 软件开发工具包</a></li><li id="286e" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><a class="ae jq" href="https://github.com/theburningmonk/aws-sdk-coldstart-overhead/blob/master/functions/aws-xray-sdk-core.js" rel="noopener ugc nofollow" target="_blank">需要 x 射线 SDK 内核并安装 AWS SDK </a></li><li id="48ed" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><a class="ae jq" href="https://github.com/theburningmonk/aws-sdk-coldstart-overhead/blob/master/functions/trace-dynamodb-only.js" rel="noopener ugc nofollow" target="_blank">需要 XRay SDK 内核，并且仅使用 DynamoDB 客户端</a></li></ul><p id="0ed7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些功能都可以通过 x 光追踪。采样率设置为 100%，这样我们就不会错过任何东西。我们只对<strong class="it hv">初始化</strong>段的持续时间感兴趣，因为它对应于初始化这些依赖项的时间。</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff kq"><img src="../Images/f56bd3dfbb7e40c6c8e57beee0f3f8dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7VDiVLICJ_e1kldE.png"/></div></div></figure><p id="b7e6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh km kn ko kp b">no AWS SDK</code>案例是我们的对照组。我们可以看到每个额外的依赖增加了我们的<code class="eh km kn ko kp b">Initialization</code>持续时间多少时间。</p><p id="85a2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了收集具有统计意义的样本数据集，我决定使用阶跃函数来自动化这个过程。</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff kq"><img src="../Images/2299a02eaabf6f31f1d2c22d40f6f1be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j9cbPruW5vuhjnfc.png"/></div></div></figure><ul class=""><li id="6602" class="jy jz hu it b iu iv iy iz jc ka jg kb jk kc jo kd ke kf kg dt translated">状态机接受一个输入<code class="eh km kn ko kp b">{ functionName, count }</code>。</li><li id="2393" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><code class="eh km kn ko kp b">SetStartTime</code>步骤将当前的 UTC 时间戳添加到执行状态中。这是必要的，因为我们需要实验的开始时间来从 X 射线中提取相关的痕迹。</li><li id="b88a" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><code class="eh km kn ko kp b">Loop</code>步骤触发指定功能所需的冷启动次数。为了触发冷启动，我在调用函数之前以编程方式更新了一个环境变量。这样，我保证每次调用都是冷启动。</li></ul><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff kq"><img src="../Images/0378af707c6963d72434b044aebffa40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UNpcIsYtf_HJFyDh.png"/></div></div></figure><ul class=""><li id="8c82" class="jy jz hu it b iu iv iy iz jc ka jg kb jk kc jo kd ke kf kg dt translated"><code class="eh km kn ko kp b">Wait30Seconds</code>步骤确保在我们试图分析它们之前，所有的轨迹都被发布到 x 射线。</li><li id="9ca5" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><code class="eh km kn ko kp b">Analyze</code>步骤获取 XRay 中所有相关的轨迹，并在<code class="eh km kn ko kp b">Initialization</code>期间输出几个统计数据。</li></ul><p id="f18b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每种配置都经过 1000 多次冷启动测试。偶尔 x 射线痕迹是不完整的(见下文)。这些不完整的轨迹在<code class="eh km kn ko kp b">Analyze</code>步骤中被排除。</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff kq"><img src="../Images/3e375ff6e5e6cd70db2fa45f69cf6eaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3ePFAiCesSN87wQb.png"/></div></div><figcaption class="mp mq fg fe ff mr ms bd b be z ek">where is the AWS::Lambda:Function segment?</figcaption></figure><p id="cca5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每个配置也用 WebPack 测试过(使用<a class="ae jq" href="https://github.com/serverless-heaven/serverless-webpack" rel="noopener ugc nofollow" target="_blank">无服务器 webpack </a>插件)。<em class="jp">感谢</em><a class="mt mu gr" href="https://medium.com/u/d7e408123f72?source=post_page-----abc73d28f62b--------------------------------" rel="noopener" target="_blank"><em class="jp">Erez Rokah</em></a><em class="jp">的建议。</em></p><h1 id="d79e" class="ln lh hu bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj dt translated">结果呢</h1><p id="7354" class="pw-post-body-paragraph ir is hu it b iu mk iw ix iy ml ja jb jc mm je jf jg mn ji jj jk mo jm jn jo hn dt translated">这些是所有测试用例的<code class="eh km kn ko kp b">Initialization</code>时间。</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div class="ab fr cl mv"><img src="../Images/528910950b22fcd13c315e3a76ea7ca1.png" data-original-src="https://miro.medium.com/v2/format:webp/1*khHxsW-Mnvr8LdL6AcGhMQ.png"/></div></figure><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div class="ab fr cl mv"><img src="../Images/3523ecb5e90738123ea40216c809fffc.png" data-original-src="https://miro.medium.com/v2/format:webp/1*Npx-GyKYkBhCvVoZ-uq47Q.png"/></div></figure><p id="ca9e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">主要观察结果:</p><ul class=""><li id="cca3" class="jy jz hu it b iu iv iy iz jc ka jg kb jk kc jo kd ke kf kg dt translated">WebPack 全面提高了<code class="eh km kn ko kp b">Initialization</code>时间。</li><li id="ca46" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">在没有任何依赖的情况下，<code class="eh km kn ko kp b">Initialization</code>在没有 WebPack 的情况下，平均时间仅为 1.72 毫秒，在有 WebPack 的情况下，平均时间为 0.97 毫秒。</li><li id="98cc" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">添加 AWS SDK 作为唯一的依赖项，在没有 WebPack 的情况下平均会增加 245 毫秒。这是相当重要的。添加 WebPack 也没有明显的改善。</li><li id="0ad7" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">只需要 DynamoDB 客户机(前面讨论过的一行代码变化)就可以节省 176 毫秒！在 90%的情况下，节省时间超过 130 毫秒。有了 WebPack，节省的成本更是惊人。</li><li id="b125" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">需要 XRay SDK 的成本大约与 AWS SDK 相同。</li><li id="c88f" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">在使用完整的 x 射线 SDK 和 x 射线 SDK 核心之间没有显著的统计差异。有或没有 WebPack。</li></ul><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div class="fe ff mw"><img src="../Images/cb78dea9f896001dc14239cfecb910e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:618/format:webp/0*DLanM5bihsn-P1y-.png"/></div></figure><p id="f870" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">嗨，我的名字是崔琰。我是一个<a class="ae jq" href="https://aws.amazon.com/developer/community/heroes/yan-cui/?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> AWS 无服务器英雄</strong> </a>和<a class="ae jq" href="https://bit.ly/production-ready-serverless?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">量产无服务器</strong> </a>的作者。</p><p id="9ddc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您是否正在为无服务器而苦恼，或者需要最佳实践方面的指导？您希望有人审查您的架构并帮助您避免代价高昂的错误吗？别担心，我是来帮忙的。<a class="ae jq" href="https://theburningmonk.com/hire-me/" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">我们谈谈吧！</strong> </a></p><p id="d960" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你喜欢这篇文章，为什么不跟随我并获得更多呢？</p><p id="f2c0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我也很感激你对帕特里翁的支持。作为回报，你可以通过私人 Slack 频道和 1-2-1 辅导从我这里获得直接帮助。</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><a href="https://www.patreon.com/bePatron?u=905909"><div class="fe ff mx"><img src="../Images/cfe17cc5258f57f589af06648f7955c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:454/format:webp/0*cwJjI7jQPbhsmabU.png"/></div></a></figure><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff my"><img src="../Images/5a59be5d40425e9e80791bc6ba83f2b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*guDj7SSWWzvs9nEN.png"/></div></div></figure><p id="fa73" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">查看我的新课程，<a class="ae jq" href="https://theburningmonk.thinkific.com/courses/complete-guide-to-aws-step-functions?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"><strong class="it hv">AWS 步骤功能完整指南</strong> </a>。</p><p id="41af" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本课程中，我们将介绍有效使用 AWS Step Functions 服务所需了解的一切。包括基本概念、HTTP 和事件触发器、活动、设计模式和最佳实践。</p><p id="a07a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在此获取您的副本<a class="ae jq" href="https://theburningmonk.thinkific.com/courses/complete-guide-to-aws-step-functions?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff my"><img src="../Images/6487f5bfe99e95b5e57f2206002c9696.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lt_VTZSxOpALv1K6.png"/></div></div></figure><p id="1f16" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">来了解 AWS Lambda: CI/CD 的操作性<strong class="it hv">最佳实践</strong>，本地测试&amp;调试功能、日志记录、监控、分布式跟踪、金丝雀部署、配置管理、认证&amp;授权、VPC、安全性、错误处理等等。</p><p id="3ed7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">代码<strong class="it hv"> ytcui </strong>还可以获得<strong class="it hv">票面价格 6 折</strong>。</p><p id="1cd5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jq" href="https://bit.ly/production-ready-serverless" rel="noopener ugc nofollow" target="_blank">获取您的副本</a></p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><p id="46ac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">原载于 2019 年 3 月 23 日</em><a class="ae jq" href="https://theburningmonk.com/2019/03/just-how-expensive-is-the-full-aws-sdk/" rel="noopener ugc nofollow" target="_blank"><em class="jp">https://theburningmonk.com</em></a><em class="jp">。</em></p></div></div>    
</body>
</html>