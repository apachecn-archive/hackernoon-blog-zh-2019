<html>
<head>
<title>Building Fault-Tolerant MicroServices using Netflix’s Hystrix</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用网飞的Hystrix构建容错微服务</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-fault-tolerant-microservices-using-netflixs-hystrix-c36083ca9af5?source=collection_archive---------4-----------------------#2019-01-29">https://medium.com/hackernoon/building-fault-tolerant-microservices-using-netflixs-hystrix-c36083ca9af5?source=collection_archive---------4-----------------------#2019-01-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="0ecf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">微服务是独立、自治服务的集合，而不是将所有模块紧密集成到一个应用中的整体应用。</p><p id="a657" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在微服务架构中，开发容错微服务是非常必要的。我们必须以这样一种方式开发微服务，即故障影响必须最小化，并且应该基于快速故障机制以具有最小的影响。</p><p id="ee69" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是一个基于微服务架构的电子商务应用程序的例子。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff jp"><img src="../Images/e4bd6293e92ebd3732d56b90e7a685eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*V5apPwT1MllA_HcdEAHqBw.png"/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">E-commerce application Microservice architecture</figcaption></figure><p id="761c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上述架构运行良好，直到有一天电子商务应用程序停止工作。发现获取可用项目列表的服务没有响应。经过进一步分析，发现它使用了有缺陷的第三方服务。错误已从第三方服务蔓延到主应用程序。</p><p id="6079" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">考虑另一个例子，当使用电子商务应用程序时，用户项目推荐服务停止工作。在这种情况下，我们应该显示不特定于用户的项目。这样，用户将无法知道我们的推荐引擎失败了。这就是为什么构建容错微服务非常重要的原因。</p><p id="118c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">网飞拥有世界上最好的基础设施之一。为了构建容错微服务，网飞想出了Hystrix，他们将其开源。</p><div class="kc kd fm fo ke kf"><a href="https://github.com/Netflix/Hystrix" rel="noopener  ugc nofollow" target="_blank"><div class="kg ab ej"><div class="kh ab ki cl cj kj"><h2 class="bd hv fv z el kk eo ep kl er et ht dt translated">网飞/海斯特里克斯</h2><div class="km l"><h3 class="bd b fv z el kk eo ep kl er et ek translated">Hystrix是一个延迟和容错库，旨在隔离远程系统、服务和应用程序的访问点</h3></div><div class="kn l"><p class="bd b gc z el kk eo ep kl er et ek translated">github.com</p></div></div><div class="ko l"><div class="kp l kq kr ks ko kt jv kf"/></div></div></a></div><p id="d9b2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">根据网飞的说法，“Hystrix是一个延迟和容错库，旨在隔离远程系统、服务和第三方库的访问点，防止级联故障，并在故障不可避免的复杂分布式系统中实现弹性。”</p><p id="888e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将使用Hystrix构建一个应用程序，并使其具有容错能力。我们将创建一个获取用户推荐电影列表的应用程序。我们将使用Spring boot来创建微服务。</p><p id="7dc4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">转到<a class="ae kb" href="https://start.spring.io/" rel="noopener ugc nofollow" target="_blank"> Spring Initializer </a>，输入组名、工件名并选择依赖项。点击generate project，解压并在您喜欢的IDE上生成它(我使用IntelliJ作为例子)。我使用spring initializer创建了两个应用程序——“<em class="ku">用户应用程序</em>和“<em class="ku">用户推荐</em>”。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff kv"><img src="../Images/54e1389f716b4f0bf29c068d579f8585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*23lA2uTAX3F0a4byth3AIQ.png"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">Spring Initializer</figcaption></figure><p id="8e26" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在UserRecommendation应用程序中，创建一个名为"<em class="ku">user recommendation controller</em>的rest控制器和一个POJO <em class="ku"> Movie </em>，其中包含电影名称、上映日期和流派。我们将在一个静态列表中填充电影列表。</p><p id="6bed" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我创建了一个rest调用“<em class="ku"> getUserMovieDetails </em>”，它将获取所有用户特定电影的列表。此外，我们通过在resources文件夹下的<em class="ku"> application.properties </em>文件中定义端口号来使用端口号8081。启动tomcat服务器，当我们点击rest URL时，我们得到如下结果:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff la"><img src="../Images/11147aa46f277d90328fe1a02e37a7e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rtdqyISigI4jUBwH92TXGg.png"/></div></div></figure><p id="92be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们将构建使用网飞Hystrix的用户应用程序，并调用用户推荐<a class="ae kb" href="https://hackernoon.com/tagged/microservice" rel="noopener ugc nofollow" target="_blank">微服务</a>。</p><p id="c62e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用相同的过程创建另一个应用程序，并将其导入IDE。我们将使用端口号8082来运行该服务。像我们在前面的服务中所做的那样配置端口号。</p><p id="90ce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在用户应用程序中，我们需要启用Hystrix和Hystrix仪表板。我们可以通过添加以下注释来做到这一点。</p><p id="7964" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了实现回退机制，我们使用以下代码:</p><p id="176e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里，如果对<em class="ku"> getMovieDetails </em>的方法调用失败，那么将调用其回退方法调用<em class="ku"> movieDetailsFallback </em>。</p><p id="64ab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在让我们测试回退机制</p><p id="1a0c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们有两个微服务在端口8081和端口8082上运行。基本上，运行在8081上的服务根据用户推荐给我们电影列表，而运行在8082上的服务首先给运行在8081上的服务打电话，如果它失败，那么它显示不是特定于用户的一般电影列表。两个tomcat服务器现在都在运行。</p><p id="14ce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们首先测试运行在8081上的用户推荐服务:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff lb"><img src="../Images/ddaa0119fe776c2b7922078bf546319a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UWyXKrRv2OJ8h2bMRZz4xA.png"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">User Recommendation Service</figcaption></figure><p id="6f12" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在测试用户服务，它反过来调用用户推荐服务。因为推荐服务在这里，所以不会发生回退，我们会得到完全相同的结果。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff lc"><img src="../Images/cc323aec0fef20004e79b302c2fd866d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k-msC9jvbcVOmxWu1UXe2Q.png"/></div></div></figure><p id="2de5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们将停止在端口8081上运行的推荐服务。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff ld"><img src="../Images/10b1f6fc3f75583792cf61c5c78b1509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FcZfH_NlWAnPu3JKRtLSBw.png"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">user recommendation service stopped</figcaption></figure><p id="55ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，当我们试图点击运行在8082上的用户服务时，它将调用它的回退方法，并将仍然给我们结果。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff le"><img src="../Images/b16dcb0a9688a56e2c1cfbc48e55d650.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tG_2tZgrypu3nM3EK5cLog.png"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">Movies are shown not specific to the user</figcaption></figure><p id="0423" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当我们的推荐服务关闭时，我们通过调用fallback方法来显示不特定于用户推荐的电影。在贴有<em class="ku">UserService.java</em>的要点上面，我们可以看到控制台上的日志。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff lf"><img src="../Images/5e1e957b4c45178e8600199f6d0d762a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BOaM0sWPMn-I2XxIp4e46w.png"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">Console Logs</figcaption></figure><p id="e4f7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Hystrix还为我们提供了仪表板来监控统计数据。</p><p id="7a63" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">转到此URL—"<a class="ae kb" href="http://localhost:8082/hystrix" rel="noopener ugc nofollow" target="_blank">http://localhost:8082/hy strix</a>"并在URL输入字段中输入"<a class="ae kb" href="http://localhost:8082/actuator/hystrix.stream" rel="noopener ugc nofollow" target="_blank">http://localhost:8082/actuator/hy strix . stream</a>"并点击monitor stream。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff lg"><img src="../Images/1e9485dd739ac55ebff5e6bacd14ba6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ikeaLYUFa-gGmtjEvuCrQ.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff lh"><img src="../Images/0b599d5e88c5e4f70cdb8a41e8093c16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-o1cH3SqswOz5pwRETBsSw.png"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">Hystrix Health stats</figcaption></figure><p id="a1c4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这里，我们可以看到与我们实现了回退机制的方法相关的所有细节。我们可以看到成功、超时和失败的百分比。还有关于线程池的相关信息。</p><p id="29bf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以通过这种方式，我们可以使用Hystrix构建容错的微服务。</p><p id="6281" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以在我的GitHub资源库中找到源代码:</p></div><div class="ab cl li lj hc lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hn ho hp hq hr"><div class="jq jr js jt fq kf"><a href="https://github.com/gauravmassand/fault-tolerant-microservices" rel="noopener  ugc nofollow" target="_blank"><div class="kg ab ej"><div class="kh ab ki cl cj kj"><h2 class="bd hv fv z el kk eo ep kl er et ht dt translated">gauravmsand/容错微服务</h2><div class="km l"><h3 class="bd b fv z el kk eo ep kl er et ek translated">通过在GitHub上创建一个帐户，为gauravmsand/容错微服务开发做出贡献。</h3></div><div class="kn l"><p class="bd b gc z el kk eo ep kl er et ek translated">github.com</p></div></div><div class="ko l"><div class="lp l kq kr ks ko kt jv kf"/></div></div></a></div><p id="9be8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">感谢阅读。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lq lr l"/></div></figure></div></div>    
</body>
</html>