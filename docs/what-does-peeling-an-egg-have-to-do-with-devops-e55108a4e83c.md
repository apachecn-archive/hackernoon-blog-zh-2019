# 剥个鸡蛋跟 DevOps 有什么关系？

> 原文：<https://medium.com/hackernoon/what-does-peeling-an-egg-have-to-do-with-devops-e55108a4e83c>

## 学习这些指导原则来帮助你提升你的开发能力

![](img/0d81473fbcfab6687cf7cc497c66b4fd.png)

Licensed from Adobe Stock Photos, By [Africa Studio](https://stock.adobe.com/contributor/293313/africa-studio?load_type=author&prev_url=detail)

前几天我像个白痴一样在剥鸡蛋。我的女朋友 Angelly 说，“你为什么要这样剥鸡蛋？”

她又拿起一个煮熟的鸡蛋，啪的一声砸在砧板上，然后一边滚一边用力往下压。蛋壳在大约 3 秒钟内脱落。

我在这里一点一点地凿掉。

我的观点是:**努力工作被高估了。**

最好的解决方案是简单有效的解决方案。

螺丝上的锈很难去掉吗？大概是吧？除非你知道可口可乐去除螺丝上的铁锈。

现在，很难吗？不。你需要做的就是把它放在杯子里，然后等着。

如果你不知道简单的技巧，你就不能使用它们。你得到的是实验而不是实施。探索而不是复制。

当软件工程中的一种技术被反复使用，因为它使你正在解决的问题变得更简单，它就成为一种模式，或者“最佳实践”。

有时，它们有着复杂、听起来吓人的名字——像命令查询责任分离(CQRS)或事件源(ES)——但是这些模式的存在是为了解决问题。特别是，在构建合理的分布式系统中发现的问题。

当我们将编码环境作为一个整体来看时，有更多的通用模式:“保持简单，愚蠢”(KISS)，以及“不要重复你自己”(DRY)。

我想谈谈应用于 DevOps 的相同类型的模式和原则。DevOps 经常被描绘成鸟儿歌唱、阳光灿烂的应许之地。然而，如果没有正确的技术，它将是一个尖尖的地狱，就像我的小蛋壳碎片一样。

除了像 KISS 和 DRY 这样的通用模式之外，我还发现了其他构建 DevOps 系统的“原则”,它们还不完全是模式。这些原则可以帮助你从一片一片地剥开蛋壳，到马上把它们剥开。他们是，没有特定的顺序:

1.  不要重复别人。
2.  尽可能提高开发人员的工作效率。
3.  没有生产。
4.  将所有内容放在集群中，并备份所有内容。
5.  VPN 不简单，同样的事情也有简单的解决方案。
6.  编纂和自动化一切。

# 第一课——不要重复别人的话

如果你能买到现成的，或者你需要的工具有一个易于使用的开源版本，那就使用它。

不要多此一举。买轮子。

你知道你可以使用 craigslist 使用的同一个邮件服务器吗？你知道你可以免费使用它吗？需要邮件服务器吗？用那个！不要建造它，围绕它建造！

我喜欢 awesome-self-hosted 查找东西，以及在他们的 hub 上使用 Helm 进行搜索。

> 虽然 Helm 是一个很新的寻找和分享软件的工具，但是一个 v3 网站已经上线:[https://v3.helm.sh/](https://v3.helm.sh/)

头盔对装轮子来说真的很棒。

让我带你回到我开始编程的时候。我在九年级时学习的第一门“真正的”语言是 QBasic。我用 HTML 和 CSS 制作网站已经有几年了。那时候，互联网还是新生事物。虽然人们可以创建包，但他们并不像我们现在这样真正地共享它们。我的标准存储机制是一张软盘——我希望我能找到它，这样我就可以提取我在 Java Swing 中制作的 11 年级砖块倒塌游戏…

我编程的时候，用的是标准库，宝贝。这就是全部的真实情况。至少我知道。我当时大概 13 岁。我确信你们中的一些人是更有经验的 Java 专家(嗨 Vlad 和 Nick！)正在杀死它。；)

今天不行。见鬼，今天，你可以把所有的功能 UI 组件打包好，随时可以使用。您可以获得一个库，用一个命令优雅而轻松地处理日期。

如果有某种东西允许你使用和安装整个功能子系统，那不是很好吗？需要数据库？`install database`

好消息！有！你现在可以*也可以*使用 Helm 将整个功能子系统打包并准备就绪。

这是我们通过 NPM 和格雷尔接受的相同概念，但它管理的软件包被称为图表。

一个图表映射了在 Kubernetes 中以不同方式运行的容器。

使用图表有点像买轮子。只不过轮子是在 Kubernetes 内部运行的容器。

图表最酷的地方在于，你可以轻松地打包自己的服务，使之在任何 Kubernetes 集群中轻松运行，如果你愿意，甚至可以与他人共享。

这意味着您可以用一种编码的方式描述整个环境:

```
dependencies:
- name: backup
  repository: [http://jenkins-x-chartmuseum:8080](http://jenkins-x-chartmuseum:8080)
  version: 0.0.2
- name: monitor
  repository: [http://jenkins-x-chartmuseum:8080](http://jenkins-x-chartmuseum:8080)
  version: 0.0.3
- name: marketing-site
  repository: [http://jenkins-x-chartmuseum:8080](http://jenkins-x-chartmuseum:8080)
  version: 1.1.10
- name: denormalizer-service
  repository: [http://jenkins-x-chartmuseum:8080](http://jenkins-x-chartmuseum:8080)
  version: 1.0.0
- name: mongo
  repository: [https://kubernetes-charts.storage.googleapis.com/](https://kubernetes-charts.storage.googleapis.com/)
  version: 1.0.0
```

需要把营销网站更新到 1.2.0？只要改变它，并提交。这就引出了第二课。

# 第 2 课——让开发人员尽可能高效地工作

于是我坐在办公桌前，埋头写代码，追踪一个 bug。用户已经抱怨了几个星期，我找到了一些空闲时间，并决定成为一个英雄。

吧嗒吧嗒，吧嗒嘣！找到了！固定！

在阳光充足的房间里，我隔着半高的隔间喊道:“我修好了那个 bug！”

下周二，当版本发布时，用户会喜欢它的！也就是说，在我们所有人聚集在一个房间里，把发布会的巨石推上另一座小山顶之后…呃，如果我们能够把它推下去，那就是…如果一路上没有任何差错的话…

好吧，下周二，*如果*发布了——用户会喜欢的！

这是我大学毕业后做第一份编程工作时，作为初级软件工程师的经历。

从那时起，事情已经有了很大的进展。

现在，我每天练习基于主干的开发和部署很多次。当我发出拉请求时，一个小机器人会在成功构建并通过测试后发布一个带有短暂拉请求预览环境的评论。

在今天的环境下，你不需要隔着半高的隔间大喊大叫。

作为一名 DevOps 工程师，您越是能够授权工程师控制他们所需的基础架构部分，您的工作就变得越简单。

在第一课中，我们看到了通过更改数字并提交来更新生产环境是可能的。

在理想世界中，我们也将所有应用程序打包到图表中，我们还授权团队中的每个工程师修改服务在生产中的运行方式。图表实际上是容器到 Kubernetes 的映射，出于这个目的，它公开了诸如资源需求之类的东西。

我似乎不太擅长猜测一项新服务需要多少内存或 CPU 设置——我猜你也不擅长——我还喜欢部署一些规则来监控和警报，当这些设置需要调整时，这些规则会通过 Slack 通知我和我的团队。这意味着一旦您部署它，它将指导您纠正设置。我过去常常一次花几个小时运行 Prometheus 查询并进行调整，就像我过去花太多时间剥鸡蛋一样。现在，我学会了用聪明的方法去做。

我已经能听到你说:“这听起来很复杂。”没有。只需安装图表。

任何可以自动化或简化的东西都应该是。例如，如果简单地部署一个带有“expose: true”标签的服务会将它映射到一个 DNS 路径，那会怎么样呢？这就是运营商的用武之地。这是一个更高级的 Kubernetes 助手工具，值得理解，但我们现在不要迷失在这些细节中。

这就把我们带到了第三课。

# 第三课——没有生产

这是我顿悟的时刻之一。这让我从一个新的角度看待事物，所以试着跟随我一分钟。

十多年来，我一直认为只有少数几种环境。最简单的是，有一个暂存环境和一个生产环境。首先，您部署并测试了产品，然后部署并测试了下一个产品，等等。一旦所有东西都部署在一起——“集成”——那么我们就可以继续这个过程，并在生产中重复这个过程。

这就是我多年来做事的方式，对此我毫不在意。事情本来就是这样。

这又是一个一片一片剥开蛋壳的时刻。

图表是一种依赖图。用图表来表示环境，然后部署到生产的过程就是部署一张图表而已！

如果每个团队、项目或有边界的上下文都有自己的图表，那么您就可以拥有许多生产环境，允许您在一个事务中对服务集进行分组和更新。

因此，不要把制作看作是一个大的、无所不包的环境，要意识到实际上有许多小制作。

巨大的变化是可怕和危险的。通过保持许多小的生产环境，您隔离了变化，并使系统的其余部分更有弹性。

此外，因为一切都在图表中，所以每个设置都以统一的方式显示和调整。也就是说，在不需要的地方运行不太强大的 Kafka 集群只是简单的配置更改。

# 第 4 课—将所有内容放入群集，并备份全部内容

好的，我们可以在生产中轻松运行，但是数据库呢？卡夫卡呢？这安全吗？

如果你一直在关注，你会记得我提到过数据库是一种可以打包成图表的东西。

在 Kubernetes 中，现在有一个专门用于在高可用性设置中运行有状态应用程序(如数据库)的 API，称为`StatefulSets`。

Kubernetes 的基本要点是可靠地运行容器。

通过 Helm Chart 安装的名为 *Velero* 的工具可以备份整个 Kubernetes 集群，现在您可以备份 Kubernetes 集群的整个状态，以及所有附加的卷，就像 StatefulSet 创建的卷一样，并通过一个命令恢复所有内容。按照计划配置备份也很容易。

由于备份和恢复只需一个命令，再加上托管的 Kubernetes，现在只需两个命令就可以启动一个全新的集群并将其恢复到备份版本。如果你首先想要一个全新的备份，那就三个。

不要把服务器当成牲口，整个集群开始变得可以任意使用。

分期很烦吗？扔掉它。只需简单的备份、恢复和 DNS 更改。

# 第 5 课—VPN 并不简单，同样的事情也有简单的解决方案

你曾经*享受过*使用 VPN 吗？

我是说，说实话。

有没有人*？*

*谷歌试过。然后，几年前，宣布他们的公司将不再使用它们。我猜他们也不喜欢使用它们。*

*相反，他们依赖于不可信的网络。*

*不是让你访问所有网络的主密钥，而是通过屏幕上的单点登录在每个服务前放置一个密钥。需要访问监控服务？只需使用您授权的公司凭据登录即可。*

*只需要一点小小的改变。不要使用 VPN 进行身份验证，而是使用代理。*

*VPN 还将 Kubernetes 管理 URL 放在 SSO 网关不放在的私有网络上。但是，它们也提供了另一种身份验证机制。对于 Google Cloud 和 AWS，这是 IAM 认证，您也可以将 IP 地址列入白名单。*

*如果您可以在获得相同收益的情况下维护更少的基础设施，那么就这么做吧。像谷歌一样:为不可信的网络抛弃 VPN。*

# *第 6 课——整理和自动化一切*

*有些东西需要更多的努力来编纂？我不在乎！这将节省几个小时、几天甚至几周的时间。编纂它。*

*这是重建基础设施的唯一可靠且可重复的方法。*

*如果每个设置都可以通过更改和提交 git 来修改，那么您的技术组织作为一个整体本质上是声明性的。任何具有 git 访问权限的开发人员都可以轻松维护任何系统。*

*要做到这一点，可以使用大量的小存储库，然后将它们结合在一起。Monorepos 导致人们走捷径，并依赖于一个人为的重要结构。取而代之的是，使用大量的小存储库，并在以后将它们结合在一起。*

*我和我的朋友 Matt 在开发中做了一个工具，叫做`[meta](https://github.com/mateodelnorte/meta)`。Helm 是在生产中实现这一点的工具:一切都只是一个依赖图！*

# *结论*

*不要一片一片地剥鸡蛋。拍打和滚动。*

> *有兴趣让我自动消除你的痛苦吗？我已经锁定了。*
> 
> *查看我的网站[了解更多关于我](https://patscott.io/home)和我的代理机构[无界](https://www.unbounded.tech/)的信息，安排一次 15 分钟的免费电话咨询。我也是 advisory cloud 的顾问。*
> 
> *刚刚开始使用 DevOps？在 HackerNoon 上查看[我的实现 DevOps 幸福之旅，没有无用的 AWS 认证](https://hackernoon.com/my-journey-to-achieving-devops-bliss-without-useless-aws-certifications-a7cbf7c539d1)，并在底部找到一个免费的 21 天电子邮件课程！*