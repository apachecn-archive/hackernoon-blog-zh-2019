<html>
<head>
<title>Better local development for Serverless Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器功能的更好的本地开发</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/better-local-development-for-serverless-functions-b96b5a4cfa8f?source=collection_archive---------6-----------------------#2019-02-11">https://medium.com/hackernoon/better-local-development-for-serverless-functions-b96b5a4cfa8f?source=collection_archive---------6-----------------------#2019-02-11</a></blockquote><div><div class="eg hj hk hl hm hn"/><div class="ho hp hq hr hs"><div class=""/><figure class="fj fl it iu iv iw ff fg paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="ff fg is"><img src="../Images/75f002e2d4bd7f441e978da8349a0692.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*roedigbmFjRYkZobdZWuKg.jpeg"/></div></div></figure><p id="4b5f" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">Lambda是一个很棒的套件，包含了AWS产品页面上列出的所有好处，T2是一个非常有用的开发Lambda函数的框架。然而，如果您要解决的问题并非完全无关紧要，那么在本地开发无服务器应用程序是一件非常痛苦的事情。</p><p id="8f9c" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">当事情变得复杂，你的Lambda函数开始与其他AWS服务集成时，事情就真的开始出问题了。有一些东西看起来像银弹，我会在这里分享它们，并解释为什么它们对我不起作用，然后给你一个我自己努力找到的工作示例(因此我写了这篇文章)。</p><h1 id="1c11" class="kc kd hv bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">本地堆栈</h1><p id="9e17" class="pw-post-body-paragraph jd je hv jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka ho dt translated"><a class="ae kb" href="https://github.com/localstack/localstack" rel="noopener ugc nofollow" target="_blank"> Localstack </a>绝对是这里最大的银弹尝试。基本上，它在本地模拟了一大块AWS，你可以将你的无服务器功能连接到其中。我没有使用它的原因:</p><ol class=""><li id="2b87" class="lf lg hv jf b jg jh jk jl jo lh js li jw lj ka lk ll lm ln dt translated">比特工作，但如果你有任何类型的半复杂的设置(如美国东部1或欧盟西部1以外的地区)，它会崩溃。上传一个完整的cloudformation模板是一场服务间链接断裂的灾难。我开始编辑localstack代码，试图解决我遇到的一个又一个问题，然后放弃了。如果产品不试图做一些超级复杂的事情，它会很酷。</li><li id="208a" class="lf lg hv jf b jg lo jk lp jo lq js lr jw ls ka lk ll lm ln dt translated">这也是开发人员机器上的巨大资源消耗。</li><li id="1999" class="lf lg hv jf b jg lo jk lp jo lq js lr jw ls ka lk ll lm ln dt translated">从根本上说，你不应该为了测试你的代码而去模拟一半的AWS。</li></ol><h1 id="99d0" class="kc kd hv bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">无服务器脱机</h1><p id="843c" class="pw-post-body-paragraph jd je hv jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka ho dt translated">无服务器脱机相当简单。它应该允许您在本地运行您的函数，并在需要时调用它们。对我来说，这需要你的lambda函数有HTTP端点，我们所有的Lambda函数都是由SQS事件或Cron驱动的。我们还在代码中实例化了SNS主题，因此它会不断尝试创建SNS主题，AWS会抛出错误。</p><p id="6f87" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">我也尝试过使用<a class="ae kb" href="https://www.npmjs.com/package/serverless-offline-sqs" rel="noopener ugc nofollow" target="_blank"> serverless-offline-sqs </a>，但是无法将事件驱动到我们的Lamdba函数中。</p><p id="bb64" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">我花了很多时间来设置开发环境，我意识到这根本就是错误的方法。我需要开始编写适当的单元测试，并使用mocking来模拟基础设施(我的意思是，理想情况下，它们应该被适当地隔离，基础设施/功能应该彼此完全不了解，但那是另一天的事了)。</p><h1 id="602e" class="kc kd hv bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">这个例子</h1><p id="a5d6" class="pw-post-body-paragraph jd je hv jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka ho dt translated">假设我们正在开发一个应用程序，它利用了:</p><ul class=""><li id="ac09" class="lf lg hv jf b jg jh jk jl jo lh js li jw lj ka lt ll lm ln dt translated">希腊字母的第11个</li><li id="4b8a" class="lf lg hv jf b jg lo jk lp jo lq js lr jw ls ka lt ll lm ln dt translated">MongoDB</li><li id="19a3" class="lf lg hv jf b jg lo jk lp jo lq js lr jw ls ka lt ll lm ln dt translated">SQS</li><li id="f1f1" class="lf lg hv jf b jg lo jk lp jo lq js lr jw ls ka lt ll lm ln dt translated">社交网站（Social Network Site的缩写）</li></ul><p id="8f61" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">你的lambda函数连接到你的MongoDB，做一件事，偶尔向其他服务发送SNS通知/SQS消息。</p><p id="83f4" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated"><strong class="jf hw">λ</strong></p><p id="3f02" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">对于正在运行的实际代码，我将使用<a class="ae kb" href="https://www.npmjs.com/package/jest" rel="noopener ugc nofollow" target="_blank"> jest </a>开始编写测试。Jest工作得很好，并且很好地集成到无服务器中。</p><p id="66d0" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated"><strong class="jf hw"> MongoDB </strong></p><p id="4044" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">为了模拟MongoDB，我将使用一个<a class="ae kb" href="https://www.npmjs.com/package/mongodb-memory-server" rel="noopener ugc nofollow" target="_blank">内存版本的MongoDB </a>,它很好地结合到我们的Mongoose模型中。</p><p id="70a4" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated"><strong class="jf hw"> SQS/SNS </strong></p><p id="4023" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">对于任何亚马逊基础设施，我们将使用<a class="ae kb" href="https://www.npmjs.com/package/aws-sdk-mock" rel="noopener ugc nofollow" target="_blank"> aws-sdk-mock </a>。这是一个模仿AWS基础设施的极好的包装器，对单元测试非常有用，稍后你会看到。</p><h1 id="b832" class="kc kd hv bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">把所有东西绑在一起</h1><p id="a4c2" class="pw-post-body-paragraph jd je hv jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka ho dt translated">所以首先让我们安装我们的依赖项。</p><pre class="lu lv lw lx fr ly lz ma mb aw mc dt"><span id="23e7" class="md kd hv lz b fw me mf l mg mh">npm install aws-sdk-mock mongodb-memory-server sinon jest --save-dev</span></pre><p id="9924" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">让我们也创建一个tests文件夹来保存所有的测试代码。</p><pre class="lu lv lw lx fr ly lz ma mb aw mc dt"><span id="de5c" class="md kd hv lz b fw me mf l mg mh">mkdir tests</span></pre><p id="8172" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated"><strong class="jf hw">设置MongoDB </strong></p><p id="4606" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">现在，为了让我们的代码与内存中的Mongo-DB服务器集成，我们需要添加一些安装/拆卸函数和一个Mongo环境。克隆这个<a class="ae kb" href="https://github.com/vladgolubev/jest-mongodb" rel="noopener ugc nofollow" target="_blank">回购</a>并放入:</p><ul class=""><li id="20ac" class="lf lg hv jf b jg jh jk jl jo lh js li jw lj ka lt ll lm ln dt translated"><code class="ei mi mj mk lz b">setup.js</code></li><li id="69bd" class="lf lg hv jf b jg lo jk lp jo lq js lr jw ls ka lt ll lm ln dt translated"><code class="ei mi mj mk lz b">teardown.js</code></li><li id="6dd8" class="lf lg hv jf b jg lo jk lp jo lq js lr jw ls ka lt ll lm ln dt translated"><code class="ei mi mj mk lz b">mongo-environment.js</code></li></ul><p id="939f" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">到新的测试文件夹中。</p><p id="2ea3" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">在您的根目录中添加一个包含此内容的<code class="ei mi mj mk lz b">jest.config.js</code>。</p><pre class="lu lv lw lx fr ly lz ma mb aw mc dt"><span id="03d1" class="md kd hv lz b fw me mf l mg mh">module.exports = {<br/>  globalSetup: './tests/setup.js',<br/>  globalTeardown: './tests/teardown.js',<br/>  testEnvironment: './tests/mongo-environment.js',<br/>  roots: ['./tests/'],<br/>};</span></pre><p id="bef6" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">这应该足以启动并运行MongoDB。现在进入我们实际的测试脚本。</p><p id="3164" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated"><strong class="jf hw">设置我们的测试</strong></p><p id="d795" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">现在，最后，您可以用下面的代码片段将它们联系起来:</p><figure class="lu lv lw lx fr iw"><div class="bz em l di"><div class="ml mm l"/></div></figure><p id="32de" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">将jest添加到您的包中。json</p><pre class="lu lv lw lx fr ly lz ma mb aw mc dt"><span id="0ad4" class="md kd hv lz b fw me mf l mg mh">"scripts":{   <br/>  "test": "jest"<br/>},</span></pre><p id="22d2" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">和<code class="ei mi mj mk lz b">npm test</code>一起跑。</p><p id="86de" class="pw-post-body-paragraph jd je hv jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka ho dt translated">需要注意的一个要点是，aws-mock-sdk需要一种非常特殊的方式来实例化aws资源(在功能测试的范围内)，因此如果您在AWS区域周围看到任何错误，请仔细检查您是否遵循了规则。</p></div></div>    
</body>
</html>