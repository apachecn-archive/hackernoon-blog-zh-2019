<html>
<head>
<title>Invoking AWS Services from AppSync HTTP Resolvers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从AppSync HTTP解析器调用AWS服务</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/invoking-aws-services-from-appsync-http-resolvers-4e2c54784204?source=collection_archive---------7-----------------------#2019-04-11">https://medium.com/hackernoon/invoking-aws-services-from-appsync-http-resolvers-4e2c54784204?source=collection_archive---------7-----------------------#2019-04-11</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/e28d023f4bdb82397875b09a106c1553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pRyNAoqDM-kxLfObLxzTcg.jpeg"/></div></div></figure><p id="b30b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">AWS最近发布了用于<strong class="je hv"> </strong> HTTP解析器的数据类型<a class="ae ka" href="https://docs.aws.amazon.com/appsync/latest/APIReference/API_AuthorizationConfig.html" rel="noopener ugc nofollow" target="_blank"><strong class="je hv">authorization config</strong></a><strong class="je hv"/>。</p><blockquote class="kb kc kd"><p id="99bf" class="jc jd ke je b jf jg jh ji jj jk jl jm kf jo jp jq kg js jt ju kh jw jx jy jz hn dt translated"><em class="hu">HTTP端点需要授权时的授权配置。</em></p></blockquote><p id="a199" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这意味着您可以调用AWS服务<strong class="je hv">而无需调用Lambda函数</strong>。</p><blockquote class="kb kc kd"><p id="776a" class="jc jd ke je b jf jg jh ji jj jk jl jm kf jo jp jq kg js jt ju kh jw jx jy jz hn dt translated"><em class="hu"> AWS AppSync现在已经扩展到支持通过HTTP数据源调用AWS服务。为了让AWS识别和授权HTTP请求，它们必须用</em> <a class="ae ka" href="https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html" rel="noopener ugc nofollow" target="_blank"> <em class="hu">签名版本4流程</em> </a> <em class="hu">进行签名。否则，这些请求将被拒绝。AWS AppSync现在可以根据作为HTTP数据源配置的一部分提供的IAM角色，代表您计算签名。</em>出自<em class="hu"> </em>乔希·卡恩</p></blockquote><p id="1d7e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这篇文章中，我展示了一个从HTTP resolvers直接发送SES电子邮件的例子。</p><h1 id="67a6" class="ki kj hu bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">无服务器框架入门</h1><p id="faac" class="pw-post-body-paragraph jc jd hu je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">示例项目基于<a class="ae ka" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">无服务器框架</strong> </a>，需要添加两个插件:<a class="ae ka" href="https://github.com/sid88in/serverless-appsync-plugin" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">无服务器-appsync-plugin </strong> </a>和<a class="ae ka" href="https://github.com/svdgraaf/serverless-pseudo-parameters" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">无服务器-伪参数</strong> </a> <strong class="je hv">。</strong></p><p id="d351" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ke">更新于2019年4月25日</em></p><p id="eaaf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ke">n̵o̵t̵e̵̵t̵h̵a̵t̵̵s̵e̵r̵v̵e̵r̵l̵e̵s̵s̵-̵a̵p̵p̵s̵y̵n̵c̵-̵p̵l̵u̵g̵i̵n̵̵d̵o̵e̵s̵n̵'̵t̵̵s̵u̵p̵p̵o̵r̵t̵̵a̵u̵t̵h̵o̵r̵i̵z̵a̵t̵i̵o̵n̵̵c̵o̵n̵f̵i̵g̵̵f̵o̵r̵̵h̵t̵t̵p̵̵r̵e̵s̵o̵l̵v̵e̵r̵s̵̵y̵e̵t̵.̵̵f̵o̵r̵̵t̵e̵m̵p̵o̵r̵a̵r̵y̵̵s̵o̵l̵u̵t̵i̵o̵n̵,̵̵y̵o̵u̵̵c̵a̵n̵̵g̵e̵t̵̵p̵l̵u̵g̵i̵n̵̵f̵r̵o̵m̵̵m̵y̵̵f̵o̵r̵k̵e̵d̵̵g̵i̵t̵̵r̵e̵p̵o̵.̵</em></p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="9562" class="lu kj hu lq b fv lv lw l lx ly">$<strong class="lq hv"> </strong>npm install serverless-pseudo-parameters<br/>$<strong class="lq hv"> </strong>npm install <!-- -->serverless-appsync-plugin</span></pre><p id="1ccb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">编辑<code class="eh lz ma mb lq b">serverless.yml</code>文件并将插件添加到<strong class="je hv">插件</strong>部分:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="04d0" class="lu kj hu lq b fv lv lw l lx ly"><strong class="lq hv">plugins</strong>:<br/>  - serverless-appsync-plugin<br/>  - serverless-pseudo-parameters</span></pre><h2 id="7fae" class="lu kj hu bd kk mc md me ko mf mg mh ks jn mi mj kw jr mk ml la jv mm mn le mo dt translated">定义AWS AppSync模式</h2><p id="cd2d" class="pw-post-body-paragraph jc jd hu je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">让我们来看看模式。模式文件是文本文件，通常命名为<code class="eh lz ma mb lq b">schema.graphql</code>，在这个例子中我只添加了发送电子邮件的变体:</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="ff3c" class="lu kj hu lq b fv lv lw l lx ly">type Mutation {<br/>  sendNotification: String<br/>}</span></pre><h2 id="7620" class="lu kj hu bd kk mc md me ko mf mg mh ks jn mi mj kw jr mk ml la jv mm mn le mo dt translated">定义HTTP数据源</h2><p id="ac39" class="pw-post-body-paragraph jc jd hu je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">接下来让我们定义AWS AppSync HTTP数据源和sendNotification变异，将以下配置添加到<code class="eh lz ma mb lq b">serverless.yml</code>中的<strong class="je hv">自定义</strong>部分。</p><figure class="ll lm ln lo fq iv"><div class="bz el l di"><div class="mp mq l"/></div></figure><h2 id="e31b" class="lu kj hu bd kk mc md me ko mf mg mh ks jn mi mj kw jr mk ml la jv mm mn le mo dt translated">为HTTP数据源定义IAM角色</h2><p id="6aa0" class="pw-post-body-paragraph jc jd hu je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">在本例中，HTTP resolver调用<strong class="je hv"> Amazon简单电子邮件服务</strong> ( <strong class="je hv"> SES) </strong>来发送电子邮件，您需要创建一个IAM角色<strong class="je hv"> AppSyncSESserviceRole </strong>，它允许HTTP resolver访问SES并发送电子邮件，将以下配置添加到<code class="eh lz ma mb lq b">serverless.yml</code>中的<strong class="je hv">资源</strong>部分。</p><figure class="ll lm ln lo fq iv"><div class="bz el l di"><div class="mp mq l"/></div></figure><h2 id="f005" class="lu kj hu bd kk mc md me ko mf mg mh ks jn mi mj kw jr mk ml la jv mm mn le mo dt translated">创建映射模板</h2><p id="25c7" class="pw-post-body-paragraph jc jd hu je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">现在我们已经配置了yml，我们需要添加解析器，映射模板文件应该位于与serverless.yml文件相关的名为mapping-templates的目录中。</p><p id="d322" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们在一个名为<code class="eh lz ma mb lq b">mapping-templates/Mutation-sendNotification-reques.vtl</code>的文件中创建发送通知变异的请求模板。</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="9bea" class="lu kj hu lq b fv lv lw l lx ly">{<br/>  "<strong class="lq hv">version</strong>": "2018-05-29",<br/>  "<strong class="lq hv">method</strong>": "GET",<br/>  "<strong class="lq hv">resourcePath</strong>": "/",<br/>  "<strong class="lq hv">params</strong>":{<br/>    "<strong class="lq hv">query</strong>":<br/>      {<br/>       "<strong class="lq hv">Action</strong>":"SendEmail",<br/>       "<strong class="lq hv">Source</strong>":"noreply@neami.blue",<br/>       "<strong class="lq hv">Destination.ToAddresses.member.1</strong>":"<a class="ae ka" href="mailto:test1@email.com" rel="noopener ugc nofollow" target="_blank">test1@email.com</a>",<br/>       "<strong class="lq hv">Destination.ToAddresses.member.2</strong>":"<a class="ae ka" href="mailto:test2@email.com" rel="noopener ugc nofollow" target="_blank">test2@email.com</a>",<br/>       "<strong class="lq hv">Message.Subject.Data</strong>":"test subject",<br/>       "<strong class="lq hv">Message.Body.Text.Data</strong>": "test content"<br/>      }<br/>  }<br/>}</span></pre><p id="5187" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后创建响应模板<code class="eh lz ma mb lq b">mapping-templates/Mutation-sendNotification-request.vtl</code>。</p><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="c811" class="lu kj hu lq b fv lv lw l lx ly">#if($ctx.error)<br/>  $util.error($ctx.error.message, $ctx.error.type)<br/>#end</span><span id="9c23" class="lu kj hu lq b fv mr lw l lx ly">#if($ctx.result.statusCode == 200)<br/>    $util.toJson($ctx.result)<br/>#else<br/>    $utils.error("Delivery failed")<br/>#end</span></pre><h2 id="b05e" class="lu kj hu bd kk mc md me ko mf mg mh ks jn mi mj kw jr mk ml la jv mm mn le mo dt translated">让我们部署服务</h2><pre class="ll lm ln lo fq lp lq lr ls aw lt dt"><span id="3157" class="lu kj hu lq b fv lv lw l lx ly">$ sls deploy --stage dev</span></pre><h1 id="0645" class="ki kj hu bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">一切准备就绪，尝试一下吧！</h1><p id="49a6" class="pw-post-body-paragraph jc jd hu je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">您可以使用<a class="ae ka" href="https://console.aws.amazon.com/appsync/home" rel="noopener ugc nofollow" target="_blank"> AWS AppSync控制台</a>来测试我们刚刚部署的sendNotification变异。</p><figure class="ll lm ln lo fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ms"><img src="../Images/f1734b62fa7fb7cb365bcca9a0721da3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OHoR5qXmmEtYLk9p2CyZlw.png"/></div></div></figure><p id="8c96" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后检查电子邮件是否已经发送和接收。</p><figure class="ll lm ln lo fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mt"><img src="../Images/bd0a6806f872b3ef803906b665947efd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GOaTrkEupXswwQSDECgt2g.jpeg"/></div></div></figure><p id="dc24" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就这些，希望你觉得这篇文章有用，你可以在我的<a class="ae ka" href="https://github.com/yai333/AppsyncDax" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv"> GitHub repo </strong> </a>中找到完整的项目。</p><figure class="ll lm ln lo fq iv"><div class="bz el l di"><div class="mu mq l"/></div></figure></div></div>    
</body>
</html>