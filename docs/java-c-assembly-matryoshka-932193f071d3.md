# Java-C 汇编 Matryoshka

> 原文：<https://medium.com/hackernoon/java-c-assembly-matryoshka-932193f071d3>

![](img/3c41dc05e791e6c5bf037ec3ee836a70.png)

Source: [Unsplash](https://unsplash.com/photos/9hhOVsf1lpU)

> **免责声明** :
> -我将使用 Windows，尤其是 Visual C++及其内嵌汇编程序。如果你使用的是 MacOs 或者 Linux，你会发现和文章中描述的有很大的不同。
> -以下所有内容主要用于演示目的

# 介绍

java 是成熟的自给自足的语言，尽管我们都知道可以将 Java“连接”到 C 语言(通过 Java-Native-Interface 或 JNI)来加速一些关键的代码。
同样，对于 C/C++来说，可以将一些更关键的代码直接委托给汇编。

在本文中，我想向您展示这个 Java-C-Assembly Matryoshka 是什么样子的。但是请注意，这个例子非常简单，所以在现实世界中，这种委托没有任何好处，因为它不会加速任何事情。

我们要看的例子是:

*   给定一个命令行程序(用 Java 编写)
*   我们通过提供 2 个整数作为参数来执行程序(在客户端进行错误处理)
*   主要的业务逻辑是“sum”方法，我们认为这是程序的一个关键部分，我们希望使用 C 和汇编来“加速”。

# Java 语言(一种计算机语言，尤用于创建网站)

## 设置

首先我们需要下载 [JDK](https://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html) 。
我已经安装了相当旧的版本，但请放心安装新版本。
安装后，验证一切正常:

```
>java -version
java version "1.8.0_121"
Java(TM) SE Runtime Environment (build 1.8.0_121-b13)
Java HotSpot(TM) Client VM (build 25.121-b13, mixed mode, sharing)
```

## 密码

下面是我们的程序:主函数、解析命令行参数和我们的目标方法“sum”(用 java 实现):

```
public class Test {

    public static void main(String[] args) {

        if (args.length != 2) {
            System.out.println("Error: wrong params count");
            return;
        }

        int a;
        try {
            a = Integer.parseInt(args[0]);
        } catch (Throwable throwable) {
            System.out.println("First param is not a number");
            return;
        }

        int b;
        try {
            b = Integer.parseInt(args[1]);
        } catch (Throwable throwable) {
            System.out.println("Second param is not a number");
            return;
        }

        Test test = new Test();
        System.out.println(test.sum(a, b));
    }

    public static int sum(int a, int b) {
        return a + b;
    }
}
```

## 编制

为了运行程序，我们首先需要用 java 编译器编译它。它将生成`Test.class`二进制文件，我们稍后将执行该文件。

```
> javac Test.java
```

## 执行

执行程序调用`java`并提供参数。看看我们的程序工作正常，并打印数字的总和。

```
> java Test 3 4
7
```

# C/JNI

## 设置

安装 [Chocolatey](https://chocolatey.org/) 并使用它安装 Visual C++构建工具:

```
choco install visualcpp-build-tools
```

我们将需要这些工具来把 C 文件编译成库 dll 文件。具体来说，为了编译，我们需要`cl`命令，所以检查它是否工作:

```
>cl
Microsoft (R) C/C++ Optimizing Compiler Version 19.16.27031.1 for x86
Copyright (C) Microsoft Corporation.  All rights reserved.
```

## 密码

Java 可以通过 JNI 与 C 进行通信。为了建立通信，我们需要更新我们的 Java 程序:

```
public class Test {

    public static void main(String[] args) {

        if (args.length != 2) {
            System.out.println("Error: wrong params count");
            return;
        }

        int a;
        try {
            a = Integer.parseInt(args[0]);
        } catch (Throwable throwable) {
            System.out.println("First param is not a number");
            return;
        }

        int b;
        try {
            b = Integer.parseInt(args[1]);
        } catch (Throwable throwable) {
            System.out.println("Second param is not a number");
            return;
        } **System.loadLibrary("Test");** Test test = new Test();
        System.out.println(test.sum(a, b));
    }

    **public native int sum(int a, int b);**
}
```

首先，我们提供所谓的本地方法，而不是静态方法和实现。它没有任何实现，因为我们希望它通过 JNI 提供。其次，我们需要加载我们的 C 库——我们用`System.loadLibrary`方法来完成。

更新程序后，我们需要生成 Test.h 头文件:

```
> javah Test
```

生成的头文件将包含我们的 C 程序的所有设置。我们的 Java 程序中有一个本地方法，这里我们有在头文件中生成的方法的方法声明:

```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class Test */#ifndef _Included_Test
#define _Included_Test
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     Test
 * Method:    sum
 * Signature: (II)I
 */
**JNIEXPORT jint JNICALL Java_Test_sum
  (JNIEnv *, jobject, jint, jint);**#ifdef __cplusplus
}
#endif
#endif
```

我们需要一个函数的实现，所以创建 Test.c 文件并实现方法:

```
#include "Test.h"JNIEXPORT jint JNICALL Java_Test_sum
  (JNIEnv *env, jobject obj, jint a, jint b) {
   return a + b;
  }void main() {}
```

## 编制

将我们的 C 库编译成 Test.dll:

```
> cl -I"%JAVA_HOME%\include" -I"%JAVA_HOME%\include\win32" -LD Test.c -FeTest.dll
```

## 执行

如上所示重新编译我们的 Java 程序，并执行以查看它是否仍然工作:

```
> java Test 3 4
7
```

# 装配

## 密码

以前我们有 C 实现，看起来基本上和 java 一样:`a + b`。当我们使用汇编时，我们是在一个较低的层次上工作，所以这样的小操作需要更多的代码。让我们更新我们的 C 程序以使用汇编语言——为此我们添加了`__asm`块——它是 Visual C++的内联汇编程序。我们在那个块里面写指令。你可以看到我们将变量`a`放入寄存器`eax`，将变量`b`放入寄存器`ebx`。然后我们对寄存器的内容求和，并将其存储在`eax`寄存器中(这就是`add`命令的作用)。
最后，我们将`eax`寄存器的值存储在结果字段中:

```
#include "Test.h"
#include <stdio.h>JNIEXPORT jint JNICALL Java_Test_sum
  (JNIEnv *env, jobject obj, jint a, jint b) {
    int result;
    __asm {
        mov eax, a
        mov ebx, b
        add eax, ebx
        mov result, eax
    }
    return result;
}void main() {}
```

重新编译 C 库(无需重新编译 Java 程序)并再次执行 Java 程序:

```
> java Test 3 4
7
```

所以，它起作用了。

希望你喜欢，也许今天学到了一些东西。如果不是，那么我希望至少它是有趣的。

编码快乐！

**参考文献**:

 [## Java 编程语言编译器

### javac 工具读取用 Java 编程语言编写的类和接口定义，并将它们编译成…

docs.oracle.com](https://docs.oracle.com/javase/7/docs/technotes/tools/windows/javac.html) [](https://www.baeldung.com/jni) [## JNI 指南(Java 本地接口)| Baeldung

### 如果您在 Java 生态系统中有几年的经验，并且有兴趣与……

www.baeldung.com](https://www.baeldung.com/jni)  [## 内嵌汇编程序

### 汇编语言有许多用途，如提高程序速度、减少内存需求和控制…

docs.microsoft.com](https://docs.microsoft.com/en-us/cpp/assembler/inline/inline-assembler?view=vs-2019)