<html>
<head>
<title>Service Mesh: Moving from bare-bones Envoy to Istio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服务网:从基本的特使到Istio</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/service-mesh-moving-from-bare-bones-envoy-to-istio-e0fef88fc1e3?source=collection_archive---------3-----------------------#2019-02-15">https://medium.com/hackernoon/service-mesh-moving-from-bare-bones-envoy-to-istio-e0fef88fc1e3?source=collection_archive---------3-----------------------#2019-02-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/855adc44cc25eef7f1cfdc4344364cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xzz6jltbnrH_DGr4fbMd6Q.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Migrating from bare-bones Envoy to Istio</figcaption></figure><p id="8afc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这篇文章是“服务网格”系列的一部分。如果你还没有阅读之前的文章，我强烈建议你这样做，这将有助于你更好地理解这篇文章。这里是以前的文章</p><ul class=""><li id="49b9" class="ke kf hu ji b jj jk jn jo jr kg jv kh jz ki kd kj kk kl km dt translated"><a class="ae kn" href="https://hackernoon.com/service-mesh-with-envoy-101-e6b2131ee30b" rel="noopener ugc nofollow" target="_blank">与特使101的服务网格</a></li><li id="142d" class="ke kf hu ji b jj ko jn kp jr kq jv kr jz ks kd kj kk kl km dt translated"><a class="ae kn" href="https://hackernoon.com/microservices-monitoring-with-envoy-service-mesh-prometheus-grafana-a1c26a8595fc" rel="noopener ugc nofollow" target="_blank">使用特使服务网格进行微服务监控，Prometheus &amp; Grafana </a></li><li id="eb60" class="ke kf hu ji b jj ko jn kp jr kq jv kr jz ks kd kj kk kl km dt translated"><a class="ae kn" href="https://hackernoon.com/distributed-tracing-with-envoy-service-mesh-jaeger-c365b6191592" rel="noopener ugc nofollow" target="_blank">带特使服务网的分布式追踪&amp;耶格</a></li></ul><p id="cd65" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在之前的文章中，我们看到了将Envoy安装为我们服务的侧车代理，并看到了服务网格设置如何帮助管理服务之间的流量，以及如何收集和可视化大量关于流量的遥测数据。</p><p id="6ab2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">虽然在设置中有一些恼人的事情</p><ol class=""><li id="8536" class="ke kf hu ji b jj jk jn jo jr kg jv kh jz ki kd kt kk kl km dt translated">手动安装特使侧车</li><li id="2939" class="ke kf hu ji b jj ko jn kp jr kq jv kr jz ks kd kt kk kl km dt translated">手动将流量路由到侧车代理</li><li id="d6f2" class="ke kf hu ji b jj ko jn kp jr kq jv kr jz ks kd kt kk kl km dt translated">管理所有特使侧车的配置</li></ol><p id="6563" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">关于第三点，正如我们在之前的一篇文章中已经看到的，我们可以使用Envoy的xDS服务器来集中管理配置，并在不需要重启的情况下动态更新它们。是的，这在一定程度上减少了痛苦，但是你仍然需要维护所有侧车代理的配置。</p><h1 id="6eaa" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">数据平面与控制平面</h1><p id="4ddb" class="pw-post-body-paragraph jg jh hu ji b jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd hn dt translated">在改进我们的设置之前，我们需要理解这些在服务网格环境中广泛使用的术语。</p><p id="5f17" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">数据平面实际上完成所有基础工作，如路由流量、收集遥测数据并发送到指标存储(例如:statsd)、通过电路中断管理流量、速率限制等..数据平面的一个例子是我们的特使侧车。</p><p id="fb8f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">控制平面是在服务网格中配置侧车代理的平面。到目前为止<strong class="ji hv">我们一直手动充当控制平面</strong>并配置侧车代理，但是我们可以使用工具充当控制平面并为我们配置侧车代理。控制平面的例子是Istio。</p><figure class="ly lz ma mb fq iv fe ff paragraph-image"><div class="fe ff lx"><img src="../Images/0a5fa69277a898eb825abe9f2fb8c5d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*g5xiMADQdDFSOwA80aLStg.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Istio Control Plane</figcaption></figure><p id="8ddb" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">所以现在你不直接配置任何侧车代理，我们提交我们的配置(流量转移，故障注入等..)到配置存储器，Istio Pilot(Istio中的一个组件)在配置存储器中寻找变化，然后将这些变化推送到侧车代理。</p><blockquote class="mc md me"><p id="ca3e" class="jg jh mf ji b jj jk jl jm jn jo jp jq mg js jt ju mh jw jx jy mi ka kb kc kd hn dt translated">注意:上图只显示了Istio Pilot，但Istio还有其他几个组件，如Citadel、Galley等…</p></blockquote><h1 id="f991" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">演示</h1><p id="ccdd" class="pw-post-body-paragraph jg jh hu ji b jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd hn dt translated">让我们看一个用Istio建立服务网格的例子。我们将在Kubernetes集群中部署我们的服务</p><figure class="ly lz ma mb fq iv fe ff paragraph-image"><div class="fe ff mj"><img src="../Images/a29ee463e3abe09d5733d4c243336555.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*SICOC54R0_hTShJXvQo7zw.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Service Architecture</figcaption></figure><h2 id="74b0" class="mk kv hu bd kw ml mm mn la mo mp mq le jr mr ms li jv mt mu lm jz mv mw lq mx dt translated">安装Istio</h2><p id="3583" class="pw-post-body-paragraph jg jh hu ji b jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd hn dt translated">先决条件:</p><ol class=""><li id="7838" class="ke kf hu ji b jj jk jn jo jr kg jv kh jz ki kd kt kk kl km dt translated">您需要启动并运行一个Kubernetes集群</li><li id="41a9" class="ke kf hu ji b jj ko jn kp jr kq jv kr jz ks kd kt kk kl km dt translated">在集群中配置Helm客户端和tiller。请参考此处的<a class="ae kn" href="https://docs.helm.sh/using_helm/#installing-helm" rel="noopener ugc nofollow" target="_blank"/></li><li id="1a70" class="ke kf hu ji b jj ko jn kp jr kq jv kr jz ks kd kt kk kl km dt translated">克隆官方Istio <a class="ae kn" href="https://github.com/istio/istio" rel="noopener ugc nofollow" target="_blank">回购</a></li></ol><pre class="ly lz ma mb fq my mz na nb aw nc dt"><span id="0344" class="mk kv hu mz b fv nd ne l nf ng">kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml</span><span id="7944" class="mk kv hu mz b fv nh ne l nf ng">helm install install/kubernetes/helm/istio -name istio -namespace istio-system</span></pre><blockquote class="mc md me"><p id="d688" class="jg jh mf ji b jj jk jl jm jn jo jp jq mg js jt ju mh jw jx jy mi ka kb kc kd hn dt translated">注意:我使用的是Helm版本2.9.1，Kubernetes集群位于GKE。你可以在这里找到其他环境<a class="ae kn" href="https://istio.io/docs/setup/kubernetes/" rel="noopener ugc nofollow" target="_blank">的安装说明。</a></p></blockquote><h1 id="d0c6" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">部署服务</h1><p id="dd65" class="pw-post-body-paragraph jg jh hu ji b jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd hn dt translated">当我们只处理Envoy时，我们必须手动将请求路由到侧车。这一次我们不会那样做，我们会让伊斯蒂奥变魔术。服务的源代码可以在<a class="ae kn" href="https://github.com/dnivra26/istio_101" rel="noopener ugc nofollow" target="_blank">这里</a>找到。没什么特别的，只是一个服务调用了几个其他服务。每个服务也没有特使配置，Istio将负责侧车配置。服务A在调用服务B和服务C时，分别使用Kubernetes服务名“serviceb.serviceb”和“servicec.servicec”</p><figure class="ly lz ma mb fq iv"><div class="bz el l di"><div class="ni nj l"/></div></figure><p id="48ed" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们正在为我们的服务创建Kubernetes名称空间，我们正在为每个名称空间添加一个特殊的标签，稍后我们将讨论为什么有必要这样做。我们使用helm管理我们的应用程序，您可以在“helm”目录下的同一个<a class="ae kn" href="https://github.com/dnivra26/istio_101" rel="noopener ugc nofollow" target="_blank">存储库</a>中找到应用程序的helm图表。如果一切顺利，你的吊舱应该已经启动并运行了</p><figure class="ly lz ma mb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nk"><img src="../Images/042a9b1a793ca69a8e15ec5dc8048e14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U4S7qywEd4rxqDVheYb5rg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">service pods running</figcaption></figure><p id="cf06" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果您仔细观察，会发现每个服务都有两个容器(在每个pod中)在运行，但是在我们的helm chart定义中，我们只定义了一个容器。发生这种情况是因为Istio监视所有的部署，并将侧车容器添加到我们的pod中。这是通过利用所谓的<a class="ae kn" href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" rel="noopener ugc nofollow" target="_blank"> <strong class="ji hv">突变adminssionweb hooks</strong></a>来实现的，这个特性是在Kubernetes 1.9中引入的。因此，在创建资源之前，web钩子拦截请求，检查是否为该名称空间启用了“Istio injection ”,然后将side car容器添加到pod。这就是Istio如何解决为我们的每个服务手动添加侧车代理的问题。</p><blockquote class="mc md me"><p id="8fe3" class="jg jh mf ji b jj jk jl jm jn jo jp jq mg js jt ju mh jw jx jy mi ka kb kc kd hn dt translated">注意:名称空间标签并不是添加side car的唯一方式，您甚至可以使用“istioctl”命令行工具来生成规范并进行部署</p></blockquote><p id="c955" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">接下来，我们创建一个入口规则，将流量路由到服务a。</p><figure class="ly lz ma mb fq iv"><div class="bz el l di"><div class="ni nj l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Istio Gateway Configuration</figcaption></figure><p id="7d19" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">网关</strong>和<strong class="ji hv">虚拟服务</strong>是我们安装Istio时创建的Kubernets CRDs(自定义资源定义)。我们将在下一篇文章中看到更多关于这些的内容，现在只需要理解我们要求所有的请求都被路由到服务a。</p><p id="334c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">让我们点击网关的公共ip来产生一些流量。</p><p id="d8b6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您可以通过以下方式找到网关的外部ip</p><pre class="ly lz ma mb fq my mz na nb aw nc dt"><span id="3a21" class="mk kv hu mz b fv nd ne l nf ng">kubectl get services istio-ingressgateway -n istio-system</span></pre><p id="b3e4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们可以使用任何负载测试工具来产生一些流量，我正在使用<a class="ae kn" href="https://github.com/rakyll/hey" rel="noopener ugc nofollow" target="_blank">嘿</a></p><pre class="ly lz ma mb fq my mz na nb aw nc dt"><span id="4ec3" class="mk kv hu mz b fv nd ne l nf ng">hey -z 30s <a class="ae kn" href="http://x.x.x.x" rel="noopener ugc nofollow" target="_blank">http://x.x.x.x</a></span></pre><p id="9f39" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">Istio自带工具来监控服务网格中正在发生的事情，让我们看看Kiali和Grafana。</p><blockquote class="mc md me"><p id="0608" class="jg jh mf ji b jj jk jl jm jn jo jp jq mg js jt ju mh jw jx jy mi ka kb kc kd hn dt translated">注:当我们用Helm安装Istio时，Grafana，Prometheus，Zipkin，Kiali等工具..会自动安装。您可以通过修改值<a class="ae kn" href="https://github.com/istio/istio/blob/master/install/kubernetes/helm/istio/values.yaml" rel="noopener ugc nofollow" target="_blank">文件</a>来控制安装的内容及其配置。</p></blockquote><h2 id="1972" class="mk kv hu bd kw ml mm mn la mo mp mq le jr mr ms li jv mt mu lm jz mv mw lq mx dt translated">基亚利</h2><pre class="ly lz ma mb fq my mz na nb aw nc dt"><span id="dbd4" class="mk kv hu mz b fv nd ne l nf ng">kubectl port-forward service/kiali -n istio-system 20001:20001</span></pre><figure class="ly lz ma mb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nl"><img src="../Images/b57227e2282e4cd379f64fefa9c07844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IEUFQ01U2wwUgEJUKPAEjA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Kiali service mesh visualisation</figcaption></figure><h2 id="0632" class="mk kv hu bd kw ml mm mn la mo mp mq le jr mr ms li jv mt mu lm jz mv mw lq mx dt translated">格拉夫纳</h2><pre class="ly lz ma mb fq my mz na nb aw nc dt"><span id="4aaa" class="mk kv hu mz b fv nd ne l nf ng">kubectl port-forward service/grafana -n istio-system 3000:3000</span></pre><figure class="ly lz ma mb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nm"><img src="../Images/1aade42e9c80c81a873f86b5b60b3c00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L5i1dab5QVUPL1ca79MRlw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Grafana metrics</figcaption></figure><p id="d5fa" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如您所见，我们的服务与Istio设置相结合，并且我们有所有的指标和可视化。但是需要注意的是<strong class="ji hv">我们没有手动将流量路由到侧车代理，它是自动发生的</strong>。Istio首先使用IP表规则将传入和传出流量路由到侧车代理。更多关于规则<a class="ae kn" href="https://github.com/istio/istio/blob/master/tools/deb/istio-iptables.sh" rel="noopener ugc nofollow" target="_blank">的细节在这里</a>。</p><h2 id="fb13" class="mk kv hu bd kw ml mm mn la mo mp mq le jr mr ms li jv mt mu lm jz mv mw lq mx dt translated">配置Istio</h2><p id="3bbb" class="pw-post-body-paragraph jg jh hu ji b jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd hn dt translated">我们看到您不直接用Isito配置侧车代理。那么我们如何配置流量控制规则呢？为此，当您安装Istio时，会创建许多Kubernetes CRDs(自定义资源定义)，例如:<strong class="ji hv"> VirtualService </strong>，<strong class="ji hv"> DestinationRule </strong> …我们在下面看到一个控制流量的配置示例:</p><figure class="ly lz ma mb fq iv"><div class="bz el l di"><div class="ni nj l"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Adding Trafic rules</figcaption></figure><p id="e0c5" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">上面的规则是canary部署的一个例子，将10%的流量路由到新版本的服务。因此，我们将这些规则提交给配置存储，Istio Pilot监视存储并将配置更改推送到适当的侧车代理。</p><h1 id="3a6b" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">结论</h1><p id="95a8" class="pw-post-body-paragraph jg jh hu ji b jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd hn dt translated">使用Istio，服务开发人员几乎不需要修改代码就可以获得服务网格的所有好处。相反，他们可以专注于构建业务功能。事实上，开发人员甚至不知道有一个服务网格设置。</p><p id="5fb6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这篇文章只是想看看迁移到Istio如何解决我们与Envoy之间的一些恼人的问题。这也是我们没有深入研究Istio的原因。Istio要大得多，有更多的东西。在下一篇文章中，我们将探索更多关于Istio的内容。</p><p id="3ae8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">你可以在这里找到所有代码<a class="ae kn" href="https://github.com/dnivra26/istio_101" rel="noopener ugc nofollow" target="_blank">。我做了一个关于这个话题的演讲，你可以在这里找到</a><a class="ae kn" href="https://www.youtube.com/watch?v=TirNIwhr0Tk" rel="noopener ugc nofollow" target="_blank"/></p><div class="nn no fm fo np nq"><a href="https://github.com/dnivra26/istio_101" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab ej"><div class="ns ab nt cl cj nu"><h2 class="bd hv fv z el nv eo ep nw er et ht dt translated">dnivra26/istio_101</h2><div class="nx l"><h3 class="bd b fv z el nv eo ep nw er et ek translated">通过在GitHub上创建帐户，为dnivra26/istio_101开发做出贡献。</h3></div><div class="ny l"><p class="bd b gc z el nv eo ep nw er et ek translated">github.com</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe ja nq"/></div></div></a></div></div></div>    
</body>
</html>