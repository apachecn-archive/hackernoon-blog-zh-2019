<html>
<head>
<title>Auto-Generating Tags for Content using Amazon SageMaker BlazingText with fastText</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Amazon SageMaker BlazingText 和 fastText 为内容自动生成标签</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/auto-generating-tags-for-content-using-amazon-sagemaker-blazingtext-with-fasttext-335c38429de0#2019-06-13">https://medium.com/hackernoon/auto-generating-tags-for-content-using-amazon-sagemaker-blazingtext-with-fasttext-335c38429de0#2019-06-13</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/321398de633f2d8f1dc5f469499be3c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J8E4pQqVPLiDGNkbyOulNw@2x.jpeg"/></div></div></figure><p id="ad21" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">多标签文本分类是自然语言处理应用的基本任务之一。在本文中，我们将构建一个 fastText 模型来预测文本内容的标签，然后在 SageMaker 托管服务上部署该模型。</p><h1 id="de5a" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">亚马逊 SageMaker 笔记本实例</h1><p id="811c" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">我们需要使用 notebook 实例来创建和管理 Jupyter notebook，这样我们就可以准备和处理数据，并训练和部署我们的模型。</p><div class="ld le fm fo lf lg"><a href="https://docs.aws.amazon.com/sagemaker/latest/dg/gs-setup-working-env.html" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab ej"><div class="li ab lj cl cj lk"><h2 class="bd hv fv z el ll eo ep lm er et ht dt translated">步骤 2:创建 Amazon SageMaker 笔记本实例——Amazon sage maker</h2><div class="ln l"><h3 class="bd b fv z el ll eo ep lm er et ek translated">亚马逊 SageMaker 笔记本实例是一个完全托管的机器学习(ML)亚马逊弹性计算云(亚马逊…</h3></div><div class="lo l"><p class="bd b gc z el ll eo ep lm er et ek translated">docs.aws.amazon.com</p></div></div><div class="lp l"><div class="lq l lr ls lt lp lu ja lg"/></div></div></a></div><h1 id="228e" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">资料组</h1><p id="fda3" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">我们将使用堆栈溢出 Q 的 10%数据集。数据集包括:</p><ul class=""><li id="64d7" class="lw lx hu je b jf jg jj jk jn ly jr lz jv ma jz mb mc md me dt translated"><strong class="je hv">问题</strong>包含 Id 为 10 的倍数的所有未删除堆栈溢出问题的标题、正文、创建日期、关闭日期(如果适用)、分数和所有者 ID。</li><li id="229f" class="lw lx hu je b jf mf jj mg jn mh jr mi jv mj jz mb mc md me dt translated"><strong class="je hv">答案</strong>包含这些问题的每个答案的正文、创建日期、分数和所有者 ID。ParentId 列链接回问题表。</li><li id="3db6" class="lw lx hu je b jf mf jj mg jn mh jr mi jv mj jz mb mc md me dt translated"><strong class="je hv">标签</strong>包含每个问题的标签</li></ul><p id="70f1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这个演示中，我们只需要问题和标签来训练我们的模型。</p><h1 id="3404" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">BlazingText 或 fastText</h1><p id="fe5d" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">亚马逊 SageMaker 内置<strong class="je hv"> BlazingText </strong>支持文本分类(监督模式)和 Word2Vec 矢量学习(Skip-gram、CBOW 和 batch_skipgram 模式)。但是 BlazingText 不支持多标签分类(说错了纠正我)。</p><p id="505c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我们的演示中，多个标签可能应用于同一内容，因此，我们将使用 fastText 训练文本分类模型，并使用 BlazingText 托管预训练的模型，而不是使用 BlazingText 直接构建模型。</p><blockquote class="mk ml mm"><p id="c055" class="jc jd mn je b jf jg jh ji jj jk jl jm mo jo jp jq mp js jt ju mq jw jx jy jz hn dt translated"><em class="hu"> fastText 0.2.0 增加了针对多标签分类的“OneVsAll”损失函数，对应的是针对每个标签独立计算的二元交叉熵之和。</em></p></blockquote><p id="108f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下图是整个过程的概述:</p><figure class="ms mt mu mv fq iv fe ff paragraph-image"><div class="fe ff mr"><img src="../Images/dd6dfa532aa7b3ab867c73b4de8580ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*o1fYU9pgg7-UI19eWCoE8w.png"/></div></figure><h1 id="f3b6" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">快速文本和 SageMaker 入门</h1><p id="7920" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">你可以在我的<a class="ae lv" href="https://github.com/yai333/SageMakerMultiLabelTextClassification" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv"> GitHub repo </strong> </a>中找到示例笔记本。</p><h2 id="fcf8" class="mw kb hu bd kc mx my mz kg na nb nc kk jn nd ne ko jr nf ng ks jv nh ni kw nj dt translated">预处理和清理数据</h2><p id="1c43" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">输入文件的格式是每一行都包含一个句子和相应的前缀为“__label__”的标签，即</p><pre class="ms mt mu mv fq nk nl nm nn aw no dt"><span id="1c7f" class="mw kb hu nl b fv np nq l nr ns">__label__database __label__oracle How to edit sessions parameters on Oracle 10g</span></pre><p id="ec79" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的数据集基本上是由 19999 个问题和相关标签组成的<code class="eh nt nu nv nl b">csv</code>文件。为了训练我们的模型，输入数据必须尽可能干净，下面的函数在删除 HTML 标签和不需要的标点符号后生成一个预处理的干净的训练数据。</p><figure class="ms mt mu mv fq iv"><div class="bz el l di"><div class="nw nx l"/></div></figure><h2 id="ac34" class="mw kb hu bd kc mx my mz kg na nb nc kk jn nd ne ko jr nf ng ks jv nh ni kw nj dt translated">安装 FastText</h2><p id="17ae" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">让我们下载<a class="ae lv" href="https://github.com/facebookresearch/fastText/releases" rel="noopener ugc nofollow" target="_blank">最新发布的</a>:</p><pre class="ms mt mu mv fq nk nl nm nn aw no dt"><span id="6893" class="mw kb hu nl b fv np nq l nr ns">!wget <a class="ae lv" href="https://github.com/facebookresearch/fastText/archive/v0.2.0.zip" rel="noopener ugc nofollow" target="_blank">https://github.com/facebookresearch/fastText/archive/v0.2.0.zip</a><br/>!unzip v0.2.0.zip<br/>!cd fastText-0.2.0 &amp;&amp; make</span></pre><h2 id="3fb1" class="mw kb hu bd kc mx my mz kg na nb nc kk jn nd ne ko jr nf ng ks jv nh ni kw nj dt translated">训练模型</h2><p id="6838" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">在演示中，我们将使用 SageMaker 本地模式来训练模型 notebook ml.t2.medium 实例对于文本分类模型训练来说足够强大，因为 fastText 允许在不需要 GPU 的情况下训练模型。</p><p id="abc8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以下命令用于为文本分类训练模型:</p><pre class="ms mt mu mv fq nk nl nm nn aw no dt"><span id="434c" class="mw kb hu nl b fv np nq l nr ns">!cd fastText-0.2.0 &amp;&amp; ./fasttext supervised -input "../stackoverflow.train" -output stackoverflow_model -lr 0.5 -epoch 25 -minCount 5 -wordNgrams 2 -loss ova</span></pre><p id="be59" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在训练结束时，在当前目录中创建一个包含已训练分类器的文件<code class="eh nt nu nv nl b">stackoverflow_model.bin</code>。</p><p id="a466" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们在验证数据上测试它。</p><pre class="ms mt mu mv fq nk nl nm nn aw no dt"><span id="4e85" class="mw kb hu nl b fv np nq l nr ns">!cd fastText-0.2.0 &amp;&amp; ./fasttext test stack_model.bin "../stackoverflow.validation"</span><span id="6ebc" class="mw kb hu nl b fv ny nq l nr ns">N	531<br/>P@1	0.566<br/>R@1	0.215</span></pre><p id="b102" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，fastText 有许多不同的训练输入参数，如果您曾经尝试调整您的模型精度，您会发现更改这些参数会显著改变模型的精度和召回率。欲了解更多详情，请点击这里查看官方文档<a class="ae lv" href="https://fasttext.cc/docs/en/supervised-tutorial.html" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="ddbe" class="mw kb hu bd kc mx my mz kg na nb nc kk jn nd ne ko jr nf ng ks jv nh ni kw nj dt translated">部署模型</h2><p id="9b35" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">SageMaker 可以托管使用 BlazingText 训练的模型或 fastText 提供的预训练模型，用于实时推理。让我们部署我们的模型<code class="eh nt nu nv nl b">stack_model.bin</code>:</p><figure class="ms mt mu mv fq iv"><div class="bz el l di"><div class="nw nx l"/></div></figure><h2 id="dcd5" class="mw kb hu bd kc mx my mz kg na nb nc kk jn nd ne ko jr nf ng ks jv nh ni kw nj dt translated">推理</h2><p id="70a7" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">一旦部署了端点，它就支持<code class="eh nt nu nv nl b">application/json</code>作为推断的内容类型。在传递到端点时，有效负载应该包含一个句子，其关键字为“<strong class="je hv"> instances </strong>”。</p><figure class="ms mt mu mv fq iv"><div class="bz el l di"><div class="nw nx l"/></div></figure><p id="f416" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">正如所料，我们得到了每个句子的概率标签，现在我们可以使用 Amazon API Gateway 调用 SageMaker 模型端点。</p><pre class="ms mt mu mv fq nk nl nm nn aw no dt"><span id="e641" class="mw kb hu nl b fv np nq l nr ns">javascript, 0.8203935623168945 <br/>jquery, 0.7201416492462158 <br/>firefox, 0.01690844297409057</span></pre><p id="5d67" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们可以从 Amazon SageMaker 控制台查看这个端点。默认端点名称类似于“blazing text-2019–06–13–01–41–24–632”。</p><figure class="ms mt mu mv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nz"><img src="../Images/1f019102ab74a067324edc1b8a5a49ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_CPIfkrtolGdW9a8yN0ZRA.jpeg"/></div></div></figure><h1 id="69e1" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">调用 SageMaker 端点</h1><p id="2b9a" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">现在我们有了一个 SageMaker 模型端点。我们从 Lambda 和 API Gateway 来说吧。首先，安装无服务器框架。</p><pre class="ms mt mu mv fq nk nl nm nn aw no dt"><span id="f731" class="mw kb hu nl b fv np nq l nr ns">$<strong class="nl hv"> </strong>sls create --template aws-python3 --path text-classification</span></pre><p id="3fd1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建的目录包括两个文件——handler . py 是 Lambda 函数。</p><p id="5eaa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将以下代码粘贴到您的 serverless.yml 中</p><figure class="ms mt mu mv fq iv"><div class="bz el l di"><div class="nw nx l"/></div></figure><p id="1a42" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您的 handler.py 文件现在应该是这样的:</p><figure class="ms mt mu mv fq iv"><div class="bz el l di"><div class="nw nx l"/></div></figure><h2 id="ca84" class="mw kb hu bd kc mx my mz kg na nb nc kk jn nd ne ko jr nf ng ks jv nh ni kw nj dt translated">部署 API</h2><p id="e5aa" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">要部署 API，请运行以下命令:</p><pre class="ms mt mu mv fq nk nl nm nn aw no dt"><span id="a77e" class="mw kb hu nl b fv np nq l nr ns">$ serverless deploy -v</span></pre><h1 id="ef79" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">测试 API</h1><p id="b3ea" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">我们现在可以使用 CURL 调用无服务器 API 端点:</p><pre class="ms mt mu mv fq nk nl nm nn aw no dt"><span id="04b8" class="mw kb hu nl b fv np nq l nr ns">$ curl -d '{"sentence":"How can I refresh a page with jQuery"}' -H "Content-Type: application/json" -X POST <a class="ae lv" href="https://kcxhl4671i.execute-api.ap-southeast-2.amazonaws.com/dev/tag" rel="noopener ugc nofollow" target="_blank">https://xxxxxx.execute-api.ap-southeast-2.amazonaws.com/dev/tag</a></span></pre><figure class="ms mt mu mv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff oa"><img src="../Images/497a6b70c6ece9c155c4cd1c71033890.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tHbPDSKTDt17ekjDq4Z24w.png"/></div></div></figure></div><div class="ab cl ob oc hc od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="hn ho hp hq hr"><p id="ae75" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">差不多就是这样！希望你觉得这篇文章有用，你可以在我的<a class="ae lv" href="https://github.com/yai333/SageMakerMultiLabelTextClassification" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv"> GitHub repo </strong> </a>中找到完整的项目。</p></div></div>    
</body>
</html>