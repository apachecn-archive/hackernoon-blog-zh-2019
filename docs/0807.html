<html>
<head>
<title>Terraform layout</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">地形布局</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/terraform-layout-be3674dfe657?source=collection_archive---------4-----------------------#2019-02-02">https://medium.com/hackernoon/terraform-layout-be3674dfe657?source=collection_archive---------4-----------------------#2019-02-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="8c05" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">从基本布局到多环境定义</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff jj"><img src="../Images/dad232839be81fd0e924f3011e27d136.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/1*xW5fuNX8jz0y1Wm1tQbjlg.png"/></div></figure><p id="0974" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">Terraform是描述我们的基础设施的强大工具，但有时小型基础设施到大型基础设施之间的变化可能很难管理，因为大型基础设施包含多个环境、大量元素以及针对每个元素的小型定制。让我们一步一步地回顾一下当您的基础架构开始增长时的演变。</p></div><div class="ab cl kn ko hc kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hn ho hp hq hr"><h1 id="e545" class="ku kv hu bd kw kx ky kz la lb lc ld le ja lf jb lg jd lh je li jg lj jh lk ll dt translated">TL；速度三角形定位法(dead reckoning)</h1><p id="97d9" class="pw-post-body-paragraph jr js hu jt b ju lm iv jw jx ln iy jz ka lo kc kd ke lp kg kh ki lq kk kl km hn dt translated"><strong class="jt hv">(剧透！！)最终布局:</strong></p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="b691" class="lw kv hu ls b fv lx ly l lz ma">├── Readme.md<br/>|   <br/>├── environments/<br/>|   |<br/>|   ├── development/<br/>|   |   ├── provider.tf<br/>|   |   ├── development.auto.tfvars<br/>|   |   ├── development.backend.tfvars<br/>|   |<br/>|   ├── production/<br/>|   |   ├── provider.tf<br/>|   |   ├── production.auto.tfvars<br/>|   |   ├── production.backend.tfvars<br/>|   |<br/>|   ├── staging/<br/>|   |   ├── provider.tf<br/>|   |   ├── staging.auto.tfvars<br/>|   |   ├── staging.backend.tfvars<br/>|   |<br/>├── manifests/<br/>|   ├── backend.tf<br/>|   ├── back_office.tf<br/>|   ├── common_network.tf<br/>|   ├── dbs.tf<br/>|   ├── frontend.tf<br/>|   ├── output.tf<br/>|   ├── persistent_data.tf<br/>|   ├── provider.tf<br/>|   ├── security.tf<br/>|   ├── modules/<br/>|   |   ├── module1/<br/>|   |   ├── module2/<br/>|   |   ├── ...<br/>|</span></pre><p id="14c0" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated"><strong class="jt hv">使用方法:</strong></p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="fd99" class="lw kv hu ls b fv lx ly l lz ma">$ cd environments\&lt;env&gt;</span><span id="fded" class="lw kv hu ls b fv mb ly l lz ma">$ terraform init \<br/>      -backend-config<!-- -->=&lt;env&gt;.backend.tfvars \<br/>      ../../manifests</span><span id="eba0" class="lw kv hu ls b fv mb ly l lz ma">$ terraform plan <!-- -->\<br/>      -out=<!-- -->tfplan \<br/>      <!-- -->-var-file=<!-- -->&lt;env&gt;.tfvars <!-- -->\<br/>      ../../manifests</span><span id="759c" class="lw kv hu ls b fv mb ly l lz ma">$ terraform apply \<br/>      <!-- -->-var-file=<!-- -->&lt;env&gt;.tfvars <!-- -->\<br/>      ../../manifests <!-- -->\<br/>      <!-- -->tfplan</span><span id="175d" class="lw kv hu ls b fv mb ly l lz ma">$ terraform output</span></pre></div><div class="ab cl kn ko hc kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hn ho hp hq hr"><h1 id="c095" class="ku kv hu bd kw kx ky kz la lb lc ld le ja lf jb lg jd lh je li jg lj jh lk ll dt translated">婴儿计划</h1><p id="1426" class="pw-post-body-paragraph jr js hu jt b ju lm iv jw jx ln iy jz ka lo kc kd ke lp kg kh ki lq kk kl km hn dt translated">当一个Terraform项目诞生时，它就像一个婴儿:小，纯洁，没有坏习惯。你想向所有人展示:</p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="c3f8" class="lw kv hu ls b fv lx ly l lz ma">├── Readme.md<br/>├── main.tf<br/>├── output.tf<br/>├── variables.tf<br/>├── terraform.tfstate</span></pre><p id="9678" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">你需要管理它的命令很小很好(吃，睡，便便，等等。):</p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="5c59" class="lw kv hu ls b fv lx ly l lz ma">$ terraform init</span><span id="edad" class="lw kv hu ls b fv mb ly l lz ma">$ terraform plan <!-- -->\<br/>      -out=<!-- -->tfplan</span><span id="96c6" class="lw kv hu ls b fv mb ly l lz ma">$ terraform apply tfplan</span></pre><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="fe ff mc"><img src="../Images/424945796ef4ce4b043f42ff4396d2ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1yScK70GDSv2v_uu"/></div></div><figcaption class="mh mi fg fe ff mj mk bd b be z ek">Photo by <a class="ae ml" href="https://unsplash.com/@invent?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Colin Maynard</a> on <a class="ae ml" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f818" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">但是所有的婴儿都在成长，你的项目也是如此。它开始变得更加复杂，没有什么是你不能管理的，当然，你已经为此做好了准备，你已经阅读了它，你能够改进它:你划分了创建一些<a class="ae ml" href="https://blog.gruntwork.io/how-to-create-reusable-infrastructure-with-terraform-modules-25526d65f73d" rel="noopener ugc nofollow" target="_blank">模块</a>(有一天我们会谈到它们)的责任，你从主文件中分离出一些组件，你(仍然)为此感到自豪。</p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="5d2b" class="lw kv hu ls b fv lx ly l lz ma">├── Readme.md<br/><strong class="ls hv">├── backend.tf</strong><br/>├── main.tf<br/>├── output.tf<br/><strong class="ls hv">├── provider.tf</strong><br/>├── variables.tf<br/>|<br/><strong class="ls hv">├── modules/<br/>|   ├── module1/<br/>|   ├── module2/<br/>|   ├── ...</strong></span></pre><h1 id="8c82" class="ku kv hu bd kw kx mm kz la lb mn ld le ja mo jb lg jd mp je li jg mq jh lk ll dt translated">婴儿长大了</h1><p id="7508" class="pw-post-body-paragraph jr js hu jt b ju lm iv jw jx ln iy jz ka lo kc kd ke lp kg kh ki lq kk kl km hn dt translated">有那么一个瞬间，你不知道怎么但是萌娃项目变成了一个不可收拾的丑陋少年项目，你需要去处理。<br/>你不知道有些环境在做什么:发育中的她在吸毒吗？他在staging学习还是聚会？你仍然爱它，但是你不像过去那样为它骄傲了…</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="fe ff mr"><img src="../Images/6b234d3edc4b384e3c56427b9e8d59db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Esbi9JRJMriSuSWZ"/></div></div><figcaption class="mh mi fg fe ff mj mk bd b be z ek">Photo by <a class="ae ml" href="https://unsplash.com/@parkergibbons?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Parker Gibbons</a> on <a class="ae ml" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="fe43" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">你需要处理它。而你处理。<br/>你知道这不是一个好的解决方案，但是你<em class="ms">需要</em>去做，所以<a class="ae ml" href="https://craftsmanshipforsoftware.com/2015/05/25/the-cost-of-duplicated-code/" rel="noopener ugc nofollow" target="_blank">你开始在环境之间复制代码</a>。你在不同的环境之间复制你的代码(你知道这不是最好的解决方案，但至少你尽力做到最好)，并且你添加一些<a class="ae ml" href="https://learn.hashicorp.com/terraform/getting-started/variables.html" rel="noopener ugc nofollow" target="_blank">变量定义来配置不同的环境</a>。</p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="e771" class="lw kv hu ls b fv lx ly l lz ma">├── Readme.md<br/>|<br/><strong class="ls hv">├── development/</strong><br/>|   ├── backend.tf<br/>|   ├── main.tf<br/>|   ├── output.tf<br/>|   ├── provider.tf<br/>|   ├── variables.tf<br/>|   ├── <strong class="ls hv">development.tfvars</strong><br/>|   |<br/>|   ├── modules/<br/>|   |   ├── module1/<br/>|   |   ├── module2/<br/>|   |   ├── ...<br/>|<br/><strong class="ls hv">├── production/</strong><br/>|   ├── backend.tf<br/>|   ├── main.tf<br/>|   ├── output.tf<br/>|   ├── provider.tf<br/>|   ├── variables.tf<br/>|   ├── <strong class="ls hv">production.tfvars</strong><br/>|   |<br/>|   ├── modules/<br/>|   |   ├── module1/<br/>|   |   ├── module2/<br/>|   |   ├── ...<br/>|<br/><strong class="ls hv">├── staging/</strong><br/>|   ├── backend.tf<br/>|   ├── main.tf<br/>|   ├── output.tf<br/>|   ├── provider.tf<br/>|   ├── variables.tf<br/>|   ├── <strong class="ls hv">staging.tfvars</strong><br/>|   |<br/>|   ├── modules/<!-- -->ssh-rsa <br/>|   |   ├── module1/<br/>|   |   ├── module2/<br/>|   |   ├── ...<br/>|<br/>├── test/<br/>|   ├── backend.tf<br/>|   ├── main.tf<br/>|   ├── output.tf<br/>|   ├── provider.tf<br/>|   ├── variables.tf<br/>|   ├── <strong class="ls hv">test.tfvars</strong><br/>|   |<br/>|   ├── modules<br/>|   |   ├── module1/<br/>|   |   ├── module2/<br/>|   |   ├── ...</span></pre><p id="77c0" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">这并不都是坏事，管理方式有所改变，但仍然很容易和很好地执行。不是什么都需要成为问题！</p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="2825" class="lw kv hu ls b fv lx ly l lz ma">$ <strong class="ls hv">cd &lt;env&gt;</strong></span><span id="0987" class="lw kv hu ls b fv mb ly l lz ma">$ terraform init</span><span id="b7f8" class="lw kv hu ls b fv mb ly l lz ma">$ terraform plan \<br/>      <!-- -->-out=<!-- -->tfplan \<br/>      <strong class="ls hv">-var-file=</strong><strong class="ls hv">&lt;env&gt;.tfvars</strong></span><span id="0058" class="lw kv hu ls b fv mb ly l lz ma">$ terraform apply \<br/>      <strong class="ls hv">-var-file=</strong><strong class="ls hv">&lt;env&gt;.tfvars</strong> \<br/>      tfplan</span><span id="0500" class="lw kv hu ls b fv mb ly l lz ma">$ terraform outputcommon_network</span></pre><p id="8785" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">但是，有那么一刻，你知道有些事情不太顺利。<br/>当你在staging里改东西的时候，你需要复制到测试、制作、开发……这不是一个搞笑的工作，某天某个人(也许是午饭后的某个星期五？)完全忘记了在环境之间传播一些变化。而这就是<strong class="jt hv">乱</strong>。你需要解决它，你想保留它，你开始搜索它。</p><p id="e1db" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">你会发现很多提议，比如<a class="ae ml" rel="noopener" href="/hdeblog/terraform-sane-practices-project-structure-c4347c1bc0f1">这个基本款</a>，或者<a class="ae ml" href="https://surminus.github.io/post/terraform-structures-and-layouts/" rel="noopener ugc nofollow" target="_blank">这个其他款</a>，甚至<a class="ae ml" href="http://2ndwatch.com/blog/how-we-organize-terraform-code-at-2nd-watch/" rel="noopener ugc nofollow" target="_blank">这个</a>。如果你搜索的时间足够长，你会被指向Terragrunt。</p><p id="15c5" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">现在，让我谈谈我们的需求以及我们在“重新布局”中搜索的内容。</p><h1 id="d2e1" class="ku kv hu bd kw kx mm kz la lb mn ld le ja mo jb lg jd mp je li jg mq jh lk ll dt translated">我们的要求</h1><ul class=""><li id="b209" class="mt mu hu jt b ju lm jx ln ka mv ke mw ki mx km my mz na nb dt translated">我们需要可以在不同环境间重用的东西。我们的具体情况是，所描述的基础设施除了最小的变化(实例名和其他一些东西)之外，完全相同。</li><li id="bd8e" class="mt mu hu jt b ju nc jx nd ka ne ke nf ki ng km my mz na nb dt translated">我们搜索一些容易阅读的东西。我们已经放弃使用Terragrunt或Terraform <a class="ae ml" href="https://www.terraform.io/docs/state/workspaces.html" rel="noopener ugc nofollow" target="_blank">工作空间</a>，因为增加了我们试图避免的复杂性。</li><li id="eb49" class="mt mu hu jt b ju nc jx nd ka ne ke nf ki ng km my mz na nb dt translated">我们需要一些快速的东西来实现。将所有当前的基础设施重新配置为模块会增加额外的时间，而我们没有这些时间。(可能改天再聊)。</li><li id="1f6e" class="mt mu hu jt b ju nc jx nd ka ne ke nf ki ng km my mz na nb dt translated">我们想要容易维护的东西。我们面临的问题是在多个环境中手工重复相同的更改，在每个环境中更新相同的文件，我们正在努力避免这种情况。</li><li id="2995" class="mt mu hu jt b ju nc jx nd ka ne ke nf ki ng km my mz na nb dt translated">我们渴望一些容易升级的东西。我们确信这种基础设施将会有很大的发展，因此有必要在未来设计it思维。</li><li id="a499" class="mt mu hu jt b ju nc jx nd ka ne ke nf ki ng km my mz na nb dt translated">我们渴望一个容易理解的代码。我们知道，不同的团队会使用这些代码，他们对Terraform和基础设施本身有不同的了解，所以我们在决定解决方案时考虑到了他们。</li><li id="0df6" class="mt mu hu jt b ju nc jx nd ka ne ke nf ki ng km my mz na nb dt translated">我们想要一个尽可能安全的项目。我们经历过这样的情况:由于人为错误，有人在错误的环境中修改了基础架构。这是一个绝对的混乱(和几个小时的痛苦和眼泪)，我们不想重复。</li></ul><p id="0c08" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">考虑到所有这些因素，当我们的“青少年项目”变成成人项目时，我们到达了这个奇怪的点。</p><h1 id="1bcc" class="ku kv hu bd kw kx mm kz la lb mn ld le ja mo jb lg jd mp je li jg mq jh lk ll dt translated">成人项目</h1><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="fe ff nh"><img src="../Images/69fb85d54d8644c2139c276c51c08f8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JC9iHbYUGwBRsupn"/></div></div><figcaption class="mh mi fg fe ff mj mk bd b be z ek">Photo by <a class="ae ml" href="https://unsplash.com/@hengfilms?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Heng Films</a> on <a class="ae ml" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0706" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">记住下面描述的所有要点，我们完成了代码重构。在这一点上，基础设施本身没有任何变化。同样，唯一改变的是布局、文件组织和变量声明。</p><p id="aad2" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">首先，我们将所有清单移动到一个名为<em class="ms"> (uah！一个原创的名字！)</em>载货单。使用这种方法，我们只需要编写一次更改，而不是为每个环境编写一次。</p><p id="0bbf" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">为了配置不同的环境，我们为每个环境声明了一个后端(用于远程tfstate)和一个变量文件。为了避免错误地进入不需要的文件夹，我们决定用当前环境的名称来命名所有的后端和变量文件(<env> .auto.tfvars和<env> .backend.tfvars)。</env></env></p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="9760" class="lw kv hu ls b fv lx ly l lz ma">├── Readme.md<br/>|   <br/>├── <strong class="ls hv">environments/</strong><br/>|   |<br/>|   ├── development/<br/>|   |   ├── development.auto.tfvars<br/>|   |   ├── <strong class="ls hv">development.backend.tfvars</strong><br/>|   |<br/>|   ├── production/<br/>|   |   ├── production.auto.tfvars<br/>|   |   ├── <strong class="ls hv">production.backend.tfvars</strong><br/>|   |<br/>|   ├── staging/<br/>|   |   ├── staging.auto.tfvars<br/>|   |   ├── <strong class="ls hv">staging.backend.tfvars</strong><br/>|   |<br/>├── <strong class="ls hv">manifests/</strong><br/>|   ├── backend.tf<br/>|   ├── main.tf<br/>|   ├── output.tf<br/>|   ├── provider.tf<br/>|   ├── variables.tf<br/>|   ├── modules/<br/>|   |   ├── module1/<br/>|   |   ├── module2/<br/>|   |   ├── ...<br/>|</span></pre><p id="42da" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">对于这种布局，管理它的方式有点不同。我们需要访问所需的环境，并将manifests文件夹引用为plan/init文件夹(这一小小的区别大大简化了我们的生活)。</p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="b8ff" class="lw kv hu ls b fv lx ly l lz ma">$ <strong class="ls hv">cd environments\&lt;env&gt;</strong></span><span id="c509" class="lw kv hu ls b fv mb ly l lz ma">$ terraform init <strong class="ls hv">\</strong><br/>      <strong class="ls hv">-backend-config</strong><strong class="ls hv">=&lt;env&gt;.backend.tfvars \<br/>      ../../manifests</strong></span><span id="38c7" class="lw kv hu ls b fv mb ly l lz ma">$ terraform plan <!-- -->\<br/>      -out=<!-- -->tfplan \<br/>      <strong class="ls hv">-var-file=</strong><strong class="ls hv">&lt;env&gt;.tfvars </strong><strong class="ls hv">\<br/></strong><strong class="ls hv">      ../../manifests</strong></span><span id="03ec" class="lw kv hu ls b fv mb ly l lz ma">$ terraform apply \<br/>      <strong class="ls hv">-var-file=</strong><strong class="ls hv">&lt;env&gt;.tfvars </strong><strong class="ls hv">\<br/></strong><strong class="ls hv">      ../../manifests </strong><strong class="ls hv">\<br/>      </strong>tfplan</span></pre><p id="5247" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">使用这种方法，布局简单，易于维护，一目了然。我们达到了预期的状态，我们能够比以前更顺利地工作。</p><p id="8ee3" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">此时，我们对清单进行了“一点”重新配置。现在，将它们都放在一个文件夹中，并在不同环境之间共享，我们就能够在所有环境中快速地更改和测试它们。</p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="c1c3" class="lw kv hu ls b fv lx ly l lz ma">├── <strong class="ls hv">manifests/</strong><br/>|   ├── backend.tf<br/>|   ├── <strong class="ls hv">backoffice.tf<br/></strong>|   ├── <strong class="ls hv">database.tf</strong><br/>|   ├── <strong class="ls hv">frontend.tf</strong><br/>|   ├── output.tf<br/>|   ├── <strong class="ls hv">persistent_storage.tf</strong><br/>|   ├── provider.tf<br/>|   ├── <strong class="ls hv">security.tf</strong><br/>|   ├── modules/<br/>|   |   ├── module1/<br/>|   |   ├── module2/<br/>|   |   ├── ...<br/>|</span></pre><p id="426c" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我们从最初的范型<em class="ms"> main.tf </em>、<em class="ms"> output.tf </em>和<em class="ms"> vars.tf </em>改成了基于“函数”的一组文件。如果我们需要改变前端基础设施，我们将转到<strong class="jt hv"> </strong>前端<em class="ms">。tf </em>文件。通过这种方法，我们获得了两件事:</p><ul class=""><li id="e22e" class="mt mu hu jt b ju jv jx jy ka ni ke nj ki nk km my mz na nb dt translated">速度检测变化:如果代码的任何部分发生变化，我们将看到它应用于架构的哪个元素，只需查看文件名。</li><li id="01f8" class="mt mu hu jt b ju nc jx nd ka ne ke nf ki ng km my mz na nb dt translated">独立性:如果我们需要删除基础架构的某些部分，我们只需要删除一个文件。或者如果我们需要添加一些我们不需要接触的500行文件，只需创建一个新的。</li></ul><p id="0acb" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated"><strong class="jt hv">地形输出(我们不引以为豪的部分)</strong></p><p id="a2ae" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">使用这种方法“我们只面临一个问题”，<code class="eh nl nm nn ls b">terraform output</code>不起作用，因为在&lt; env &gt;文件夹中没有定义提供者。解决这个问题的快速方法是在每个环境中都有一个provider.tf，作为manifests文件夹中的provider . TF的副本，具有相同的内容:</p><pre class="jk jl jm jn fq lr ls lt lu aw lv dt"><span id="c8ae" class="lw kv hu ls b fv lx ly l lz ma">provider "PROVIDER_NAME" { }</span></pre><p id="d302" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">当然，也可以通过<env> .auto.tfvars文件进行配置。</env></p></div><div class="ab cl kn ko hc kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hn ho hp hq hr"><h1 id="9da3" class="ku kv hu bd kw kx ky kz la lb lc ld le ja lf jb lg jd lh je li jg lj jh lk ll dt translated"><strong class="ak">接下来的步骤</strong></h1><p id="2905" class="pw-post-body-paragraph jr js hu jt b ju lm iv jw jx ln iy jz ka lo kc kd ke lp kg kh ki lq kk kl km hn dt translated"><strong class="jt hv">模块<br/> </strong>如果我们有使它更可重用的需求(也许在项目之间)，我们将重新配置，把基础设施定义为不同的模块。到目前为止，我们只有针对更低级元素的模块。</p><p id="6e28" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated"><strong class="jt hv">版本控制</strong> <br/>也许我们会面临这样的问题，如果我们需要在特定的环境中改变基础架构的某些部分，我们将需要开始添加条件定义(<em class="ms">嗯……太难看了……</em>)。但是当我们同意这个问题不会影响我们的时候(我们需要环境中完全相同的基础设施，并且可以通过变量进行改变)。这可以通过在git中标记基础设施版本或添加“有条件的”基础设施来解决，或者…当我们需要它时，我们会解决它；)</p><h1 id="0466" class="ku kv hu bd kw kx mm kz la lb mn ld le ja mo jb lg jd mp je li jg mq jh lk ll dt translated">结论</h1><p id="6886" class="pw-post-body-paragraph jr js hu jt b ju lm iv jw jx ln iy jz ka lo kc kd ke lp kg kh ki lq kk kl km hn dt translated">项目不断变化，开始时规模很小，有时会增长很多。或者不是。<br/>出于这个原因，重要的是<strong class="jt hv">停下来想一想我们在代码中需要什么</strong>。描述我们的需求以及我们为什么要重构。</p><blockquote class="no np nq"><p id="121f" class="jr js ms jt b ju jv iv jw jx jy iy jz nr kb kc kd ns kf kg kh nt kj kk kl km hn dt translated">不要试图一步到位达到最佳方案，从有用的东西开始，一步一步完善。</p></blockquote><p id="1e0d" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">所有的项目都是不同的，要理解一个项目为什么会是现在这个样子，有必要了解它的背景和“发展历史”，不要试图过度保护一个项目，在一些你可能永远不会尝试的事情上花费时间和精力。</p><p id="e602" class="pw-post-body-paragraph jr js hu jt b ju jv iv jw jx jy iy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">并非所有的项目都需要相同的解决方案或相同的方法，所以停下来想想为什么要重构代码。</p></div></div>    
</body>
</html>