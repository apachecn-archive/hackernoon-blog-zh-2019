<html>
<head>
<title>DIY — Build Your Own Decentralized Thermostat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DIY——建造你自己的分散式恒温器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/diy-build-your-own-decentralized-thermostat-7acb6a2833d4#2019-05-27">https://medium.com/hackernoon/diy-build-your-own-decentralized-thermostat-7acb6a2833d4#2019-05-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="a69d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这篇博文中，我们将探索如何构建一个“分散式”恒温器，在这个过程中，我们将探索分散式物联网的概念。</p><p id="052e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从最基本的定义来看，分散式物联网是指不依赖集中式云服务或中间人进行通信的物联网。</p><p id="4d27" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在过去的几年里，人们一直致力于构建完全去中心化的 P2P 消息网络。分散式消息网络包括<a class="ae jp" href="https://github.com/ethereum/go-ethereum/wiki/Whisper-Overview" rel="noopener ugc nofollow" target="_blank">耳语</a>、<a class="ae jp" href="https://swarm-guide.readthedocs.io/en/latest/pss.html" rel="noopener ugc nofollow" target="_blank">蜂群 PSS </a>和<a class="ae jp" href="https://bitmessage.org/wiki/Main_Page" rel="noopener ugc nofollow" target="_blank">比特消息</a>。</p><p id="eb7f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦分散式消息传递网络发展成熟，变得可扩展和可靠，与集中式设备相比，它可以提供许多好处，包括:</p><ul class=""><li id="e358" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">它没有服务器。你不必设置服务器或其他媒介来与你的设备通信。</li><li id="93e1" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><strong class="it hv">您可以持续访问您的设备。由于你依赖的是 P2P 网络而不是服务器(单点故障)，你的正常运行时间明显更长，而且没有维护服务器的开销。</strong></li><li id="1b7f" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><strong class="it hv">您的通信可以是完全隐私的，包括元数据。</strong>许多分散的消息网络，如 Whisper，使用暗路由和加密来支持私人通信，没有可靠的方法让外人跟踪元数据。</li></ul><p id="1ebf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，所有去中心化的消息传递网络都还非常不成熟，仍然缺少一些使它们可靠和可伸缩的核心特性(例如，激励层)。但是，嘿，我们是黑客，如果我们不参与实验技术，谁会呢？</p><p id="1757" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">事不宜迟，让我们继续构建高度实验性的分散式恒温器。</p></div><div class="ab cl ke kf hc kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hn ho hp hq hr"><p id="4d51" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">严格地说，分散式恒温器已经存在了相当一段时间。这是一个经典的例子:</p><figure class="km kn ko kp fq kq fe ff paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="fe ff kl"><img src="../Images/d4a35127ee56f4a33e70e62cec2506cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_o4hrcgeusR0ZXqaBv_GMA.jpeg"/></div></div><figcaption class="kx ky fg fe ff kz la bd b be z ek">A classic “decentralized” thermostat</figcaption></figure><p id="25d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上述恒温器在任何意义上都是分散的。它不依赖任何集中式云服务或中间人，与它的通信是私密的，包括任何元数据(除非你不信任你的家庭)。</p><p id="a5a8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是，在这篇博文中，我们更感兴趣的是构建一个<em class="lb">智能</em>分散式恒温器。至少，我们希望能够通过手机远程控制它。下面是我们想要提供的功能的粗略草图:</p><figure class="km kn ko kp fq kq fe ff paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="fe ff lc"><img src="../Images/eab6e287a47c952bb1929b249c0d7013.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HQvqoMJ7rq-qaPgp0GE-Zg.png"/></div></div><figcaption class="kx ky fg fe ff kz la bd b be z ek">A mockup interface for the functionality/data we want to expose to the phone from the thermostat.</figcaption></figure><p id="664d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以上是我们想要建立的功能非常基本的样机。具体来说，我们希望能够做到以下几点:</p><ol class=""><li id="f6bc" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo ld jw jx jy dt translated">设置目标温度。</li><li id="d177" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ld jw jx jy dt translated">显示目标温度和实际温度。</li></ol><p id="ef1a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在将探索恒温器和电话之间使用分散技术的通信层的两种可能的实现。我们讨论的焦点将只集中在通信层，而不是硬件的内部。</p><h2 id="4914" class="le lf hu bd lg lh li lj lk ll lm ln lo jc lp lq lr jg ls lt lu jk lv lw lx ly dt translated">实施#1:耳语</h2><p id="6b73" class="pw-post-body-paragraph ir is hu it b iu lz iw ix iy ma ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">Whisper 是以太坊的分散消息协议，如果你熟悉以太坊，它与<code class="eh me mf mg mh b">geth</code>捆绑在一起。通常，您必须在您的硬件上设置一个 Whisper 节点，对其进行调整，使其不会消耗过多的硬件资源，为通信生成密钥，优雅地处理任何崩溃，设置启动时自动启动，等等。</p><p id="fba5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">或者，你可以使用<a class="ae jp" href="https://elk.cc?ref=d-ther-1" rel="noopener ugc nofollow" target="_blank">麋鹿</a>。Elk 是一个硬件开发板，用于构建分散的和区块链连接的设备，它为开箱即用的 Whisper 提供支持。它处理密钥管理和生成，并提供类似 Arduino 的 SDK，而无需在嵌入式设备上设置 Whisper 节点。</p><figure class="km kn ko kp fq kq fe ff paragraph-image"><div class="fe ff mi"><img src="../Images/2f2da3a5ef0d1c37f14eb793fd1c52bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/format:webp/1*6DdR9IrQ2PTV1x95ui0nww.png"/></div><figcaption class="kx ky fg fe ff kz la bd b be z ek">Elk: A hardware development board for building decentralized and blockchain-connected devices.</figcaption></figure><p id="084a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是我们用 raw Whisper 和 Elk 的 SDK 编写的恒温器代码(也被称为<a class="ae jp" href="https://www.arduino.cc/en/Tutorial/Sketch" rel="noopener ugc nofollow" target="_blank">草图</a>)的概要。如果你不熟悉 Arduino 编码方式，你可以在这里<a class="ae jp" href="https://www.arduino.cc/en/Tutorial/Sketch" rel="noopener ugc nofollow" target="_blank">了解更多。</a></p><pre class="km kn ko kp fq mj mh mk ml aw mm dt"><span id="cfdf" class="le lf hu mh b fv mn mo l mp mq">/* Initial target temperature (in Celsius) */<br/>unsigned int targetTemperature = 23;</span><span id="2ea7" class="le lf hu mh b fv mr mo l mp mq">// 1. Setting a topic<br/>String TOPIC = "0x11223344";</span><span id="7e0f" class="le lf hu mh b fv mr mo l mp mq">void setup() {<br/>  // 2. Listening to incoming Whisper messages.<br/>  Whisper.subscribe(TOPIC, &amp;handleMessage);<br/>}</span><span id="19c6" class="le lf hu mh b fv mr mo l mp mq">void loop() {<br/>  // logic related to running the thermostat goes here<br/>}</span><span id="80af" class="le lf hu mh b fv mr mo l mp mq">void handleMessage(WhisperMessage message) {<br/>  // 3. Handling incoming whisper messages.</span><span id="d595" class="le lf hu mh b fv mr mo l mp mq">  if (message.payload == "increaseTemperature") {<br/>    targetTemperature += 1;<br/>    setTemperature(targetTemperature);</span><span id="6205" class="le lf hu mh b fv mr mo l mp mq">    // Send acknowledgement that message is received.<br/>    Whisper.send(message.from, TOPIC, "ack");</span><span id="b9ac" class="le lf hu mh b fv mr mo l mp mq">  } else if (message.payload == "decreaseTemperature") {<br/>    targetTemperature -= 1;<br/>    setTemperature(targetTemperature);</span><span id="1d37" class="le lf hu mh b fv mr mo l mp mq">    // Send acknowledgement that message is received.<br/>    Whisper.send(message.from, TOPIC, "ack");</span><span id="6a00" class="le lf hu mh b fv mr mo l mp mq">  } else if (message.payload == "currentTemperature") {<br/>    // Respond with current temperature<br/>    Whisper.send(message.from, TOPIC, readTemperature());</span><span id="3697" class="le lf hu mh b fv mr mo l mp mq">  } else if (message.payload == "targetTemperature") {<br/>    // Respond with target temperature<br/>    Whisper.send(message.from, TOPIC, targetTemperature);</span><span id="2ed8" class="le lf hu mh b fv mr mo l mp mq">  }<br/>}</span><span id="163a" class="le lf hu mh b fv mr mo l mp mq">/* Stub of setting target temperature. */<br/>void setTemperature(unsigned int target);</span><span id="6d1b" class="le lf hu mh b fv mr mo l mp mq">/* Stub to read current room temperature from temperature sensor. */<br/>float readTemperature();</span></pre><p id="b48d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们更仔细地检查一下上面的代码:</p><ol class=""><li id="2ac7" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo ld jw jx jy dt translated"><strong class="it hv">设置话题。</strong> Whisper 依靠话题使其路由更高效。这实际上是您设置的 4 个字节的任意数据，发送方和接收方需要使用相同的主题进行通信。你可以在这里了解更多关于<a class="ae jp" href="https://geth.ethereum.org/whisper/Whisper-Overview" rel="noopener ugc nofollow" target="_blank">的话题。</a></li><li id="4707" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ld jw jx jy dt translated"><strong class="it hv">收听传入的密语信息。</strong> Elk 提供密钥管理，并自动使用其自动生成的密语密钥(如果您愿意，可以覆盖该密钥)。该设备本质上监听发送到主题的任何消息，它能够解密。</li><li id="4c66" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ld jw jx jy dt translated"><strong class="it hv">处理传入的密语消息。</strong>这部分代码是不言自明的，它定义了一个接口，用于将设备接收的消息转化为功能。</li></ol><p id="cbf6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上面的代码是一个智能恒温器的工作实现的概要，我们可以使用 Whisper 远程设置和监控温度。尽管上面的实现存在许多问题:</p><ol class=""><li id="5c67" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo ld jw jx jy dt translated"><strong class="it hv">没有认证。任何人都可以向恒温器发送命令。解决这个问题的一个简单方法是检查邮件是否被您加密了。</strong></li><li id="14ac" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ld jw jx jy dt translated">在炎热的夏天，当你试图告诉你的恒温器在回家的路上给房子降温时，用耳语传递信息是没有保证的。</li><li id="28fd" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ld jw jx jy dt translated"><strong class="it hv">你需要开发一个手机应用程序或其他用户界面来使用它。</strong> Whisper 是一种底层协议，没有用户界面。</li></ol><h2 id="419d" class="le lf hu bd lg lh li lj lk ll lm ln lo jc lp lq lr jg ls lt lu jk lv lw lx ly dt translated">实现#2: Elk 协议+应用程序</h2><p id="eac3" class="pw-post-body-paragraph ir is hu it b iu lz iw ix iy ma ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">构建恒温器通讯层最简单的方法是使用<a class="ae jp" href="https://elk.cc" rel="noopener ugc nofollow" target="_blank"> Elk </a>以及 Elk 协议和移动应用程序。Elk 协议扩展了以太坊的<a class="ae jp" href="https://github.com/ethereum/go-ethereum/wiki/Whisper-Overview" rel="noopener ugc nofollow" target="_blank"> Whisper </a>协议，以简化与物联网设备的通信。与 Whisper 相比，它具有以下优势:</p><ol class=""><li id="61b8" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo ld jw jx jy dt translated"><strong class="it hv">它包括开箱即用的身份验证。</strong></li><li id="1e36" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ld jw jx jy dt translated"><strong class="it hv">它包括重试和超时机制。</strong></li><li id="5844" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ld jw jx jy dt translated"><strong class="it hv">它会自动生成一个移动界面来与您的设备进行通信。</strong>Elk 应用程序为您生成一个基本的用户界面，帮助您快速开始使用您的设备。</li></ol><p id="fab4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是使用 Elk 协议与恒温器通信所需的代码:</p><pre class="km kn ko kp fq mj mh mk ml aw mm dt"><span id="f301" class="le lf hu mh b fv mn mo l mp mq">/* Initial target temperature (in Celsius) */<br/>unsigned int targetTemperature = 23;</span><span id="8d85" class="le lf hu mh b fv mr mo l mp mq">void setup() {<br/>  // Define a name for the sketch to be used in the Elk app<br/>  Elk.setName("Thermostat");</span><span id="2238" class="le lf hu mh b fv mr mo l mp mq">  // Exposing variables<br/>  Elk.expose("Current Temperature", &amp;readTemperature);<br/>  Elk.expose("Target Temperature", &amp;targetTemperature);</span><span id="2da5" class="le lf hu mh b fv mr mo l mp mq">  // Exposing functions<br/>  Elk.expose("Temperature++", &amp;increaseTemperature);<br/>  Elk.expose("Temperature--", &amp;decreaseTemperature);<br/>}</span><span id="e5d2" class="le lf hu mh b fv mr mo l mp mq">void loop() {<br/>  // logic related to running the thermostat goes here.<br/>}</span><span id="b356" class="le lf hu mh b fv mr mo l mp mq">void increaseTemperature() {<br/>  targetTemperature += 1;<br/>  setTemperature(targetTemperature);<br/>}</span><span id="296e" class="le lf hu mh b fv mr mo l mp mq">void decreaseTemperature() {<br/>  targetTemperature -= 1;<br/>  setTemperature(targetTemperature);<br/>}</span><span id="6e48" class="le lf hu mh b fv mr mo l mp mq">/* Stub of setting target temperature. */<br/>void setTemperature(unsigned int target);</span><span id="c807" class="le lf hu mh b fv mr mo l mp mq">/* Stub to read current room temperature from temperature sensor. */<br/>float readTemperature();</span></pre><p id="21e6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上面的代码是我们实现恒温器的通信层所需要的全部。该代码公开了增加和降低目标温度的两个函数，以及目标温度和当前温度的两个变量。为了简洁起见，我剔除了硬件相关的功能。</p><p id="4aba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当我们将上面的草图部署到板上时会发生什么？你现在可以下载 Elk 应用程序，扫描电路板的二维码，瞧！Elk 应用程序使用 Whisper 与电路板通信，获取关于草图的元数据，并为我们在草图中展示的功能生成一个接口。</p><figure class="km kn ko kp fq kq fe ff paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="fe ff ms"><img src="../Images/79ba4b43d2315a0e9bc19ef65c950ed9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*xyfAy5-f4Tw3eEcmnCZLoQ.gif"/></div></div><figcaption class="kx ky fg fe ff kz la bd b be z ek">Adding a sketch to one’s phone with the Elk app and the Elk board’s QR code.</figcaption></figure><p id="c6a9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该接口还提供恒温器已经成功接收到消息的反馈。</p><figure class="km kn ko kp fq kq fe ff paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="fe ff ms"><img src="../Images/5311bd161b559ee6bebcf69d682e5992.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*drF-qy_S3dmUDrXM6KSfUg.gif"/></div></div><figcaption class="kx ky fg fe ff kz la bd b be z ek">The interface generated by the Elk app from our sketch. The interface is dynamically generated without having to code anything. Variables like target and current temperatures are updated in real-time.</figcaption></figure><p id="c915" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，当前的实现允许任何人与您的设备通信。为了安全起见，您可以通过 IDE 配置轻松地将您自己作为开发板的用户列入白名单。</p><p id="20b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样！我们现在能够使用分散的信息网络来控制我们的恒温器——不需要中间人或服务器。那不是很容易吗？</p></div><div class="ab cl ke kf hc kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hn ho hp hq hr"><p id="b24d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在 Elk，我们的使命是将分散技术引入物理世界，并使其开发体验提高 10 倍。如果您对此感兴趣，请查看我们的<a class="ae jp" href="https://elk.cc" rel="noopener ugc nofollow" target="_blank">开发板</a>。</p><figure class="km kn ko kp fq kq"><div class="bz el l di"><div class="mt mu l"/></div></figure></div></div>    
</body>
</html>