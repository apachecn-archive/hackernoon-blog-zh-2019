<html>
<head>
<title>The Difference between setTimeout, setImmediate, And process.nextTick</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">setTimeout、setImmediate和process.nextTick之间的区别</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/settimeout-vs-setimmediate-vs-process-nexttick-ffafa3b36de2?source=collection_archive---------5-----------------------#2019-04-22">https://medium.com/hackernoon/settimeout-vs-setimmediate-vs-process-nexttick-ffafa3b36de2?source=collection_archive---------5-----------------------#2019-04-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/9d03ca897555f166492863e474f7a9b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*9mwzOKwgL4MWtfn1HGOTOg.png"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">The Event Loop and Callbacks</figcaption></figure><p id="c119" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh ka kb kc kd b">setTimeout(callback, 0)</code>和<code class="eh ka kb kc kd b">process.nextTick(callback)</code>有什么区别？Node的<code class="eh ka kb kc kd b">setImmediate(callback)</code>怎么样？</p><p id="fcb7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">从表面上看，这三个函数做的事情是一样的——它们在当前<a class="ae ke" href="https://hackernoon.com/tagged/event-loop" rel="noopener ugc nofollow" target="_blank">事件循环</a>之后执行回调，但在其他任何事情之前执行。自然要问的问题是，为什么有三种不同的功能？让我们做一个实验:</p><pre class="kf kg kh ki fq kj kd kk kl aw km dt"><span id="20b7" class="kn ko hu kd b fv kp kq l kr ks">let racer = function() {<br/>  setTimeout(() =&gt; console.log("timeout"), 0);<br/>  setImmediate(() =&gt; console.log("immediate"));<br/>  process.nextTick(() =&gt; console.log("nextTick"));<br/>  console.log("current event loop");<br/>}</span><span id="4656" class="kn ko hu kd b fv kt kq l kr ks">racer()</span></pre><p id="225b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们可以从输出中看到，这些回调没有按照它们在源代码中被编写的顺序执行。</p><pre class="kf kg kh ki fq kj kd kk kl aw km dt"><span id="6e7f" class="kn ko hu kd b fv kp kq l kr ks">[Running] node "/Users/logicmason/timeouts.js"<br/>current event loop<br/>nextTick<br/>timeout<br/>immediate</span><span id="2c6b" class="kn ko hu kd b fv kt kq l kr ks">[Done] exited with code=0 in 0.203 seconds</span></pre><h1 id="8bcc" class="ku ko hu bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">说明</h1><p id="1161" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated">第一个执行的是<code class="eh ka kb kc kd b">process.nextTick</code>，它将其回调放在事件队列的前面。它将在当前正在执行的代码之后，但在任何I/O事件或计时器之前执行。</p><p id="d536" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来是“暂停”。因为我们给<code class="eh ka kb kc kd b">setTimeout</code>设置了0的超时，所以在它执行之前没有额外的强制延迟，它在下一个循环中被放入定时器队列。</p><p id="be50" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后我们还有<code class="eh ka kb kc kd b">setImmediate</code>，显然没有它的名字那么立竿见影！它的回调被放在事件循环的下一个周期的检查队列中。由于检查队列发生在计时器队列之后，setImmediate将比setTimeout 0慢。</p><p id="95b6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">总而言之，事件循环如下所示:</p><p id="88c5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh ka kb kc kd b">timers</code>-&gt;-<code class="eh ka kb kc kd b">IO</code>-&gt;-<code class="eh ka kb kc kd b">poll</code>-&gt;-<code class="eh ka kb kc kd b">check</code>-&gt;-<code class="eh ka kb kc kd b">close</code>-&gt;-<code class="eh ka kb kc kd b">timers</code>-&gt;...</p><p id="42f9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">定时器</strong>:来自<code class="eh ka kb kc kd b">setInterval</code>或<code class="eh ka kb kc kd b">setTimeout</code>的回调<br/>或<strong class="je hv"> IO回调</strong>:来自I/O事件<br/>的回调<strong class="je hv">空闲</strong>:在IO和轮询阶段<br/>之间由<a class="ae ke" href="https://hackernoon.com/tagged/node" rel="noopener ugc nofollow" target="_blank">节点</a>内部使用<strong class="je hv">轮询</strong>:检索新的I/O事件<br/> <strong class="je hv">检查</strong>:来自setImmediate的回调在此执行<br/> <strong class="je hv">关闭</strong>:处理像套接字一样关闭的连接</p><h1 id="2435" class="ku ko hu bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">挑战时间！</h1><p id="eda1" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated">您期望Node中以下代码的输出是什么？</p><pre class="kf kg kh ki fq kj kd kk kl aw km dt"><span id="0861" class="kn ko hu kd b fv kp kq l kr ks">let racer1 = function() {<br/>  setTimeout(() =&gt; console.log("timeout"), 0);<br/>  setImmediate(() =&gt; console.log("immediate"));<br/>  process.nextTick(() =&gt; console.log("nextTick"));<br/>}</span><span id="a21b" class="kn ko hu kd b fv kt kq l kr ks">let racer2 = function() {<br/>  process.nextTick(() =&gt; console.log("nextTick"));<br/>  setTimeout(() =&gt; console.log("timeout"), 0);<br/>  setImmediate(() =&gt; console.log("immediate"));<br/>}</span><span id="9e76" class="kn ko hu kd b fv kt kq l kr ks">let racer3 = function() {<br/>  setImmediate(() =&gt; console.log("immediate"));<br/>  process.nextTick(() =&gt; console.log("nextTick"));<br/>  setTimeout(() =&gt; console.log("timeout"), 0);<br/>}</span><span id="5404" class="kn ko hu kd b fv kt kq l kr ks">racer1()<br/>racer2()<br/>racer3()</span></pre><p id="2547" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是你所期望的吗？</p></div><div class="ab cl lw lx hc ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hn ho hp hq hr"><p id="2e60" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="md">原载于2019年4月22日</em><a class="ae ke" href="https://logicmason.com/2019/settimeout-vs-setimmediate-vs-process-nexttick/" rel="noopener ugc nofollow" target="_blank"><em class="md">https://logicmason.com</em></a><em class="md">。</em></p><figure class="kf kg kh ki fq iv"><div class="bz el l di"><div class="me mf l"/></div></figure></div></div>    
</body>
</html>