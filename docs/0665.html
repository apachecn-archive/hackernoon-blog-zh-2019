<html>
<head>
<title>Tezos smart contracts with ReasonML, Docker and a sandboxed node</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Tezos智能合约包含ReasonML、Docker和一个沙盒节点</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/tezos-smart-contracts-with-reasonml-docker-and-a-sandboxed-node-89df929ca1cf?source=collection_archive---------18-----------------------#2019-01-28">https://medium.com/hackernoon/tezos-smart-contracts-with-reasonml-docker-and-a-sandboxed-node-89df929ca1cf?source=collection_archive---------18-----------------------#2019-01-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="5966" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">本文将指导您使用tezos-environment-manager在ReasonML中实现智能合约。</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/2183f31d4d36f1817087c2a1ea9af51a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O-gT2fldAiMqlHEQ9wxHxg.jpeg"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek"><a class="ae jz" href="https://tezos.com" rel="noopener ugc nofollow" target="_blank">https://tezos.com</a></figcaption></figure><h1 id="b98d" class="ka kb hu bd kc kd ke kf kg kh ki kj kk ja kl jb km jd kn je ko jg kp jh kq kr dt translated">你会学到什么？</h1><p id="a19a" class="pw-post-body-paragraph ks kt hu ku b kv kw iv kx ky kz iy la lb lc ld le lf lg lh li lj lk ll lm ln hn dt translated">您将使用<a class="ae jz" href="https://github.com/maht0rz/tezos-environment-manager" rel="noopener ugc nofollow" target="_blank">Tezos-environment-manager</a>部署一个用<a class="ae jz" href="https://reasonml.github.io" rel="noopener ugc nofollow" target="_blank"> ReasonML </a>编写的简单<a class="ae jz" href="https://tezos.com/get-started/" rel="noopener ugc nofollow" target="_blank"> Tezos </a>智能契约。您将使用<a class="ae jz" href="https://www.npmjs.com/package/sotez" rel="noopener ugc nofollow" target="_blank"> sotez </a>调用智能合约来验证部署。所有这一切都将发生在一个本地的、私人的、沙盒化的区块链。</p><h1 id="dfb6" class="ka kb hu bd kc kd ke kf kg kh ki kj kk ja kl jb km jd kn je ko jg kp jh kq kr dt translated">Tezos是什么？</h1><p id="1a3b" class="pw-post-body-paragraph ks kt hu ku b kv kw iv kx ky kz iy la lb lc ld le lf lg lh li lj lk ll lm ln hn dt translated">Tezos是一项区块链技术，或者换句话说，一个允许你通过实现区块链分类账和智能合约支持来构建分散化应用的平台。你可以在这里了解更多<a class="ae jz" href="https://tezos.com/learn-about-tezos/" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="417d" class="ka kb hu bd kc kd ke kf kg kh ki kj kk ja kl jb km jd kn je ko jg kp jh kq kr dt translated">设置Tezos环境管理器</h1><p id="aadb" class="pw-post-body-paragraph ks kt hu ku b kv kw iv kx ky kz iy la lb lc ld le lf lg lh li lj lk ll lm ln hn dt translated">Tezos环境管理器(TEM)是一个工具包，用于在Tezos区块链的基础上构建去中心化的应用程序和智能合同。要启动一个基于TEM的项目，您必须首先克隆它的源代码库:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><blockquote class="lq lr ls"><p id="bc87" class="ks kt lt ku b kv lu iv kx ky lv iy la lw lx ld le ly lz lh li ma mb ll lm ln hn dt translated">确保你有docker🐳在运行任何TEM命令之前安装并运行。⚠️也不忘了<code class="eh mc md me mf b">cd tezos-environment-manager</code>。</p></blockquote><p id="3ae1" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">在我们成功地克隆了TEM之后，我们可以通过选择一个我们想要在其中开发我们的契约的环境来开始使用它。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><p id="5d09" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">构建我们的docker映像接下来，请耐心等待，因为这个命令将编译所有必要的工具，使我们的设置工作。构建图像可能需要几分钟时间。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><p id="165b" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">构建完映像后，我们希望开始一个私有的沙盒<code class="eh mc md me mf b">tezos-node</code>。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mg"><img src="../Images/c51e6c5aeca2ed1bc83b8f212b6bdb5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3cljS6t3tCuDnctTv73ASw.png"/></div></div></figure><p id="eaa6" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">如果一切按预期进行，我们现在将有一个正在运行的tezos-node，以私有/沙箱模式运行，RPC在端口<code class="eh mc md me mf b">18731</code>公开。</p><h1 id="f886" class="ka kb hu bd kc kd ke kf kg kh ki kj kk ja kl jb km jd kn je ko jg kp jh kq kr dt translated">与沙盒tezos-node交互</h1><p id="91fe" class="pw-post-body-paragraph ks kt hu ku b kv kw iv kx ky kz iy la lb lc ld le lf lg lh li lj lk ll lm ln hn dt translated">在我们的设置中，我们可以在端口<code class="eh mc md me mf b">18731</code>访问节点的RPC接口，这本身非常有用，但是我们并不真的想自己编写RPC调用，库的存在就是为了替我们做这件事。与节点交互的方式之一是一个<code class="eh mc md me mf b">tezos-client</code>。您可以使用以下命令启动预先配置了<code class="eh mc md me mf b">tezos-client</code>的交互式shell:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><blockquote class="lq lr ls"><p id="6011" class="ks kt lt ku b kv lu iv kx ky lv iy la lw lx ld le ly lz lh li ma mb ll lm ln hn dt translated">您可以在这里找到所有支持的<code class="eh mc md me mf b">tezos-client</code>命令<a class="ae jz" href="https://tezos.gitlab.io/master/api/cli-commands.html" rel="noopener ugc nofollow" target="_blank">的详细手册</a></p></blockquote><p id="9f52" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">让我们检查一下我们是否有可用的帐户(提示:我们没有)</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mh"><img src="../Images/849bd1f04ac6a23ef99cbd7c93ffceee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eUMfmNKik13Iioen5fum2Q.png"/></div></div></figure><p id="8f7c" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">因为这是一个私人沙盒网络，真的没有一个水龙头可以给我们一个免费加密货币(tez)的账户，我们可以使用。幸运的是，TEM提供了一个命令，来加载沙盒网络上存在的几个帐户，并拥有我们可以使用的tez。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mi"><img src="../Images/fcccd98b3c2931916d4670b761d73b62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Lwgl1FWpTyqNU1oxwkqPA.png"/></div></div></figure><p id="5ab2" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">成功初始化后，我们可以再次尝试检查已知地址。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mj"><img src="../Images/368aa71f5c45951bde8412fff904f6e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-wHYKSOyDsVSoJoosUjQ7A.png"/></div></div></figure><p id="6fc9" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">万岁，我们已经有了一堆充满tez的帐户，我们可以用它们来开发我们的应用程序/智能合同！</p><h1 id="389f" class="ka kb hu bd kc kd ke kf kg kh ki kj kk ja kl jb km jd kn je ko jg kp jh kq kr dt translated">简单智能合同</h1><p id="f1b5" class="pw-post-body-paragraph ks kt hu ku b kv kw iv kx ky kz iy la lb lc ld le lf lg lh li lj lk ll lm ln hn dt translated">智能合约基本上是分布式后端应用程序，能够在区块链上存储信息/执行交易，部署和执行智能合约的代码会产生相关成本。让我们来看看我们自己的智能合同:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><p id="9a37" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">我们选择的语言是ReasonML，但是本地的tezos智能合约是用<a class="ae jz" href="https://www.michelson-lang.com" rel="noopener ugc nofollow" target="_blank"> Michelson </a>编写的。我们正在使用<a class="ae jz" href="http://www.liquidity-lang.org" rel="noopener ugc nofollow" target="_blank"> Liquidity </a>，它获取我们的OCaml/ReasonML代码，并将其编译到Michelson。</p><blockquote class="lq lr ls"><p id="ab3e" class="ks kt lt ku b kv lu iv kx ky lv iy la lw lx ld le ly lz lh li ma mb ll lm ln hn dt translated">ReasonML是OCaml的一种语法，它可以很容易地转换成OCaml或者转换回来</p></blockquote><p id="34cd" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">我们的智能合约是做什么的？它存储一个整数，初始化为<code class="eh mc md me mf b">0</code>。它指定了一个叫做<code class="eh mc md me mf b">main</code>的<code class="eh mc md me mf b">%entry</code>点。当被调用时，它按提供的数量(int)增加当前存储。关于如何调用契约方法的更多信息，<a class="ae jz" href="http://www.liquidity-lang.org/doc/usage/index.html#calling-a-contract" rel="noopener ugc nofollow" target="_blank">查看这里</a>。</p><p id="13a8" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">本教程的目标，纯粹是部署我们的合同，所以让我们回到正轨。</p><p id="5870" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">为了使用流动性部署我们的合同，我们必须首先将其转换为OCaml/Liquidity。这是使用<code class="eh mc md me mf b">refmt</code>完成的，它是<a class="ae jz" href="https://github.com/reasonml/reason-cli" rel="noopener ugc nofollow" target="_blank"> reason-cli </a>提供的工具的一部分。可以按如下方式进行转换:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff mk"><img src="../Images/68af19bffd9b777a757c972c8cf51a83.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*A04Bawz2Fariq8vIzpGxLA.png"/></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">simple.liq is the converted simple.re smart contract</figcaption></figure><h1 id="e7b6" class="ka kb hu bd kc kd ke kf kg kh ki kj kk ja kl jb km jd kn je ko jg kp jh kq kr dt translated">部署智能合同</h1><p id="cd91" class="pw-post-body-paragraph ks kt hu ku b kv kw iv kx ky kz iy la lb lc ld le lf lg lh li lj lk ll lm ln hn dt translated">为了部署智能合同，我们必须伪造一个操作，该操作来自我们在<code class="eh mc md me mf b">tezos-client</code>中配置的一个已知帐户/地址。我们还必须提供费用&amp;初始合同的技术开发中心金额。伪造一个操作将导致创建<code class="eh mc md me mf b">contract_deployment_op.bytes</code>，它将存储我们需要签名的op字节。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ml"><img src="../Images/c0940f980d44b10d49de4b03854e0b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*doZ3GnhK6TXo6vYiShnvrg.png"/></div></div></figure><p id="0dad" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">可以使用<code class="eh mc md me mf b">tezos-client</code>对伪造的操作进行签名，并且必须使用操作被伪造时指定为<code class="eh mc md me mf b">--source</code>的帐户的私钥进行签名。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mm"><img src="../Images/0174a547fe5717aca8a162451e7c6f6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qq7BvSNCjHw_85nHOb8_zg.png"/></div></div></figure><p id="9490" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">我们可以使用上面生成的签名，将一个操作注入到我们运行的<code class="eh mc md me mf b">tezos-node</code>中</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mn"><img src="../Images/e004525139559acf4bf6c08a1f6d250d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CIKzWRKQo9408xADS5Gzng.png"/></div></div></figure><p id="49ef" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">现在我们的操作已经被注入，我们必须等到一个新的区块链块被创建/烘焙，才能使用我们的智能契约！</p><h1 id="34c4" class="ka kb hu bd kc kd ke kf kg kh ki kj kk ja kl jb km jd kn je ko jg kp jh kq kr dt translated">验证部署</h1><p id="61f3" class="pw-post-body-paragraph ks kt hu ku b kv kw iv kx ky kz iy la lb lc ld le lf lg lh li lj lk ll lm ln hn dt translated">为了验证我们的部署是否成功，我们可以检查收据。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mo"><img src="../Images/cff7a11027eb81388ec7e9662d116d28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*92xRbFKJGGGl-63J6F2RPw.png"/></div></div></figure><p id="24d4" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">哎呦！我们的业务还不包括在区块链。这是因为在沙盒环境中，我们也负责为自己烘焙新的块，所以让我们在继续之前先这样做。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lo lp l"/></div></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mp"><img src="../Images/eec064c87c4f88f813bd708307fb6bcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A0SlImM0k7zpWHUxw217NA.png"/></div></div></figure><p id="5e98" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">现在，我们可以检查我们的操作是否已经包含在区块链中:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mq"><img src="../Images/ef1c004a07bdd5924e6fa7dd292111b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XrrwIcqU89rwfgt-Z81w5w.png"/></div></div></figure><p id="23cb" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">万岁！我们的运营——意味着我们的智能合约部署确实包含在新出炉的模块中，很酷吧？</p><p id="016f" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">Operation receipt包括一条重要的信息，它是我们的智能契约的原始地址，我们稍后将使用它来获得当前的存储值。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mr"><img src="../Images/9c9b3370616fae404adf93004b4f8b22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*laIfZh2_NgvK_L6uiiMbbw.png"/></div></div></figure><h1 id="d9c0" class="ka kb hu bd kc kd ke kf kg kh ki kj kk ja kl jb km jd kn je ko jg kp jh kq kr dt translated">可选:运行javascript/sotez示例</h1><blockquote class="lq lr ls"><p id="5907" class="ks kt lt ku b kv lu iv kx ky lv iy la lw lx ld le ly lz lh li ma mb ll lm ln hn dt translated">为了运行这个示例，请确保安装了NodeJS的最新版本</p></blockquote><p id="3212" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">在TEM的存储库中有一个<code class="eh mc md me mf b"><em class="lt">examples</em></code>文件夹，其中包含一个名为<code class="eh mc md me mf b"><em class="lt">contract.js</em></code>的脚本。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ms"><img src="../Images/83b41ec9f8825fe4ee56f48b6e2b7268.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y7FSFgTNCBg3GM6yh_4_rw.png"/></div></div></figure><p id="f8ce" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">为了运行它，通过键入<code class="eh mc md me mf b">exit</code>并按回车键退出您的<code class="eh mc md me mf b">tezos-client</code> shell。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff mt"><img src="../Images/2602e3ec25984079d749eb806d94e768.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*KNRpMrmfgxJ3kSYKf8Sk6A.png"/></div></figure><p id="ec00" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated">在<code class="eh mc md me mf b">examples</code>目录中，运行<code class="eh mc md me mf b">npm install</code>，在<code class="eh mc md me mf b">contract.js</code> <em class="lt"> (KT1…) </em>中更新您的合同地址，并使用<code class="eh mc md me mf b">npm run contract</code>运行脚本。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mu"><img src="../Images/14322fe98a311ad77dc3c4cff7e39065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C3aGjzzYTVyy8TZaAdYLzA.png"/></div></div></figure><p id="5d04" class="pw-post-body-paragraph ks kt hu ku b kv lu iv kx ky lv iy la lb lx ld le lf lz lh li lj mb ll lm ln hn dt translated"><strong class="ku hv">华友世纪，您已经成功部署了智能合约，并检索了其当前存储。</strong></p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mv"><img src="../Images/8d5c34192c5d3ed9336d163e705c3e2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*BpUnJiis2mIMcokKj09fEA.gif"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Tutorial steps as a GIF</figcaption></figure><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw lp l"/></div></figure></div></div>    
</body>
</html>