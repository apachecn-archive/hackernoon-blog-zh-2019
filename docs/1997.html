<html>
<head>
<title>“Bankers Rounding” for Smart Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">智能合约的“银行家舍入”</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/bankers-rounding-for-smart-contracts-2bccd0b664?source=collection_archive---------9-----------------------#2019-03-26">https://medium.com/hackernoon/bankers-rounding-for-smart-contracts-2bccd0b664?source=collection_archive---------9-----------------------#2019-03-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/4ef4a76e5be3aebd56ac972e48739771.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Sd7UFkrEgKG3u3FfP87gw.jpeg"/></div></div></figure><p id="33bc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">大家好！我叫安东，是<a class="ae ka" href="https://crypto.tickets" rel="noopener ugc nofollow" target="_blank"> crypto.tickets的首席技术官。</a> Crypto Tickets开发了新的分散售票协议，可以防止门票被伪造或重复出售。对于活动组织者来说，加密门票的吸引力在于能够控制二级市场，保留每张门票转售的额外佣金，完全禁止转售，或者只允许授权粉丝转售。这项技术旨在成为市场上任何售票技术的附加产品。</p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><h1 id="0320" class="ki kj hu bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">整数？</h1><p id="57bc" class="pw-post-body-paragraph jc jd hu je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">如你所知，以太坊智能合约无法轻松处理实数(浮点数)。所以，我们都和整数打交道。</p><p id="73f4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是，如果你用百分数计算，你将不得不用一个数除以另一个数。这就是舍入的用武之地。比如，假设你需要给账户a发“13%作为分红”，如果你有10个代币要分呢？你应该把1.3个代币四舍五入到1个还是2个？很明显1.3要四舍五入到1。就是高中数学，没什么意思。</p><p id="13b4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ll">在智能合约中有一些处理实数的通用方法。</em> <a class="ae ka" href="https://github.com/ConsenSys/smart-contract-best-practices/blob/master/docs/recommendations.md#beware-rounding-with-integer-division" rel="noopener ugc nofollow" target="_blank"> <em class="ll">有些将分子和分母存储为单独的变量</em> </a> <em class="ll">所以你可以通过在分子中存储1，在分母中存储3来描述1/3，但那是另一个不同的故事了。</em></p><p id="422d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">故事从你必须四舍五入到1.5开始。如果我们总是四舍五入到1呢？你的系统会累积误差，你的投资者会损失红利。如果你把它四舍五入到2，你就会一直赔钱。想象你分红几百万次。有什么方法可以减少累积误差？</p><p id="7a4d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">银行家不一定总是反对整个社会。他们有一些我们可以使用的东西，叫做“银行家四舍五入”，也就是“四舍五入”。这个想法是，当一个数在两个数的中间时，它被四舍五入到最近的<strong class="je hv">甚至</strong>数。例如，2.125向下舍入到2.12。同时，2.135向上舍入到2.14。其他小数按照同样的方法四舍五入:2.122到2.12，2.127到2.13，-2.122到-2.12等等。所以，你不会一直赔钱，就像你的客户一样。</p><figure class="lm ln lo lp fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/08a41aa1e9bcdc3215a4f412b8ade268.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8WA1LlwZZoZU10aw"/></div></div><figcaption class="lq lr fg fe ff ls lt bd b be z ek"><a class="ae ka" href="https://en.wikipedia.org/wiki/Rounding" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Rounding</a></figcaption></figure><p id="0397" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">好了，让我们把那个功能介绍给加密货币世界吧！</p><p id="e689" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在crypto.tickets中，我们使用智能合约进行记账(我们称之为“计费”)，因此当门票在二级市场上转售时，活动组织者将收到50%的加价作为费用。让我们描述一下如何以及在哪里使用银行家舍入。</p><ol class=""><li id="5397" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated"><strong class="je hv">让</strong> <em class="ll"> feeOrg_ppm </em>存储活动组织者应该收到的红利ppm数。Ppm代表百万分率，所以1%就是10000 ppm。最终，<em class="ll"> feeOrg_ppm </em>将等于50000。</li><li id="e592" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated"><strong class="je hv">让</strong> <em class="ll"> markup_cents </em>存储当前的加价，比如14美分。</li></ol><p id="3d8c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了计算组织者应该得到多少，我们使用这个简单的公式:</p><figure class="lm ln lo lp fq iv"><div class="bz el l di"><div class="mi mj l"/></div></figure><p id="31ab" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就是<em class="ll">bankersloudediv()</em>方法的用武之地:</p><figure class="lm ln lo lp fq iv"><div class="bz el l di"><div class="mi mj l"/></div></figure><p id="8fbd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果markup_cents是14，那么活动组织者将获得<strong class="je hv"> 7美分</strong>。</p><p id="a3f1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果markup_cents为15，那么活动组织者将获得<strong class="je hv"> 8美分</strong> (7.5四舍五入为最接近的偶数)。</p><p id="c2aa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果markup_cents是17，那么活动组织者将收到<strong class="je hv"> 8美分</strong> (8.5被四舍五入为最接近的偶数，仍然是8)。</p><h1 id="c709" class="ki kj hu bd kk kl mk kn ko kp ml kr ks kt mm kv kw kx mn kz la lb mo ld le lf dt translated">“银行家舍入”代码</h1><p id="027b" class="pw-post-body-paragraph jc jd hu je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">代码可在此处获得<a class="ae ka" href="https://github.com/cryptoticket/openzeppelin-solidity/blob/master/contracts/math/RoundedDivMath.sol#L53" rel="noopener ugc nofollow" target="_blank">—https://github . com/cryptoticket/open zeppelin-solidity/blob/master/contracts/math/roundeddivmath . sol # L53</a></p><figure class="lm ln lo lp fq iv"><div class="bz el l di"><div class="mi mj l"/></div></figure><p id="6f9f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">测试可在此处获得<a class="ae ka" href="https://github.com/cryptoticket/openzeppelin-solidity/blob/master/test/math/RoundedDivMath.test.js" rel="noopener ugc nofollow" target="_blank">—https://github . com/cryptoticket/open zeppelin-solidity/blob/master/test/math/roundeddivmath . test . js</a></p><h1 id="1462" class="ki kj hu bd kk kl mk kn ko kp ml kr ks kt mm kv kw kx mn kz la lb mo ld le lf dt translated">结论</h1><p id="ef89" class="pw-post-body-paragraph jc jd hu je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">四舍五入有助于你将累计误差降至最低，因此你的客户在收到费用或股息时会很高兴。</p><p id="6e06" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">随时联系我:<a class="ae ka" href="mailto: tony@crypto.tickets" rel="noopener ugc nofollow" target="_blank"> tony@crypto.tickets </a></p></div></div>    
</body>
</html>