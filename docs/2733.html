<html>
<head>
<title>Where do you keep credentials for your Lambda functions?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你把 Lambda 函数的凭证放在哪里？</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/where-do-you-keep-credentials-for-your-lambda-functions-cac746048480#2019-04-29">https://medium.com/hackernoon/where-do-you-keep-credentials-for-your-lambda-functions-cac746048480#2019-04-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="70e2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你的 Lambda 函数必须访问一个数据库(或者任何其他需要凭证的服务),你在哪里以及如何存储那个配置？</p><p id="2614" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最近，我们一直在迭代我们的 MVP，我们的应用程序的需求和规模有所增长，我们一直在讨论如何安全地处理不同环境/阶段和相关用户/密码的数据库配置。</p><p id="e1a5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有很多很多可能性，让我们来看看其中的一些:</p><h1 id="6f48" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">只需将主机、用户和密码硬编码在您的文件中。</h1><figure class="ko kp kq kr fq ks fe ff paragraph-image"><div class="fe ff kn"><img src="../Images/a330c744324272cac25c956381663b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*J_PbMuerYYBWUORj.gif"/></div></figure><p id="e80d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请不要。我真的应该告诉你为什么吗？</p><h1 id="e9d7" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">使用提交给 repo 的. env 文件</h1><figure class="ko kp kq kr fq ks fe ff paragraph-image"><div class="fe ff kn"><img src="../Images/af4fcf3ac0742311047f51aa2c913801.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*rtGe-oaudWkZE3gh.gif"/></div></figure><p id="1ecf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">尽管这种解决方案可能允许更多的灵活性，但它仍然非常糟糕。每个可以访问您的回购协议的人都可以立即看到您的凭据。</p><h1 id="d487" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">使用. secrets 文件(基本上是。上面的 env 文件，但是通过<a class="ae kv" href="https://github.com/serverless/serverless-secrets-plugin" rel="noopener ugc nofollow" target="_blank">无服务器秘密插件</a>加密</h1><figure class="ko kp kq kr fq ks fe ff paragraph-image"><div class="fe ff kw"><img src="../Images/ac0fe90545c87bae3fe66fbdef9acab2.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/0*M4VpykODg-tAMBES.gif"/></div></figure><p id="d1d9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我们的第一个快速方法，但事实证明效果并不好，因为:</p><ul class=""><li id="6ef0" class="kx ky hu it b iu iv iy iz jc kz jg la jk lb jo lc ld le lf dt translated">一旦 lambda 函数被部署，凭证在 AWS UI 控制台中清晰可见(env 变量在部署时被<em class="lg">嵌入到代码中)</em></li><li id="060f" class="kx ky hu it b iu lh iy li jc lj jg lk jk ll jo lc ld le lf dt translated">有人错误提交解密文件的风险很高</li><li id="abc7" class="kx ky hu it b iu lh iy li jc lj jg lk jk ll jo lc ld le lf dt translated">我们不得不在许多共享类似凭证的回购中复制这些文件</li><li id="aba4" class="kx ky hu it b iu lh iy li jc lj jg lk jk ll jo lc ld le lf dt translated">最重要的是，问题出现了——<strong class="it hv">我们把解密这些秘密的密码存放在哪里</strong>？</li></ul><pre class="ko kp kq kr fq lm ln lo lp aw lq dt"><span id="9adf" class="lr jq hu ln b fv ls lt l lu lv">plugins: - serverless-secrets-plugin custom: secrets: ${file(secrets.${self:provider.stage}.yml)}</span></pre><h1 id="4f81" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">在你的 serverless.yml 中使用 SSM 加密的<a class="ae kv" href="https://serverless.com/framework/docs/providers/aws/guide/variables#reference-variables-using-aws-secrets-manager" rel="noopener ugc nofollow" target="_blank"> env 变量</a></h1><figure class="ko kp kq kr fq ks fe ff paragraph-image"><div class="fe ff lw"><img src="../Images/29cab4cb09812d4414ad09f3d24fc468.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*gDN8Xa9vDhyBtxW5.gif"/></div></figure><p id="7f5d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是 secrets-plugin 的进一步发展，<a class="ae kv" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank"> AWS Systems Manager 参数存储</a>允许您删除文件，并且只有一个配置由许多 lambda/repos 共享，可以通过 AWS UI 控制台或 AWS CLI 快速更新，但它也有同样的缺点:</p><ul class=""><li id="407f" class="kx ky hu it b iu iv iy iz jc kz jg la jk lb jo lc ld le lf dt translated">配置值以明文形式存储为 Lambda 环境变量——您可以在 AWS Lambda 控制台中清楚地看到它们——如果该功能被攻击者破坏(攻击者可以访问 process.env ),那么他们也可以很容易地找到解密后的值</li><li id="7d5b" class="kx ky hu it b iu lh iy li jc lj jg lk jk ll jo lc ld le lf dt translated">因为您将代码与 env 变量一起部署，所以如果您需要更改配置，您需要重新部署每个 lambda 来传播所有更改。</li></ul><pre class="ko kp kq kr fq lm ln lo lp aw lq dt"><span id="4de7" class="lr jq hu ln b fv ls lt l lu lv">custom: supersecret: ${ssm:/aws/reference/secretsmanager/secret_ID_in_Secrets_Manager~true}</span></pre><h1 id="03ea" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">在运行时访问 SSM 或 SecretsManager(并使用缓存)</h1><figure class="ko kp kq kr fq ks fe ff paragraph-image"><div class="fe ff lx"><img src="../Images/06f69bbac78c6d03c76bf8e03d8e724c.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/0*iIpkTypPFDI3IHvh.gif"/></div></figure><p id="b471" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在系统管理器参数存储或<a class="ae kv" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank">机密管理器</a>(也允许自动轮换)上安全加密存储您的凭证，并在运行时访问它们。<br/>然后配置您的无服务器 yaml，通过 IAMRole 策略授予对 lambda 的访问权限:</p><pre class="ko kp kq kr fq lm ln lo lp aw lq dt"><span id="3559" class="lr jq hu ln b fv ls lt l lu lv">iamRoleStatements: - Effect: Allow Action: - ssm:GetParameter Resource:"arn:aws:ssm:YOUR_REGION:YOUR_ACCOUNT_ID:parameter/YOUR_PARAMETER"</span></pre><p id="0926" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以设置粒度越来越细的权限</p><pre class="ko kp kq kr fq lm ln lo lp aw lq dt"><span id="b085" class="lr jq hu ln b fv ls lt l lu lv">"arn:aws:ssm:*:*:parameter/*" "arn:aws:ssm:YOUR_REGION:YOUR_ACCOUNT_ID:parameter/*" "arn:aws:ssm:YOUR_REGION:YOUR_ACCOUNT_ID:parameter/YOUR_PARAMETER-*" "arn:aws:ssm:YOUR_REGION:YOUR_ACCOUNT_ID:parameter/YOUR_PARAMETER-SOME_MORE_SPECIFIC"</span></pre><p id="48e5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上面的代码直接指定了您的 ARN /地区/帐户——如果您想更加灵活，您可以设置自动获取这些值的权限:</p><pre class="ko kp kq kr fq lm ln lo lp aw lq dt"><span id="c035" class="lr jq hu ln b fv ls lt l lu lv">iamRoleStatements: - Effect: Allow Action: - ssm:GetParameter Resource: - Fn::Join: - ':' - - arn:aws:ssm - Ref: AWS::Region - Ref: AWS::AccountId - parameter/YOUR_PARAMETER-*</span></pre><p id="0b33" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于 SecretsManager 与 ParameterStore 集成，您可以通过 SSM 访问您的秘密，只需在您的密钥前加上<code class="eh ly lz ma ln b">aws/reference/secretsmanager/</code></p><p id="90f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您开始使用这些权限(尤其是在 UI 控制台中编辑策略——而不是重新部署 lambda——可能需要一些时间。通常以秒为单位，但也可能是 2-5 分钟)</p><p id="704d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦你授予你的 lambda 访问你的秘密的权限，你就可以指定一个环境变量来告诉你的 lambda 在运行时基于环境/阶段加载哪些凭证:</p><pre class="ko kp kq kr fq lm ln lo lp aw lq dt"><span id="c4ef" class="lr jq hu ln b fv ls lt l lu lv">custom: credentialsKey: production: YOUR-PRODUCTION-CREDENTIALS-KEY development: YOUR-DEV-CREDENTIALS-KEY other: YOUR-OTHER-CREDENTIALS-KEY functions: environment: SECRETS_KEY:${self:custom.credentialsKey}</span></pre><p id="cdac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是一个将某种条件应用于无服务器部署的巧妙小技巧。基本上，你是在告诉 serverless 你有三个密匙:一个用于生产，一个用于开发，一个用于所有其他阶段。<br/>在 lambda 函数的 environment 节点中，根据当前部署的阶段设置键。如果当前阶段匹配列表中的一个变量名，它将被选中，否则，它将退回到另一个变量。</p><p id="ad8f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在您的 lambda 中，您只需从 SSM 或 SecretsManager 加载凭证并连接到您的数据库。</p><pre class="ko kp kq kr fq lm ln lo lp aw lq dt"><span id="7a73" class="lr jq hu ln b fv ls lt l lu lv">const ssm = new AWS.SSM(); const params = { Name: process.env.SECRETS_KEY, WithDecryption: true }; ssm.getParameter(params, function(err, data) { if (err) console.log(err, err.stack); // an error occurred else console.log(data.Parameter.Value); // here you have your values! });</span></pre><blockquote class="mb mc md"><p id="8ea8" class="ir is lg it b iu iv iw ix iy iz ja jb me jd je jf mf jh ji jj mg jl jm jn jo hn dt translated"><em class="hu">记得实现某种缓存，这样当 lambda 容器被重用时，你就可以避免从 AWS 加载密钥(并导致额外的成本)</em></p></blockquote><p id="1ddb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我想指出的是<strong class="it hv"> SSM 要求在实例化</strong>时定义 aws 区域。如你所见，我没有传递那个值。这是因为<code class="eh ly lz ma ln b">process.env.AWS_REGION</code>是从 AWS SDK 自动读取的，env 变量是由无服务器脱机设置的。</p><p id="2c03" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您不需要做任何事情，直到您有一些集成测试试图加载秘密——我们添加了一些测试来确保在每次部署之后，该 env-stage 的秘密在 SecretsManager 上是可用的。在这种情况下，您必须将该变量传递给集成测试(记住手动将其传递给集成测试)。</p><p id="d396" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我们的 npm 脚本(我们使用<a class="ae kv" href="https://github.com/avajs/ava" rel="noopener ugc nofollow" target="_blank"> AVA </a>进行测试，使用<a class="ae kv" href="https://github.com/istanbuljs/nyc" rel="noopener ugc nofollow" target="_blank">伊斯坦布尔/纽约</a>进行代码覆盖):</p><pre class="ko kp kq kr fq lm ln lo lp aw lq dt"><span id="da0e" class="lr jq hu ln b fv ls lt l lu lv">"test:integration": "AWS_REGION=eu-west-1 SECRETS_KEY=MY_KEY_DEVSTAGE nyc ava tests-integration/**/*.*"</span></pre><p id="572e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你有其他方法来处理这个共同的——我认为是基本的/根本的——特征吗？</p><p id="f142" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">更多相关资源:<br/><a class="ae kv" href="https://docs.aws.amazon.com/en_us/systems-manager/latest/userguide/integration-ps-secretsmanager.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/en _ us/systems-manager/latest/user guide/integration-PS-secrets manager . html</a><br/><a class="ae kv" href="https://serverless.com/framework/docs/providers/aws/guide/variables/#reference-variables-using-aws-secrets-manager" rel="noopener ugc nofollow" target="_blank">https://server less . com/framework/docs/providers/AWS/guide/variables/# reference-variables-using-AWS-secrets-manager</a></p></div><div class="ab cl mh mi hc mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="hn ho hp hq hr"><p id="2a16" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="lg">原发布于</em><a class="ae kv" href="https://dev.to/dvddpl/where-do-you-keep-credentials-for-your-lambda-functions-5dno" rel="noopener ugc nofollow" target="_blank"><em class="lg">https://dev . to</em></a><em class="lg">。</em></p></div></div>    
</body>
</html>