<html>
<head>
<title>The best way to securely manage user sessions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">安全管理用户会话的最佳方式</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-best-way-to-securely-manage-user-sessions-91f27eeef460#2019-06-08">https://medium.com/hackernoon/the-best-way-to-securely-manage-user-sessions-91f27eeef460#2019-06-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/6cf6344d105c77fdfa833b1f4e35e452.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wjlZYPr-4_UWQRHra72q7w.png"/></div></div></figure><p id="fe4b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">作者编辑:我觉得我应该感谢所有人的积极回应——最重要的是，我很高兴这篇文章对开发者社区有用！如果您想更详细地讨论此解决方案或 <a class="ae kb" href="https://supertokens.io/" rel="noopener ugc nofollow" target="_blank"> <em class="ka">超级令牌</em> </a> <em class="ka">用于您的使用情形，请随时安排致电</em> <a class="ae kb" href="https://calendly.com/supertokens-rishabh" rel="noopener ugc nofollow" target="_blank"> <em class="ka">此处</em> </a> <em class="ka">。</em></p><p id="1d72" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是关于会话管理的两部分系列文章的第 2 部分。如果读者理解了 JWT (JSON web token)和用户会话的一般概念，那么可以不读第 1 部分而读第 2 部分。</p><p id="ec33" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae kb" href="https://supertokens.io/blog/all-you-need-to-know-about-user-session-security" rel="noopener ugc nofollow" target="_blank"> <em class="ka">第 1 部分:会话管理介绍、最常用会话流分析和最佳实践</em> </a></p><p id="c7c2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">第 2 部分:安全且易于集成的新开源会话流分析</em></p><p id="947b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">第 1 部分提供了会话管理的教育指南(在活动会话期间如何处理、存储和更改授权令牌<em class="ka"> ) </em>，我们讨论了几种常用的会话流。然而，我们认为第 1 部分中提到的流程在大多数用例的安全性方面是次优的。我们在 RFC 6819 中遇到了 IETF(互联网工程任务组)概念化的流程。我们采用了提议的流程，构建了它，并应其他人的请求，为更广泛的社区开源了我们的代码。</p><p id="b8e2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这篇文章中，我们将探索和分析会话流，讨论一些实现细节，并为您提供一个<a class="ae kb" href="https://github.com/supertokens/supertokens-node-mysql-ref-jwt" rel="noopener ugc nofollow" target="_blank">可定制的库</a>。这个库已经可以生产了，并且可以在一天之内集成到您的系统中(目前适用于 NodeJS 和 MySQL)。它叫做<a class="ae kb" href="https://supertokens.io/" rel="noopener ugc nofollow" target="_blank">超级坦克</a>。</p><h2 id="225c" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">建议流量</h2><p id="dbed" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated"><strong class="je hv">用短期访问令牌轮换刷新令牌</strong></p><figure class="ld le lf lg fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lc"><img src="../Images/c8121658914891a4e8e548aef4fb9780.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sF3GvcASCEQipThNsLwiCQ.png"/></div></div><figcaption class="lh li fg fe ff lj lk bd b be z ek">Suggested Auth flow — Click to Zoom</figcaption></figure><ul class=""><li id="736e" class="ll lm hu je b jf jg jj jk jn ln jr lo jv lp jz lq lr ls lt dt translated">访问令牌是短期的，而刷新令牌是长期的。</li><li id="78f7" class="ll lm hu je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt dt translated">当获得新的刷新令牌时，旧的刷新和访问令牌在后端无效并从前端移除。正确地做到这一点并不简单。请参见后面讨论的“实施注意事项”。</li><li id="d3f9" class="ll lm hu je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt dt translated">如果用户自愿注销，访问和刷新令牌将被撤销并从前端清除。</li></ul><p id="a9c2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">损害分析<br/> </strong>关键认证令牌永久暴露在前端和后端两个攻击面上，偶尔会在传输中暴露。</p><p id="d6a7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">身份验证令牌被盗的影响:<br/> </em>访问令牌被盗:攻击者将在短时间内进行未经授权的访问(直到令牌到期)</p><p id="fbc6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">刷新令牌被盗:检测到被盗将使被盗的刷新令牌失效，将损害限制在短时间内</p><p id="1a24" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">失窃检测:<br/> </em>访问令牌失窃:这种失窃只能通过使用<a class="ae kb" href="https://supertokens.io/blog/all-you-need-to-know-about-user-session-security#eee3" rel="noopener ugc nofollow" target="_blank">启发式算法</a>或用户通知服务提供商/开发商来检测。</p><p id="a205" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">刷新令牌失窃:只要攻击者和受害者在攻击后至少使用一次刷新令牌，就有可能检测到失窃。下面的例子说明了这一点。</p><ul class=""><li id="4fa2" class="ll lm hu je b jf jg jj jk jn ln jr lo jv lp jz lq lr ls lt dt translated">攻击者设法获得了受害者的刷新令牌— RT0。在访问令牌(AT0)到期时，受害者和攻击者都需要使用 RT0 来获取一组新的令牌。</li><li id="f432" class="ll lm hu je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt dt translated">如果攻击者首先使用 RT0，那么他们将收到一个新的 RT1 和 AT1，当使用时，将使 RT0 无效。当受害者使用被无效的 RT0 时，服务器将接收到一个清楚的指示，即盗窃已经发生，因为客户端应该使用 RT1。如果受害者首先使用 RT0，则类似的论点有效。</li><li id="0f63" class="ll lm hu je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt dt translated">如果受害者和攻击者同时使用 RT0，那么一方将得到(RT1，AT1)，另一方将得到(RT2，AT2)。他们中的任何一个使用新的访问令牌的下一个请求将使 RT1 或 RT2 无效，导致受害者或攻击者最终被注销<a class="ae kb" href="#d440" rel="noopener ugc nofollow">【1】</a>。同样，这里后端会得到一个盗窃的明确指示。</li></ul><p id="9f38" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">一旦检测到:<br/> </em>访问令牌不需要被撤销，因为它们是短期的。但是，如果需要，可以通过从数据库中删除不透明的访问令牌来撤销它们。</p><p id="e92d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">通过从数据库中删除刷新令牌，可以很容易地撤销它。</p><p id="dcb8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这总结了概念流程的讨论。下面是一些额外的提示，希望自己实现这个流程的读者需要记住。或者，我们在<a class="ae kb" href="https://github.com/supertokens/supertokens-core" rel="noopener ugc nofollow" target="_blank"> Github </a>上有这个流程的开源实现。</p><h2 id="249e" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">实施注意事项</h2><ol class=""><li id="e820" class="ll lm hu je b jf kx jj ky jn lz jr ma jv mb jz mc lr ls lt dt translated">后端在生成新的令牌对时会使之前的令牌失效。在前端没有收到新令牌的情况下(无论出于何种原因)，它将继续使用以前失效的令牌，导致用户被注销。为了防止这种情况，后端应该仅在前端使用新令牌时使以前的令牌无效，以确认其成功接收。</li><li id="002c" class="ll lm hu je b jf lu jj lv jn lw jr lx jv ly jz mc lr ls lt dt translated">每次使用有效的刷新令牌时，系统都会生成一个新的不同的刷新令牌(RT)。为了防止误报(盗窃的迹象)和用户注销，必须考虑前端<a class="ae kb" href="#e81c" rel="noopener ugc nofollow">【2】</a>可能发生的竞争情况。</li><li id="4570" class="ll lm hu je b jf lu jj lv jn lw jr lx jv ly jz mc lr ls lt dt translated">如果刷新令牌被撤销，那么理想地，它的访问令牌也应该被撤销。</li><li id="2747" class="ll lm hu je b jf lu jj lv jn lw jr lx jv ly jz mc lr ls lt dt translated">检测刷新令牌盗窃不需要数据库显式存储失效的令牌。这可以通过使用父子层次结构构造刷新令牌来实现(参见 Github 实现)。</li><li id="a29c" class="ll lm hu je b jf lu jj lv jn lw jr lx jv ly jz mc lr ls lt dt translated">就空间和时间复杂度而言，使用 JWT 访问令牌的实现可以像第 1 部分中的会话流 5 一样具有可伸缩性。我们只需要在数据库中为每个设备的每个登录用户存储一个刷新令牌。</li></ol><p id="8985" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就是我们关于会话管理的大部分内容。下面你会发现一个 GitHub 仓库，里面有处理所有实现问题的源代码。它可以根据您的需求进行高度定制，并且可以快速集成到您的系统中。它在防止和检测令牌盗窃方面也非常安全。我们很想知道你对它的看法——请留下评论或给我们发电子邮件。</p><h2 id="1ee5" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">超级文库</h2><p id="b0cd" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">我们承诺支持我们的库(修复错误、解决问题、添加功能和更新文档)并做出响应(通过 SO、电子邮件等)。</p><p id="f2ab" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了向我们的早期读者表达更多的爱，我们提供以下专门支持:</p><ul class=""><li id="2951" class="ll lm hu je b jf jg jj jk jn ln jr lo jv lp jz lq lr ls lt dt translated">免费咨询您当前的会话管理系统，包括识别漏洞和针对您的特定用例提出改进建议。</li><li id="c81e" class="ll lm hu je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt dt translated">SuperToken 库的免费支持。如果您在实施、错误和定制方面有任何问题，我们将随时待命。</li></ul><p id="9819" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请访问<a class="ae kb" href="https://bit.ly/2XSjBHu" rel="noopener ugc nofollow" target="_blank">我们的文档</a>，为您的技术堆栈找到正确的库。</p><figure class="ld le lf lg fq iv fe ff paragraph-image"><a href="https://supertokens.io"><div class="fe ff lc"><img src="../Images/73cca35a8ec0ebeec926bc9531e1764c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O6WlTGoP5cTsBFQG0RulNg.png"/></div></a></figure><h2 id="7a43" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">最后结论和建议</h2><p id="5c8c" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">构建生产就绪的会话管理解决方案并不简单。它需要很深的知识，并且在时间和金钱方面是昂贵的。许多开发人员没有优先考虑会话管理，导致生产中的系统次优、不安全。</p><p id="b5ac" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们已经在这两篇文章中讨论了各种会话流。根据需求，一个流可能比其他流更适合。总的来说，我们的建议如下:</p><p id="8d7d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于处理<strong class="je hv">非常敏感数据</strong>的服务(例如:股票交易平台或类似 Ashley Madison 的东西)，安全性可能优先于用户体验。这里理想的流程是使用我们的流程和<strong class="je hv">短期刷新令牌和短期不透明访问令牌</strong>。刷新令牌的到期时间将取决于用户由于不活动而注销的时间量(让我们称这个时间为 T)。每次使用刷新令牌时，新令牌将在时间 t 内有效。您可能还希望对整个会话的生存期进行硬限制。也就是说，无论用户活动如何，会话都会在这段时间内过期。举例来说，这是根据你期望用户在一天内使用你的服务的时间来估计的。</p><p id="9f4b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于所有其他服务，使用我们的带有<strong class="je hv"> JWT 访问令牌</strong>(为了更容易的可伸缩性)和<strong class="je hv">长期刷新令牌</strong>的流。您还可以使用黑名单来立即撤销访问令牌(这将增加每个 API 的时间，但是与使用不透明的访问令牌相比，您将节省空间)。但是，如果您不希望所有身份验证都依赖一个共享密钥(即使该密钥不断变化)，或者如果节省网络带宽是首要任务，则使用不透明访问令牌。此外，通过使用双因素身份验证或无密码登录方法，可以提高安全性。后者的好处是不需要用户记住另一个密码。</p><p id="7b29" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就是这样！请通过评论或给我们发电子邮件<a class="ae kb" href="mailto:team@supertokens.io" rel="noopener ugc nofollow" target="_blank">这里</a>让我们知道你在阅读这篇文章时的想法。我们希望这是有用的。</p></div><div class="ab cl md me hc mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hn ho hp hq hr"><h2 id="ee9d" class="kc kd hu bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">脚注</h2><p id="d440" class="pw-post-body-paragraph jc jd hu je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated"><em class="ka"> [1]如果使用不透明令牌，则立即注销，否则他们将在新 JWT 到期后被注销。</em></p><p id="e81c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">【2】这是一个竞态条件问题:假设一个用户在其浏览器中的 Tab1 和 Tab2 中打开了你的 app。这两个选项卡共享同一套 cookies。下图演示了竞争条件如何导致用户注销。</em></p><figure class="ld le lf lg fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lc"><img src="../Images/52c73d920aca970171a7e8eac322caa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yBgorgg9ooxaS6NvtVqRmg.png"/></div></div></figure><p id="c6cc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">由<a class="ae kb" href="https://supertokens.com" rel="noopener ugc nofollow" target="_blank">超级油轮</a>的人们撰写——希望你喜欢！如有任何问题，请在 Twitter 上关注我们或加入我们的 Discord 服务器！</p><div class="ld le lf lg fq ab cb"><figure class="mk iv ml mm mn mo mp paragraph-image"><a href="https://twitter.com/supertokensio"><img src="../Images/cb07c2160b29db7029a47ae41b422a42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Gd_-JxdUM2ajwBab8mqE1g.png"/></a></figure><figure class="mk iv ml mm mn mo mp paragraph-image"><a href="https://supertokens.io/discord"><img src="../Images/a128baf35ec64a1a0fefd680bff6e85c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*4tXjaNQnqRxaVzKG5TL8mw.png"/></a></figure></div></div></div>    
</body>
</html>