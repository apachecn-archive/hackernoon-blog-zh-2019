<html>
<head>
<title>Implementing AudioWorklets with React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用React实现AudioWorklets</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/implementing-audioworklets-with-react-8a80a470474?source=collection_archive---------19-----------------------#2019-01-02">https://medium.com/hackernoon/implementing-audioworklets-with-react-8a80a470474?source=collection_archive---------19-----------------------#2019-01-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/76fd0f9d2bacae957e213e4f291748fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xBAAzp2dbEan-3sRgVT6yw.jpeg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Photo by <a class="ae ih" href="https://unsplash.com/photos/xWiXi6wRLGo?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Steve Harvey</a> on <a class="ae ih" href="https://unsplash.com/search/photos/synthesizer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><p id="6b68" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">随着<a class="ae ih" href="https://hackernoon.com/tagged/chrome" rel="noopener ugc nofollow" target="_blank"> Chrome </a> 64中<a class="ae ih" href="https://hackernoon.com/tagged/audioworklets" rel="noopener ugc nofollow" target="_blank"> AudioWorklet </a>功能的推出，可能有理由说2018年是网络音频API的好年景。在它发布近一年后，除了谷歌Chrome Labs和dsp.audio之外，可供开发者借鉴的例子仍然相对较少。这些都是对界面的很好的介绍，但是由于可供学习的用户创建的例子相对较少，所以在弄清楚如何在野外实现它时，我们只能靠自己的设备。事实是，让AudioWorklets与React和其他UI框架完美结合的任务并不像看起来那么简单。本文的目的是向已经熟悉Web Audio API的程序员展示如何将AudioWorklets连接到React接口。有关AudioWorklet规范的更多信息，请参见本文最底部的链接。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="35c0" class="km kn ik bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">背景</h1><p id="3dd2" class="pw-post-body-paragraph jh ji ik jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">作为一名音乐学院培养的音乐家，通过<a class="ae ih" rel="noopener" href="/@krisshaffer/what-is-computational-musicology-f25ee0a65102">计算音乐学</a>进入软件工程和DSP的世界，我曾经(现在仍然)对用专用音频渲染线程创建web界面的前景感到眩晕。简而言之，一听到这个消息，我就准备发射了！我启动了<code class="eh lp lq lr ls b">create-react-app</code>，从Chrome实验室复制了一些例子，然后运行<code class="eh lp lq lr ls b">yarn start</code>，却收到了以下错误:</p><pre class="lt lu lv lw fq lx ls ly lz aw ma dt"><span id="56e9" class="mb kn ik ls b fv mc md l me mf">Failed to compile.<br/>./src/worklet/worklet-node.js<br/>  Line 2:  'AudioWorkletNode' is not defined  no-undef</span></pre><p id="03a8" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我的Chrome版本过时了吗？不是吗？为什么AudioWorkletNode没有定义？谢天谢地，丹·阿布拉莫夫很快消除了我对StackOverflow的困惑(谢谢，丹！):</p><blockquote class="mg mh mi"><p id="5d6a" class="jh ji mj jj b jk jl jm jn jo jp jq jr mk jt ju jv ml jx jy jz mm kb kc kd ke hn dt translated">Create React App被配置为强制您使用<code class="eh lp lq lr ls b">window.</code>限定符访问这样的浏览器API。这样很明显你在使用一个全局变量，并且没有忘记导入一些东西(这是很常见的)。</p><p id="97ec" class="jh ji mj jj b jk jl jm jn jo jp jq jr mk jt ju jv ml jx jy jz mm kb kc kd ke hn dt translated">这应该可行:</p><p id="6b4f" class="jh ji mj jj b jk jl jm jn jo jp jq jr mk jt ju jv ml jx jy jz mm kb kc kd ke hn dt translated"><code class="eh lp lq lr ls b">class MyWorkletNode extends window.AudioWorkletNode {</code></p><p id="ee6b" class="jh ji mj jj b jk jl jm jn jo jp jq jr mk jt ju jv ml jx jy jz mm kb kc kd ke hn dt translated">(在未来的版本中，默认情况下，ESLint会知道这个全局，并且您可以删除<code class="eh lp lq lr ls b">window.</code>)</p></blockquote><p id="3915" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">好吧，没什么大不了的！我们现在应该没事了，对吧？不完全是。尝试使用<code class="eh lp lq lr ls b">context.audioWorklet.addModule()</code>加载我的AudioWorklet处理器时，出现了一个最模糊、最致命的错误，这是任何开发人员都不想遇到的:</p><pre class="lt lu lv lw fq lx ls ly lz aw ma dt"><span id="e08b" class="mb kn ik ls b fv mc md l me mf">DOMException: The user aborted a request.</span></pre><p id="aa80" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我回到了StackOverflow。<a class="ae ih" href="http://audionodes.com" rel="noopener ugc nofollow" target="_blank"> AudioNodes </a>的John Weisz指出，这个错误可能是Chromium模块加载器中的一个<a class="ae ih" href="https://bugs.chromium.org/p/chromium/issues/detail?id=807160" rel="noopener ugc nofollow" target="_blank"> bug </a>:</p><blockquote class="mg mh mi"><p id="65e5" class="jh ji mj jj b jk jl jm jn jo jp jq jr mk jt ju jv ml jx jy jz mm kb kc kd ke hn dt translated">…它通过删除空白来解析<code class="eh lp lq lr ls b">worklet/processor.js</code>文件，这反过来导致它到处都是JavaScript语法错误，这最终导致这个一般性的非解释性错误消息出现。</p></blockquote><p id="0299" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">他继续建议为模块提供指定的头<code class="eh lp lq lr ls b">Content-Type: application/javascript</code>。我不知道在哪里或者如何指定AudioWorklet内容头，所以我暂时离开audio work let，希望随着时间的推移会出现更多的例子。</p><h1 id="0414" class="km kn ik bd ko kp mn kr ks kt mo kv kw kx mp kz la lb mq ld le lf mr lh li lj dt translated">7个月后:出乎意料的简单解决方案</h1><p id="759a" class="pw-post-body-paragraph jh ji ik jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">从<code class="eh lp lq lr ls b">public</code>文件夹为你的AudioWorklet处理器服务。去做吧。我四处摸索，发现<code class="eh lp lq lr ls b">addModule('path/to/your/module')</code>方法默认指向那里。没有进口，没有需求，不需要<code class="eh lp lq lr ls b">{process.env.PUBLIC_URL}/my-worklet-processor</code>。</p><p id="8480" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">有了这些，移植来自<a class="ae ih" href="https://googlechromelabs.github.io/web-audio-samples/audio-worklet/" rel="noopener ugc nofollow" target="_blank">谷歌Chrome实验室</a>的四个音频处理演示来作出反应将是一个很好的练习:旁路器、单极滤波器、噪声发生器和BitCrusher。如果你没有耐心，想要立即深入了解整个代码库，那么GitHub repo的链接就列在最底部。简单克隆一下，用<code class="eh lp lq lr ls b">yarn install</code>安装依赖项，用<code class="eh lp lq lr ls b">yarn start</code>运行app。</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ms"><img src="../Images/7380dc441425389ddc91fc37dd4ed8cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-eDsaBGKdAMVr8h8_2AR0g.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek"><a class="ae ih" href="https://react-audio-worklet.herokuapp.com" rel="noopener ugc nofollow" target="_blank">Click here</a> to view the demo.</figcaption></figure><p id="4dd6" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在下面的演练中，我们将在create-react-app样板代码上创建一个非常简单的UI。我们将使用<a class="ae ih" href="https://ant.design/" rel="noopener ugc nofollow" target="_blank"> Ant Design </a>组件，并通过对每个处理器稍作修改以通过messagePort接受数据来打开或关闭它，从而熟悉AudioWorklets。用户可以从下拉菜单中选择四种音频处理演示。我们将在下拉菜单旁边粘贴一个按钮，该按钮将打开和关闭当前节点。就是这样！如果你想看演示，点击左边的链接(如果你在手机上看，它在上面)。</p><p id="fb3b" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">下面是我们将要创建的项目的概述。我们添加到create-react-app样板文件中的目录和文件以粗体和斜体显示，并带有相邻的描述。</p><pre class="lt lu lv lw fq lx ls ly lz aw ma dt"><span id="b074" class="mb kn ik ls b fv mc md l me mf">| — README.md<br/>| — package.json<br/>| — public<br/>| | — favicon.ico<br/>| | — index.html<br/>| | — manifest.json<br/><strong class="ls il"><em class="mj">| ` — worklet </em></strong><em class="mj">/*Contains AudioWorkletProcessors*/</em><strong class="ls il"><em class="mj"><br/>| | — bit-crusher-processor.js<br/>| | — bypass-processor.js<br/>| | — noise-generator.js<br/>| ` — one-pole-processor.js</em></strong><br/>| — src<br/>| | — App.css<br/>| | — App.js /* Main UI */<br/>| | — App.test.js<br/><em class="mj">| |</em><strong class="ls il"><em class="mj"> — Demos.js </em></strong><em class="mj">/*Functions that interface with the processors*/</em><br/>| | — index.css<br/>| | — index.js<br/>| | — logo.svg<br/>| — serviceWorker.js<br/>| — yarn.lock</span></pre><h1 id="2f49" class="km kn ik bd ko kp mn kr ks kt mo kv kw kx mp kz la lb mq ld le lf mr lh li lj dt translated">准系统用户界面</h1><p id="ddbe" class="pw-post-body-paragraph jh ji ik jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">第一步:<code class="eh lp lq lr ls b">create-react-app react-audio-worklet</code></p><p id="977d" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">步骤2:安装依赖项。在这种情况下，我们只使用一个UI包，所以继续运行命令<code class="eh lp lq lr ls b">yarn add antd</code>。确保<code class="eh lp lq lr ls b">import 'antd/dist/antd.css'</code>进入<em class="mj"> index.js. </em></p><p id="61f2" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">步骤3:引入必要的组件来创建下拉菜单并设置初始状态:</p><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="mt mu l"/></div></figure><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="mt mu l"/></div></figure><h1 id="f02d" class="km kn ik bd ko kp mn kr ks kt mo kv kw kx mp kz la lb mq ld le lf mr lh li lj dt translated">模块选择/加载和音频切换</h1><p id="b1be" class="pw-post-body-paragraph jh ji ik jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">第1步:牢记关注点的分离，让我们包含回调以从一个名为<em class="mj"> Demos.js: </em>的单独文件中触发音频演示</p><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="mt mu l"/></div></figure><p id="b6a6" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">步骤2:在<code class="eh lp lq lr ls b">public/worklet:</code>中创建AudioWorklet处理器</p><p id="e840" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">注意:和演示一样，这些实际上是Chrome团队的代码，只是稍微修改了一下，将端口的onMessage函数绑定到AudioWorkletProcessor，以获得更好的可读性。</p><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="mt mu l"/></div></figure><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="mt mu l"/></div></figure><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="mt mu l"/></div></figure><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="mt mu l"/></div></figure><p id="d90f" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">步骤3:现在我们将在<em class="mj"> App.js </em>中创建方法来处理处理器模块的选择/加载，以及切换当前所选模块的回放:</p><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="mt mu l"/></div></figure><p id="5130" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我们忘记之前，让我们将<em class="mj"> Demos.js </em>导入到主应用程序中。您的最终<em class="mj"> App.js </em>现在应该如下所示:</p><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="mt mu l"/></div></figure><p id="9ccd" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在继续运行<code class="eh lp lq lr ls b">yarn start</code>并听那些演示。听到了吗？这是网络音频处理在其专用渲染线程上的甜美声音！</p><h1 id="7bc6" class="km kn ik bd ko kp mn kr ks kt mo kv kw kx mp kz la lb mq ld le lf mr lh li lj dt translated">结论</h1><p id="8555" class="pw-post-body-paragraph jh ji ik jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">我希望这篇文章已经阐明了如何避免在尝试将AudioWorklets集成到React时可能会遇到的一些常见问题。我还希望它有助于熟悉使用Worklet API本身。Chrome WebAudio团队通过AudioWorklets向网络平台引入了强大的技术——随着<a class="ae ih" href="https://developers.google.com/web/updates/2018/06/audio-worklet-design-pattern#using_audio_worklet_with_webassembly" rel="noopener ugc nofollow" target="_blank"> WebAssembly </a>的兴起，DSP在网络上的前景一片光明。</p><h1 id="d02d" class="km kn ik bd ko kp mn kr ks kt mo kv kw kx mp kz la lb mq ld le lf mr lh li lj dt translated">链接</h1><p id="3601" class="pw-post-body-paragraph jh ji ik jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated"><a class="ae ih" href="https://github.com/bloom510/react-audio-worklet-example" rel="noopener ugc nofollow" target="_blank"> GitHub回购</a></p><p id="e2d8" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae ih" href="https://developers.google.com/web/updates/2017/12/audio-worklet" rel="noopener ugc nofollow" target="_blank">输入AudioWorklet </a></p><p id="4cab" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae ih" href="https://www.w3.org/TR/webaudio/#audioworklet" rel="noopener ugc nofollow" target="_blank">audio work let接口</a></p><p id="aee2" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae ih" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API" rel="noopener ugc nofollow" target="_blank">网络音频API | MDN </a></p><h2 id="230b" class="mb kn ik bd ko mv mw mx ks my mz na kw js nb nc la jw nd ne le ka nf ng li nh dt translated">关于作者</h2><p id="517b" class="pw-post-body-paragraph jh ji ik jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">Aphra Bloomfield是一名音乐学院培养的音乐家，他通过计算音乐学与软件工程和DSP世界发生了碰撞。</p><p id="5c7f" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae ih" href="https://linkedin.com/in/heyaphra" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae ih" href="https://aphra.link" rel="noopener ugc nofollow" target="_blank">aphra . link</a></p><figure class="lt lu lv lw fq hw"><div class="bz el l di"><div class="ni mu l"/></div></figure></div></div>    
</body>
</html>