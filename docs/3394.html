<html>
<head>
<title>How to solve the API-GW “30 seconds limitation” using ALB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 ALB 解决 API-GW“30 秒限制”</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-solve-the-api-gw-30-seconds-limitation-using-alb-700bf3b1bd0e#2019-05-31">https://medium.com/hackernoon/how-to-solve-the-api-gw-30-seconds-limitation-using-alb-700bf3b1bd0e#2019-05-31</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/9737496656835c81c0b75e43aea9f05b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EDs-d96ntD5san7u5dkiog.png"/></div></div></figure><p id="afc6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你有一个使用多个 AWS lambdas 和 API-GW 的无服务解决方案。一切都很好，但是你有一个(或多个)lambda 函数运行超过 30 秒——然后你得到<strong class="je hv">超时错误</strong>。这是令人沮丧的，因为 lambda 可以运行长达 15 分钟。通常 AWS 为你提供选项来决定你的解决方案看起来如何，但是在这里他们为我们决定 API 必须花费少于 30 秒。</p><p id="9042" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我的例子中，我使用的是运行 SQL 查询的 API，在许多情况下，只需要 30 多秒就可以完成。类似的场景还有很多。</p><p id="1802" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所以我们需要一个可以持续 30 秒以上的 API 服务，但是仍然希望停留在一个<strong class="je hv">无服务器架构中。</strong></p><p id="71b3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我将在这里演示的解决方案是使用<strong class="je hv"> AWS ALB </strong>(应用程序负载平衡器)</p><p id="84a5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些是我将介绍的步骤:</p><ol class=""><li id="8ed6" class="ka kb hu je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">创建一个 lambda 和 API-GW。显示在使用 API-GW 时，运行超过 30 秒的 API 请求会失败。</li><li id="ef1e" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">创建调用相同 lambda 的 ALB 验证它工作 40 秒。</li><li id="45a8" class="ka kb hu je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki dt translated">创建第二个 lambda，并展示如何使用 URL 参数在 lambda 之间进行路由。</li></ol><h1 id="285b" class="ko kp hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">步骤 1:创建 Lambda 和 API GW</h1><ul class=""><li id="b41f" class="ka kb hu je b jf lm jj ln jn lo jr lp jv lq jz lr kg kh ki dt translated">新的λ叫做<strong class="je hv">λ1。</strong>这是一个非常基本的 lambda，它有一个名为<strong class="je hv"> waitSec - </strong>的参数，可以帮助我们控制 lambda 的持续时间。这是<strong class="je hv"/><strong class="je hv">节点的</strong>代码:</li></ul><pre class="ls lt lu lv fq lw lx ly lz aw ma dt"><span id="5a07" class="mb kp hu lx b fv mc md l me mf"><strong class="lx hv"><em class="mg">exports</em></strong>.handler = <strong class="lx hv">async </strong>(<strong class="lx hv"><em class="mg">event</em></strong>) =&gt; {</span><span id="ffa3" class="mb kp hu lx b fv mh md l me mf">    let start = <strong class="lx hv">new <em class="mg">Date</em></strong>();                // start time<br/>    let waitSec  = <strong class="lx hv"><em class="mg">event</em></strong>.<strong class="lx hv">queryStringParameters</strong>.waitSec;//wait param<br/>    await <em class="mg">wait</em>(waitSec);                   // wait!       <br/>    let end = <strong class="lx hv">new <em class="mg">Date</em></strong>();                  // end time<br/>    <strong class="lx hv">const </strong>response = {<br/>        <strong class="lx hv">statusCode</strong>: 200,<br/>        <strong class="lx hv">headers</strong>: {<br/>            <strong class="lx hv">"content-type"</strong>: <strong class="lx hv">"application/json"</strong>,<br/>        },<br/>        <strong class="lx hv">body</strong>: <strong class="lx hv"><em class="mg">JSON</em></strong>.stringify(<strong class="lx hv">`Hello from Lambda * 1 *, wait:</strong>${<strong class="lx hv"><em class="mg">event</em></strong>.<strong class="lx hv">queryStringParameters</strong>.waitSec}<strong class="lx hv"> ***start: </strong>${start}<strong class="lx hv"> ***end: </strong>${end}<strong class="lx hv">`</strong>),<br/>    };<br/>    <strong class="lx hv">return </strong>response;<br/>};</span><span id="b7a5" class="mb kp hu lx b fv mh md l me mf">// wait function (sleep)<br/><strong class="lx hv">async function </strong><em class="mg">wait</em>(timeSec){<br/>    <strong class="lx hv">return new </strong><em class="mg">Promise</em>(<strong class="lx hv">resolved </strong>=&gt; {<br/>        setTimeout(() =&gt; {<br/>        resolved()<br/>    }, timeSec * 1000)<br/>})<br/>}</span></pre><p id="c5a7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将 lambda 超时更改为 5 分钟(或者您需要的任何大于 30 秒的时间)，并部署 lambda。</p><ul class=""><li id="1bc4" class="ka kb hu je b jf jg jj jk jn kc jr kd jv ke jz lr kg kh ki dt translated">创建一个新 API-GW 来调用<strong class="je hv">λ1</strong>，我把它叫做<strong class="je hv">λ1 API:</strong></li></ul><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mi"><img src="../Images/87943ef50d4f228056a5848cda15fa1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mmz9FsgnE2f1hivFxT8sow.png"/></div></div></figure><p id="37c2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建一个方法"<strong class="je hv"> ANY " </strong>，它将调用<strong class="je hv">λ1</strong></p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/735c322b3569fdd4e42d62a04b2f32fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nqpK4ycF8s37R3JZAuAdww.png"/></div></div></figure><p id="0010" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">部署 API。</p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mk"><img src="../Images/a68d04b09fc67b38950ada25b452b8b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pXMC2t0JShul9uJdTWNEtQ.png"/></div></div></figure><ul class=""><li id="371c" class="ka kb hu je b jf jg jj jk jn kc jr kd jv ke jz lr kg kh ki dt translated">为了进行测试，我们需要从以下位置获取 API-GW URL:</li></ul><p id="ca40" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">阶段- &gt;阶段 1 - &gt;调用 URL(在标题中)</strong></p><p id="e074" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">别忘了添加我们的<strong class="je hv"> waitSec </strong>参数！这是我得到的:</p><p id="d9de" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ml" href="https://w4bnn2g6ce.execute-api.eu-central-1.amazonaws.com/stage1?waitSec=3" rel="noopener ugc nofollow" target="_blank">https://w4 bn N2 g 6 ce . execute-API . eu-central-1 . Amazon AWS . com/stage 1？<strong class="je hv">wait sec = 3</strong>T29】</a></p><p id="cfa7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">工作 3 秒钟:</p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mm"><img src="../Images/ce7e3f3338c4c00d47d4746b90616b60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XluB2u9OR5rHDWFkbteoaw.png"/></div></div></figure><p id="0312" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是<strong class="je hv">没有</strong>工作 40 秒:</p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mn"><img src="../Images/6d402e6ed3dc50743100360e9dad8459.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AuWM_3LOYPTFUepRrkjW4A.png"/></div></div></figure><h1 id="eab2" class="ko kp hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">步骤 2:创建 ALB</h1><p id="3e40" class="pw-post-body-paragraph jc jd hu je b jf lm jh ji jj ln jl jm jn mo jp jq jr mp jt ju jv mq jx jy jz hn dt translated">从 EC2 服务控制台-&gt;目标组，创建一个新目标</p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mr"><img src="../Images/caf90ee1571b84dfa2e703901e56f31e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ym5d4bfdvdfFRfi7aiFUQ.png"/></div></div></figure><p id="598f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">并从<strong class="je hv">“负载平衡器”</strong>菜单中，创建一个新的 ELB - &gt;“应用负载平衡器”</p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ms"><img src="../Images/77ab56399e665d02cd871b5364fee269.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DMGvd8JC7HF2RERIFm21lw.png"/></div></div></figure><p id="9c27" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">确保端口 80 在安全组中打开，以便我们浏览。</p><p id="386d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在路由步骤中，默认情况下，我们会将所有请求定向到我们的<strong class="je hv"> lambda1TargetGroup。</strong></p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mt"><img src="../Images/610b5f98d801bad0e7c01f1ddac9b7d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rHpEOL14X5OF2lkXBiqGMA.png"/></div></div></figure><p id="6f7e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">完成后，从“<strong class="je hv">描述</strong>选项卡中获取 ALB DNS 名称。将<strong class="je hv"> waitSec </strong>参数添加到 URL，并测试:</p><p id="72c0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">【http://lambdaALB-641303138.eu-central-1.elb.amazonaws.com】T4？waitSec=  40</p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mu"><img src="../Images/f4cfddbc63323e6c1b868e3cba3e1217.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DJoX5nMn4wX8lhweMCJFyQ.png"/></div></div></figure><p id="1597" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">40 秒和<strong class="je hv">工作！！</strong></p><h1 id="a9cf" class="ko kp hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">步骤 3:使用 URL 参数在 Lambdas 之间路由</h1><p id="7c3e" class="pw-post-body-paragraph jc jd hu je b jf lm jh ji jj ln jl jm jn mo jp jq jr mp jt ju jv mq jx jy jz hn dt translated">如果需要通过 ALB 使用 API 调用多个 lambdas，可以使用 URL 参数进行路由，例如:</p><p id="e143" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ml" href="http://lambdaalb-641303138.eu-central-1.elb.amazonaws.com/?waitSec=2&amp;lambda=lambda2" rel="noopener ugc nofollow" target="_blank">http://lambdaalb-641303138.eu-central-1.elb.amazonaws.com/?wait sec = 2<strong class="je hv">T44】λ=λ2</strong>T11】</a></p><ol class=""><li id="d69b" class="ka kb hu je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated">使用步骤 1 中的指令再创建一个名为<strong class="je hv">λ2，</strong>的 lambda。唯一的变化是返回的文本是"<strong class="je hv"> lambda 2" </strong>，这样我们就可以识别我们使用了哪个 lambda。</li></ol><p id="9288" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">2.在 ALB-&gt; ce 中为<strong class="je hv">λ2</strong>多创建一个目标组</p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mv"><img src="../Images/9a5cf3b07a3f68ea51b6e8677d6429c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BNlAY68KwKdY9o6nfOl9eQ.png"/></div></div></figure><p id="ee65" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">3.编辑路由规则，并为<strong class="je hv">λ2</strong>添加路由:我们将使用名为<strong class="je hv">λ的 URL 查询参数将 API 路由到正确的λ。</strong></p><p id="aede" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">λ=λ1</strong>或<strong class="je hv">λ=λ2</strong></p><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mw"><img src="../Images/cd5935ba9ddca3af035794e977f5f603.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*48VtRwEhqA2dsht7K1DvwQ.png"/></div></div></figure><figure class="ls lt lu lv fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mx"><img src="../Images/028cbf3b398a7e61043f4327b676fd8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WSNz91jGYCGZAcENMN39BQ.png"/></div></div></figure><p id="59ac" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，让我们通过<strong class="je hv"> lambda </strong>参数测试并确保正确的 lambda 正在运行:</p><p id="48b2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ml" href="http://lambdaalb-641303138.eu-central-1.elb.amazonaws.com/?waitSec=2&amp;lambda=lambda2" rel="noopener ugc nofollow" target="_blank">http://lambdaalb-641303138.eu-central-1.elb.amazonaws.com/?wait sec = 2<strong class="je hv">&amp;lambda = lambda</strong></a><strong class="je hv">1</strong></p><p id="b4af" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">返回:<strong class="je hv">“你好来自 Lambda * 1 *，</strong></p><p id="2303" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">http://lambdaalb-641303138.eu-central-1.elb.amazonaws.com/?wait sec = 2<strong class="je hv">T46】λ=λ2</strong>T39】</p><p id="4825" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">返回:<strong class="je hv">“你好来自 Lambda * 2* </strong></p><h1 id="13b0" class="ko kp hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated"><strong class="ak">结论</strong></h1><p id="c352" class="pw-post-body-paragraph jc jd hu je b jf lm jh ji jj ln jl jm jn mo jp jq jr mp jt ju jv mq jx jy jz hn dt translated">如果您的 lambda 耗时超过 30 秒，ALB 是 API-GW 的一个很好的无服务器替代方案。</p><p id="69f9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">尽情享受吧！</p></div></div>    
</body>
</html>